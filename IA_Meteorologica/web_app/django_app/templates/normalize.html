{% extends 'base.html' %}
{% load static %}

{% block title %}Normalizaci√≥n de Dataset{% endblock %}

{% block extra_css %}
<style>
    .normalization-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .dataset-header {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }

    .dataset-header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(0, 212, 255, 0.1) 0%, transparent 70%);
        animation: rotate 20s linear infinite;
    }

    .dataset-info {
        position: relative;
        z-index: 1;
    }

    .dataset-stats {
        display: flex;
        gap: 30px;
        margin-top: 20px;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        text-shadow: var(--neon-glow);
    }

    .stat-label {
        color: rgba(240, 249, 255, 0.6);
        font-size: 0.9rem;
    }

    .variables-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .variable-card {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 15px;
        padding: 20px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .variable-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--neon-glow);
        border-color: var(--primary-color);
    }

    .variable-card::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(0, 212, 255, 0.05) 0%, transparent 70%);
        transition: all 0.3s ease;
        opacity: 0;
    }

    .variable-card:hover::before {
        opacity: 1;
    }

    .variable-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        position: relative;
        z-index: 1;
    }

    .variable-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .variable-type {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .type-numeric {
        background: rgba(0, 212, 255, 0.2);
        color: #00d4ff;
        border: 1px solid rgba(0, 212, 255, 0.4);
    }

    .type-text {
        background: rgba(255, 0, 255, 0.2);
        color: #ff00ff;
        border: 1px solid rgba(255, 0, 255, 0.4);
    }

    .type-unknown {
        background: rgba(255, 165, 0, 0.2);
        color: #ffa500;
        border: 1px solid rgba(255, 165, 0, 0.4);
    }

    .variable-stats {
        font-size: 0.85rem;
        color: rgba(240, 249, 255, 0.7);
        margin-bottom: 15px;
        line-height: 1.6;
        position: relative;
        z-index: 1;
    }

    .normalization-select {
        width: 100%;
        padding: 10px;
        background: rgba(15, 17, 20, 0.8);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 8px;
        color: var(--light-color);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
    }

    .normalization-select:hover {
        border-color: var(--primary-color);
        box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
    }

    .normalization-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: var(--neon-glow);
    }

    .normalization-select option {
        background: var(--dark-color);
        padding: 10px;
    }

    .normalization-select optgroup {
        font-weight: bold;
        color: var(--primary-color);
    }

    .preview-btn {
        margin-top: 10px;
        width: 100%;
        padding: 8px;
        background: transparent;
        border: 1px solid rgba(0, 212, 255, 0.3);
        color: var(--primary-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.85rem;
        position: relative;
        z-index: 1;
    }

    .preview-btn:hover {
        background: rgba(0, 212, 255, 0.1);
        border-color: var(--primary-color);
        box-shadow: var(--neon-glow);
    }

    .control-panel {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        position: sticky;
        top: 20px;
    }

    .control-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 20px;
        text-shadow: var(--neon-glow);
    }

    .control-group {
        margin-bottom: 20px;
    }

    .control-label {
        display: block;
        font-size: 0.9rem;
        color: rgba(240, 249, 255, 0.8);
        margin-bottom: 8px;
    }

    .dataset-name-input {
        width: 100%;
        padding: 10px;
        background: rgba(15, 17, 20, 0.8);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 8px;
        color: var(--light-color);
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .dataset-name-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: var(--neon-glow);
    }

    .apply-btn {
        width: 100%;
        padding: 12px 24px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .apply-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--neon-glow-intense);
    }

    .apply-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .normalized-copies {
        margin-top: 30px;
    }

    .copies-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 15px;
    }

    .copy-list {
        background: rgba(15, 17, 20, 0.5);
        border-radius: 10px;
        padding: 10px;
    }

    .copy-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid rgba(0, 212, 255, 0.1);
        transition: all 0.3s ease;
    }

    .copy-item:last-child {
        border-bottom: none;
    }

    .copy-item:hover {
        background: rgba(0, 212, 255, 0.05);
    }

    .copy-name {
        font-size: 0.9rem;
        color: var(--light-color);
    }

    .copy-date {
        font-size: 0.8rem;
        color: rgba(240, 249, 255, 0.5);
    }

    .copy-actions {
        display: flex;
        gap: 10px;
    }

    .copy-btn {
        padding: 6px 12px;
        background: transparent;
        border: 1px solid rgba(0, 212, 255, 0.3);
        color: var(--primary-color);
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.8rem;
    }

    .copy-btn:hover {
        background: rgba(0, 212, 255, 0.1);
        border-color: var(--primary-color);
    }

    .loading-spinner {
        display: none;
        text-align: center;
        padding: 50px;
    }

    .spinner {
        border: 3px solid rgba(0, 212, 255, 0.1);
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .preview-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        overflow-y: auto;
    }

    .preview-content {
        max-width: 800px;
        margin: 50px auto;
        background: var(--dark-color);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 20px;
        padding: 30px;
        position: relative;
    }

    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .preview-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .close-preview {
        background: transparent;
        border: none;
        color: var(--light-color);
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .close-preview:hover {
        color: var(--primary-color);
    }

    .preview-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .preview-table-container {
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .preview-table-container::-webkit-scrollbar {
        width: 10px;
    }

    .preview-table-container::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
    }

    .preview-table-container::-webkit-scrollbar-thumb {
        background: rgba(0, 212, 255, 0.5);
        border-radius: 5px;
    }

    .preview-table-container::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 212, 255, 0.7);
    }

    .preview-table th,
    .preview-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid rgba(0, 212, 255, 0.1);
    }

    .preview-table th {
        background: rgba(0, 212, 255, 0.1);
        color: var(--primary-color);
        font-weight: 600;
    }

    .preview-table thead[style*="sticky"] th {
        background: var(--dark-color);
        border-bottom: 2px solid rgba(0, 212, 255, 0.3);
    }

    .preview-table tr:hover {
        background: rgba(0, 212, 255, 0.05);
    }

    .stats-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }

    .stats-box {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 15px;
    }

    .stats-box h4 {
        color: var(--primary-color);
        margin-bottom: 10px;
    }

    .stat-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        font-size: 0.9rem;
    }

    .stat-row label {
        color: rgba(240, 249, 255, 0.7);
    }

    .stat-row value {
        color: var(--light-color);
        font-weight: 500;
    }
    
    /* Estilos para el modal de progreso */
    .progress-container {
        color: var(--light-color);
    }
    
    .progress {
        overflow: visible;
    }
    
    .progress-bar {
        position: relative;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    #progressLog {
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 212, 255, 0.5) rgba(0, 0, 0, 0.3);
    }
    
    #progressLog::-webkit-scrollbar {
        width: 8px;
    }
    
    #progressLog::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
    }
    
    #progressLog::-webkit-scrollbar-thumb {
        background-color: rgba(0, 212, 255, 0.5);
        border-radius: 4px;
    }
    
    #progressLog::-webkit-scrollbar-thumb:hover {
        background-color: rgba(0, 212, 255, 0.8);
    }
    
    .modal-content {
        animation: modalGlow 3s ease-in-out infinite alternate;
    }
    
    @keyframes modalGlow {
        0% { box-shadow: 0 0 20px rgba(0, 212, 255, 0.3); }
        100% { box-shadow: 0 0 40px rgba(0, 212, 255, 0.5); }
    }
    
    .steps-graph {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        padding: 20px;
        border: 1px solid rgba(0, 212, 255, 0.2);
    }
    
    /* Estilos para creaci√≥n de funciones personalizadas */
    .custom-function-btn {
        background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 20px;
        font-weight: 600;
        width: 100%;
    }
    
    .custom-function-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--neon-glow);
    }
    
    .custom-function-modal .modal-content {
        background: var(--dark-color);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 20px;
    }
    
    .custom-function-modal .modal-header {
        border-bottom: 1px solid rgba(0, 212, 255, 0.3);
    }
    
    .custom-function-modal .modal-footer {
        border-top: 1px solid rgba(0, 212, 255, 0.3);
    }
    
    .function-type-selector {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .function-type-option {
        flex: 1;
        padding: 15px;
        border: 2px solid rgba(0, 212, 255, 0.3);
        border-radius: 10px;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .function-type-option:hover {
        border-color: var(--primary-color);
        background: rgba(0, 212, 255, 0.05);
    }
    
    .function-type-option.active {
        border-color: var(--primary-color);
        background: rgba(0, 212, 255, 0.1);
        box-shadow: var(--neon-glow);
    }
    
    .code-editor {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 8px;
        padding: 15px;
        font-family: 'Consolas', 'Monaco', monospace;
        min-height: 500px;
        width: 100%;
        color: #f0f9ff;
        overflow-x: auto;
        resize: vertical;
    }
    
    .code-editor:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: var(--neon-glow);
    }
    
    .test-section {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .test-input {
        width: 100%;
        padding: 10px;
        background: rgba(15, 17, 20, 0.8);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 8px;
        color: var(--light-color);
        margin-bottom: 10px;
    }
    
    .test-result {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        padding: 15px;
        font-family: monospace;
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .test-result.success {
        border: 1px solid rgba(0, 255, 0, 0.3);
        color: #00ff00;
    }
    
    .test-result.error {
        border: 1px solid rgba(255, 0, 0, 0.3);
        color: #ff6b6b;
    }
    
    .test-result-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    
    .test-result-table th,
    .test-result-table td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid rgba(0, 212, 255, 0.2);
    }
    
    .test-result-table th {
        background: rgba(0, 212, 255, 0.1);
        color: var(--primary-color);
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .test-result-table tr:hover {
        background: rgba(0, 212, 255, 0.05);
    }
    
    .test-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    /* Estilos para gesti√≥n de funciones */
    .functions-list {
        max-height: 500px;
        overflow-y: auto;
    }
    
    .function-item {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    
    .function-item:hover {
        background: rgba(0, 212, 255, 0.1);
        border-color: var(--primary-color);
    }
    
    .function-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .function-name {
        font-weight: 600;
        color: var(--primary-color);
        font-size: 1.1rem;
    }
    
    .function-type {
        background: rgba(0, 212, 255, 0.2);
        padding: 2px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        color: var(--light-color);
    }
    
    .function-actions {
        display: flex;
        gap: 10px;
    }
    
    .function-actions button {
        padding: 5px 10px;
        background: transparent;
        border: 1px solid rgba(0, 212, 255, 0.3);
        color: var(--primary-color);
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.85rem;
    }
    
    .function-actions button:hover {
        background: rgba(0, 212, 255, 0.1);
        border-color: var(--primary-color);
    }
    
    .function-actions button.delete-btn {
        border-color: rgba(255, 107, 107, 0.5);
        color: #ff6b6b;
    }
    
    .function-actions button.delete-btn:hover {
        background: rgba(255, 107, 107, 0.1);
        border-color: #ff6b6b;
    }
</style>
{% endblock %}

{% block content %}
<div class="normalization-container">
    <div class="page-header">
        <h1>Normalizaci√≥n de Dataset</h1>
        <p>Normaliza tu dataset variable por variable con m√©todos espec√≠ficos para cada tipo de dato</p>
    </div>

    <div class="dataset-header">
        <div class="dataset-info">
            <h2 id="dataset-name">Cargando dataset...</h2>
            <div class="dataset-stats">
                <div class="stat-item">
                    <div class="stat-value" id="dataset-rows">-</div>
                    <div class="stat-label">Filas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="dataset-cols">-</div>
                    <div class="stat-label">Columnas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="normalized-count">0</div>
                    <div class="stat-label">Normalizadas</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Botones para funciones personalizadas -->
    <div class="d-flex gap-2 mb-3">
        <button class="custom-function-btn" onclick="openCustomFunctionModal()">
            <i class="bi bi-code-slash"></i> Crear Funci√≥n de Normalizaci√≥n Personalizada
        </button>
        <button class="custom-function-btn" onclick="openManageFunctionsModal()">
            <i class="bi bi-gear"></i> Gestionar Funciones Existentes
        </button>
    </div>

    <div class="row">
        <div class="col-md-8">
            <h3 class="mb-4">Variables del Dataset</h3>
            <div class="variables-grid" id="variables-grid">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p class="mt-3">Cargando variables...</p>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="control-panel">
                <h3 class="control-title">Control de Normalizaci√≥n</h3>
                
                <div class="control-group">
                    <label class="control-label">Nombre del dataset normalizado:</label>
                    <input type="text" class="dataset-name-input" id="new-dataset-name" 
                           placeholder="Se generar√° autom√°ticamente">
                </div>
                
                <div class="control-group">
                    <label class="control-label">Descripci√≥n corta: <small class="text-muted" id="normShortCharCount">(0/80)</small></label>
                    <input type="text" class="dataset-name-input" id="new-dataset-short-description" 
                           placeholder="Descripci√≥n breve para las tarjetas..."
                           maxlength="80" oninput="updateNormShortCharCount()">
                </div>
                
                <div class="control-group">
                    <label class="control-label">Descripci√≥n detallada (opcional):</label>
                    <textarea class="dataset-name-input" id="new-dataset-long-description" 
                              rows="3" placeholder="Describa detalladamente los cambios realizados en la normalizaci√≥n..."></textarea>
                </div>

                <div class="control-group">
                    <label class="control-label">Variables seleccionadas:</label>
                    <div id="selected-count">0 variables seleccionadas</div>
                </div>

                <button class="apply-btn" id="apply-normalization" disabled>
                    <i class="bi bi-check-circle"></i> Aplicar Normalizaci√≥n
                </button>

                <div class="normalized-copies" id="normalized-copies">
                    <h4 class="copies-title">Copias Normalizadas</h4>
                    <div class="copy-list" id="copy-list">
                        <p class="text-muted text-center">No hay copias normalizadas</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de previsualizaci√≥n -->
<div class="preview-modal" id="preview-modal">
    <div class="preview-content">
        <div class="preview-header">
            <h3 class="preview-title" id="preview-title">Previsualizaci√≥n</h3>
            <button class="close-preview" onclick="closePreview()">&times;</button>
        </div>
        <div id="preview-body">
            <!-- Content will be dynamically inserted here -->
        </div>
    </div>
</div>

<!-- Modal de progreso de normalizaci√≥n -->
<div class="modal fade" id="progressModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--dark-color); border: 1px solid rgba(0, 212, 255, 0.3);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(0, 212, 255, 0.3);">
                <h5 class="modal-title" style="color: var(--primary-color);">
                    <i class="bi bi-gear-wide-connected"></i> Proceso de Normalizaci√≥n
                </h5>
            </div>
            <div class="modal-body">
                <div class="progress-container">
                    <div class="overall-progress mb-4">
                        <h6 style="color: var(--light-color);">Progreso General</h6>
                        <div class="progress" style="height: 30px; background: rgba(0, 212, 255, 0.1);">
                            <div id="overallProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 style="background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));"
                                 role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                <span id="overallProgressText">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="current-step mb-4">
                        <h6 style="color: var(--light-color);">Paso Actual</h6>
                        <div class="step-info" style="background: rgba(0, 212, 255, 0.05); padding: 15px; border-radius: 10px; border: 1px solid rgba(0, 212, 255, 0.2);">
                            <div id="currentStepText" style="color: var(--primary-color); font-weight: 600;">Preparando normalizaci√≥n...</div>
                            <div id="currentStepDetails" style="color: rgba(240, 249, 255, 0.7); font-size: 0.9rem; margin-top: 5px;"></div>
                        </div>
                    </div>
                    
                    <div class="steps-visualization mb-4">
                        <h6 style="color: var(--light-color);">Pasos del Proceso</h6>
                        <div class="steps-graph" style="position: relative; height: 300px;">
                            <canvas id="progressChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="steps-log">
                        <h6 style="color: var(--light-color);">Registro de Actividad</h6>
                        <div id="progressLog" style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 10px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;">
                            <!-- Los logs aparecer√°n aqu√≠ -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(0, 212, 255, 0.3);">
                <button type="button" class="btn btn-danger" id="cancelNormalization">
                    <i class="bi bi-x-circle"></i> Cancelar Proceso
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Gestionar Funciones Existentes -->
<div class="modal fade" id="manageFunctionsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="color: var(--primary-color);">
                    <i class="bi bi-gear"></i> Gestionar Funciones Personalizadas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="functionsList" class="functions-list">
                    <!-- Las funciones se cargar√°n aqu√≠ -->
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de creaci√≥n de funci√≥n personalizada -->
<div class="modal fade custom-function-modal" id="customFunctionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="color: var(--primary-color);">
                    <i class="bi bi-code-slash"></i> Crear Funci√≥n de Normalizaci√≥n Personalizada
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Selector de tipo de objetivo -->
                <div class="mb-3">
                    <label class="form-label" style="color: var(--light-color);">Tipo de variable objetivo:</label>
                    <div class="function-type-selector">
                        <div class="function-type-option active" data-type="numeric" onclick="selectFunctionType('numeric')">
                            <i class="bi bi-123" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <h6 style="margin-top: 10px;">Num√©rica</h6>
                            <small>Para valores num√©ricos</small>
                        </div>
                        <div class="function-type-option" data-type="text" onclick="selectFunctionType('text')">
                            <i class="bi bi-fonts" style="font-size: 2rem; color: var(--secondary-color);"></i>
                            <h6 style="margin-top: 10px;">Texto</h6>
                            <small>Para valores de texto</small>
                        </div>
                    </div>
                </div>
                
                <!-- Nombre de la funci√≥n -->
                <div class="mb-3">
                    <label class="form-label" style="color: var(--light-color);">Nombre de la funci√≥n:</label>
                    <input type="text" class="form-control dataset-name-input" id="functionName" 
                           placeholder="Ej: normalizar_temperatura, codificar_categorias">
                </div>
                
                <!-- Descripci√≥n -->
                <div class="mb-3">
                    <label class="form-label" style="color: var(--light-color);">Descripci√≥n:</label>
                    <textarea class="form-control dataset-name-input" id="functionDescription" rows="2"
                              placeholder="Describe qu√© hace tu funci√≥n de normalizaci√≥n..."></textarea>
                </div>
                
                <!-- Editor de c√≥digo -->
                <div class="mb-3">
                    <label class="form-label" style="color: var(--light-color);">C√≥digo de la funci√≥n:</label>
                    <div class="alert alert-info" style="background: rgba(0, 212, 255, 0.1); border: 1px solid rgba(0, 212, 255, 0.3); color: var(--light-color);">
                        <i class="bi bi-info-circle"></i> La funci√≥n debe recibir un par√°metro 'value' y retornar el valor normalizado.
                        Para funciones num√©ricas, tambi√©n puede recibir 'series' con toda la columna.
                    </div>
                    <textarea class="code-editor" id="functionCode" placeholder="def normalize(value):
    # Tu c√≥digo aqu√≠
    return normalized_value"></textarea>
                </div>
                
                <!-- Secci√≥n de prueba -->
                <div class="test-section">
                    <h6 style="color: var(--primary-color);">Probar funci√≥n</h6>
                    
                    <!-- Opci√≥n 1: Valor manual -->
                    <div class="mb-3">
                        <label class="form-label" style="color: var(--light-color);">
                            <i class="bi bi-pencil"></i> Opci√≥n 1: Ingresar valor de prueba manual
                        </label>
                        <input type="text" class="test-input" id="testValue" 
                               placeholder="Escribe aqu√≠ un valor para probar tu funci√≥n">
                        <button class="btn btn-sm btn-primary mt-2" onclick="testWithManualValue()">
                            <i class="bi bi-play-circle"></i> Probar con este valor
                        </button>
                    </div>
                    
                    <div class="text-center my-3" style="color: rgba(240, 249, 255, 0.6);">
                        <hr style="border-color: rgba(0, 212, 255, 0.2);">
                        <span>O</span>
                        <hr style="border-color: rgba(0, 212, 255, 0.2);">
                    </div>
                    
                    <!-- Opci√≥n 2: Columna del dataset -->
                    <div class="mb-3">
                        <label class="form-label" style="color: var(--light-color);">
                            <i class="bi bi-table"></i> Opci√≥n 2: Probar con valores de una columna
                        </label>
                        <select class="form-select test-input" id="columnSelector" 
                                onchange="updateDatasetValues()"
                                style="background: rgba(15, 17, 20, 0.8); border: 1px solid rgba(0, 212, 255, 0.3); color: var(--light-color);">
                            <option value="">Seleccionar columna del dataset...</option>
                        </select>
                        <div id="columnTestButtons" style="display: none;" class="mt-2">
                            <button class="btn btn-sm btn-success" onclick="testFirst20Values()" id="test20Btn">
                                <i class="bi bi-lightning"></i> Probar primeros 20 valores
                            </button>
                            <button class="btn btn-sm btn-info" onclick="testAllUniqueValues()" id="testUniqueBtn">
                                <i class="bi bi-list-check"></i> Probar todos los valores √∫nicos
                            </button>
                        </div>
                    </div>
                    
                    <div id="testResult" class="test-result mt-3" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveCustomFunction()">
                    <i class="bi bi-save"></i> Guardar Funci√≥n
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const datasetId = {{ dataset_id }};
    let datasetInfo = null;
    let normalizationConfig = {};
    let normalizedCount = 0;
    let selectedFunctionType = 'numeric';

    document.addEventListener('DOMContentLoaded', function() {
        console.log('normalize.html script loaded');
        loadDatasetInfo();
        
        // Verificar que las funciones globales est√©n disponibles
        console.log('window.editFunction:', typeof window.editFunction);
        console.log('window.deleteFunction:', typeof window.deleteFunction);
    });

    async function loadDatasetInfo() {
        try {
            // Agregar timestamp para evitar cache
            const timestamp = new Date().getTime();
            const response = await fetch(`/api/datasets/${datasetId}/normalization/?t=${timestamp}`, {
                cache: 'no-store'
            });
            if (!response.ok) throw new Error('Error loading dataset info');
            
            datasetInfo = await response.json();
            console.log('Dataset info loaded:', datasetInfo);
            
            // Actualizar informaci√≥n del dataset
            document.getElementById('dataset-name').textContent = datasetInfo.dataset.name;
            document.getElementById('dataset-rows').textContent = datasetInfo.dataset.shape[0].toLocaleString();
            document.getElementById('dataset-cols').textContent = datasetInfo.dataset.shape[1];
            
            // Sugerir nombre para el dataset normalizado
            // Contar cu√°ntas normalizaciones existen
            const normalizedCount = datasetInfo.normalized_copies ? datasetInfo.normalized_copies.length : 0;
            const nextNumber = normalizedCount + 1;
            document.getElementById('new-dataset-name').placeholder = 
                `${datasetInfo.dataset.name}_normalizacion_${nextNumber}`;
            
            // Renderizar variables
            renderVariables();
            
            // Cargar copias normalizadas
            renderNormalizedCopies();
            
        } catch (error) {
            console.error('Error:', error);
            showNotification('Error al cargar informaci√≥n del dataset', 'error');
        }
    }

    function renderVariables() {
        const grid = document.getElementById('variables-grid');
        grid.innerHTML = '';
        
        for (const [column, info] of Object.entries(datasetInfo.normalization_info)) {
            const card = createVariableCard(column, info);
            grid.appendChild(card);
        }
    }

    function createVariableCard(column, info) {
        const card = document.createElement('div');
        card.className = 'variable-card';
        
        // Determinar el tipo de badge
        const typeClass = `type-${info.type}`;
        const typeLabel = info.type === 'numeric' ? 'Num√©rico' : 
                         info.type === 'text' ? 'Texto' : 'Desconocido';
        
        // Crear contenido de estad√≠sticas
        let statsHtml = '';
        if (info.type === 'numeric' && info.stats) {
            statsHtml = `
                <div class="variable-stats">
                    ${info.stats.mean !== null ? `Media: ${info.stats.mean.toFixed(2)}` : ''}
                    ${info.stats.std !== null ? ` | Desv: ${info.stats.std.toFixed(2)}` : ''}<br>
                    ${info.stats.min !== null ? `Min: ${info.stats.min.toFixed(2)}` : ''}
                    ${info.stats.max !== null ? ` | Max: ${info.stats.max.toFixed(2)}` : ''}
                </div>
            `;
        } else if (info.type === 'text' && info.stats) {
            statsHtml = `
                <div class="variable-stats">
                    ${info.stats.unique_count} valores √∫nicos<br>
                    ${info.stats.sample_values ? `Ej: ${info.stats.sample_values.slice(0, 2).join(', ')}...` : ''}
                </div>
            `;
        }
        
        card.innerHTML = `
            <div class="variable-header">
                <span class="variable-name">${column}</span>
                <span class="variable-type ${typeClass}">${typeLabel}</span>
            </div>
            ${statsHtml}
            <select class="normalization-select" id="norm-${column}" onchange="onNormalizationChange('${column}')">
                <option value="">Sin normalizar</option>
                <optgroup label="M√©todos principales">
                    ${info.primary_methods.map(method => 
                        `<option value="${method.value}" title="${method.description}">${method.label}</option>`
                    ).join('')}
                </optgroup>
                ${info.secondary_methods.length > 0 ? `
                    <optgroup label="Otros m√©todos">
                        ${info.secondary_methods.map(method => 
                            `<option value="${method.value}" title="${method.description}">${method.label}</option>`
                        ).join('')}
                    </optgroup>
                ` : ''}
            </select>
            <button class="preview-btn" onclick="previewNormalization('${column}')" 
                    id="preview-btn-${column}" style="display: none;">
                <i class="bi bi-eye"></i> Previsualizar
            </button>
        `;
        
        return card;
    }

    function onNormalizationChange(column) {
        const select = document.getElementById(`norm-${column}`);
        const previewBtn = document.getElementById(`preview-btn-${column}`);
        
        if (select.value) {
            normalizationConfig[column] = select.value;
            previewBtn.style.display = 'block';
        } else {
            delete normalizationConfig[column];
            previewBtn.style.display = 'none';
        }
        
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const count = Object.keys(normalizationConfig).length;
        document.getElementById('selected-count').textContent = 
            `${count} variable${count !== 1 ? 's' : ''} seleccionada${count !== 1 ? 's' : ''}`;
        document.getElementById('normalized-count').textContent = count;
        
        const applyBtn = document.getElementById('apply-normalization');
        applyBtn.disabled = count === 0;
    }

    async function previewNormalization(column) {
        const method = normalizationConfig[column];
        if (!method) return;
        
        try {
            const response = await fetch(`/api/datasets/${datasetId}/normalization/preview/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    normalization: {
                        [column]: method
                    },
                    sample_size: 100
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                console.error('Error response:', data);
                
                // Si es un error de funci√≥n personalizada, mostrar en formato especial
                if (data.error_type === 'CustomFunctionError') {
                    showPreviewError(data.details || data.message);
                    return;
                }
                
                let errorMessage = 'Error al generar previsualizaci√≥n';
                
                if (data.error) {
                    errorMessage = data.error;
                    if (data.traceback) {
                        console.error('Traceback:', data.traceback);
                    }
                    if (data.debug_info) {
                        console.error('Debug info:', data.debug_info);
                    }
                }
                
                showNotification(errorMessage, 'error');
                return;
            }
            
            showPreview(data);
            
        } catch (error) {
            // Solo mostrar error de conexi√≥n si es realmente un problema de red
            if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                console.error('Error de conexi√≥n:', error);
                showNotification('Error de conexi√≥n al generar previsualizaci√≥n', 'error');
            } else if (error.name === 'NetworkError') {
                console.error('Error de red:', error);
                showNotification('Error de conexi√≥n al generar previsualizaci√≥n', 'error');
            }
            // Para otros errores, solo registrar en consola sin mostrar notificaci√≥n
            else {
                console.error('Error procesando respuesta:', error);
            }
        }
    }

    function showPreview(response) {
        const modal = document.getElementById('preview-modal');
        const body = document.getElementById('preview-body');
        const title = document.getElementById('preview-title');
        
        // Extraer la columna del preview (asumimos que solo se envi√≥ una columna)
        const columns = Object.keys(response.preview || {});
        if (columns.length === 0) {
            showNotification('No se recibieron datos de previsualizaci√≥n', 'error');
            return;
        }
        
        const column = columns[0];
        const preview = response.preview[column];
        
        title.textContent = `Previsualizaci√≥n: ${column}`;
        
        let bodyHtml = '';
        
        if (preview.new_columns) {
            // One-hot encoding
            bodyHtml = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> One-Hot Encoding generar√° ${preview.new_columns.length} nuevas columnas
                </div>
                <h4>Nuevas columnas:</h4>
                <ul>
                    ${preview.new_columns.map(col => `<li>${col}</li>`).join('')}
                </ul>
                ${preview.one_hot_preview ? `
                    <h4>Vista previa (primeras 10 filas):</h4>
                    <div style="overflow-x: auto;">
                        <table class="preview-table">
                            <thead>
                                <tr>
                                    ${preview.new_columns.map(col => `<th>${col}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${preview.one_hot_preview.slice(0, 10).map(row => `
                                    <tr>
                                        ${preview.new_columns.map(col => `<td>${row[col]}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : ''}
            `;
        } else {
            // Normal preview
            const original = preview.original || {};
            const normalized = preview.normalized || {};
            const uniqueMapping = preview.unique_mapping || [];
            const isCategorical = preview.is_categorical || false;
            
            if (isCategorical && uniqueMapping.length > 0) {
                // Show unique value mapping for categorical data
                bodyHtml = `
                    <h4>Mapeo de valores √∫nicos:</h4>
                    <div class="preview-table-container" style="max-height: 400px; overflow-y: auto;">
                        <table class="preview-table">
                            <thead style="position: sticky; top: 0; background-color: white; z-index: 10;">
                                <tr>
                                    <th>Valor Original</th>
                                    <th>Valor Normalizado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${uniqueMapping.map(item => `
                                    <tr>
                                        <td>${item.original}</td>
                                        <td>${item.normalized}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4>Muestras de datos (${(original.sample || []).length} valores):</h4>
                        <div class="preview-table-container" style="max-height: 300px; overflow-y: auto;">
                            <table class="preview-table">
                                <thead style="position: sticky; top: 0; background-color: white; z-index: 10;">
                                    <tr>
                                        <th>√çndice</th>
                                        <th>Antes</th>
                                        <th>Despu√©s</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(original.sample || []).map((val, idx) => `
                                        <tr>
                                            <td>${idx + 1}</td>
                                            <td>${val}</td>
                                            <td>${normalized.sample && normalized.sample[idx] !== undefined ? normalized.sample[idx] : 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else {
                // Regular numeric preview
                bodyHtml = `
                    <h4>Comparaci√≥n antes/despu√©s (${(original.sample || []).length} muestras):</h4>
                    <div class="preview-table-container" style="max-height: 400px; overflow-y: auto;">
                        <table class="preview-table">
                            <thead style="position: sticky; top: 0; background-color: white; z-index: 10;">
                                <tr>
                                    <th>√çndice</th>
                                    <th>Antes</th>
                                    <th>Despu√©s</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(original.sample || []).map((val, idx) => `
                                    <tr>
                                        <td>${idx + 1}</td>
                                        <td>${typeof val === 'number' ? val.toFixed(4) : val}</td>
                                        <td>${normalized.sample && normalized.sample[idx] !== undefined ? 
                                            (typeof normalized.sample[idx] === 'number' ? normalized.sample[idx].toFixed(4) : normalized.sample[idx]) 
                                            : 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // A√±adir estad√≠sticas si est√°n disponibles
            if (original.stats || normalized.stats) {
                bodyHtml += `
                    <div class="stats-comparison" style="margin-top: 20px;">
                        <div class="stats-box">
                            <h4>Estad√≠sticas Originales</h4>
                            ${original.stats ? Object.entries(original.stats).map(([key, val]) => {
                                if (typeof val === 'object' && val !== null) return '';
                                return `
                                    <div class="stat-row">
                                        <label>${key}:</label>
                                        <value>${val !== null && typeof val === 'number' ? val.toFixed(4) : val || 'N/A'}</value>
                                    </div>
                                `;
                            }).join('') : '<p>No disponibles</p>'}
                        </div>
                        <div class="stats-box">
                            <h4>Estad√≠sticas Normalizadas</h4>
                            ${normalized.stats ? Object.entries(normalized.stats).map(([key, val]) => {
                                if (typeof val === 'object' && val !== null) return '';
                                return `
                                    <div class="stat-row">
                                        <label>${key}:</label>
                                        <value>${val !== null && typeof val === 'number' ? val.toFixed(4) : val || 'N/A'}</value>
                                    </div>
                                `;
                            }).join('') : '<p>No disponibles</p>'}
                        </div>
                    </div>
                `;
            }
        }
        
        body.innerHTML = bodyHtml;
        modal.style.display = 'block';
    }

    function closePreview() {
        document.getElementById('preview-modal').style.display = 'none';
    }

    let normalizationProcess = null;
    let progressChart = null;
    let cancelRequested = false;

    async function applyNormalization() {
        const applyBtn = document.getElementById('apply-normalization');
        applyBtn.disabled = true;
        
        const datasetName = document.getElementById('new-dataset-name').value || 
                           document.getElementById('new-dataset-name').placeholder;
        const shortDescription = document.getElementById('new-dataset-short-description').value.trim();
        const longDescription = document.getElementById('new-dataset-long-description').value.trim();
        
        // Preparar datos para el proceso
        const normalizedColumns = Object.keys(normalizationConfig);
        const totalSteps = normalizedColumns.length + 3; // +3 para: preparaci√≥n, guardado, finalizaci√≥n
        
        // Mostrar modal de progreso
        showProgressModal(totalSteps, normalizedColumns);
        
        try {
            // Simular proceso paso a paso (en producci√≥n, esto ser√≠a as√≠ncrono)
            await simulateNormalizationProcess(datasetName, normalizedColumns, shortDescription, longDescription);
            
        } catch (error) {
            console.error('Error completo:', error);
            hideProgressModal();
            
            // Mostrar error m√°s espec√≠fico
            let errorMessage = 'Error al aplicar normalizaci√≥n';
            if (error.message) {
                errorMessage = error.message;
            }
            
            showNotification(errorMessage, 'error');
            
            // Si hay log de progreso, a√±adir el error
            if (document.getElementById('progressLog')) {
                addProgressLog(`‚ùå Error: ${errorMessage}`);
            }
        } finally {
            applyBtn.disabled = false;
            applyBtn.innerHTML = '<i class="bi bi-check-circle"></i> Aplicar Normalizaci√≥n';
        }
    }
    
    function showProgressModal(totalSteps, columns) {
        cancelRequested = false;
        
        // Resetear UI
        document.getElementById('overallProgressBar').style.width = '0%';
        document.getElementById('overallProgressText').textContent = '0%';
        document.getElementById('currentStepText').textContent = 'Preparando normalizaci√≥n...';
        document.getElementById('currentStepDetails').textContent = '';
        document.getElementById('progressLog').innerHTML = '';
        
        // Inicializar gr√°fico
        initializeProgressChart(columns);
        
        // Mostrar modal sin backdrop
        const modalElement = document.getElementById('progressModal');
        let modal = bootstrap.Modal.getInstance(modalElement);
        
        if (!modal) {
            modal = new bootstrap.Modal(modalElement, {
                backdrop: false,  // Sin backdrop para evitar el filtro gris
                keyboard: true
            });
        }
        modal.show();
        
        // Configurar bot√≥n de cancelar
        document.getElementById('cancelNormalization').onclick = () => {
            cancelNormalization();
        };
    }
    
    function hideProgressModal() {
        const modalElement = document.getElementById('progressModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
            modal.dispose();
        }
        // Clean up any lingering backdrops
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('overflow');
        document.body.style.removeProperty('padding-right');
    }
    
    function initializeProgressChart(columns) {
        const ctx = document.getElementById('progressChart').getContext('2d');
        
        if (progressChart) {
            progressChart.destroy();
        }
        
        const labels = ['Preparaci√≥n', ...columns, 'Guardado', 'Finalizaci√≥n'];
        const data = new Array(labels.length).fill(0);
        
        progressChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Progreso',
                    data: data,
                    backgroundColor: 'rgba(0, 212, 255, 0.2)',
                    borderColor: 'rgba(0, 212, 255, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            color: '#f0f9ff',
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#f0f9ff',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y + '% completado';
                            }
                        }
                    }
                }
            }
        });
    }
    
    async function simulateNormalizationProcess(datasetName, columns, shortDescription, longDescription) {
        const totalSteps = columns.length + 3;
        let currentStep = 0;
        
        // Paso 1: Preparaci√≥n
        updateProgress(currentStep, totalSteps, 'Preparando normalizaci√≥n...', 'Cargando dataset y verificando configuraci√≥n');
        addProgressLog('‚úì Iniciando proceso de normalizaci√≥n');
        addProgressLog(`‚úì Dataset: ${datasetInfo.dataset.name}`);
        addProgressLog(`‚úì Variables a normalizar: ${columns.length}`);
        updateChartStep(0, 100);
        await delay(1000);
        
        if (cancelRequested) throw new Error('Proceso cancelado por el usuario');
        
        currentStep++;
        
        // Normalizar cada columna
        for (let i = 0; i < columns.length; i++) {
            const column = columns[i];
            const method = normalizationConfig[column];
            
            updateProgress(currentStep, totalSteps, `Normalizando: ${column}`, `M√©todo: ${method}`);
            addProgressLog(`‚öôÔ∏è Normalizando "${column}" con m√©todo ${method}...`);
            
            // Simular tiempo de procesamiento
            await delay(800 + Math.random() * 400);
            
            updateChartStep(i + 1, 100);
            addProgressLog(`‚úì "${column}" normalizada correctamente`);
            
            if (cancelRequested) throw new Error('Proceso cancelado por el usuario');
            
            currentStep++;
        }
        
        // Paso: Guardando
        updateProgress(currentStep, totalSteps, 'Guardando dataset...', 'Escribiendo archivo CSV normalizado');
        addProgressLog('üíæ Guardando dataset normalizado...');
        updateChartStep(columns.length + 1, 100);
        
        // Hacer la llamada real al servidor
        const response = await fetch(`/api/datasets/${datasetId}/normalization/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                normalization_config: normalizationConfig,
                create_copy: true,
                copy_name: datasetName,
                copy_short_description: shortDescription,
                copy_long_description: longDescription
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            console.error('Error del servidor:', errorData);
            
            // Si es un error de funci√≥n personalizada, mostrar en el log
            if (errorData.error_type === 'CustomFunctionError') {
                // Parsear el mensaje de error para mostrarlo l√≠nea por l√≠nea
                const errorLines = (errorData.details || errorData.message).split('\n');
                
                addProgressLog('‚ùå ERROR EN FUNCI√ìN PERSONALIZADA');
                addProgressLog('‚ïê'.repeat(50));
                
                errorLines.forEach(line => {
                    if (line.trim()) {
                        addProgressLog(line);
                    }
                });
                
                addProgressLog('‚ïê'.repeat(50));
                addProgressLog('‚ö†Ô∏è El proceso de normalizaci√≥n ha sido detenido');
                
                // Actualizar el estado del paso actual
                document.getElementById('currentStepText').textContent = 'Error en normalizaci√≥n';
                document.getElementById('currentStepDetails').textContent = 'Se encontr√≥ un error al ejecutar una funci√≥n personalizada';
                
                // Cambiar el bot√≥n de cancelar a cerrar
                const cancelBtn = document.getElementById('cancelNormalization');
                cancelBtn.textContent = 'Cerrar';
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.onclick = hideProgressModal;
                
                throw new Error('Error en funci√≥n personalizada');
            } else {
                throw new Error(errorData.error || 'Error al aplicar normalizaci√≥n');
            }
        }
        
        const result = await response.json();
        console.log('Response from server:', result); // Debug log
        currentStep++;
        
        // Paso: Finalizaci√≥n
        updateProgress(currentStep, totalSteps, 'Finalizando...', 'Proceso completado exitosamente');
        addProgressLog(`‚úì Dataset guardado como: ${result.dataset_name}`);
        if (result.new_shape && Array.isArray(result.new_shape) && result.new_shape.length >= 2) {
            addProgressLog(`‚úì Nuevas dimensiones: ${result.new_shape[0]} filas x ${result.new_shape[1]} columnas`);
        } else {
            addProgressLog(`‚úì Dataset normalizado correctamente`);
        }
        updateChartStep(columns.length + 2, 100);
        
        await delay(1000);
        
        // √âxito
        hideProgressModal();
        showNotification(`Dataset normalizado creado: ${result.dataset_name}`, 'success');
        
        // Limpiar selecci√≥n
        normalizationConfig = {};
        loadDatasetInfo();
        
        // Redirigir despu√©s de 2 segundos con par√°metro para forzar recarga
        setTimeout(() => {
            window.location.href = `/datasets/?refresh=true`;
        }, 2000);
    }
    
    function updateProgress(current, total, stepText, details) {
        const percentage = Math.round((current / total) * 100);
        
        document.getElementById('overallProgressBar').style.width = percentage + '%';
        document.getElementById('overallProgressText').textContent = percentage + '%';
        document.getElementById('currentStepText').textContent = stepText;
        document.getElementById('currentStepDetails').textContent = details || '';
    }
    
    function updateChartStep(stepIndex, value) {
        if (progressChart) {
            progressChart.data.datasets[0].data[stepIndex] = value;
            progressChart.update();
        }
    }
    
    function addProgressLog(message, isError = false) {
        const log = document.getElementById('progressLog');
        const timestamp = new Date().toLocaleTimeString();
        let color = '#00d4ff';
        
        // Determinar el color seg√∫n el tipo de mensaje
        if (isError || message.includes('ERROR') || message.includes('Error')) {
            color = '#ff6b6b';
        } else if (message.includes('‚ö†Ô∏è') || message.includes('Warning')) {
            color = '#ffd93d';
        } else if (message.includes('‚úì') || message.includes('‚úÖ')) {
            color = '#6bcf7f';
        } else if (message.includes('‚ïê') || message.includes('‚îÄ')) {
            color = '#666';
        } else if (message.includes('Function:') || message.includes('Error Type:') || message.includes('Traceback:')) {
            color = '#ff9ff3';
        }
        
        log.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
        log.scrollTop = log.scrollHeight;
    }
    
    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    async function cancelNormalization() {
        cancelRequested = true;
        addProgressLog('‚ùå Cancelaci√≥n solicitada por el usuario');
        
        // Aqu√≠ deber√≠as hacer una llamada al servidor para cancelar el proceso real
        // y limpiar cualquier archivo temporal
        
        await delay(500);
        hideProgressModal();
        showNotification('Proceso de normalizaci√≥n cancelado', 'warning');
    }

    function renderNormalizedCopies() {
        const copyList = document.getElementById('copy-list');
        
        if (!datasetInfo.normalized_copies || datasetInfo.normalized_copies.length === 0) {
            copyList.innerHTML = '<p class="text-muted text-center">No hay copias normalizadas</p>';
            return;
        }
        
        copyList.innerHTML = datasetInfo.normalized_copies.map(copy => `
            <div class="copy-item">
                <div>
                    <div class="copy-name">${copy.name}</div>
                    <div class="copy-date">${new Date(copy.created_at).toLocaleString()}</div>
                </div>
                <div class="copy-actions">
                    <button class="copy-btn" onclick="viewDataset(${copy.id})">
                        <i class="bi bi-eye"></i> Ver
                    </button>
                    <button class="copy-btn" onclick="continueNormalization(${copy.id})">
                        <i class="bi bi-arrow-repeat"></i> Continuar
                    </button>
                </div>
            </div>
        `).join('');
    }

    function viewDataset(id) {
        // Redirigir directamente al an√°lisis del dataset normalizado
        window.location.href = `/datasets/?open=${id}`;
    }

    function continueNormalization(id) {
        window.location.href = `/datasets/${id}/normalize/`;
    }

    function showNotification(message, type) {
        // Implementar notificaciones toast
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        // A√±adir al contenedor de toasts (crear si no existe)
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Actualizar contador de caracteres para descripci√≥n corta de normalizaci√≥n
    function updateNormShortCharCount() {
        const input = document.getElementById('new-dataset-short-description');
        const charCount = document.getElementById('normShortCharCount');
        if (input && charCount) {
            const current = input.value.length;
            charCount.textContent = `(${current}/80)`;
            charCount.style.color = current >= 80 ? '#ff6b6b' : '#6c757d';
        }
    }

    // Event listeners
    document.getElementById('apply-normalization').addEventListener('click', applyNormalization);
    
    // Cerrar modal al hacer clic fuera
    window.onclick = function(event) {
        const modal = document.getElementById('preview-modal');
        if (event.target === modal) {
            closePreview();
        }
    }
    
    
    function openCustomFunctionModal(functionData = null) {
        const modal = new bootstrap.Modal(document.getElementById('customFunctionModal'));
        const modalTitle = document.querySelector('#customFunctionModal .modal-title');
        
        if (functionData) {
            // Modo edici√≥n
            console.log('Opening modal for edit mode with data:', functionData);
            modalTitle.innerHTML = '<i class="bi bi-pencil-square"></i> Editar Funci√≥n de Normalizaci√≥n Personalizada';
            
            // Guardar el ID y el tipo original ANTES de cualquier otra operaci√≥n
            document.getElementById('customFunctionModal').dataset.editingId = functionData.id;
            document.getElementById('customFunctionModal').dataset.originalType = functionData.function_type;
            
            // Primero establecer el tipo de funci√≥n (sin actualizar el c√≥digo)
            selectFunctionType(functionData.function_type, true);
            
            // Luego establecer los valores
            document.getElementById('functionName').value = functionData.name;
            document.getElementById('functionDescription').value = functionData.description;
            
            // Establecer el c√≥digo despu√©s de un peque√±o delay para asegurar que no se sobrescriba
            setTimeout(() => {
                document.getElementById('functionCode').value = functionData.code;
                
                // Verificar que el c√≥digo se carg√≥ correctamente
                console.log('Code loaded into textarea:', document.getElementById('functionCode').value.substring(0, 200) + '...');
                console.log('Original code:', functionData.code.substring(0, 200) + '...');
                
                // Forzar un evento de cambio para actualizar cualquier listener
                const event = new Event('input', { bubbles: true });
                document.getElementById('functionCode').dispatchEvent(event);
            }, 100);
            
            console.log('Modal data set - ID:', functionData.id, 'Type:', functionData.function_type);
        } else {
            // Modo creaci√≥n
            console.log('Opening modal for create mode');
            modalTitle.innerHTML = '<i class="bi bi-code-slash"></i> Crear Funci√≥n de Normalizaci√≥n Personalizada';
            document.getElementById('functionName').value = '';
            document.getElementById('functionDescription').value = '';
            updateCodeExample();
            
            // Eliminar el ID de edici√≥n si existe
            delete document.getElementById('customFunctionModal').dataset.editingId;
            delete document.getElementById('customFunctionModal').dataset.originalType;
        }
        
        modal.show();
        
        // Establecer c√≥digo de ejemplo seg√∫n el tipo seleccionado
        updateCodeExample();
        
        // Poblar el selector de columnas
        populateColumnSelector();
    }
    
    function selectFunctionType(type, skipCodeUpdate = false) {
        selectedFunctionType = type;
        
        // Actualizar visual
        document.querySelectorAll('.function-type-option').forEach(opt => {
            opt.classList.remove('active');
        });
        const typeSelector = document.querySelector(`[data-type="${type}"]`);
        if (typeSelector) {
            typeSelector.classList.add('active');
        }
        
        // NO actualizar el c√≥digo si estamos en modo edici√≥n
        // Verificar tanto el par√°metro skipCodeUpdate como el dataset.editingId
        const isEditMode = skipCodeUpdate || document.getElementById('customFunctionModal').dataset.editingId;
        if (!isEditMode) {
            updateCodeExample();
        }
        
        // Repoblar el selector de columnas con el nuevo tipo
        populateColumnSelector();
        
        // Limpiar valores del datalist si existe
        const datasetValuesList = document.getElementById('datasetValuesList');
        if (datasetValuesList) {
            datasetValuesList.innerHTML = '';
        }
        
        const testValueInput = document.getElementById('testValue');
        if (testValueInput) {
            testValueInput.value = '';
        }
    }
    
    function updateCodeExample() {
        // No actualizar si estamos en modo edici√≥n
        if (document.getElementById('customFunctionModal').dataset.editingId) {
            console.log('Skipping code update - in edit mode');
            return;
        }
        
        const codeEditor = document.getElementById('functionCode');
        console.log('Updating code example for type:', selectedFunctionType);
        
        if (selectedFunctionType === 'numeric') {
            codeEditor.value = `def normalize(value, series=None):
    """
    Normaliza valores num√©ricos
    Args:
        value: El valor individual a normalizar
        series: La serie completa de la columna (opcional)
    Returns:
        El valor normalizado
    """
    # Ejemplo: normalizaci√≥n personalizada
    if series is not None:
        min_val = series.min()
        max_val = series.max()
        if max_val - min_val > 0:
            return (value - min_val) / (max_val - min_val)
    return value`;
        } else {
            codeEditor.value = `def normalize(value):
    """
    Normaliza valores de texto
    Args:
        value: El valor de texto a normalizar
    Returns:
        El texto normalizado
    """
    # Ejemplo: limpieza de texto
    if isinstance(value, str):
        # Eliminar espacios extras y convertir a min√∫sculas
        return value.strip().lower().replace('  ', ' ')
    return value`;
        }
    }
    
    function populateColumnSelector() {
        const columnSelector = document.getElementById('columnSelector');
        columnSelector.innerHTML = '<option value="">Seleccionar columna...</option>';
        
        if (datasetInfo && datasetInfo.normalization_info) {
            // Filtrar columnas seg√∫n el tipo de funci√≥n seleccionado
            for (const [column, info] of Object.entries(datasetInfo.normalization_info)) {
                if (selectedFunctionType === 'numeric' && info.type === 'numeric') {
                    columnSelector.innerHTML += `<option value="${column}">${column} (Num√©rico)</option>`;
                } else if (selectedFunctionType === 'text' && info.type === 'text') {
                    columnSelector.innerHTML += `<option value="${column}">${column} (Texto)</option>`;
                } else if (info.type === 'unknown') {
                    columnSelector.innerHTML += `<option value="${column}">${column} (Desconocido)</option>`;
                }
            }
        }
    }
    
    let currentColumnData = null;
    
    async function updateDatasetValues() {
        const columnName = document.getElementById('columnSelector').value;
        const columnTestButtons = document.getElementById('columnTestButtons');
        
        currentColumnData = null;
        
        if (!columnName) {
            columnTestButtons.style.display = 'none';
            return;
        }
        
        try {
            // Obtener valores √∫nicos de la columna
            const response = await fetch(`/api/datasets/${datasetId}/columns/${encodeURIComponent(columnName)}/`);
            if (response.ok) {
                const data = await response.json();
                currentColumnData = data;
                
                // Mostrar botones de prueba
                columnTestButtons.style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading column values:', error);
            showNotification('Error al cargar datos de la columna', 'error');
        }
    }
    
    async function testWithManualValue() {
        const testValue = document.getElementById('testValue').value;
        
        if (!testValue) {
            showNotification('Por favor ingresa un valor de prueba', 'warning');
            return;
        }
        
        await testCustomFunction(testValue);
    }
    
    async function testFirst20Values() {
        const columnName = document.getElementById('columnSelector').value;
        if (!columnName || !currentColumnData) {
            showNotification('Por favor selecciona una columna primero', 'warning');
            return;
        }
        
        const functionCode = document.getElementById('functionCode').value;
        if (!functionCode.trim()) {
            showNotification('Por favor escribe el c√≥digo de la funci√≥n primero', 'warning');
            return;
        }
        
        // Obtener los primeros 20 valores
        let valuesToTest = [];
        
        // Intentar obtener valores de diferentes formas seg√∫n la estructura de los datos
        // Priorizar frequency_data ya que contiene todos los valores √∫nicos
        if (currentColumnData.frequency_data && Array.isArray(currentColumnData.frequency_data)) {
            // frequency_data contiene objetos con {value: x, count: y}, tomar los primeros 20 valores
            valuesToTest = currentColumnData.frequency_data.slice(0, 20).map(item => item.value || item);
        } else if (currentColumnData.unique_values && Array.isArray(currentColumnData.unique_values)) {
            valuesToTest = currentColumnData.unique_values.slice(0, 20);
        } else if (currentColumnData.value_counts) {
            valuesToTest = Object.keys(currentColumnData.value_counts).slice(0, 20);
        } else if (currentColumnData.sample_values && Array.isArray(currentColumnData.sample_values)) {
            // sample_values como √∫ltimo recurso ya que puede tener pocos valores
            valuesToTest = currentColumnData.sample_values.slice(0, 20);
        }
        
        if (valuesToTest.length === 0) {
            showNotification('No se encontraron valores en la columna', 'warning');
            return;
        }
        
        // Ejecutar la funci√≥n en cada valor
        const results = await testMultipleValues(valuesToTest);
        displayMultipleResults(results, `Primeros ${valuesToTest.length} valores de "${columnName}"`);
    }
    
    async function testAllUniqueValues() {
        const columnName = document.getElementById('columnSelector').value;
        if (!columnName || !currentColumnData) {
            showNotification('Por favor selecciona una columna primero', 'warning');
            return;
        }
        
        // Obtener todos los valores √∫nicos
        let allValues = [];
        
        // Intentar obtener valores de diferentes formas seg√∫n la estructura de los datos
        // Priorizar frequency_data ya que contiene todos los valores √∫nicos
        if (currentColumnData.frequency_data && Array.isArray(currentColumnData.frequency_data)) {
            // frequency_data contiene todos los valores √∫nicos con su frecuencia
            allValues = currentColumnData.frequency_data.map(item => item.value !== undefined ? item.value : item);
        } else if (currentColumnData.unique_values && Array.isArray(currentColumnData.unique_values)) {
            allValues = currentColumnData.unique_values;
        } else if (currentColumnData.value_counts) {
            allValues = Object.keys(currentColumnData.value_counts);
        } else if (currentColumnData.sample_values && Array.isArray(currentColumnData.sample_values)) {
            // Si solo tenemos una muestra, obtener valores √∫nicos de ella
            allValues = [...new Set(currentColumnData.sample_values)];
        }
        
        if (allValues.length === 0) {
            showNotification('No se encontraron valores √∫nicos en la columna', 'warning');
            return;
        }
        
        // Mostrar loading
        const resultDiv = document.getElementById('testResult');
        resultDiv.className = 'test-result mt-3';
        resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Procesando...</span></div><p class="mt-2">Probando ' + allValues.length + ' valores √∫nicos...</p></div>';
        resultDiv.style.display = 'block';
        
        // Ejecutar la funci√≥n en cada valor
        const results = await testMultipleValues(allValues);
        displayMultipleResults(results, `Todos los valores √∫nicos de ${columnName} (${allValues.length} valores)`);
    }
    
    async function testMultipleValues(values) {
        const functionCode = document.getElementById('functionCode').value;
        const results = [];
        
        for (const value of values) {
            try {
                const response = await fetch('/api/custom-normalization-functions/test/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        code: functionCode,
                        test_value: value,
                        function_type: selectedFunctionType
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    results.push({
                        input: value,
                        output: result.result,
                        success: true
                    });
                } else {
                    results.push({
                        input: value,
                        output: result.error,
                        success: false
                    });
                }
            } catch (error) {
                results.push({
                    input: value,
                    output: error.message,
                    success: false
                });
            }
        }
        
        return results;
    }
    
    function displayMultipleResults(results, title) {
        const resultDiv = document.getElementById('testResult');
        
        const successCount = results.filter(r => r.success).length;
        const errorCount = results.length - successCount;
        
        let html = `<h6>${title}</h6>`;
        html += `<p class="mb-2">‚úÖ Exitosos: ${successCount} | ‚ùå Errores: ${errorCount}</p>`;
        
        html += '<table class="test-result-table">';
        html += '<thead><tr><th>Valor Original</th><th>Resultado</th><th>Estado</th></tr></thead>';
        html += '<tbody>';
        
        results.forEach(result => {
            const statusIcon = result.success ? '‚úÖ' : '‚ùå';
            const rowClass = result.success ? '' : 'style="color: #ff6b6b;"';
            html += `<tr ${rowClass}>`;
            html += `<td>${result.input}</td>`;
            html += `<td>${result.output}</td>`;
            html += `<td>${statusIcon}</td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        
        resultDiv.className = 'test-result success mt-3';
        resultDiv.innerHTML = html;
        resultDiv.style.display = 'block';
    }
    
    async function testCustomFunction(testValue) {
        const functionCode = document.getElementById('functionCode').value;
        const resultDiv = document.getElementById('testResult');
        
        if (!functionCode.trim()) {
            showNotification('Por favor escribe el c√≥digo de la funci√≥n primero', 'warning');
            return;
        }
        
        if (!testValue) {
            showNotification('Por favor proporciona un valor de prueba', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/custom-normalization-functions/test/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    code: functionCode,
                    test_value: testValue,
                    function_type: selectedFunctionType
                })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                resultDiv.className = 'test-result success mt-3';
                resultDiv.innerHTML = `
                    <h6>Resultado de la prueba</h6>
                    <table class="test-result-table">
                        <tr>
                            <th>Valor de entrada</th>
                            <td>${testValue}</td>
                        </tr>
                        <tr>
                            <th>Resultado</th>
                            <td>${result.result}</td>
                        </tr>
                    </table>
                `;
                resultDiv.style.display = 'block';
            } else {
                resultDiv.className = 'test-result error mt-3';
                resultDiv.innerHTML = `<strong>Error:</strong> ${result.error}`;
                resultDiv.style.display = 'block';
            }
        } catch (error) {
            resultDiv.className = 'test-result error mt-3';
            resultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
            resultDiv.style.display = 'block';
        }
    }
    
    async function saveCustomFunction() {
        const name = document.getElementById('functionName').value.trim();
        const description = document.getElementById('functionDescription').value.trim();
        const code = document.getElementById('functionCode').value; // No trim para preservar el formato exacto
        const editingId = document.getElementById('customFunctionModal').dataset.editingId;
        
        if (!name || !description || !code) {
            showNotification('Por favor completa todos los campos', 'warning');
            return;
        }
        
        try {
            const url = editingId 
                ? `/api/custom-normalization-functions/${editingId}/`
                : '/api/custom-normalization-functions/';
            
            const method = editingId ? 'PUT' : 'POST';
            
            const requestData = {
                name: name,
                description: description,
                code: code,
                function_type: selectedFunctionType
            };
            
            console.log('Saving function:', {
                url: url,
                method: method,
                data: requestData,
                codeLength: code.length,
                editingId: editingId,
                codePreview: code.substring(0, 200) + '...'
            });
            
            // Verificar una vez m√°s que el c√≥digo es el correcto antes de enviar
            console.log('Final code check before sending:');
            console.log('  Code starts with:', code.substring(0, 50));
            console.log('  Code ends with:', code.substring(code.length - 50));
            
            // Verificar que el c√≥digo del textarea es el correcto
            const textareaCode = document.getElementById('functionCode').value;
            console.log('Code from textarea:', textareaCode.substring(0, 200) + '...');
            console.log('Codes match:', code === textareaCode);
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(requestData)
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('Function saved/updated:', result);
                console.log('Returned code preview:', result.code ? result.code.substring(0, 200) + '...' : 'No code returned');
                console.log('Returned code length:', result.code ? result.code.length : 0);
                
                // Verificar que el c√≥digo devuelto coincide con el enviado
                if (result.code !== code) {
                    console.warn('WARNING: Returned code does not match sent code!');
                    console.log('Sent code length:', code.length);
                    console.log('Returned code length:', result.code ? result.code.length : 0);
                }
                
                showNotification(
                    editingId ? 'Funci√≥n actualizada exitosamente' : 'Funci√≥n guardada exitosamente', 
                    'success'
                );
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('customFunctionModal'));
                modal.hide();
                
                // Forzar recarga completa de datos sin cache
                await new Promise(resolve => setTimeout(resolve, 500)); // Peque√±a pausa para asegurar que el backend proces√≥ todo
                
                // Recargar funciones y actualizar UI
                await loadDatasetInfo();
                renderVariables();
                
                // Si hay un modal de gesti√≥n abierto, recargarlo tambi√©n
                if (document.getElementById('manageFunctionsModal').classList.contains('show')) {
                    await loadFunctionsForManagement();
                }
                
                // Limpiar formulario
                document.getElementById('functionName').value = '';
                document.getElementById('functionDescription').value = '';
                updateCodeExample();
                
                // Eliminar el ID de edici√≥n
                delete document.getElementById('customFunctionModal').dataset.editingId;
            } else {
                const error = await response.json();
                console.error('Error saving function:', error);
                let errorMessage = editingId ? 'Error al actualizar la funci√≥n' : 'Error al guardar la funci√≥n';
                if (error.name && error.name[0]) {
                    errorMessage = `Error en el nombre: ${error.name[0]}`;
                } else if (error.error) {
                    errorMessage = error.error;
                } else if (error.detail) {
                    errorMessage = error.detail;
                }
                showNotification(errorMessage, 'error');
            }
        } catch (error) {
            showNotification('Error de conexi√≥n', 'error');
        }
    }
    
    // Modificar la funci√≥n createVariableCard para incluir funciones personalizadas
    function createVariableCard(column, info) {
        console.log(`Creating card for ${column}:`, info);
        console.log(`Primary methods:`, info.primary_methods);
        console.log(`Secondary methods:`, info.secondary_methods);
        
        const card = document.createElement('div');
        card.className = 'variable-card';
        
        // Determinar el tipo de badge
        const typeClass = `type-${info.type}`;
        const typeLabel = info.type === 'numeric' ? 'Num√©rico' : 
                         info.type === 'text' ? 'Texto' : 'Desconocido';
        
        // Crear contenido de estad√≠sticas
        let statsHtml = '';
        if (info.type === 'numeric' && info.stats) {
            statsHtml = `
                <div class="variable-stats">
                    ${info.stats.mean !== null ? `Media: ${info.stats.mean.toFixed(2)}` : ''}
                    ${info.stats.std !== null ? ` | Desv: ${info.stats.std.toFixed(2)}` : ''}<br>
                    ${info.stats.min !== null ? `Min: ${info.stats.min.toFixed(2)}` : ''}
                    ${info.stats.max !== null ? ` | Max: ${info.stats.max.toFixed(2)}` : ''}
                </div>
            `;
        } else if (info.type === 'text' && info.stats) {
            statsHtml = `
                <div class="variable-stats">
                    ${info.stats.unique_count} valores √∫nicos<br>
                    ${info.stats.sample_values ? `Ej: ${info.stats.sample_values.slice(0, 2).join(', ')}...` : ''}
                </div>
            `;
        }
        
        card.innerHTML = `
            <div class="variable-header">
                <span class="variable-name">${column}</span>
                <span class="variable-type ${typeClass}">${typeLabel}</span>
            </div>
            ${statsHtml}
            <select class="normalization-select" id="norm-${column}" onchange="onNormalizationChange('${column}')">
                <option value="">Sin normalizar</option>
                <optgroup label="M√©todos principales">
                    ${info.primary_methods.map(method => 
                        `<option value="${method.value}" title="${method.description}">${method.label}</option>`
                    ).join('')}
                </optgroup>
                ${info.secondary_methods.length > 0 ? `
                    <optgroup label="Otros m√©todos">
                        ${info.secondary_methods.map(method => 
                            `<option value="${method.value}" title="${method.description}">${method.label}</option>`
                        ).join('')}
                    </optgroup>
                ` : ''}
            </select>
            <button class="preview-btn" onclick="previewNormalization('${column}')" 
                    id="preview-btn-${column}" style="display: none;">
                <i class="bi bi-eye"></i> Previsualizar
            </button>
        `;
        
        return card;
    }
    
    function showPreviewError(errorMessage) {
        const modal = document.getElementById('preview-modal');
        const body = document.getElementById('preview-body');
        const title = document.getElementById('preview-title');
        
        title.innerHTML = '<i class="bi bi-exclamation-triangle-fill text-danger"></i> Error en Funci√≥n Personalizada';
        
        // Parsear el mensaje de error para mostrarlo l√≠nea por l√≠nea
        const errorLines = errorMessage.split('\n');
        
        let bodyHtml = `
            <div class="error-console" style="background-color: #1a1a1a; color: #f0f0f0; padding: 20px; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; overflow-x: auto;">
                <div style="color: #ff6b6b; margin-bottom: 10px;">
                    <i class="bi bi-terminal"></i> ERROR DE EJECUCI√ìN
                </div>
                <div style="border-top: 1px solid #444; margin: 10px 0;"></div>
        `;
        
        errorLines.forEach(line => {
            if (line.trim()) {
                let lineColor = '#f0f0f0';
                
                // Colorear diferentes tipos de l√≠neas
                if (line.includes('Error Type:') || line.includes('Function:')) {
                    lineColor = '#ff9ff3';
                } else if (line.includes('Error Message:')) {
                    lineColor = '#ff6b6b';
                } else if (line.includes('Traceback:')) {
                    lineColor = '#ffd93d';
                } else if (line.includes('File') && line.includes('line')) {
                    lineColor = '#6bcf7f';
                }
                
                bodyHtml += `<div style="color: ${lineColor}; margin: 2px 0;">${line}</div>`;
            }
        });
        
        bodyHtml += `
                <div style="border-top: 1px solid #444; margin: 10px 0;"></div>
                <div style="color: #ffd93d; margin-top: 10px;">
                    <i class="bi bi-lightbulb"></i> Revisa tu funci√≥n y aseg√∫rate de que maneje correctamente el tipo de datos de la columna.
                </div>
            </div>
        `;
        
        body.innerHTML = bodyHtml;
        
        // Mostrar el modal
        const modalBS = new bootstrap.Modal(modal);
        modalBS.show();
        
        // Asegurar que se elimine la clase modal-open al cerrar
        modal.addEventListener('hidden.bs.modal', function () {
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            // Eliminar cualquier backdrop que haya quedado
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
        });
    }
    
    async function openManageFunctionsModal() {
        const modal = new bootstrap.Modal(document.getElementById('manageFunctionsModal'));
        modal.show();
        
        // Cargar funciones
        await loadFunctionsForManagement();
    }
    
    async function loadFunctionsForManagement() {
        const functionsList = document.getElementById('functionsList');
        functionsList.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>';
        
        try {
            // Agregar timestamp para evitar cache
            const timestamp = new Date().getTime();
            const response = await fetch(`/api/custom-normalization-functions/?t=${timestamp}`, {
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            });
            if (response.ok) {
                const functions = await response.json();
                
                if (functions.length === 0) {
                    functionsList.innerHTML = `
                        <div class="text-center text-muted" style="padding: 50px;">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <p class="mt-3">No hay funciones personalizadas creadas a√∫n.</p>
                        </div>
                    `;
                } else {
                    functionsList.innerHTML = functions.map(func => {
                        const safeName = func.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
                        return `
                            <div class="function-item">
                                <div class="function-header">
                                    <div>
                                        <span class="function-name">${func.name}</span>
                                        <span class="function-type">${func.function_type === 'numeric' ? 'Num√©rica' : 'Texto'}</span>
                                    </div>
                                    <div class="function-actions">
                                        <button onclick="editFunction(${func.id})" title="Editar">
                                            <i class="bi bi-pencil"></i> Editar
                                        </button>
                                        <button onclick="deleteFunction(${func.id}, '${safeName}')" class="delete-btn" title="Eliminar">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </button>
                                    </div>
                                </div>
                                <div class="function-description" style="color: rgba(240, 249, 255, 0.7); font-size: 0.9rem;">
                                    ${func.description || 'Sin descripci√≥n'}
                                </div>
                                <div class="function-code mt-2" style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.85rem; max-height: 200px; overflow-y: auto;">
                                    <pre style="margin: 0; color: #00d4ff;">${escapeHtml(func.code)}</pre>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
        } catch (error) {
            console.error('Error loading functions:', error);
            functionsList.innerHTML = '<div class="alert alert-danger">Error al cargar las funciones</div>';
        }
    }
    
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
    
    // Hacer las funciones globales para que puedan ser llamadas desde el HTML generado din√°micamente
    window.editFunction = async function(functionId) {
        console.log('editFunction called with ID:', functionId);
        try {
            // Obtener la funci√≥n espec√≠fica directamente para evitar datos cacheados
            const timestamp = new Date().getTime();
            const response = await fetch(`/api/custom-normalization-functions/${functionId}/?t=${timestamp}`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                cache: 'no-store'
            });
            console.log('Response status:', response.status);
            if (response.ok) {
                const functionData = await response.json();
                console.log('Function loaded directly:', functionData);
                console.log('Code preview:', functionData.code ? functionData.code.substring(0, 100) + '...' : 'No code');
                
                if (functionData) {
                    // Cerrar el modal de gesti√≥n
                    const manageModal = bootstrap.Modal.getInstance(document.getElementById('manageFunctionsModal'));
                    if (manageModal) {
                        manageModal.hide();
                    }
                    
                    // Abrir el modal de edici√≥n
                    setTimeout(() => {
                        console.log('Opening custom function modal...');
                        openCustomFunctionModal(functionData);
                    }, 300);
                } else {
                    console.error('Function not found with ID:', functionId);
                    showNotification('Funci√≥n no encontrada', 'error');
                }
            } else {
                console.error('Failed to load functions, status:', response.status);
                showNotification('Error al cargar las funciones', 'error');
            }
        } catch (error) {
            console.error('Error loading function:', error);
            showNotification('Error al cargar la funci√≥n', 'error');
        }
    }
    
    window.deleteFunction = async function(functionId, functionName) {
        if (!confirm(`¬øEst√°s seguro de eliminar la funci√≥n "${functionName}"?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/custom-normalization-functions/${functionId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            if (response.ok) {
                showNotification('Funci√≥n eliminada exitosamente', 'success');
                await loadFunctionsForManagement();
                await loadDatasetInfo(); // Recargar para actualizar las opciones
            } else {
                showNotification('Error al eliminar la funci√≥n', 'error');
            }
        } catch (error) {
            console.error('Error deleting function:', error);
            showNotification('Error de conexi√≥n', 'error');
        }
    }
    
</script>
{% endblock %}