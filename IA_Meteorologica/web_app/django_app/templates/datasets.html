{% extends 'base.html' %}
{% load static %}

{% block title %}Datasets - IA Météorologique{% endblock %}

{% block extra_css %}
<style>
    /* Fix para el modal backdrop */
    .modal-backdrop {
        display: none !important;
    }
    
    /* Agregar nuestro propio backdrop para el modal de búsqueda */
    #columnSearchModal.show {
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    /* Asegurar que el modal esté sobre otros elementos */
    #columnSearchModal .modal-dialog {
        z-index: 1060;
    }
    
    /* Asegurar que el modal de búsqueda avanzada esté al frente */
    #advancedSearchReplaceModal .modal-dialog {
        z-index: 1070;
    }
    
    /* Estilos mejorados para datasets */
    .dataset-card {
        background: rgba(10, 14, 39, 0.8);
        border: 2px solid rgba(0, 212, 255, 0.3);
        border-radius: 20px;
        padding: 15px 25px 20px 25px;
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 380px;
        width: 350px;
        min-width: 350px;
        max-width: 350px;
    }
    
    /* Forzar reset de hover cuando el mouse no está sobre la tarjeta */
    .dataset-card:not(:hover) {
        transform: translateY(0) !important;
        border-color: rgba(0, 212, 255, 0.3) !important;
        box-shadow: none !important;
    }
    
    .dataset-card:not(:hover)::before {
        opacity: 0 !important;
    }
    
    .dataset-clickable {
        cursor: pointer;
    }
    
    .dataset-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(0, 212, 255, 0.1) 0%, transparent 70%);
        transform: rotate(45deg);
        transition: all 0.5s ease;
        opacity: 0;
        pointer-events: none; /* Evitar que interfiera con los clicks */
    }
    
    .dataset-card:hover {
        transform: translateY(-10px);
        border-color: rgba(0, 212, 255, 0.8);
        box-shadow: 0 15px 40px rgba(0, 212, 255, 0.3);
    }
    
    .dataset-card:hover::before {
        opacity: 1;
    }
    
    .dataset-icon {
        font-size: 3rem;
        background: linear-gradient(135deg, #00d4ff, #0099ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
        text-align: center;
    }
    
    .dataset-card .card-title {
        color: white !important;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .dataset-card .card-body {
        display: flex;
        flex-direction: column;
        flex: 1;
        width: 100%;
    }
    
    .dataset-card p {
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .dataset-stats {
        display: flex;
        justify-content: space-around;
        margin-top: auto;
        margin-bottom: 10px;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.3rem;
        font-weight: bold;
        color: #00d4ff;
    }
    
    .upload-area {
        background: rgba(0, 212, 255, 0.05);
        border: 3px dashed rgba(0, 212, 255, 0.5);
        border-radius: 20px;
        padding: 60px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .upload-area:hover {
        border-color: #00d4ff;
        background: rgba(0, 212, 255, 0.1);
    }
    
    .upload-area.active {
        border-color: #00ff88;
        background: rgba(0, 255, 136, 0.1);
        box-shadow: inset 0 0 30px rgba(0, 255, 136, 0.2);
    }
    
    .quick-actions {
        position: absolute;
        top: 10px;
        right: 15px;
        display: flex;
        gap: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 100;
    }
    
    .dataset-card:hover .quick-actions {
        opacity: 1;
    }
    
    .quick-actions button {
        background: rgba(0, 212, 255, 0.2);
        border: 2px solid rgba(0, 212, 255, 0.4);
        color: #00d4ff;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        transition: all 0.2s ease;
        cursor: pointer;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        margin: 0;
    }
    
    .quick-actions button:hover {
        background: rgba(0, 212, 255, 0.8);
        transform: scale(1.1);
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.8);
        border-color: #00d4ff;
        color: white;
    }
    
    .quick-actions button:active {
        transform: scale(0.95);
        background: rgba(0, 212, 255, 1);
    }
    
    .quick-actions button:focus {
        outline: 2px solid #00d4ff;
        outline-offset: 2px;
    }
    
    
    
    /* Estilos para checkbox de outliers */
    .form-check-input:checked {
        background-color: #00d4ff;
        border-color: #00d4ff;
    }
    
    .form-check-input:focus {
        border-color: #00d4ff;
        box-shadow: 0 0 0 0.25rem rgba(0, 212, 255, 0.25);
    }
    
    /* Colores específicos para cada acción */
    .quick-actions button[data-action="normalize"]:hover {
        background: rgba(0, 212, 255, 0.8);
        border-color: #00d4ff;
    }
    
    .quick-actions button[data-action="analyze"]:hover {
        background: rgba(255, 193, 7, 0.8);
        border-color: #ffc107;
        box-shadow: 0 0 20px rgba(255, 193, 7, 0.8);
    }
    
    .quick-actions button[data-action="download"]:hover {
        background: rgba(16, 185, 129, 0.8);
        border-color: #10b981;
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);
    }
    
    .quick-actions button[data-action="duplicate"]:hover {
        background: rgba(147, 51, 234, 0.8);
        border-color: #9333ea;
        box-shadow: 0 0 20px rgba(147, 51, 234, 0.8);
    }
    
    .quick-actions button[data-action="delete"]:hover {
        background: rgba(239, 68, 68, 0.8);
        border-color: #ef4444;
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
    }
    
    /* Estilos para el modal de detalles */
    .column-stats {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.8s ease;
        cursor: pointer;
    }
    
    .column-stats:hover {
        background: rgba(0, 212, 255, 0.1);
        border-color: rgba(0, 212, 255, 0.5);
    }
    
    .column-stats.selected {
        background: rgba(0, 212, 255, 0.15);
        border-color: rgba(0, 212, 255, 0.8);
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
    }
    
    .column-type {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .column-type.type-numeric {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }
    
    .column-type.type-text {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }
    
    .column-type.type-datetime {
        background: rgba(168, 85, 247, 0.2);
        color: #a855f7;
    }
    
    .data-preview {
        background: rgba(10, 14, 39, 0.5);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 20px;
        overflow-x: auto;
    }
    
    .data-preview table {
        color: #f0f9ff;
    }
    
    .data-preview th {
        background: rgba(0, 212, 255, 0.1);
        color: #00d4ff;
        font-weight: 600;
        border-color: rgba(0, 212, 255, 0.2);
    }
    
    .data-preview td {
        border-color: rgba(0, 212, 255, 0.1);
    }
    
    .chart-container {
        background: rgba(10, 14, 39, 0.5);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 20px;
    }
    
    /* Estilos para los análisis */
    .stat-card {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 15px;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        background: rgba(0, 212, 255, 0.1);
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
    }
    
    .accordion-button {
        background: rgba(0, 212, 255, 0.05);
        color: #f0f9ff;
    }
    
    .accordion-button:not(.collapsed) {
        background: rgba(0, 212, 255, 0.1);
        color: #00d4ff;
    }
    
    .accordion-body {
        background: rgba(10, 14, 39, 0.5);
        border-top: 1px solid rgba(0, 212, 255, 0.2);
    }
    
    .column-row {
        cursor: pointer;
        transition: background-color 0.8s ease;
    }
    
    .column-row:hover {
        background-color: rgba(0, 212, 255, 0.05);
    }
    
    .column-row.selected {
        background-color: rgba(0, 212, 255, 0.15);
    }
    
    /* Estilos para la tabla de frecuencias */
    .table-responsive {
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 8px;
    }
    
    .progress {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    /* Estilos para datasets agrupados */
    .dataset-group {
        background: rgba(10, 14, 39, 0.4);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 25px;
        transition: all 0.3s ease;
    }
    
    .dataset-group:hover {
        border-color: rgba(0, 212, 255, 0.5);
        background: rgba(10, 14, 39, 0.6);
    }
    
    .dataset-group-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(0, 212, 255, 0.3);
    }
    
    .dataset-group-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #00d4ff;
        margin: 0;
    }
    
    .dataset-cards-container {
        display: flex;
        gap: 20px;
        overflow-x: auto;
        padding: 10px 0;
        align-items: flex-start;
        height: 400px;
    }
    
    .dataset-cards-container::-webkit-scrollbar {
        height: 8px;
    }
    
    .dataset-cards-container::-webkit-scrollbar-track {
        background: rgba(0, 212, 255, 0.1);
        border-radius: 4px;
    }
    
    .dataset-cards-container::-webkit-scrollbar-thumb {
        background: rgba(0, 212, 255, 0.5);
        border-radius: 4px;
    }
    
    .dataset-cards-container::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 212, 255, 0.7);
    }
    
    .dataset-card.original {
        border-color: rgba(0, 212, 255, 0.6);
        background: rgba(0, 212, 255, 0.1);
        flex-shrink: 0;
    }
    
    .dataset-card.normalized {
        border-color: rgba(255, 0, 255, 0.4);
        background: rgba(255, 0, 255, 0.05);
        flex-shrink: 0;
    }
    
    .normalization-arrow {
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(0, 212, 255, 0.6);
        font-size: 2rem;
        padding: 0 10px;
        flex-shrink: 0;
    }
    
    /* Estilos para el árbol genealógico */
    .genealogy-tree {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 15px;
        font-family: monospace;
    }
    
    .genealogy-item {
        padding: 5px 0;
        transition: all 0.3s ease;
    }
    
    .genealogy-item:hover {
        background: rgba(0, 212, 255, 0.1);
        padding-left: 10px;
        border-radius: 5px;
    }
    
    /* Pattern selector styles */
    .pattern-char {
        display: inline-block;
        padding: 5px 8px;
        margin: 2px;
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.2s;
        user-select: none;
        color: #212529;
    }

    .pattern-char:hover {
        background-color: #e9ecef;
        transform: scale(1.1);
        border-color: #0d6efd;
    }

    .pattern-char.selected {
        background-color: #28a745;
        color: white;
        border-color: #28a745;
    }

    .pattern-char.selected:hover {
        background-color: #218838;
        border-color: #1e7e34;
    }
    
    /* Estilos para SweetAlert2 inputs en tema oscuro */
    .swal2-popup input.form-control:not(:disabled) {
        background-color: #1a1e3a !important;
        color: #f0f9ff !important;
        border-color: #2d3561 !important;
        cursor: text !important;
    }
    
    .swal2-popup input.form-control:not(:disabled):focus {
        background-color: #1a1e3a !important;
        color: #f0f9ff !important;
        border-color: #00d4ff !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 212, 255, 0.25) !important;
        outline: none !important;
    }
    
    .swal2-popup input.form-control:disabled {
        background-color: #0d1225 !important;
        color: #8b92a9 !important;
        border-color: #1a1e3a !important;
        opacity: 0.7;
        cursor: not-allowed !important;
    }
    
    .swal2-popup input.form-control::placeholder {
        color: #6b7280 !important;
        opacity: 0.8;
    }
    
    .swal2-popup .form-label {
        color: #00d4ff !important;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    
    /* Estilos adicionales para mensajes de validación */
    .swal2-validation-message {
        background-color: #1a1e3a !important;
        color: #ef4444 !important;
        border: 1px solid #ef4444 !important;
    }
    
    /* Estilos para el input nativo de SweetAlert2 */
    .swal2-input {
        background-color: #1a1e3a !important;
        color: #f0f9ff !important;
        border: 1px solid #2d3561 !important;
        padding: 8px 12px !important;
        font-size: 1rem !important;
        width: 80% !important;
    }
    
    .swal2-input:focus {
        background-color: #1a1e3a !important;
        color: #f0f9ff !important;
        border-color: #00d4ff !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 212, 255, 0.25) !important;
        outline: none !important;
    }
    
    .swal2-input::placeholder {
        color: #6b7280 !important;
        opacity: 0.8;
    }
    
    /* Label del input */
    .swal2-input-label {
        color: #00d4ff !important;
        font-weight: 500 !important;
        margin-bottom: 0.5rem !important;
        display: block !important;
    }
    
    /* Estilos para select en SweetAlert2 */
    .swal2-popup select.form-select {
        background-color: #1a1e3a !important;
        color: #f0f9ff !important;
        border: 1px solid #2d3561 !important;
        padding: 8px 12px !important;
        font-size: 1rem !important;
        cursor: pointer !important;
    }
    
    .swal2-popup select.form-select:focus {
        background-color: #1a1e3a !important;
        color: #f0f9ff !important;
        border-color: #00d4ff !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 212, 255, 0.25) !important;
        outline: none !important;
    }
    
    .swal2-popup select.form-select option {
        background-color: #1a1e3a !important;
        color: #f0f9ff !important;
        padding: 5px !important;
    }
    
    /* Asegurar que los inputs personalizados en SweetAlert2 sean editables */
    .swal2-popup input[type="text"]:not(:disabled),
    .swal2-popup input[type="number"]:not(:disabled) {
        background-color: #1a1e3a !important;
        color: #f0f9ff !important;
        border: 1px solid #2d3561 !important;
        cursor: text !important;
        pointer-events: auto !important;
        -webkit-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
    }
    
    .swal2-popup input[type="text"]:not(:disabled):focus,
    .swal2-popup input[type="number"]:not(:disabled):focus {
        background-color: #1a1e3a !important;
        color: #f0f9ff !important;
        border-color: #00d4ff !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 212, 255, 0.25) !important;
        outline: none !important;
    }
    
    /* Estilos específicos para el input customValue */
    .swal2-popup #customValue,
    .swal-dark-theme #customValue,
    #customValue {
        background-color: #1a1e3a !important;
        color: #f0f9ff !important;
        border: 1px solid #2d3561 !important;
        cursor: text !important;
        pointer-events: auto !important;
        -webkit-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
        opacity: 1 !important;
        display: block !important;
        width: 100% !important;
        padding: 0.375rem 0.75rem !important;
        font-size: 1rem !important;
        line-height: 1.5 !important;
        border-radius: 0.25rem !important;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out !important;
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        appearance: none !important;
        min-height: 38px !important;
        box-sizing: border-box !important;
        position: relative !important;
        z-index: 9999 !important;
    }
    
    /* Fix para el contenedor del modal */
    .swal2-container {
        z-index: 10000 !important;
    }
    
    .swal2-popup {
        z-index: 10001 !important;
    }
    
    /* Asegurar que no haya overlays bloqueando */
    .swal2-html-container * {
        pointer-events: auto !important;
    }
    
    .swal2-popup #customValue:focus,
    .swal-dark-theme #customValue:focus {
        background-color: #1a1e3a !important;
        color: #f0f9ff !important;
        border-color: #00d4ff !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 212, 255, 0.25) !important;
        outline: none !important;
    }
    
    .swal2-popup #customValue::placeholder,
    .swal-dark-theme #customValue::placeholder {
        color: #6b7280 !important;
        opacity: 0.8 !important;
    }
    
    /* Estilos para el tema oscuro de SweetAlert2 */
    .swal-dark-theme {
        background-color: #0a0e27 !important;
        color: #f0f9ff !important;
    }
    
    .swal-dark-content {
        color: #f0f9ff !important;
    }
    
    .swal-dark-theme .alert {
        background-color: #1a1e3a !important;
        border-color: #2d3561 !important;
        color: #f0f9ff !important;
    }
    
    .swal-dark-theme .alert-info {
        background-color: #1a1e3a !important;
        border-color: #00d4ff !important;
        color: #00d4ff !important;
    }
    
    /* Estilos para el modal de edición de dataset */
    #datasetEditorModal .modal-content {
        background-color: #0a0e27;
        color: #f0f9ff;
    }
    
    #datasetEditorModal .list-group-item {
        background-color: #1a1e3a;
        border: 1px solid #2d3561;
        color: #f0f9ff;
        transition: all 0.3s ease;
    }
    
    #datasetEditorModal .list-group-item:hover {
        background-color: #2d3561;
        border-color: #00d4ff;
        transform: translateX(5px);
    }
    
    #datasetEditorModal .list-group-item.active {
        background-color: #00d4ff;
        border-color: #00d4ff;
        color: #0a0e27;
    }
    
    #datasetEditorModal .form-control {
        background-color: #1a1e3a !important;
        border-color: #2d3561 !important;
        color: #f0f9ff !important;
    }
    
    #datasetEditorModal .form-control:focus {
        background-color: #1a1e3a !important;
        border-color: #00d4ff !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 212, 255, 0.25) !important;
        color: #f0f9ff !important;
    }
    
    #datasetEditorModal .table {
        color: #f0f9ff;
    }
    
    #datasetEditorModal .table-dark {
        background-color: #0d1225;
    }
    
    #datasetEditorModal .table-hover tbody tr:hover {
        background-color: rgba(0, 212, 255, 0.1);
        color: #f0f9ff;
    }
    
    #datasetEditorModal .progress {
        background-color: #1a1e3a;
        border: 1px solid #2d3561;
    }
    
    #datasetEditorModal .progress-bar {
        font-weight: bold;
        font-size: 0.875rem;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }
    
    #datasetEditorModal .badge {
        font-size: 0.875rem;
    }
    
    /* Asegurar que el texto sea visible */
    #datasetEditorModal p,
    #datasetEditorModal span,
    #datasetEditorModal div,
    #datasetEditorModal td,
    #datasetEditorModal th {
        color: #f0f9ff !important;
    }
    
    #datasetEditorModal .text-muted {
        color: #8b92a9 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-5">
        <div class="col-12">
            <h1 class="text-white fw-bold">
                <i class="bi bi-database"></i> Gestion des Datasets
            </h1>
            <p class="text-white-50">Importez et gérez vos données météorologiques</p>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-database-fill text-primary" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="totalDatasets">0</h3>
                    <p class="text-muted mb-0">Datasets Totaux</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-hdd-fill text-success" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="totalSize">0 MB</h3>
                    <p class="text-muted mb-0">Espace Utilisé</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-bar-chart-fill text-info" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="totalRows">0</h3>
                    <p class="text-muted mb-0">Lignes Totales</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-calendar3 text-warning" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="lastUpdate">-</h3>
                    <p class="text-muted mb-0">Dernière Mise à Jour</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Upload Area -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <i class="bi bi-cloud-arrow-up" style="font-size: 4rem; color: #00d4ff;"></i>
                <h4 class="mt-3 text-white">Glissez vos fichiers CSV ici</h4>
                <p class="text-muted">ou cliquez pour parcourir</p>
                <input type="file" id="fileInput" multiple accept=".csv" style="display: none;" onchange="handleFileSelect(this)">
            </div>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-primary">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label for="searchFilter" class="form-label text-info">Rechercher par nom</label>
                            <input type="text" class="form-control" id="searchFilter" 
                                   placeholder="Nom du dataset..." onkeyup="filterDatasets()">
                        </div>
                        <div class="col-md-4">
                            <label for="parentFilter" class="form-label text-info">Filtrer par dataset original</label>
                            <select class="form-select" id="parentFilter" onchange="filterDatasets()">
                                <option value="">Tous les datasets</option>
                                <option value="original">Seulement originaux</option>
                                <option value="normalized">Seulement normalisés</option>
                                <!-- Les options de datasets spécifiques seront ajoutées dynamiquement -->
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-info">Tri</label>
                            <select class="form-select" id="sortFilter" onchange="filterDatasets()">
                                <option value="name">Par nom</option>
                                <option value="date">Par date</option>
                                <option value="size">Par taille</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Datasets Grid -->
    <div id="datasetsContainer">
        <!-- Les datasets groupés seront chargés ici -->
    </div>
</div>

<!-- Modal Detail Dataset -->
<div class="modal fade" id="datasetDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="datasetDetailTitle">
                    <i class="bi bi-database"></i> Détails du Dataset
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="datasetDetailContent">
                <!-- Le contenu sera chargé dynamiquement -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Fermer
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteDataset()">
                    <i class="bi bi-trash"></i> Supprimer
                </button>
                <button type="button" class="btn btn-warning" onclick="openDatasetEditorFromModal()">
                    <i class="bi bi-pencil-square"></i> Editar Dataset
                </button>
                <button type="button" class="btn btn-success" onclick="downloadDataset()">
                    <i class="bi bi-file-earmark-csv"></i> Télécharger Dataset
                </button>
                <button type="button" class="btn btn-primary" onclick="downloadReport()">
                    <i class="bi bi-file-earmark-pdf"></i> Télécharger Rapport
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Información del Dataset -->
<div class="modal fade" id="datasetInfoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i> Información del Dataset
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="datasetInfoForm">
                    <div class="mb-3">
                        <label for="datasetName" class="form-label">Nombre del Dataset</label>
                        <input type="text" class="form-control" id="datasetName" required>
                        <small class="text-muted">Si no especifica un nombre, se usará el nombre del archivo</small>
                    </div>
                    <div class="mb-3">
                        <label for="datasetShortDescription" class="form-label">Descripción corta <small class="text-muted" id="charCount">(0/80)</small></label>
                        <input type="text" class="form-control" id="datasetShortDescription" 
                               placeholder="Descripción breve para las tarjetas..."
                               maxlength="80" oninput="updateCharCount()">
                    </div>
                    <div class="mb-3">
                        <label for="datasetLongDescription" class="form-label">Descripción detallada <small class="text-muted">(opcional)</small></label>
                        <textarea class="form-control" id="datasetLongDescription" rows="3" 
                                  placeholder="Descripción completa del dataset, fuente de datos, metodología..."></textarea>
                    </div>
                    <input type="hidden" id="pendingFile">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="proceedWithUpload()">
                    <i class="bi bi-cloud-arrow-up"></i> Subir Dataset
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Upload Progress -->
<div class="modal fade" id="uploadProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-cloud-upload"></i> Chargement en cours
                </h5>
                <button type="button" class="btn-close" onclick="forceCloseUploadModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong id="uploadFileName">Fichier.csv</strong>
                </div>
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="uploadProgressBar">0%</div>
                </div>
                <div class="text-muted small" id="uploadStatus">Préparation du fichier...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="forceCloseUploadModal()">
                    <i class="bi bi-x-circle"></i> Annuler
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edición de Dataset -->
<div class="modal fade" id="datasetEditorModal" tabindex="-1" aria-labelledby="datasetEditorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-info" id="datasetEditorModalLabel">
                    <i class="bi bi-pencil-square"></i> Editor de Dataset
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="background-color: #1a1e3a;">
                <div class="row">
                    <!-- Panel de selección de columna -->
                    <div class="col-md-4">
                        <h6 class="text-info mb-3">
                            <i class="bi bi-list-columns"></i> Seleccionar Columna
                        </h6>
                        <div class="list-group" id="columnListEditor" style="max-height: 500px; overflow-y: auto;">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>
                    
                    <!-- Panel de información y acciones -->
                    <div class="col-md-8">
                        <div id="columnEditPanel" style="display: none;">
                            <h6 class="text-warning mb-3">
                                <i class="bi bi-info-circle"></i> Información de la Columna: 
                                <span id="selectedColumnName" class="text-white"></span>
                            </h6>
                            
                            <!-- Estadísticas básicas -->
                            <div class="card mb-3" style="background-color: #0d1225; border: 1px solid #2d3561;">
                                <div class="card-body">
                                    <h6 class="card-title text-info">
                                        <i class="bi bi-graph-up"></i> Estadísticas
                                    </h6>
                                    <div id="columnStatistics" class="text-light">
                                        <!-- Se llenará dinámicamente -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Valores únicos y frecuencias -->
                            <div class="card mb-3" style="background-color: #0d1225; border: 1px solid #2d3561;">
                                <div class="card-body">
                                    <h6 class="card-title text-info">
                                        <i class="bi bi-list-ul"></i> Valores Únicos y Frecuencias
                                    </h6>
                                    <div class="mb-3">
                                        <label class="form-label text-warning">Filtrar por porcentaje mínimo:</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control bg-dark text-light border-secondary" 
                                                   id="percentageThreshold" 
                                                   min="0" max="100" step="0.1" value="0.1">
                                            <span class="input-group-text bg-secondary text-light">%</span>
                                            <button class="btn btn-primary" onclick="applyPercentageFilter()">
                                                <i class="bi bi-funnel"></i> Aplicar Filtro
                                            </button>
                                        </div>
                                        <small class="text-muted">Eliminará todas las filas con valores que aparezcan menos del porcentaje especificado</small>
                                    </div>
                                    <div id="uniqueValuesTable" style="max-height: 300px; overflow-y: auto;" class="bg-dark">
                                        <!-- Se llenará dinámicamente -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Acciones adicionales -->
                            <div class="card" style="background-color: #0d1225; border: 1px solid #2d3561;">
                                <div class="card-body">
                                    <h6 class="card-title text-info">
                                        <i class="bi bi-tools"></i> Acciones
                                    </h6>
                                    <div class="d-flex gap-2 flex-wrap mb-3">
                                        <button class="btn btn-sm btn-info" onclick="renameColumnFromEditor()">
                                            <i class="bi bi-pencil"></i> Renombrar Columna
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteColumnFromEditor()">
                                            <i class="bi bi-trash"></i> Eliminar Columna
                                        </button>
                                        <button class="btn btn-sm btn-warning" onclick="removeNullValues()">
                                            <i class="bi bi-x-circle"></i> Eliminar Filas con Nulos (Esta columna)
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="removeAllNullRows()">
                                            <i class="bi bi-x-square"></i> Eliminar Filas con Cualquier Nulo
                                        </button>
                                        <button class="btn btn-sm btn-success" onclick="fillNullValues()">
                                            <i class="bi bi-plus-circle"></i> Rellenar Valores Nulos
                                        </button>
                                    </div>
                                    
                                    <h6 class="card-title text-warning mt-3">
                                        <i class="bi bi-magic"></i> Edición Avanzada
                                    </h6>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <button class="btn btn-sm btn-primary" onclick="openAdvancedEditor()">
                                            <i class="bi bi-search"></i> Buscar y Reemplazar
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="openTextManipulation()">
                                            <i class="bi bi-scissors"></i> Manipular Texto
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="openNumericTransform()">
                                            <i class="bi bi-calculator"></i> Transformaciones Numéricas
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="noColumnSelected" class="text-center text-muted">
                            <i class="bi bi-arrow-left" style="font-size: 3rem; color: #6b7280;"></i>
                            <p class="text-light">Selecciona una columna para ver su información y opciones de edición</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary" style="background-color: #0d1225;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Column Search -->
<div class="modal fade" id="columnSearchModal" tabindex="-1" aria-labelledby="columnSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="columnSearchModalLabel">
                    <i class="bi bi-search"></i> Buscar en columna: <span id="searchColumnName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Tipo de búsqueda</label>
                        <select class="form-select" id="searchType" onchange="updateSearchInterface()">
                            <option value="contains">Contiene</option>
                            <option value="startsWith">Empieza por</option>
                            <option value="endsWith">Termina por</option>
                            <option value="equals">Es igual a</option>
                            <option value="regex">Expresión Regular</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Valor a buscar</label>
                        <input type="text" class="form-control" id="searchValue" placeholder="Introduzca el valor a buscar">
                        <small class="text-muted" id="searchHint">Buscar valores que contengan este texto</small>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="mb-3">
                            <div class="d-flex align-items-center">
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="togglePatternMode()">
                                    <i class="bi bi-grid-3x3-gap"></i> <span id="patternToggleText">Activar patrón personalizado</span>
                                </button>
                                <small class="text-muted ms-2">
                                    <i class="bi bi-info-circle"></i> Agrupa resultados por caracteres seleccionados para encontrar valores únicos
                                </small>
                            </div>
                        </div>
                        
                        <div class="d-flex align-items-center">
                            <small class="text-muted me-2">
                                <i class="bi bi-search"></i> Alcance de búsqueda:
                            </small>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-primary" onclick="setSearchScope('first')" id="searchFirstBtn">
                                    <i class="bi bi-funnel"></i> Primeros <span id="limitValue">100</span>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setSearchScope('range')" id="searchRangeBtn">
                                    <i class="bi bi-arrows-expand"></i> Rango
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="showLimitModal()" title="Configurar">
                                    <i class="bi bi-gear"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setSearchScope('all')" id="searchAllBtn">
                                    <i class="bi bi-database"></i> Todo
                                </button>
                            </div>
                        </div>
                        
                        <!-- Selector de rango -->
                        <div id="rangeSelector" class="mt-2" style="display: none;">
                            <div class="d-flex align-items-center">
                                <small class="text-muted me-2">Desde índice:</small>
                                <input type="number" id="rangeStart" class="form-control form-control-sm" value="1" min="1" style="width: 80px;" onchange="updateRangeInfo()" oninput="updateRangeInfo()">
                                <small class="text-muted mx-2">hasta:</small>
                                <input type="number" id="rangeEnd" class="form-control form-control-sm" value="100" min="1" style="width: 80px;" onchange="updateRangeInfo()" oninput="updateRangeInfo()">
                                <small class="text-muted ms-2" id="rangeInfo"></small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Selector de patrón integrado -->
                <div id="patternSelectorRow" class="row mb-3" style="display: none;">
                    <div class="col-md-12">
                        <div class="border rounded p-3" style="background-color: rgba(0, 123, 255, 0.05);">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Ejemplo #</label>
                                    <div class="input-group">
                                        <input type="number" id="patternExampleIndex" class="form-control" value="1" min="1" 
                                               onchange="updatePatternExample()" 
                                               oninput="updatePatternExample()"
                                               onkeyup="updatePatternExample()">
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">Clickea los caracteres para seleccionar el patrón:</label>
                                    <div id="patternCharacters" class="p-2 border rounded" style="font-family: monospace; font-size: 1.1em; letter-spacing: 0.1em;">
                                        <!-- Los caracteres clickeables aparecerán aquí -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-12">
                        <button class="btn btn-primary" onclick="performColumnSearch()">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                        <button class="btn btn-secondary ms-2" onclick="clearColumnSearch()">
                            <i class="bi bi-x-circle"></i> Limpiar
                        </button>
                    </div>
                </div>
                
                <!-- Resultados de búsqueda -->
                <div id="searchResults" style="display: none;">
                    <hr>
                    <h6>Resultados de búsqueda</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <strong>Coincidencias encontradas:</strong> <span id="matchCount">0</span> de <span id="totalCount">0</span> valores
                                (<span id="matchPercentage">0</span>%)
                            </div>
                            <div id="matchedValuesList" style="max-height: 400px; overflow-y: auto;" class="border rounded p-2">
                                <!-- Lista de valores coincidentes -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <canvas id="searchResultChart" style="max-height: 300px;"></canvas>
                            <small class="text-muted text-center d-block mt-1">
                                <i class="bi bi-hand-index"></i> Click en el gráfico para ver los valores
                            </small>
                            <div class="mt-3">
                                <h6 class="text-center text-muted mb-2">
                                    <i class="bi bi-bar-chart"></i> Valores Únicos en la Búsqueda
                                </h6>
                                <canvas id="uniqueValuesChart" style="max-height: 400px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para configurar límite de búsqueda -->
<div class="modal fade" id="searchLimitModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Configurar límite de búsqueda</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Configurar búsqueda:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="searchConfig" id="configFirst" checked onchange="updateConfigModal()">
                        <label class="form-check-label" for="configFirst">
                            Primeros N valores
                        </label>
                    </div>
                    <div class="ms-3 mt-2" id="configFirstOptions">
                        <input type="number" id="customSearchLimit" class="form-control form-control-sm" value="100" min="1" style="width: 120px;">
                    </div>
                    
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="radio" name="searchConfig" id="configRange" onchange="updateConfigModal()">
                        <label class="form-check-label" for="configRange">
                            Rango de índices
                        </label>
                    </div>
                    <div class="ms-3 mt-2" id="configRangeOptions" style="display: none;">
                        <div class="d-flex align-items-center">
                            <input type="number" id="customRangeStart" class="form-control form-control-sm" value="1" min="1" style="width: 100px;">
                            <span class="mx-2">hasta</span>
                            <input type="number" id="customRangeEnd" class="form-control form-control-sm" value="100" min="1" style="width: 100px;">
                        </div>
                    </div>
                </div>
                <div class="text-muted small">
                    <i class="bi bi-info-circle"></i> Limitar la búsqueda mejora el rendimiento en datasets grandes
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-sm btn-primary" onclick="applyCustomLimit()">Aplicar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Búsqueda y Reemplazo Avanzado -->
<div class="modal fade" id="advancedSearchReplaceModal" tabindex="-1" aria-labelledby="advancedSearchReplaceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-info" id="advancedSearchReplaceModalLabel">
                    <i class="bi bi-search"></i> Búsqueda y Reemplazo Avanzado - <span id="advancedColumnName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="background-color: #1a1e3a;">
                <div class="row">
                    <!-- Panel de búsqueda -->
                    <div class="col-md-6">
                        <h6 class="text-warning mb-3">
                            <i class="bi bi-search"></i> Búsqueda
                        </h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Tipo de búsqueda</label>
                            <select class="form-select bg-dark text-light border-secondary" id="advSearchType" onchange="updateAdvancedSearchInterface()">
                                <option value="contains">Contiene</option>
                                <option value="startsWith">Empieza por</option>
                                <option value="endsWith">Termina por</option>
                                <option value="equals">Es igual a</option>
                                <option value="regex">Expresión Regular</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Valor a buscar</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="advSearchValue" placeholder="Introduzca el valor a buscar">
                            <small class="text-muted" id="advSearchHint">Buscar valores que contengan este texto</small>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex align-items-center">
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="toggleAdvPatternMode()">
                                    <i class="bi bi-grid-3x3-gap"></i> <span id="advPatternToggleText">Activar patrón personalizado</span>
                                </button>
                                <small class="text-muted ms-2">
                                    <i class="bi bi-info-circle"></i> Agrupa resultados por caracteres seleccionados
                                </small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted me-2">
                                <i class="bi bi-search"></i> Alcance de búsqueda:
                            </small>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-primary" onclick="setAdvSearchScope('first')" id="advSearchFirstBtn">
                                    <i class="bi bi-funnel"></i> Primeros <span id="advLimitValue">100</span>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setAdvSearchScope('range')" id="advSearchRangeBtn">
                                    <i class="bi bi-arrows-expand"></i> Rango
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setAdvSearchScope('all')" id="advSearchAllBtn">
                                    <i class="bi bi-database"></i> Todo
                                </button>
                            </div>
                        </div>
                        
                        <!-- Selector de rango -->
                        <div id="advRangeSelector" class="mb-3" style="display: none;">
                            <div class="d-flex align-items-center">
                                <small class="text-muted me-2">Desde índice:</small>
                                <input type="number" id="advRangeStart" class="form-control form-control-sm bg-dark text-light border-secondary" value="1" min="1" style="width: 80px;">
                                <small class="text-muted mx-2">hasta:</small>
                                <input type="number" id="advRangeEnd" class="form-control form-control-sm bg-dark text-light border-secondary" value="100" min="1" style="width: 80px;">
                            </div>
                        </div>
                        
                        <!-- Selector de patrón -->
                        <div id="advPatternSelectorRow" class="mb-3" style="display: none;">
                            <div class="border rounded p-3" style="background-color: rgba(0, 123, 255, 0.1);">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Ejemplo #</label>
                                        <input type="number" id="advPatternExampleIndex" class="form-control bg-dark text-light border-secondary" value="1" min="1" onchange="updateAdvPatternExample()">
                                    </div>
                                    <div class="col-md-8">
                                        <label class="form-label">Clickea los caracteres para seleccionar el patrón:</label>
                                        <div id="advPatternCharacters" class="p-2 border rounded bg-dark" style="font-family: monospace; font-size: 1.1em; letter-spacing: 0.1em;">
                                            <!-- Los caracteres clickeables aparecerán aquí -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary w-100" onclick="performAdvancedSearch()">
                            <i class="bi bi-search"></i> Buscar (Opcional)
                        </button>
                    </div>
                    
                    <!-- Panel de reemplazo -->
                    <div class="col-md-6">
                        <h6 class="text-warning mb-3">
                            <i class="bi bi-arrow-repeat"></i> Reemplazo
                        </h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Valor de reemplazo</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="advReplaceValue" placeholder="Nuevo valor" onchange="validatePartialReplacement()" oninput="validatePartialReplacement()">
                            <small class="text-muted">Deja vacío para eliminar el texto encontrado</small>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="togglePartialReplace()">
                                    <i class="bi bi-crop"></i> <span id="partialReplaceToggleText">Activar reemplazo parcial</span>
                                </button>
                                <small class="text-muted ms-2">
                                    <i class="bi bi-info-circle"></i> Reemplaza solo parte del texto encontrado
                                </small>
                            </div>
                            <div class="d-flex align-items-center">
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="toggleCharReplace()">
                                    <i class="bi bi-alphabet"></i> <span id="charReplaceToggleText">Activar reemplazo de subcadena</span>
                                </button>
                                <small class="text-muted ms-2">
                                    <i class="bi bi-info-circle"></i> Reemplaza una subcadena específica por otra
                                </small>
                            </div>
                        </div>
                        
                        <!-- Selector de reemplazo parcial -->
                        <div id="partialReplaceSelector" class="mb-3" style="display: none;">
                            <div class="border rounded p-3" style="background-color: rgba(255, 193, 7, 0.1);">
                                <div class="mb-3">
                                    <label class="form-label">Modo de reemplazo parcial</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="partialMode" id="partialModeComplete" value="complete" checked onchange="updatePartialMode()">
                                        <label class="form-check-label" for="partialModeComplete">
                                            Reemplazar selección completa
                                        </label>
                                        <small class="text-muted d-block ms-4">Los caracteres seleccionados se reemplazan por el valor completo</small>
                                    </div>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="radio" name="partialMode" id="partialModeCharByChar" value="charByChar" onchange="updatePartialMode()">
                                        <label class="form-check-label" for="partialModeCharByChar">
                                            Reemplazar carácter por carácter
                                        </label>
                                        <small class="text-muted d-block ms-4">Cada carácter seleccionado se reemplaza individualmente</small>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Ejemplo #</label>
                                        <input type="number" id="partialExampleIndex" class="form-control bg-dark text-light border-secondary" value="1" min="1" onchange="updatePartialExample()">
                                    </div>
                                    <div class="col-md-8">
                                        <label class="form-label">Selecciona los caracteres a reemplazar:</label>
                                        <div id="partialCharacters" class="p-2 border rounded bg-dark" style="font-family: monospace; font-size: 1.1em; letter-spacing: 0.1em;">
                                            <!-- Los caracteres clickeables aparecerán aquí -->
                                        </div>
                                        <small class="text-muted mt-1" id="partialHint">Click en los caracteres para seleccionar qué parte reemplazar</small>
                                        <div class="alert alert-warning mt-2" id="partialWarning" style="display: none;">
                                            <i class="bi bi-exclamation-triangle"></i>
                                            <span id="partialWarningText"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Selector de reemplazo de subcadena -->
                        <div id="charReplaceSelector" class="mb-3" style="display: none;">
                            <div class="border rounded p-3" style="background-color: rgba(0, 123, 255, 0.1);">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Subcadena a buscar</label>
                                        <input type="text" id="charToFind" class="form-control bg-dark text-light border-secondary" placeholder="Ej: _test_" onchange="validateCharReplace()" oninput="validateCharReplace()">
                                        <small class="text-muted">Ingresa el texto a buscar</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Subcadena de reemplazo</label>
                                        <input type="text" id="charToReplace" class="form-control bg-dark text-light border-secondary" placeholder="Ej: -prod-" onchange="validateCharReplace()" oninput="validateCharReplace()">
                                        <small class="text-muted">Ingresa el texto de reemplazo</small>
                                    </div>
                                </div>
                                <div class="alert alert-info mt-2">
                                    <i class="bi bi-info-circle"></i>
                                    <span id="charReplaceInfo">Este modo reemplazará todas las ocurrencias de la subcadena especificada dentro de las coincidencias encontradas</span>
                                </div>
                                <div class="mt-2" id="charReplaceExample" style="display: none;">
                                    <small class="text-muted">
                                        <strong>Ejemplo:</strong> <span id="charReplaceExampleText"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Opciones de búsqueda</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="advCaseSensitive">
                                <label class="form-check-label" for="advCaseSensitive">
                                    Distinguir mayúsculas/minúsculas
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Reemplazar en índices específicos</label>
                            <div class="input-group">
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="advReplacePositions" placeholder="Ej: 1,3,5-10,15" onchange="updateReplaceButtons()" oninput="updateReplaceButtons()">
                                <button class="btn btn-outline-secondary" type="button" onclick="showPositionHelp()">
                                    <i class="bi bi-question-circle"></i>
                                </button>
                            </div>
                            <small class="text-muted">Especifica los índices de las coincidencias a reemplazar</small>
                        </div>
                        
                        <button class="btn btn-warning w-100" onclick="previewReplacement()" disabled id="previewReplaceBtn">
                            <i class="bi bi-eye"></i> Vista Previa de Reemplazo
                        </button>
                        
                        <div class="mt-3">
                            <label class="form-label">Alcance de la ejecución</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="executionScope" id="execScopeSearch" value="search" checked>
                                <label class="form-check-label" for="execScopeSearch">
                                    Solo en el alcance de búsqueda actual
                                </label>
                                <small class="text-muted d-block ms-4" id="execScopeSearchHint">Se aplicará solo en los valores buscados</small>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="executionScope" id="execScopeAll" value="all">
                                <label class="form-check-label" for="execScopeAll">
                                    En todo el dataset
                                </label>
                                <small class="text-muted d-block ms-4">Se aplicará a todas las filas del dataset</small>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="executionScope" id="execScopeCustom" value="custom" onchange="toggleExecutionRange()">
                                <label class="form-check-label" for="execScopeCustom">
                                    Rango personalizado
                                </label>
                                <small class="text-muted d-block ms-4">Especifica un rango de filas personalizado</small>
                            </div>
                            
                            <!-- Selector de rango personalizado -->
                            <div id="executionRangeSelector" class="mt-2 ms-4" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <small class="text-muted me-2">Desde fila:</small>
                                    <input type="number" id="execRangeStart" class="form-control form-control-sm bg-dark text-light border-secondary" value="1" min="1" style="width: 100px;" onchange="updateExecutionRangeInfo()" oninput="updateExecutionRangeInfo()">
                                    <small class="text-muted mx-2">hasta:</small>
                                    <input type="number" id="execRangeEnd" class="form-control form-control-sm bg-dark text-light border-secondary" value="1000" min="1" style="width: 100px;" onchange="updateExecutionRangeInfo()" oninput="updateExecutionRangeInfo()">
                                    <small class="text-muted ms-2" id="execRangeInfo"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Resultados de búsqueda -->
                <div id="advSearchResults" class="mt-4" style="display: none;">
                    <hr class="border-secondary">
                    <h6 class="text-info">Resultados de búsqueda</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <strong>Coincidencias encontradas:</strong> <span id="advMatchCount">0</span> de <span id="advTotalCount">0</span> valores
                                (<span id="advMatchPercentage">0</span>%)
                            </div>
                            <div id="advMatchedValuesList" style="max-height: 300px; overflow-y: auto;" class="border rounded p-2 bg-dark">
                                <!-- Lista de valores coincidentes -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <canvas id="advSearchResultChart" style="max-height: 250px;"></canvas>
                            <small class="text-muted text-center d-block mt-1">
                                <i class="bi bi-hand-index"></i> Click en el gráfico para ver los valores
                            </small>
                            <div class="mt-3">
                                <h6 class="text-center text-muted mb-2">
                                    <i class="bi bi-bar-chart"></i> Valores Únicos en la Búsqueda
                                </h6>
                                <canvas id="advUniqueValuesChart" style="max-height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Vista previa de reemplazo -->
                <div id="advReplacePreview" class="mt-4" style="display: none;">
                    <hr class="border-secondary">
                    <h6 class="text-warning">Vista Previa de Reemplazo</h6>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <span id="advReplaceCount">0</span> valores serán reemplazados
                    </div>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Índice</th>
                                    <th>Valor Original</th>
                                    <th>Valor Nuevo</th>
                                </tr>
                            </thead>
                            <tbody id="advReplacePreviewTable">
                                <!-- Preview rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary" style="background-color: #0d1225;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="executeReplacement()" disabled id="executeReplaceBtn">
                    <i class="bi bi-arrow-repeat"></i> Ejecutar Reemplazo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Manipulación de Texto -->
<div class="modal fade" id="textManipulationModal" tabindex="-1" aria-labelledby="textManipulationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-info" id="textManipulationModalLabel">
                    <i class="bi bi-scissors"></i> Manipulación de Texto - <span id="textManipColumnName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="background-color: #1a1e3a;">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-warning mb-3">Operaciones de Texto</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Tipo de operación</label>
                            <select class="form-select bg-dark text-light border-secondary" id="textOperation" onchange="updateTextOperationOptions()">
                                <option value="truncate">Truncar texto</option>
                                <option value="extract">Extraer substring</option>
                                <option value="remove_chars">Eliminar caracteres</option>
                                <option value="case">Cambiar mayúsculas/minúsculas</option>
                                <option value="trim">Eliminar espacios</option>
                                <option value="split">Dividir texto</option>
                                <option value="pad">Rellenar texto</option>
                            </select>
                        </div>
                        
                        <div id="textOperationOptions">
                            <!-- Las opciones específicas aparecerán aquí -->
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label">Alcance de la operación</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="textManipScope" id="textManipScopeAll" value="all" checked>
                                <label class="form-check-label" for="textManipScopeAll">
                                    Todo el dataset
                                </label>
                                <small class="text-muted d-block ms-4">Aplica la operación a todas las filas</small>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="textManipScope" id="textManipScopeRange" value="range" onchange="toggleTextManipRange()">
                                <label class="form-check-label" for="textManipScopeRange">
                                    Rango personalizado
                                </label>
                                <small class="text-muted d-block ms-4">Especifica un rango de filas</small>
                            </div>
                            
                            <!-- Selector de rango -->
                            <div id="textManipRangeSelector" class="mt-2 ms-4" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <small class="text-muted me-2">Desde fila:</small>
                                    <input type="number" id="textManipRangeStart" class="form-control form-control-sm bg-dark text-light border-secondary" value="1" min="1" style="width: 100px;" onchange="updateTextManipRangeInfo()" oninput="updateTextManipRangeInfo()">
                                    <small class="text-muted mx-2">hasta:</small>
                                    <input type="number" id="textManipRangeEnd" class="form-control form-control-sm bg-dark text-light border-secondary" value="100" min="1" style="width: 100px;" onchange="updateTextManipRangeInfo()" oninput="updateTextManipRangeInfo()">
                                    <small class="text-muted ms-2" id="textManipRangeInfo"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="text-warning mb-3">Vista Previa</h6>
                        <div id="textManipPreview" class="border rounded p-3 bg-dark" style="max-height: 400px; overflow-y: auto;">
                            <p class="text-muted text-center">Selecciona una operación para ver la vista previa</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary" style="background-color: #0d1225;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="previewTextManipulation()">
                    <i class="bi bi-eye"></i> Vista Previa
                </button>
                <button type="button" class="btn btn-danger" onclick="executeTextManipulation()" disabled id="executeTextManipBtn">
                    <i class="bi bi-scissors"></i> Aplicar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Transformaciones Numéricas -->
<div class="modal fade" id="numericTransformModal" tabindex="-1" aria-labelledby="numericTransformModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-info" id="numericTransformModalLabel">
                    <i class="bi bi-calculator"></i> Transformaciones Numéricas - <span id="numericColumnName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="background-color: #1a1e3a;">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-warning mb-3">Operaciones Numéricas</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Tipo de transformación</label>
                            <select class="form-select bg-dark text-light border-secondary" id="numericOperation" onchange="updateNumericOperationOptions()">
                                <option value="round">Redondear</option>
                                <option value="floor">Redondear hacia abajo</option>
                                <option value="ceil">Redondear hacia arriba</option>
                                <option value="scale">Escalar valores</option>
                                <option value="clip">Limitar rango</option>
                                <option value="arithmetic">Operación aritmética</option>
                                <option value="log">Transformación logarítmica</option>
                                <option value="power">Elevar a potencia</option>
                            </select>
                        </div>
                        
                        <div id="numericOperationOptions">
                            <!-- Las opciones específicas aparecerán aquí -->
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="text-warning mb-3">Vista Previa</h6>
                        <div id="numericTransformPreview" class="border rounded p-3 bg-dark" style="max-height: 400px; overflow-y: auto;">
                            <p class="text-muted text-center">Selecciona una operación para ver la vista previa</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary" style="background-color: #0d1225;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="previewNumericTransform()">
                    <i class="bi bi-eye"></i> Vista Previa
                </button>
                <button type="button" class="btn btn-danger" onclick="executeNumericTransform()" disabled id="executeNumericBtn">
                    <i class="bi bi-calculator"></i> Aplicar Transformación
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/@sgratzl/chartjs-chart-boxplot@3"></script>
<script>
let datasets = [];
let selectedDataset = null;
let charts = {};
let analysisCount = 1;
let analysisCharts = {}; // Store multiple charts by analysis ID
let analysisData = {}; // Store analysis data for report generation
let datasetsAlreadyLoaded = false; // Flag to track if datasets have been loaded for the first time

// Function to parse normalization info and create badge
function getNormalizationBadge(normalizationMethod) {
    try {
        // Parse the normalization method string
        const config = typeof normalizationMethod === 'string' ? 
            normalizationMethod.replace(/'/g, '"').replace(/True/g, 'true').replace(/False/g, 'false') : 
            normalizationMethod;
        
        let normInfo;
        try {
            normInfo = typeof config === 'string' ? JSON.parse(config) : config;
        } catch (e) {
            // If parsing fails, return a simple badge
            return `<div class="text-center small mb-2" style="color: #9333ea;">
                <i class="bi bi-gear"></i> Normalizado
            </div>`;
        }
        
        // Count columns with keep_original = true
        let columnsKept = 0;
        let totalColumns = 0;
        
        for (const [column, layers] of Object.entries(normInfo)) {
            totalColumns++;
            if (Array.isArray(layers)) {
                // Check if any layer has keep_original = true
                const hasKeptOriginal = layers.some(layer => layer && layer.keep_original === true);
                if (hasKeptOriginal) {
                    columnsKept++;
                }
            } else if (layers && layers.keep_original === true) {
                columnsKept++;
            }
        }
        
        // Create badge based on columns kept
        const badgeColor = columnsKept > 0 ? '#00d4ff' : '#9333ea';
        const badgeIcon = columnsKept > 0 ? 'bi-shield-check' : 'bi-gear';
        const badgeText = columnsKept > 0 ? 
            `${columnsKept} columna${columnsKept !== 1 ? 's' : ''} original${columnsKept !== 1 ? 'es' : ''} conservada${columnsKept !== 1 ? 's' : ''}` : 
            'Sin columnas originales';
        
        return `<div class="text-center small mb-2" style="color: ${badgeColor};">
            <i class="bi ${badgeIcon}"></i> ${badgeText}
        </div>`;
        
    } catch (error) {
        console.error('Error parsing normalization method:', error);
        return '';
    }
}

// Function to get detailed normalization info for modal
function getDetailedNormalizationInfo(normalizationMethod) {
    try {
        // Parse the normalization method string
        const config = typeof normalizationMethod === 'string' ? 
            normalizationMethod.replace(/'/g, '"').replace(/True/g, 'true').replace(/False/g, 'false') : 
            normalizationMethod;
        
        let normInfo;
        try {
            normInfo = typeof config === 'string' ? JSON.parse(config) : config;
        } catch (e) {
            return '<p class="mb-0">Información de normalización no disponible</p>';
        }
        
        let html = '<div class="mt-2">';
        
        for (const [column, layers] of Object.entries(normInfo)) {
            let keepOriginal = false;
            let methods = [];
            
            if (Array.isArray(layers)) {
                // Multi-layer normalization
                methods = layers.map(layer => layer.method).filter(m => m);
                keepOriginal = layers.some(layer => layer && layer.keep_original === true);
            } else if (typeof layers === 'object' && layers !== null) {
                // Single layer object
                methods = [layers.method].filter(m => m);
                keepOriginal = layers.keep_original === true;
            } else if (typeof layers === 'string') {
                // Legacy format
                methods = [layers];
            }
            
            html += `
                <div class="mb-2 p-2" style="background: rgba(0, 212, 255, 0.05); border-radius: 5px;">
                    <strong>${column}:</strong>
                    <span class="ms-2">${methods.join(' → ') || 'Sin método'}</span>
                    ${keepOriginal ? 
                        '<span class="badge bg-info ms-2"><i class="bi bi-shield-check"></i> Original conservada</span>' : 
                        '<span class="badge bg-secondary ms-2"><i class="bi bi-x-circle"></i> Original eliminada</span>'
                    }
                </div>
            `;
        }
        
        html += '</div>';
        return html;
        
    } catch (error) {
        console.error('Error parsing normalization method:', error);
        return '<p class="mb-0">Error al procesar información de normalización</p>';
    }
}

// Función para obtener el CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Funciones de loading
function showLoading(message = 'Cargando...') {
    // Crear overlay si no existe
    let loadingOverlay = document.getElementById('globalLoadingOverlay');
    if (!loadingOverlay) {
        loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'globalLoadingOverlay';
        loadingOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        `;
        loadingOverlay.innerHTML = `
            <div class="text-center text-white">
                <div class="spinner-border mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div id="loadingMessage">${message}</div>
            </div>
        `;
        document.body.appendChild(loadingOverlay);
    } else {
        document.getElementById('loadingMessage').textContent = message;
        loadingOverlay.style.display = 'flex';
    }
}

function hideLoading() {
    const loadingOverlay = document.getElementById('globalLoadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
}

// Función para mostrar notificaciones
function showNotification(title, message, type = 'info') {
    // Crear contenedor de notificaciones si no existe
    let notificationContainer = document.getElementById('notificationContainer');
    if (!notificationContainer) {
        notificationContainer = document.createElement('div');
        notificationContainer.id = 'notificationContainer';
        notificationContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 350px;
        `;
        document.body.appendChild(notificationContainer);
    }
    
    // Mapear tipo a clase de Bootstrap
    const typeMap = {
        'info': 'info',
        'success': 'success',
        'warning': 'warning',
        'error': 'danger',
        'danger': 'danger'
    };
    
    const alertType = typeMap[type] || 'info';
    
    // Crear notificación
    const notification = document.createElement('div');
    notification.className = `alert alert-${alertType} alert-dismissible fade show`;
    notification.setAttribute('role', 'alert');
    notification.innerHTML = `
        <strong>${title}</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    notificationContainer.appendChild(notification);
    
    // Auto-cerrar después de 5 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 150);
        }
    }, 5000);
}

// Normalizar dataset
function normalizeDataset(datasetId) {
    window.location.href = `/datasets/${datasetId}/normalize/`;
}

// Analizar dataset
function analyzeDataset(datasetId) {
    window.location.href = `/datasets/${datasetId}/analyze/`;
}

// Charger les datasets
function loadDatasets() {
    // Only show loading message on first load
    if (!datasetsAlreadyLoaded) {
        showLoading('Chargement des datasets...', 'Récupération de vos fichiers de données');
    }
    return fetch('/api/datasets/')
        .then(response => response.json())
        .then(data => {
            datasets = data;
            displayDatasets(data);
            updateStats(data);
            if (!datasetsAlreadyLoaded) {
                hideLoading();
                datasetsAlreadyLoaded = true; // Mark as loaded
            }
            return data;
        })
        .catch(error => {
            console.error('Erreur:', error);
            hideLoading();
            showNotification('Erreur', 'Impossible de charger les datasets', 'error');
            throw error;
        });
}

// Encontrar el dataset original raíz
function findRootParent(datasetList, dataset) {
    if (!dataset.is_normalized || !dataset.parent_dataset) {
        return dataset;
    }
    
    const parent = datasetList.find(d => d.id === dataset.parent_dataset);
    if (!parent) {
        return null;
    }
    
    // Si el padre también es normalizado, buscar recursivamente
    if (parent.is_normalized && parent.parent_dataset) {
        return findRootParent(datasetList, parent);
    }
    
    return parent;
}

// Afficher les datasets
function displayDatasets(datasetList) {
    console.log('displayDatasets called with:', datasetList);
    const container = document.getElementById('datasetsContainer');
    if (!container) {
        console.error('Container datasetsContainer not found!');
        return;
    }
    container.innerHTML = '';
    
    // Debug: ver qué datos estamos recibiendo
    console.log('Datasets recibidos:', datasetList);
    
    if (!datasetList || datasetList.length === 0) {
        container.innerHTML = `
            <div class="text-center p-5">
                <p class="text-muted">Aucun dataset disponible. Importez votre premier dataset!</p>
            </div>
        `;
        return;
    }
    
    // Agrupar datasets por root_dataset_id
    const rootGroups = {};
    
    console.log('Grouping datasets by root_dataset_id...');
    
    // Agrupar todos los datasets por su root_dataset_id
    datasetList.forEach(dataset => {
        let rootId;
        
        if (!dataset.is_normalized) {
            // Dataset original, su ID es el root
            rootId = dataset.id;
        } else if (dataset.root_dataset_id) {
            // Dataset normalizado con root_dataset_id
            rootId = dataset.root_dataset_id;
        } else {
            // Dataset normalizado sin root_dataset_id (no debería pasar pero por si acaso)
            rootId = `orphan_${dataset.id}`;
        }
        
        if (!rootGroups[rootId]) {
            rootGroups[rootId] = {
                rootId: rootId,
                datasets: []
            };
        }
        
        rootGroups[rootId].datasets.push(dataset);
    });
    
    console.log('Root groups:', rootGroups);
    
    // Procesar cada grupo
    Object.values(rootGroups).forEach(group => {
        // Ordenar datasets por fecha (más antiguo primero)
        group.datasets.sort((a, b) => new Date(a.uploaded_at) - new Date(b.uploaded_at));
        
        // Buscar el dataset original (no normalizado)
        const originalDataset = group.datasets.find(d => !d.is_normalized);
        
        if (originalDataset) {
            // Hay un dataset original, mostrar como grupo normal
            const normalizedDatasets = group.datasets.filter(d => d.is_normalized);
            displayDatasetGroup({
                original: originalDataset,
                normalized: normalizedDatasets
            });
        } else {
            // No hay dataset original, usar el más antiguo como cabeza
            const headDataset = group.datasets[0];
            const otherDatasets = group.datasets.slice(1);
            
            // Crear un grupo especial con el más antiguo como cabeza
            displayDatasetGroupWithNormalizedHead(headDataset, otherDatasets);
        }
    });
    
    // Actualizar el filtro de datasets originales
    const originalDatasets = datasetList.filter(d => !d.is_normalized);
    updateParentFilter(originalDatasets);
}

// Actualizar filtro de datasets originales
function updateParentFilter(originalDatasets) {
    const filter = document.getElementById('parentFilter');
    const currentValue = filter.value;
    
    // Mantener las primeras 3 opciones
    filter.innerHTML = `
        <option value="">Tous les datasets</option>
        <option value="original">Seulement originaux</option>
        <option value="normalized">Seulement normalisés</option>
    `;
    
    // Añadir datasets originales
    if (originalDatasets.length > 0) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = 'Par dataset original';
        originalDatasets.forEach(dataset => {
            const option = document.createElement('option');
            option.value = dataset.id;
            option.textContent = dataset.name;
            optgroup.appendChild(option);
        });
        filter.appendChild(optgroup);
    }
    
    // Restaurar valor seleccionado
    filter.value = currentValue;
}

// Mostrar grupo de datasets
function displayDatasetGroup(group) {
    const container = document.getElementById('datasetsContainer');
    
    const groupDiv = document.createElement('div');
    groupDiv.className = 'dataset-group';
    groupDiv.setAttribute('data-group-id', group.original.id);
    
    // Header del grupo
    const header = document.createElement('div');
    header.className = 'dataset-group-header';
    header.innerHTML = `
        <h3 class="dataset-group-title">
            <i class="bi bi-folder2-open"></i> ${group.original.name}
            <span class="badge bg-primary ms-2">${group.normalized.length} normalizaciones</span>
        </h3>
        <div>
            <span class="text-muted small">
                <i class="bi bi-calendar3"></i> ${new Date(group.original.uploaded_at).toLocaleDateString('fr-FR')}
            </span>
        </div>
    `;
    
    // Contenedor de tarjetas
    const cardsContainer = document.createElement('div');
    cardsContainer.className = 'dataset-cards-container';
    
    // Tarjeta original
    const originalCard = createDatasetCard(group.original, 'original');
    cardsContainer.appendChild(originalCard);
    
    // Flecha separadora si hay normalizaciones
    if (group.normalized.length > 0) {
        const arrow = document.createElement('div');
        arrow.className = 'normalization-arrow';
        arrow.innerHTML = '<i class="bi bi-arrow-right-circle"></i>';
        cardsContainer.appendChild(arrow);
    }
    
    // Tarjetas normalizadas
    group.normalized.forEach(dataset => {
        const normalizedCard = createDatasetCard(dataset, 'normalized');
        cardsContainer.appendChild(normalizedCard);
    });
    
    groupDiv.appendChild(header);
    groupDiv.appendChild(cardsContainer);
    container.appendChild(groupDiv);
}

// Mostrar grupo donde un dataset normalizado es la cabeza (cuando se borró el original)
function displayDatasetGroupWithNormalizedHead(headDataset, otherDatasets) {
    const container = document.getElementById('datasetsContainer');
    
    const groupDiv = document.createElement('div');
    groupDiv.className = 'dataset-group';
    groupDiv.setAttribute('data-group-id', headDataset.id);
    
    // Header del grupo
    const header = document.createElement('div');
    header.className = 'dataset-group-header';
    header.innerHTML = `
        <h3 class="dataset-group-title">
            <i class="bi bi-folder2-open"></i> ${headDataset.name}
            <span class="badge bg-warning ms-2">Original eliminado</span>
            <span class="badge bg-primary ms-2">${otherDatasets.length} normalizaciones</span>
        </h3>
        <div>
            <span class="text-muted small">
                <i class="bi bi-calendar3"></i> ${new Date(headDataset.uploaded_at).toLocaleDateString('fr-FR')}
            </span>
        </div>
    `;
    
    // Contenedor de tarjetas
    const cardsContainer = document.createElement('div');
    cardsContainer.className = 'dataset-cards-container';
    
    // El primer dataset normalizado actúa como cabeza (pero sigue siendo normalizado)
    const headCard = createDatasetCard(headDataset, 'normalized');
    headCard.style.borderColor = 'rgba(255, 193, 7, 0.6)'; // Color amarillo para indicar que es la cabeza
    cardsContainer.appendChild(headCard);
    
    // Flecha separadora si hay más normalizaciones
    if (otherDatasets.length > 0) {
        const arrow = document.createElement('div');
        arrow.className = 'normalization-arrow';
        arrow.innerHTML = '<i class="bi bi-arrow-right-circle"></i>';
        cardsContainer.appendChild(arrow);
    }
    
    // Otras tarjetas normalizadas
    otherDatasets.forEach(dataset => {
        const normalizedCard = createDatasetCard(dataset, 'normalized');
        cardsContainer.appendChild(normalizedCard);
    });
    
    groupDiv.appendChild(header);
    groupDiv.appendChild(cardsContainer);
    container.appendChild(groupDiv);
}

// Mostrar grupo de datasets huérfanos
function displayOrphanGroup(rootId, orphans) {
    const container = document.getElementById('datasetsContainer');
    
    const groupDiv = document.createElement('div');
    groupDiv.className = 'dataset-group';
    groupDiv.setAttribute('data-group-id', `orphan-${rootId}`);
    
    // Obtener el nombre del dataset original del primer huérfano
    const originalName = orphans[0].parent_dataset_name || 'Dataset eliminado';
    
    const header = document.createElement('div');
    header.className = 'dataset-group-header';
    header.innerHTML = `
        <h3 class="dataset-group-title">
            <i class="bi bi-folder2-open"></i> ${originalName}
            <span class="badge bg-warning ms-2">Original eliminado</span>
            <span class="badge bg-primary ms-2">${orphans.length} normalizaciones</span>
        </h3>
    `;
    
    const cardsContainer = document.createElement('div');
    cardsContainer.className = 'dataset-cards-container';
    
    // Mostrar todos los datasets huérfanos del grupo
    orphans.forEach(dataset => {
        const card = createDatasetCard(dataset, 'normalized');
        cardsContainer.appendChild(card);
    });
    
    groupDiv.appendChild(header);
    groupDiv.appendChild(cardsContainer);
    container.appendChild(groupDiv);
}

// Mostrar dataset huérfano individual
function displayOrphanDataset(dataset) {
    const container = document.getElementById('datasetsContainer');
    
    const groupDiv = document.createElement('div');
    groupDiv.className = 'dataset-group';
    groupDiv.setAttribute('data-dataset-id', dataset.id);
    
    const header = document.createElement('div');
    header.className = 'dataset-group-header';
    const parentName = dataset.parent_dataset_name || 'Dataset eliminado';
    header.innerHTML = `
        <h3 class="dataset-group-title">
            <i class="bi bi-file-earmark-question"></i> ${parentName}
            <span class="badge bg-warning ms-2">Original eliminado</span>
        </h3>
    `;
    
    const cardsContainer = document.createElement('div');
    cardsContainer.className = 'dataset-cards-container';
    
    const card = createDatasetCard(dataset, 'normalized');
    cardsContainer.appendChild(card);
    
    groupDiv.appendChild(header);
    groupDiv.appendChild(cardsContainer);
    container.appendChild(groupDiv);
}

// Crear tarjeta de dataset
function createDatasetCard(dataset, type = 'original') {
    const card = document.createElement('div');
    card.className = `card dataset-card ${type} h-100`;
    card.setAttribute('data-dataset-id', dataset.id);
    
    const size = dataset.file_size ? (dataset.file_size / 1024 / 1024).toFixed(2) : '0';
    
    // Crear el contenedor de acciones rápidas
    const quickActions = document.createElement('div');
    quickActions.className = 'quick-actions';
        
    // Botón Normalizar
    const btnNormalize = document.createElement('button');
    btnNormalize.type = 'button';
    btnNormalize.className = 'action-btn';
    btnNormalize.setAttribute('data-action', 'normalize');
    btnNormalize.setAttribute('data-dataset-id', dataset.id);
    btnNormalize.title = 'Normalizar';
    btnNormalize.innerHTML = '<i class="bi bi-sliders"></i>';
    
    // Botón Analizar
    const btnAnalyze = document.createElement('button');
    btnAnalyze.type = 'button';
    btnAnalyze.className = 'action-btn';
    btnAnalyze.setAttribute('data-action', 'analyze');
    btnAnalyze.setAttribute('data-dataset-id', dataset.id);
    btnAnalyze.title = 'Analizar';
    btnAnalyze.innerHTML = '<i class="bi bi-bar-chart"></i>';
    
    // Botón Descargar
    const btnDownload = document.createElement('button');
    btnDownload.type = 'button';
    btnDownload.className = 'action-btn';
    btnDownload.setAttribute('data-action', 'download');
    btnDownload.setAttribute('data-dataset-id', dataset.id);
    btnDownload.title = 'Descargar';
    btnDownload.innerHTML = '<i class="bi bi-download"></i>';
    
    // Botón Duplicar
    const btnDuplicate = document.createElement('button');
    btnDuplicate.type = 'button';
    btnDuplicate.className = 'action-btn';
    btnDuplicate.setAttribute('data-action', 'duplicate');
    btnDuplicate.setAttribute('data-dataset-id', dataset.id);
    btnDuplicate.title = 'Duplicar';
    btnDuplicate.innerHTML = '<i class="bi bi-copy"></i>';
    
    // Botón Eliminar
    const btnDelete = document.createElement('button');
    btnDelete.type = 'button';
    btnDelete.className = 'action-btn';
    btnDelete.setAttribute('data-action', 'delete');
    btnDelete.setAttribute('data-dataset-id', dataset.id);
    btnDelete.title = 'Eliminar';
    btnDelete.innerHTML = '<i class="bi bi-trash"></i>';
    
    quickActions.appendChild(btnNormalize);
    quickActions.appendChild(btnAnalyze);
    quickActions.appendChild(btnDownload);
    quickActions.appendChild(btnDuplicate);
    quickActions.appendChild(btnDelete);
    
    // Crear el cuerpo de la tarjeta
    const cardBody = document.createElement('div');
    cardBody.className = 'card-body';
    // Determinar si es un dataset normalizado
    const isNormalized = dataset.is_normalized || dataset.name.includes('_normalizacion_');
    
    cardBody.innerHTML = `
        <div class="dataset-icon">
            <i class="bi ${isNormalized ? 'bi-sliders' : 'bi-file-earmark-spreadsheet'}"></i>
        </div>
        <h5 class="card-title text-center mb-1" style="font-weight: 600; font-size: 1.1rem; min-height: 35px; display: flex; align-items: center; justify-content: center;">
            ${dataset.name}
        </h5>
        ${dataset.is_normalized && dataset.parent_dataset_name ? `
            <p class="text-center small mb-1" style="color: #00d4ff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                <i class="bi bi-arrow-return-right"></i> Desde: <strong>${dataset.parent_dataset_name}</strong>
            </p>
        ` : '<div style="height: 20px;"></div>'}
        ${dataset.is_normalized && dataset.normalization_method ? getNormalizationBadge(dataset.normalization_method) : ''}
        <p class="text-muted small text-center mb-2" style="font-size: 0.85rem; opacity: 0.8; line-height: 1.3;">
            ${dataset.short_description || dataset.display_description || 'Dataset météorologique'}
        </p>
        <div class="dataset-stats">
            <div class="stat-item">
                <div class="stat-value">${(dataset.row_count || 0).toLocaleString('fr-FR')}</div>
                <div class="text-muted small">Lignes</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">${dataset.column_count || 0}</div>
                <div class="text-muted small">Colonnes</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">${size}</div>
                <div class="text-muted small">MB</div>
            </div>
        </div>
        <div class="text-center mt-auto pt-2" style="border-top: 1px solid rgba(0, 212, 255, 0.2); color: #00d4ff; font-size: 0.8rem;">
            <i class="bi bi-clock"></i> 
            ${dataset.uploaded_at ? `${new Date(dataset.uploaded_at).toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric' 
            })} à ${new Date(dataset.uploaded_at).toLocaleTimeString('fr-FR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            })}` : 'Date inconnue'}
        </div>
    `;
    
    // Ensamblar la tarjeta
    card.appendChild(quickActions);
    card.appendChild(cardBody);
    
    // Agregar eventos directamente a la tarjeta
    card.addEventListener('click', function(e) {
        // Solo procesar clic si no es en un botón
        if (!e.target.closest('.action-btn')) {
            showDatasetDetails(dataset.id);
        }
    });
    
    card.addEventListener('mouseenter', function() {
        this.classList.add('hover');
    });
    
    card.addEventListener('mouseleave', function() {
        this.classList.remove('hover');
    });
    
    // Eventos para los botones
    btnNormalize.addEventListener('click', function(e) {
        e.stopPropagation();
        normalizeDataset(dataset.id);
    });
    
    btnAnalyze.addEventListener('click', function(e) {
        e.stopPropagation();
        analyzeDataset(dataset.id);
    });
    
    btnDownload.addEventListener('click', function(e) {
        e.stopPropagation();
        downloadDataset(dataset.id);
    });
    
    btnDuplicate.addEventListener('click', function(e) {
        e.stopPropagation();
        duplicateDataset(dataset.id, dataset.name);
    });
    
    btnDelete.addEventListener('click', function(e) {
        e.stopPropagation();
        deleteDataset(dataset.id);
    });
    
    return card;
}

// Filtrar datasets
function filterDatasets() {
    const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
    const parentFilter = document.getElementById('parentFilter').value;
    const sortBy = document.getElementById('sortFilter').value;
    
    // Obtener todos los grupos
    const groups = document.querySelectorAll('.dataset-group');
    
    groups.forEach(group => {
        let shouldShowGroup = false;
        const cards = group.querySelectorAll('.dataset-card');
        
        cards.forEach(card => {
            const datasetId = card.getAttribute('data-dataset-id');
            const dataset = datasets.find(d => d.id == datasetId);
            
            if (!dataset) return;
            
            let shouldShow = true;
            
            // Filtro por nombre
            if (searchTerm && !dataset.name.toLowerCase().includes(searchTerm)) {
                shouldShow = false;
            }
            
            // Filtro por tipo
            if (parentFilter === 'original' && dataset.is_normalized) {
                shouldShow = false;
            } else if (parentFilter === 'normalized' && !dataset.is_normalized) {
                shouldShow = false;
            } else if (parentFilter && parentFilter !== 'original' && parentFilter !== 'normalized') {
                // Filtro por dataset original específico usando root_dataset_id
                const rootId = dataset.is_normalized ? dataset.root_dataset_id : dataset.id;
                if (rootId != parentFilter) {
                    shouldShow = false;
                }
            }
            
            card.style.display = shouldShow ? '' : 'none';
            if (shouldShow) shouldShowGroup = true;
        });
        
        group.style.display = shouldShowGroup ? '' : 'none';
    });
    
    // Reordenar si es necesario
    if (sortBy !== 'name') {
        sortDatasets(sortBy);
    }
}

// Ordenar datasets
function sortDatasets(sortBy) {
    const container = document.getElementById('datasetsContainer');
    const groups = Array.from(container.querySelectorAll('.dataset-group'));
    
    groups.sort((a, b) => {
        const aId = a.getAttribute('data-group-id') || a.getAttribute('data-dataset-id');
        const bId = b.getAttribute('data-group-id') || b.getAttribute('data-dataset-id');
        
        const aDataset = datasets.find(d => d.id == aId);
        const bDataset = datasets.find(d => d.id == bId);
        
        if (!aDataset || !bDataset) return 0;
        
        switch(sortBy) {
            case 'date':
                return new Date(bDataset.uploaded_at) - new Date(aDataset.uploaded_at);
            case 'size':
                return (bDataset.file_size || 0) - (aDataset.file_size || 0);
            default:
                return aDataset.name.localeCompare(bDataset.name);
        }
    });
    
    // Reordenar en el DOM
    groups.forEach(group => container.appendChild(group));
}

// Función para truncar la descripción
function truncateDescription(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

// Actualizar contador de caracteres
function updateCharCount() {
    const input = document.getElementById('datasetShortDescription');
    const charCount = document.getElementById('charCount');
    if (input && charCount) {
        const current = input.value.length;
        charCount.textContent = `(${current}/80)`;
        charCount.style.color = current >= 80 ? '#ff6b6b' : '#6c757d';
    }
}

// Función vacía ya que los eventos se agregan directamente en displayDatasets
function setupDatasetCardListeners() {
    // Los eventos ya se agregan directamente al crear las tarjetas
}

// Función para manejar teclas en modo edición
function handleEditKeydown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        // Si es un textarea y se presiona Shift+Enter, permitir nueva línea
        if (event.target.tagName === 'TEXTAREA' && event.shiftKey) {
            return;
        }
        event.preventDefault();
        saveInlineDatasetInfo();
    } else if (event.key === 'Escape') {
        event.preventDefault();
        toggleEditMode(false);
    }
}

// Función para alternar entre modo vista y edición
function toggleEditMode(editMode) {
    const viewMode = document.getElementById('viewMode');
    const editModeDiv = document.getElementById('editMode');
    const editBtn = document.getElementById('editInfoBtn');
    const saveBtn = document.getElementById('saveInfoBtn');
    const cancelBtn = document.getElementById('cancelInfoBtn');
    
    if (editMode) {
        // Activar modo edición
        viewMode.style.display = 'none';
        editModeDiv.style.display = 'block';
        editBtn.style.display = 'none';
        saveBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
        
        // Cargar valores actuales
        document.getElementById('editName').value = window.selectedDataset.name || '';
        document.getElementById('editShortDesc').value = window.selectedDataset.short_description || '';
        document.getElementById('editLongDesc').value = window.selectedDataset.long_description || '';
        
        // Enfocar el primer campo
        document.getElementById('editName').focus();
    } else {
        // Volver a modo vista
        viewMode.style.display = 'block';
        editModeDiv.style.display = 'none';
        editBtn.style.display = 'inline-block';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
    }
}

// Función para guardar la información del dataset inline
function saveInlineDatasetInfo() {
    if (!window.selectedDataset) return;
    
    const name = document.getElementById('editName').value.trim();
    const shortDescription = document.getElementById('editShortDesc').value.trim();
    const longDescription = document.getElementById('editLongDesc').value.trim();
    
    if (!name) {
        showNotification('Error', 'El nombre del dataset es obligatorio', 'error');
        return;
    }
    
    showLoading();
    
    fetch(`/api/datasets/${window.selectedDataset.id}/update-info/`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            name: name,
            short_description: shortDescription,
            long_description: longDescription
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error al actualizar la información');
        }
        return response.json();
    })
    .then(data => {
        hideLoading();
        showNotification('Éxito', 'Información del dataset actualizada correctamente', 'success');
        
        // Actualizar la información local
        window.selectedDataset.name = name;
        window.selectedDataset.short_description = shortDescription;
        window.selectedDataset.long_description = longDescription;
        
        // Actualizar la vista
        document.getElementById('viewName').textContent = name;
        document.getElementById('viewShortDesc').textContent = shortDescription || 'Sin descripción';
        document.getElementById('viewLongDesc').textContent = longDescription || 'Sin descripción detallada';
        
        // Actualizar el título del modal
        document.getElementById('datasetDetailTitle').innerHTML = `
            <i class="bi bi-database"></i> ${name}
        `;
        
        // Volver a modo vista
        toggleEditMode(false);
        
        // Actualizar también el dataset en el array global si existe
        const datasetIndex = datasets.findIndex(d => d.id === window.selectedDataset.id);
        if (datasetIndex !== -1) {
            datasets[datasetIndex].name = name;
            datasets[datasetIndex].short_description = shortDescription;
            datasets[datasetIndex].long_description = longDescription;
        }
        
        // Actualizar la tarjeta del dataset sin recargar toda la página
        const card = document.querySelector(`[data-dataset-id="${window.selectedDataset.id}"]`);
        if (card) {
            const cardTitle = card.querySelector('.card-title');
            if (cardTitle) {
                cardTitle.textContent = name;
            }
            const cardText = card.querySelector('.card-text');
            if (cardText) {
                cardText.textContent = shortDescription || 'Sin descripción';
            }
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showNotification('Error', 'Error al actualizar la información del dataset', 'error');
    });
}

// Afficher les détails d'un dataset
function showDatasetDetails(datasetId) {
    selectedDataset = datasets.find(d => d.id === datasetId);
    window.selectedDataset = selectedDataset;  // Hacer accesible globalmente
    if (!selectedDataset) return;
    
    // Fermer tous les modals ouverts d'abord
    document.querySelectorAll('.modal.show').forEach(modalEl => {
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) {
            modalInstance.hide();
        }
    });
    
    // Attendre un peu pour que Bootstrap nettoie
    setTimeout(() => {
        // Limpiar cualquier modal o backdrop previo
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('overflow');
        document.body.style.removeProperty('padding-right');
        
        // Asegurar que no haya loading activo
        hideLoading();
        
        const modalElement = document.getElementById('datasetDetailModal');
        // Verificar si ya existe una instancia
        let modal = bootstrap.Modal.getInstance(modalElement);
        if (!modal) {
            modal = new bootstrap.Modal(modalElement, {
                backdrop: false,  // Sin backdrop
                keyboard: true
            });
        }
        
        document.getElementById('datasetDetailTitle').innerHTML = `
            <i class="bi bi-database"></i> ${selectedDataset.name}
        `;
        
        // Mostrar loading en el contenido
        document.getElementById('datasetDetailContent').innerHTML = `
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Cargando análisis del dataset...</p>
            </div>
        `;
        
        // Mostrar el modal
        modal.show();
        
        // Cargar los datos del dataset (con timestamp para evitar caché)
        fetch(`/api/datasets/${datasetId}/columns/?t=${Date.now()}`, {
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                displayDatasetDetails(selectedDataset, data);
            })
            .catch(error => {
                console.error('Error completo:', error);
                document.getElementById('datasetDetailContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error al cargar los detalles del dataset
                        <br><small>${error.message}</small>
                    </div>
                `;
            });
    }, 100);
}

// Mostrar análisis completo del dataset
function displayDatasetDetails(dataset, data) {
    const shape = data.shape || [0, 0];
    const rows = shape[0];
    const cols = shape[1];
    const stats = data.stats || {};
    const preview = data.preview || {};
    const columns = data.columns || [];
    const memoryUsage = data.memory_usage ? 
        (typeof data.memory_usage === 'object' ? data.memory_usage.total_mb : data.memory_usage).toFixed(2) : '0';
    const totalNulls = data.total_null_count || 0;
    
    // Guardar datos en variable global para uso posterior
    window.currentDatasetData = data;
    window.selectedDataset = dataset;  // Asegurar que el dataset esté disponible globalmente
    
    // Reset analysis data for new dataset
    analysisCount = 1;
    analysisCharts = {};
    analysisData = {};
    
    // Información de descripciones
    let descriptionsSection = `
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card bg-dark border-info">
                    <div class="card-body" id="datasetInfoSection">
                        <h5 class="text-info mb-3 d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-info-circle"></i> Información del Dataset</span>
                            <div id="editButtons">
                                <button class="btn btn-sm btn-outline-info" id="editInfoBtn" onclick="toggleEditMode(true)" title="Editar información del dataset">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-success" id="saveInfoBtn" onclick="saveInlineDatasetInfo()" style="display: none;" title="Guardar cambios">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary ms-1" id="cancelInfoBtn" onclick="toggleEditMode(false)" style="display: none;" title="Cancelar">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </h5>
                        
                        <!-- Modo Vista -->
                        <div id="viewMode">
                            <div class="mb-2">
                                <strong class="text-muted">Nombre:</strong>
                                <p class="mb-0" id="viewName">${dataset.name}</p>
                            </div>
                            <div class="mb-2">
                                <strong class="text-muted">Descripción corta:</strong>
                                <p class="mb-0" id="viewShortDesc">${dataset.short_description || dataset.display_description || 'Sin descripción'}</p>
                            </div>
                            <div class="mb-2">
                                <strong class="text-muted">Descripción detallada:</strong>
                                <p class="mb-0" id="viewLongDesc">${dataset.long_description || 'Sin descripción detallada'}</p>
                            </div>
                        </div>
                        
                        <!-- Modo Edición -->
                        <div id="editMode" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label text-muted">Nombre:</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" 
                                       id="editName" value="${dataset.name}" maxlength="255"
                                       onkeydown="handleEditKeydown(event)">
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted">Descripción corta:</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" 
                                       id="editShortDesc" value="${dataset.short_description || ''}" 
                                       maxlength="80" placeholder="Máx. 80 caracteres"
                                       onkeydown="handleEditKeydown(event)">
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted">Descripción detallada:</label>
                                <textarea class="form-control bg-dark text-light border-secondary" 
                                          id="editLongDesc" rows="3" 
                                          placeholder="Descripción detallada del dataset"
                                          onkeydown="handleEditKeydown(event)">${dataset.long_description || ''}</textarea>
                            </div>
                        </div>
                        ${dataset.is_normalized && dataset.parent_dataset_name ? `
                            <div class="mb-2">
                                <strong class="text-muted">Dataset padre directo:</strong>
                                <p class="mb-0">${dataset.parent_dataset_name}</p>
                            </div>
                        ` : ''}
                        ${dataset.is_normalized && dataset.normalization_method ? `
                            <div class="mb-2">
                                <strong class="text-muted">Información de normalización:</strong>
                                ${getDetailedNormalizationInfo(dataset.normalization_method)}
                            </div>
                        ` : ''}
                        ${dataset.is_normalized && dataset.genealogy && dataset.genealogy.length > 0 ? `
                            <div class="mb-2">
                                <strong class="text-muted">Árbol genealógico completo:</strong>
                                <div class="genealogy-tree mt-2">
                                    ${dataset.genealogy.map((ancestor, index) => `
                                        <div class="genealogy-item" style="margin-left: ${index * 20}px;">
                                            <i class="bi bi-arrow-return-right text-info"></i>
                                            <span class="${!ancestor.exists ? 'text-warning' : ''}">${ancestor.name}</span>
                                            ${!ancestor.exists ? '<span class="badge bg-warning ms-2">Eliminado</span>' : ''}
                                        </div>
                                    `).join('')}
                                    <div class="genealogy-item" style="margin-left: ${dataset.genealogy.length * 20}px;">
                                        <i class="bi bi-arrow-return-right text-success"></i>
                                        <strong>${dataset.name}</strong> <span class="badge bg-success ms-2">Actual</span>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        <div>
                            <strong class="text-muted">Fecha de creación:</strong>
                            <p class="mb-0">${new Date(dataset.uploaded_at).toLocaleString('es-ES')}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Preview de datos
    let dataPreview = `
        <div class="row mb-4">
            <div class="col-md-12">
                <h5 class="text-primary mb-3"><i class="bi bi-eye"></i> Vista Previa de Datos (Primeras 10 filas)</h5>
                <div class="table-responsive" style="max-height: 300px; overflow: auto;">
                    <table class="table table-sm table-striped table-hover">
                        <thead class="table-dark sticky-top">
                            <tr>
                                ${columns.map(col => `<th class="text-nowrap">${col}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    // Generar filas del preview
    for (let i = 0; i < 10 && i < rows; i++) {
        dataPreview += '<tr>';
        columns.forEach(col => {
            const value = preview[col] && preview[col][i] !== undefined ? preview[col][i] : '';
            dataPreview += `<td class="text-nowrap">${value}</td>`;
        });
        dataPreview += '</tr>';
    }
    
    dataPreview += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Selector de variable y generador de histograma
    let variableSelector = `
        <div class="row mb-4">
            <div class="col-md-12">
                <h5 class="text-primary mb-3"><i class="bi bi-bar-chart-line"></i> Analyse de Distribution</h5>
                <div id="analysisContainer">
                    <div class="card bg-dark border-primary mb-3 analysis-card" data-analysis-id="1">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <label for="variableSelect1" class="form-label text-info">Sélectionner Variable:</label>
                                    <select class="form-select variable-select" id="variableSelect1" data-analysis-id="1" onchange="updateAnalysisButton(1)">
                                        <option value="">-- Sélectionnez une variable --</option>
                                        ${columns.map(col => {
                                            const colStats = stats[col] || {};
                                            const dtype = colStats.dtype || 'unknown';
                                            const isNumeric = colStats.mean !== undefined;
                                            
                                            let typeLabel = dtype;
                                            if (dtype.includes('int') || dtype.includes('float') || dtype.includes('uint')) {
                                                typeLabel = '📊 Numérique';
                                            } else if (dtype.includes('datetime')) {
                                                typeLabel = '📅 Date/Heure';
                                            } else if (dtype.includes('numeric (stored as text)')) {
                                                typeLabel = '🔢 Numérique (texte)';
                                            } else if (isNumeric) {
                                                typeLabel = '📊 Numérique';
                                            } else if (dtype.includes('object')) {
                                                typeLabel = '📝 Texte';
                                            }
                                            
                                            return `<option value="${col}" data-numeric="${isNumeric}" data-dtype="${dtype}">${col} - ${typeLabel}</option>`;
                                        }).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <select class="form-select" id="analysisType1" onchange="updateAnalysisButton(1)">
                                        <option value="histogram">Histogramme</option>
                                        <option value="pie">Gráfico Circular (Pie Chart)</option>
                                        <option value="outlier_map" class="numeric-only">Carte des Outliers</option>
                                        <option value="boxplot" class="numeric-only">Box Plot</option>
                                        <option value="scatter" class="numeric-only">Scatter Plot (2 variables)</option>
                                        <option value="lasso" class="numeric-only">LASSO (Sélection de variables)</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="includeOutliers1" checked onchange="handleOutliersChange(1)">
                                        <label class="form-check-label text-info" for="includeOutliers1">
                                            Inclure outliers
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-primary w-100" id="analysisButton1" onclick="executeAnalysis(1)">
                                        <i class="bi bi-graph-up"></i> Générer
                                    </button>
                                </div>
                            </div>
                            <div class="row mt-2" id="histogramConfig1" style="display: none;">
                                <div class="col-md-4">
                                    <label for="numBins1" class="form-label text-info small">Nombre d'intervalles:</label>
                                    <input type="number" class="form-control form-control-sm" id="numBins1" value="20" min="5" max="50" onchange="updateHistogramBins(1)">
                                </div>
                                <div class="col-md-4">
                                    <label for="binMin1" class="form-label text-info small">Valeur minimale:</label>
                                    <input type="number" class="form-control form-control-sm" id="binMin1" step="any" onchange="updateHistogramBins(1)">
                                </div>
                                <div class="col-md-4">
                                    <label for="binMax1" class="form-label text-info small">Valeur maximale:</label>
                                    <input type="number" class="form-control form-control-sm" id="binMax1" step="any" onchange="updateHistogramBins(1)">
                                </div>
                            </div>
                            <div class="mt-4" id="histogramContainer1" style="display: none;">
                                <canvas id="variableHistogram1" height="400"></canvas>
                            </div>
                            <div class="mt-3" id="variableStats1" style="display: none;">
                                <!-- Les statistiques de la variable sélectionnée apparaîtront ici -->
                            </div>
                            <div class="mt-3" id="analysisResultContainer1">
                                <!-- Les résultats des analyses avancées apparaîtront ici -->
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success btn-lg w-100" onclick="addNewAnalysis()">
                    <i class="bi bi-plus-circle"></i> Ajouter une autre analyse de variable
                </button>
            </div>
        </div>
        
        <!-- Análisis Generales del Dataset -->
        <div class="row mb-4">
            <div class="col-md-12">
                <h5 class="text-primary mb-3"><i class="bi bi-diagram-3"></i> Analyses Générales du Dataset</h5>
                <div class="btn-group d-flex flex-wrap mb-3" role="group">
                    <button class="btn btn-outline-info" onclick="generateGeneralAnalysis('correlation')">
                        <i class="bi bi-grid-3x3"></i> Matrice de Corrélation
                    </button>
                    <button class="btn btn-outline-warning" onclick="generateGeneralAnalysis('pca')">
                        <i class="bi bi-arrows-angle-contract"></i> Analyse PCA
                    </button>
                    <button class="btn btn-outline-success" onclick="generateRadarChart()">
                        <i class="bi bi-radar"></i> Gráfico Radar de Variables
                    </button>
                </div>
                <div id="generalAnalysisContainer">
                    <!-- Les analyses générales apparaîtront ici -->
                </div>
            </div>
        </div>
    `;
    
    // Info general compacta
    let generalInfo = `
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3">
                            <i class="bi bi-table text-primary" style="font-size: 1.5rem;"></i>
                            <h6 class="mt-2 mb-0">${rows.toLocaleString()} × ${cols}</h6>
                            <small class="text-muted">Dimensiones</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3">
                            <i class="bi bi-hdd text-success" style="font-size: 1.5rem;"></i>
                            <h6 class="mt-2 mb-0">${memoryUsage} MB</h6>
                            <small class="text-muted">Memoria</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3">
                            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 1.5rem;"></i>
                            <h6 class="mt-2 mb-0">${totalNulls.toLocaleString()}</h6>
                            <small class="text-muted">Valores Nulos</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3">
                            <i class="bi bi-percent text-info" style="font-size: 1.5rem;"></i>
                            <h6 class="mt-2 mb-0">${rows > 0 ? ((totalNulls / (rows * cols)) * 100).toFixed(2) : '0'}%</h6>
                            <small class="text-muted">Faltantes</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Análisis detallado (simplificado)
    let detailedAnalysis = `
        <div class="row mb-4">
            <div class="col-md-12">
                <h5 class="text-primary mb-3"><i class="bi bi-list-columns-reverse"></i> Información de Variables</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Variable</th>
                                <th>Tipo Python</th>
                                <th>Valores Únicos</th>
                                <th>Nulos</th>
                                <th>% Nulos</th>
                                <th>Estadísticas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${columns.map(col => {
                                const colStats = stats[col] || {};
                                const dtype = colStats.dtype || 'unknown';
                                const isNumeric = colStats.mean !== undefined;
                                
                                // Determinar el color y el icono según el tipo
                                let badgeClass = 'secondary';
                                let typeIcon = 'bi-question-circle';
                                let displayType = dtype;
                                let pythonType = 'object';
                                
                                if (dtype.includes('int64') || dtype.includes('int32') || dtype.includes('int16') || dtype.includes('int8') || dtype.includes('uint')) {
                                    badgeClass = 'success';
                                    typeIcon = 'bi-123';
                                    displayType = 'Numérico';
                                    pythonType = 'int';
                                } else if (dtype.includes('float64') || dtype.includes('float32') || dtype.includes('float16')) {
                                    badgeClass = 'success';
                                    typeIcon = 'bi-123';
                                    displayType = 'Numérico';
                                    pythonType = 'float';
                                } else if (dtype.includes('datetime')) {
                                    badgeClass = 'warning';
                                    typeIcon = 'bi-calendar-date';
                                    displayType = 'Fecha/Hora';
                                    pythonType = 'datetime';
                                } else if (dtype.includes('numeric (stored as text)')) {
                                    badgeClass = 'primary';
                                    typeIcon = 'bi-hash';
                                    displayType = 'Numérico (como texto)';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (URL)')) {
                                    badgeClass = 'info';
                                    typeIcon = 'bi-link-45deg';
                                    displayType = 'URL';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (Email)')) {
                                    badgeClass = 'info';
                                    typeIcon = 'bi-envelope';
                                    displayType = 'Email';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (ID/Code)')) {
                                    badgeClass = 'secondary';
                                    typeIcon = 'bi-upc';
                                    displayType = 'ID/Código';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (Boolean text)')) {
                                    badgeClass = 'danger';
                                    typeIcon = 'bi-toggle-on';
                                    displayType = 'Booleano (texto)';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (str)')) {
                                    badgeClass = 'info';
                                    typeIcon = 'bi-fonts';
                                    displayType = 'Texto';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (')) {
                                    // Extraer el tipo específico del paréntesis
                                    const match = dtype.match(/object \(([^)]+)\)/);
                                    badgeClass = 'info';
                                    typeIcon = 'bi-box';
                                    displayType = match ? match[1] : 'Objeto';
                                    pythonType = 'object';
                                } else if (dtype.includes('object')) {
                                    badgeClass = 'info';
                                    typeIcon = 'bi-fonts';
                                    displayType = 'Texto';
                                    pythonType = 'str';
                                } else if (dtype.includes('bool')) {
                                    badgeClass = 'danger';
                                    typeIcon = 'bi-toggle-on';
                                    displayType = 'Booleano';
                                    pythonType = 'bool';
                                } else if (isNumeric) {
                                    // Fallback para columnas numéricas que no coinciden con los patrones anteriores
                                    badgeClass = 'success';
                                    typeIcon = 'bi-123';
                                    displayType = 'Numérico';
                                    // Determinar si es int o float basándose en los valores de muestra
                                    const sampleValues = colStats.sample_values || [];
                                    const hasDecimals = sampleValues.some(val => val !== null && val !== undefined && val % 1 !== 0);
                                    pythonType = hasDecimals ? 'float' : 'int';
                                }
                                
                                return `
                                    <tr class="column-row" data-column="${col}" onclick="selectVariable('${col}', ${isNumeric})">
                                        <td>
                                            <strong>${col}</strong>
                                            <button class="btn btn-sm btn-outline-secondary ms-2" 
                                                onclick="event.stopPropagation(); renameColumn('${col}');" 
                                                title="Renombrar columna">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary ms-2" 
                                                onclick="event.stopPropagation(); openColumnSearchModal('${col}', ${dataset.id});" 
                                                title="Buscar en esta columna">
                                                <i class="bi bi-search"></i>
                                            </button>
                                        </td>
                                        <td>
                                            <span class="badge bg-${badgeClass}">
                                                <i class="bi ${typeIcon}"></i> ${pythonType}
                                            </span>
                                            <small class="text-muted d-block">${displayType}</small>
                                        </td>
                                        <td>${colStats.unique_count || 0}</td>
                                        <td>${colStats.null_count || 0}</td>
                                        <td>${colStats.null_percentage ? colStats.null_percentage.toFixed(1) : '0'}%</td>
                                        <td>
                                            ${isNumeric ? 
                                                `<small>
                                                    μ=${colStats.mean?.toFixed(2) || 'N/A'}, σ=${colStats.std?.toFixed(2) || 'N/A'}
                                                    ${colStats.decimals_info ? `<br>Decimales: ${colStats.decimals_info.most_common_decimals || 0}` : ''}
                                                    ${colStats.magnitude_info ? `<br>Magnitud: 10<sup>${colStats.magnitude_info.avg_magnitude}</sup>` : ''}
                                                </small>` : 
                                                `<small>${colStats.unique_count} valores únicos</small>`
                                            }
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); showUniqueValues('${col}')" title="Ver valores únicos">
                                                <i class="bi bi-list-ul"></i>
                                            </button>
                                            ${isNumeric ? `
                                                <button class="btn btn-sm btn-outline-warning ms-1" onclick="event.stopPropagation(); showOutliers('${col}')" title="Ver outliers">
                                                    <i class="bi bi-exclamation-triangle"></i>
                                                </button>
                                            ` : ''}
                                            <button class="btn btn-sm btn-outline-danger ms-1" onclick="event.stopPropagation(); deleteColumn('${col}')" title="Eliminar columna">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Combinar todo
    document.getElementById('datasetDetailContent').innerHTML = 
        descriptionsSection + dataPreview + variableSelector + generalInfo + detailedAnalysis;
    
    // Actualizar el botón de análisis para la primera variable
    setTimeout(() => {
        updateAnalysisButton(1);
    }, 100);
}

// Generar gráficos del dataset
function generateDatasetCharts(columns, stats) {
    // Destruir gráficos existentes
    Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
    });
    charts = {};
    
    // Gráfico de tipos de datos
    const dataTypes = {};
    columns.forEach(col => {
        const colStats = stats[col] || {};
        const dtype = colStats.dtype || 'unknown';
        const isNumeric = colStats.mean !== undefined;
        const type = dtype.includes('float') || dtype.includes('int') || dtype.includes('uint') || isNumeric ? 'Numérico' : 
                     dtype.includes('object') ? 'Texto' : 
                     dtype.includes('datetime') ? 'Fecha' : 'Otro';
        dataTypes[type] = (dataTypes[type] || 0) + 1;
    });
    
    const ctx1 = document.getElementById('dataTypesChart');
    if (ctx1) {
        charts.dataTypes = new Chart(ctx1, {
            type: 'pie',
            data: {
                labels: Object.keys(dataTypes),
                datasets: [{
                    data: Object.values(dataTypes),
                    backgroundColor: ['#10b981', '#3b82f6', '#a855f7', '#f59e0b']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#f0f9ff' }
                    }
                }
            }
        });
    }
    
    // Gráfico de datos faltantes
    const nullData = columns.map(col => stats[col]?.null_percentage || 0);
    const ctx2 = document.getElementById('missingDataChart');
    if (ctx2) {
        charts.missingData = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: columns,
                datasets: [{
                    label: 'Porcentaje de valores nulos',
                    data: nullData,
                    backgroundColor: 'rgba(239, 68, 68, 0.5)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { color: '#f0f9ff' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    x: {
                        ticks: { 
                            color: '#f0f9ff',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
    
    // Gráficos individuales por columna
    columns.forEach((col, index) => {
        const colStats = stats[col];
        if (!colStats) return;
        
        const canvasId = `chart_${index}_${col.replace(/[^a-zA-Z0-9]/g, '_')}`;
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        
        if (colStats.histogram) {
            // Histograma para datos numéricos
            const bins = colStats.histogram.bins;
            const counts = colStats.histogram.counts;
            const labels = [];
            for (let i = 0; i < bins.length - 1; i++) {
                labels.push(`${bins[i].toFixed(1)}-${bins[i+1].toFixed(1)}`);
            }
            
            charts[canvasId] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frecuencia',
                        data: counts,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#f0f9ff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#f0f9ff',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        } else if (colStats.top_values) {
            // Gráfico de barras para datos categóricos
            charts[canvasId] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: colStats.top_values.values,
                    datasets: [{
                        label: 'Frecuencia',
                        data: colStats.top_values.counts,
                        backgroundColor: 'rgba(16, 185, 129, 0.5)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#f0f9ff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#f0f9ff',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    });
}

// Generar histograma para variable seleccionada
// Function to add new analysis section
function addNewAnalysis() {
    analysisCount++;
    const data = window.currentDatasetData;
    const columns = data.columns || [];
    const stats = data.stats || {};
    
    const newAnalysisHTML = `
        <div class="card bg-dark border-primary mb-3 analysis-card" data-analysis-id="${analysisCount}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="text-info mb-0">Analyse ${analysisCount}</h6>
                    <button class="btn btn-sm btn-danger" onclick="removeAnalysis(${analysisCount})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <label for="variableSelect${analysisCount}" class="form-label text-info">Sélectionner Variable:</label>
                        <select class="form-select variable-select" id="variableSelect${analysisCount}" data-analysis-id="${analysisCount}" onchange="updateAnalysisButton(${analysisCount})">
                            <option value="">-- Sélectionnez une variable --</option>
                            ${columns.map(col => {
                                const colStats = stats[col] || {};
                                const dtype = colStats.dtype || 'unknown';
                                const isNumeric = colStats.mean !== undefined;
                                
                                let typeLabel = dtype;
                                if (dtype.includes('int') || dtype.includes('float') || dtype.includes('uint')) {
                                    typeLabel = '📊 Numérique';
                                } else if (dtype.includes('datetime')) {
                                    typeLabel = '📅 Date/Heure';
                                } else if (dtype.includes('numeric (stored as text)')) {
                                    typeLabel = '🔢 Numérique (texte)';
                                } else if (isNumeric) {
                                    typeLabel = '📊 Numérique';
                                } else if (dtype.includes('object')) {
                                    typeLabel = '📝 Texte';
                                }
                                
                                return `<option value="${col}" data-numeric="${isNumeric}" data-dtype="${dtype}">${col} - ${typeLabel}</option>`;
                            }).join('')}
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <select class="form-select" id="analysisType${analysisCount}" onchange="updateAnalysisButton(${analysisCount})">
                            <option value="histogram">Histogramme</option>
                            <option value="pie">Gráfico Circular (Pie Chart)</option>
                            <option value="outlier_map" class="numeric-only">Carte des Outliers</option>
                            <option value="boxplot" class="numeric-only">Box Plot</option>
                            <option value="scatter" class="numeric-only">Scatter Plot (2 variables)</option>
                            <option value="lasso" class="numeric-only">LASSO (Sélection de variables)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="includeOutliers${analysisCount}" checked onchange="handleOutliersChange(${analysisCount})">
                            <label class="form-check-label text-info" for="includeOutliers${analysisCount}">
                                Inclure outliers
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" id="analysisButton${analysisCount}" onclick="executeAnalysis(${analysisCount})">
                            <i class="bi bi-graph-up"></i> Générer
                        </button>
                    </div>
                </div>
                <div class="row mt-2" id="histogramConfig${analysisCount}" style="display: none;">
                    <div class="col-md-4">
                        <label for="numBins${analysisCount}" class="form-label text-info small">Nombre d'intervalles:</label>
                        <input type="number" class="form-control form-control-sm" id="numBins${analysisCount}" value="20" min="5" max="50" onchange="updateHistogramBins(${analysisCount})">
                    </div>
                    <div class="col-md-4">
                        <label for="binMin${analysisCount}" class="form-label text-info small">Valeur minimale:</label>
                        <input type="number" class="form-control form-control-sm" id="binMin${analysisCount}" step="any" onchange="updateHistogramBins(${analysisCount})">
                    </div>
                    <div class="col-md-4">
                        <label for="binMax${analysisCount}" class="form-label text-info small">Valeur maximale:</label>
                        <input type="number" class="form-control form-control-sm" id="binMax${analysisCount}" step="any" onchange="updateHistogramBins(${analysisCount})">
                    </div>
                </div>
                <div class="mt-4" id="histogramContainer${analysisCount}" style="display: none;">
                    <canvas id="variableHistogram${analysisCount}" height="400"></canvas>
                </div>
                <div class="mt-3" id="variableStats${analysisCount}" style="display: none;">
                    <!-- Les statistiques de la variable sélectionnée apparaîtront ici -->
                </div>
                <div class="mt-3" id="analysisResultContainer${analysisCount}">
                    <!-- Les résultats des analyses avancées apparaîtront ici -->
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('analysisContainer').insertAdjacentHTML('beforeend', newAnalysisHTML);
}

// Function to remove an analysis
function removeAnalysis(analysisId) {
    const analysisCard = document.querySelector(`[data-analysis-id="${analysisId}"]`);
    if (analysisCard) {
        // Destroy chart if exists
        if (analysisCharts[analysisId]) {
            analysisCharts[analysisId].destroy();
            delete analysisCharts[analysisId];
        }
        // Remove data
        delete analysisData[analysisId];
        // Remove DOM element
        analysisCard.remove();
    }
}

// Nueva función para actualizar el botón según el tipo de análisis
function updateAnalysisButton(analysisId) {
    const variableSelect = document.getElementById(`variableSelect${analysisId}`);
    const analysisTypeSelect = document.getElementById(`analysisType${analysisId}`);
    const selectedOption = variableSelect.options[variableSelect.selectedIndex];
    const isNumeric = selectedOption && selectedOption.getAttribute('data-numeric') === 'true';
    
    // Mostrar/ocultar opciones según el tipo de variable
    const numericOptions = analysisTypeSelect.querySelectorAll('.numeric-only');
    const textOptions = analysisTypeSelect.querySelectorAll('.text-only');
    
    numericOptions.forEach(option => {
        option.style.display = isNumeric ? 'block' : 'none';
    });
    
    textOptions.forEach(option => {
        option.style.display = !isNumeric ? 'block' : 'none';
    });
    
    // Si la opción seleccionada no es válida para el tipo de variable, cambiar a histograma
    const selectedAnalysis = analysisTypeSelect.value;
    if (!isNumeric && ['outlier_map', 'boxplot', 'scatter', 'lasso'].includes(selectedAnalysis)) {
        analysisTypeSelect.value = 'histogram';
    }
    // Ya no restringimos pie chart para variables numéricas
}

// Nueva función para ejecutar el análisis seleccionado
function handleOutliersChange(analysisId) {
    // Si ya hay un gráfico generado, regenerarlo con la nueva configuración
    const analysisType = document.getElementById(`analysisType${analysisId}`).value;
    const selectedVariable = document.getElementById(`variableSelect${analysisId}`).value;
    
    if (selectedVariable && analysisType === 'histogram') {
        generateHistogram(analysisId);
    }
}

// Función para actualizar el histograma cuando se cambian los bins
function updateHistogramBins(analysisId) {
    const analysisType = document.getElementById(`analysisType${analysisId}`).value;
    const select = document.getElementById(`variableSelect${analysisId}`);
    
    if (!select || select.selectedIndex < 0) {
        console.error('No variable selected for analysis', analysisId);
        return;
    }
    
    const selectedVariable = select.value;
    const selectedOption = select.options[select.selectedIndex];
    const isNumeric = selectedOption && selectedOption.getAttribute('data-numeric') === 'true';
    
    if (selectedVariable && analysisType === 'histogram') {
        // Para variables categóricas, regenerar con los datos guardados
        if (!isNumeric) {
            // Si tenemos los datos guardados, usarlos
            if (window[`categoricalData_${analysisId}`] && window[`categoricalData_${analysisId}`].allData) {
                const data = window[`categoricalData_${analysisId}`];
                const colStats = window.currentDatasetData.stats[selectedVariable] || {};
                generateCategoricalHistogramWithData(analysisId, data.selectedVariable, data.allData, colStats);
            } else {
                // Si no, regenerar todo el histograma
                generateHistogram(analysisId);
            }
        } else {
            // Para variables numéricas, regenerar normalmente
            generateHistogram(analysisId);
        }
    }
}

function executeAnalysis(analysisId) {
    const analysisType = document.getElementById(`analysisType${analysisId}`).value;
    
    switch(analysisType) {
        case 'histogram':
            generateHistogram(analysisId);
            break;
        case 'pie':
            generatePieChart(analysisId);
            break;
        case 'outlier_map':
        case 'boxplot':
        case 'scatter':
            generateAdvancedAnalysis(analysisId, analysisType);
            break;
        case 'lasso':
            generateLassoForVariable(analysisId);
            break;
        default:
            generateHistogram(analysisId);
    }
}

// Función para generar gráfico circular (pie chart) para cualquier tipo de variable
function generatePieChart(analysisId) {
    const select = document.getElementById(`variableSelect${analysisId}`);
    const selectedVariable = select.value;
    const selectedOption = select.options[select.selectedIndex];
    const isNumeric = selectedOption && selectedOption.getAttribute('data-numeric') === 'true';
    
    if (!selectedVariable) {
        showNotification('Error', 'Por favor selecciona una variable', 'warning');
        return;
    }
    
    const data = window.currentDatasetData;
    if (!data || !data.stats) {
        showNotification('Error', 'No hay datos disponibles', 'error');
        return;
    }
    
    const colStats = data.stats[selectedVariable];
    const container = document.getElementById(`analysisResultContainer${analysisId}`);
    
    // Si no hay estadísticas para esta columna
    if (!colStats) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> No hay estadísticas disponibles para esta variable
            </div>
        `;
        return;
    }
    
    // Para variables numéricas, necesitamos agrupar los valores
    if (isNumeric) {
        generateNumericPieChart(analysisId, selectedVariable, colStats, container);
        return;
    }
    
    // Verificar que hay un dataset seleccionado
    if (!window.selectedDataset || !window.selectedDataset.id) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> No hay dataset seleccionado
            </div>
        `;
        return;
    }
    
    // Para variables categóricas, siempre obtener los datos completos de la columna
    // para tener el conteo real de valores únicos
    fetch(`/api/datasets/${window.selectedDataset.id}/columns/${encodeURIComponent(selectedVariable)}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(detailData => {
            if (detailData && !detailData.error) {
                // Usar value_counts_complete si está disponible, sino usar value_counts
                let valueCountsObj = detailData.value_counts_complete || detailData.value_counts || {};
                
                // Si no hay value_counts pero hay frequency_data, usarlo
                if (Object.keys(valueCountsObj).length === 0 && detailData.frequency_data) {
                    valueCountsObj = {};
                    detailData.frequency_data.forEach(item => {
                        if (item.value !== 'null') {
                            valueCountsObj[item.value] = item.count;
                        }
                    });
                }
                
                // Si aún no hay datos, intentar con los stats originales
                if (Object.keys(valueCountsObj).length === 0 && colStats) {
                    if (colStats.value_counts) {
                        valueCountsObj = colStats.value_counts;
                    } else if (colStats.categories) {
                        valueCountsObj = colStats.categories;
                    } else if (colStats.top_values) {
                        // Convertir el formato top_values a un objeto de conteo
                        valueCountsObj = {};
                        if (colStats.top_values.values && colStats.top_values.counts) {
                            colStats.top_values.values.forEach((val, idx) => {
                                valueCountsObj[val] = colStats.top_values.counts[idx];
                            });
                        }
                    }
                }
                
                if (Object.keys(valueCountsObj).length > 0) {
                    // Usar los value_counts del endpoint detallado
                    const sortedEntries = Object.entries(valueCountsObj).sort((a, b) => b[1] - a[1]);
                    // Agregar información sobre el número real de valores únicos
                    // Primero del detailData, luego de colStats, luego de sortedEntries
                    const uniqueCount = detailData.unique_count || colStats?.unique_count || sortedEntries.length;
                    generatePieChartWithData(analysisId, selectedVariable, sortedEntries, null, uniqueCount);
                } else {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> No hay datos de frecuencia disponibles para esta variable
                        </div>
                    `;
                }
            } else {
                // Si hay error, mostrar el mensaje específico
                const errorMsg = detailData?.error || 'No hay datos disponibles para esta variable';
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> ${errorMsg}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching column details:', error);
            // Si falla la petición detallada, intentar usar los datos de colStats
            if (colStats && (colStats.categories || colStats.top_values || colStats.value_counts)) {
                let valueCountsObj = {};
                
                if (colStats.value_counts) {
                    valueCountsObj = colStats.value_counts;
                } else if (colStats.categories) {
                    valueCountsObj = colStats.categories;
                } else if (colStats.top_values) {
                    colStats.top_values.values.forEach((val, idx) => {
                        valueCountsObj[val] = colStats.top_values.counts[idx];
                    });
                }
                
                if (Object.keys(valueCountsObj).length > 0) {
                    const sortedEntries = Object.entries(valueCountsObj).sort((a, b) => b[1] - a[1]);
                    const uniqueCount = colStats.unique_count || sortedEntries.length;
                    generatePieChartWithData(analysisId, selectedVariable, sortedEntries, null, uniqueCount);
                    return;
                }
            }
            
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> Error al obtener datos: ${error.message}
                </div>
            `;
        });
}

// Función auxiliar para generar el pie chart con datos
function generatePieChartWithData(analysisId, selectedVariable, sortedEntries, maxSlices = null, totalUniqueCount = null) {
    const container = document.getElementById(`analysisResultContainer${analysisId}`);
    
    // Usar el conteo real de valores únicos si está disponible, sino usar la longitud de sortedEntries
    const totalUnique = totalUniqueCount || sortedEntries.length;
    
    // Lógica inteligente para determinar el valor inicial
    if (maxSlices === null) {
        
        if (totalUnique <= 10) {
            // Si hay 10 o menos valores, mostrar todos
            maxSlices = totalUnique;
        } else if (totalUnique <= 20) {
            // Entre 11-20 valores, mostrar 10
            maxSlices = 10;
        } else if (totalUnique <= 50) {
            // Entre 21-50 valores, mostrar 15
            maxSlices = 15;
        } else if (totalUnique <= 100) {
            // Entre 51-100 valores, mostrar 20
            maxSlices = 20;
        } else {
            // Más de 100 valores, mostrar 25
            maxSlices = 25;
        }
    }
    
    // Asegurar que maxSlices no exceda el total de entradas
    maxSlices = Math.min(maxSlices, sortedEntries.length);
    
    // Guardar todos los datos para poder regenerar el gráfico
    window[`pieChartData_${analysisId}`] = {
        selectedVariable,
        sortedEntries,
        currentMax: maxSlices,
        totalUnique: totalUnique
    };
    
    let topEntries;
    let othersCount = 0;
    
    // Si maxSlices es mayor o igual al total de entradas, mostrar todo sin agrupar
    if (maxSlices >= sortedEntries.length) {
        topEntries = sortedEntries;
    } else {
        topEntries = sortedEntries.slice(0, maxSlices);
        // Solo agrupar como "Otros" si hay límite
        for (let i = maxSlices; i < sortedEntries.length; i++) {
            othersCount += sortedEntries[i][1];
        }
        if (othersCount > 0) {
            topEntries.push(['Otros', othersCount]);
        }
    }
    
    const labels = topEntries.map(([value, _]) => String(value).substring(0, 30) + (String(value).length > 30 ? '...' : ''));
    const values = topEntries.map(([_, count]) => count);
    const total = values.reduce((a, b) => a + b, 0);
    
    // Generar colores aleatorios pero agradables
    const colors = topEntries.map((_, i) => {
        const hue = (i * 360 / topEntries.length) % 360;
        return `hsl(${hue}, 70%, 50%)`;
    });
    
    // Crear el contenedor del gráfico
    container.innerHTML = `
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <h6 class="mb-0 text-info">
                    <i class="bi bi-pie-chart"></i> Gráfico Circular - ${selectedVariable}
                </h6>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="d-flex align-items-center gap-3">
                            <label class="text-muted mb-0">Mostrar top:</label>
                            <input type="number" 
                                   id="pieSliceCount${analysisId}" 
                                   class="form-control form-control-sm" 
                                   style="width: 80px;" 
                                   value="${maxSlices}" 
                                   min="3" 
                                   max="${totalUnique}"
                                   onchange="updatePieChart(${analysisId})">
                            <span class="text-muted">valores (de ${totalUnique} únicos)</span>
                            <div class="ms-auto">
                                ${maxSlices < totalUnique && maxSlices < sortedEntries.length ? `
                                    <button class="btn btn-sm btn-outline-success" onclick="showAllInPie(${analysisId})">
                                        <i class="bi bi-pie-chart-fill"></i> Mostrar todos
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm btn-outline-primary" onclick="showAllPieValues(${analysisId})">
                                    <i class="bi bi-list-ul"></i> Ver lista completa
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <canvas id="pieChart${analysisId}" style="max-height: 400px;"></canvas>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-info">
                            <strong>Estadísticas:</strong><br>
                            Total de valores: ${total}<br>
                            Valores únicos: ${totalUnique}<br>
                            Mostrando: ${maxSlices >= totalUnique ? 'Todos los' : `Top ${maxSlices}`} valores
                            ${totalUnique > maxSlices ? `<br>Agrupados como "Otros": ${totalUnique - maxSlices} valores` : ''}
                        </div>
                        <div class="mt-3">
                            <h6>${maxSlices >= sortedEntries.length ? 'Todos los' : `Top ${maxSlices}`} valores:</h6>
                            <div id="pieValuesList${analysisId}" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead style="position: sticky; top: 0; background: #1a1a1a;">
                                        <tr>
                                            <th>Valor</th>
                                            <th>Cantidad</th>
                                            <th>%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${topEntries.map(([value, count], idx) => `
                                            <tr>
                                                <td title="${value}">
                                                    <span class="badge" style="background-color: ${colors[idx]}; color: white;">
                                                        ${idx + 1}
                                                    </span>
                                                    ${String(value).substring(0, 20)}${String(value).length > 20 ? '...' : ''}
                                                </td>
                                                <td>${count}</td>
                                                <td>${((count/total)*100).toFixed(1)}%</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Crear el gráfico
    setTimeout(() => {
        const ctx = document.getElementById(`pieChart${analysisId}`).getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderColor: '#1a1a1a',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: topEntries.length > 20 ? 'bottom' : 'right',
                        labels: {
                            color: '#f0f9ff',
                            font: {
                                size: topEntries.length > 30 ? 9 : 11
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const value = dataset.data[i];
                                        const percentage = ((value/total)*100).toFixed(1);
                                        // Si hay muchos valores, solo mostrar porcentaje en valores significativos
                                        const showPercentage = topEntries.length <= 30 || percentage >= 1;
                                        return {
                                            text: showPercentage ? `${label} (${percentage}%)` : label,
                                            fillStyle: dataset.backgroundColor[i],
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        },
                        display: topEntries.length <= 50 // Ocultar leyenda si hay demasiados valores
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const percentage = ((value/total)*100).toFixed(2);
                                const fullLabel = topEntries[context.dataIndex][0];
                                return [
                                    `${fullLabel}`,
                                    `Cantidad: ${value}`,
                                    `Porcentaje: ${percentage}%`
                                ];
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: `Distribución de ${selectedVariable}`,
                        color: '#f0f9ff'
                    }
                }
            }
        });
    }, 100);
}

// Función para generar pie chart para variables numéricas
async function generateNumericPieChart(analysisId, selectedVariable, colStats, container) {
    // Mostrar loading
    container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p>Procesando valores numéricos...</p></div>';
    
    try {
        // Obtener los datos detallados de la columna
        const response = await fetch(`/api/datasets/${window.selectedDataset.id}/columns/${encodeURIComponent(selectedVariable)}/`);
        const detailData = await response.json();
        
        if (detailData && !detailData.error) {
            // Usar value_counts_complete si está disponible, sino usar value_counts
            let valueCountsObj = detailData.value_counts_complete || detailData.value_counts || {};
            
            // Si no hay value_counts pero hay frequency_data, usarlo
            if (Object.keys(valueCountsObj).length === 0 && detailData.frequency_data) {
                valueCountsObj = {};
                detailData.frequency_data.forEach(item => {
                    if (item.value !== 'null') {
                        valueCountsObj[item.value] = item.count;
                    }
                });
            }
            
            // Si tenemos muchos valores únicos, agrupar por rangos
            const uniqueValues = Object.keys(valueCountsObj).length;
            
            if (uniqueValues > 100) {
                // Agrupar en rangos para valores numéricos
                const numericValues = Object.entries(valueCountsObj)
                    .map(([val, count]) => ({
                        value: parseFloat(val),
                        count: count
                    }))
                    .filter(item => !isNaN(item.value));
                
                if (numericValues.length > 0) {
                    const min = Math.min(...numericValues.map(v => v.value));
                    const max = Math.max(...numericValues.map(v => v.value));
                    const range = max - min;
                    const numBins = Math.min(20, Math.ceil(Math.sqrt(numericValues.length)));
                    const binSize = range / numBins;
                    
                    // Crear bins
                    const bins = {};
                    for (let i = 0; i < numBins; i++) {
                        const binMin = min + (i * binSize);
                        const binMax = i === numBins - 1 ? max + 0.001 : min + ((i + 1) * binSize);
                        const binLabel = `${binMin.toFixed(2)} - ${binMax.toFixed(2)}`;
                        bins[binLabel] = 0;
                    }
                    
                    // Asignar valores a bins
                    numericValues.forEach(item => {
                        const binIndex = Math.min(Math.floor((item.value - min) / binSize), numBins - 1);
                        const binMin = min + (binIndex * binSize);
                        const binMax = binIndex === numBins - 1 ? max + 0.001 : min + ((binIndex + 1) * binSize);
                        const binLabel = `${binMin.toFixed(2)} - ${binMax.toFixed(2)}`;
                        bins[binLabel] += item.count;
                    });
                    
                    // Convertir bins a formato de entrada para el pie chart
                    const sortedEntries = Object.entries(bins)
                        .filter(([_, count]) => count > 0)
                        .sort((a, b) => {
                            // Ordenar por el valor mínimo del rango
                            const aMin = parseFloat(a[0].split(' - ')[0]);
                            const bMin = parseFloat(b[0].split(' - ')[0]);
                            return aMin - bMin;
                        });
                    
                    generatePieChartWithData(analysisId, selectedVariable + ' (Agrupado en rangos)', sortedEntries);
                } else {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> No se pudieron procesar los valores numéricos
                        </div>
                    `;
                }
            } else {
                // Si hay pocos valores únicos, usar directamente
                const sortedEntries = Object.entries(valueCountsObj).sort((a, b) => b[1] - a[1]);
                generatePieChartWithData(analysisId, selectedVariable, sortedEntries);
            }
        } else {
            container.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> No hay datos de frecuencia disponibles para esta variable
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Error al obtener datos: ${error.message}
            </div>
        `;
    }
}

// Función para actualizar el pie chart con un nuevo número de elementos
function updatePieChart(analysisId) {
    const newMax = parseInt(document.getElementById(`pieSliceCount${analysisId}`).value);
    const data = window[`pieChartData_${analysisId}`];
    
    if (data && newMax >= 3) {
        generatePieChartWithData(analysisId, data.selectedVariable, data.sortedEntries, newMax, data.totalUnique);
    }
}

// Función para mostrar todos los valores en el gráfico
function showAllInPie(analysisId) {
    const data = window[`pieChartData_${analysisId}`];
    if (!data) return;
    
    // Actualizar el input y regenerar el gráfico con todos los valores
    document.getElementById(`pieSliceCount${analysisId}`).value = data.sortedEntries.length;
    generatePieChartWithData(analysisId, data.selectedVariable, data.sortedEntries, data.sortedEntries.length, data.totalUnique);
}

// Función para mostrar todos los valores en un modal
function showAllPieValues(analysisId) {
    const data = window[`pieChartData_${analysisId}`];
    if (!data) return;
    
    const total = data.sortedEntries.reduce((sum, [_, count]) => sum + count, 0);
    
    // Crear modal con todos los valores
    const modalHtml = `
        <div class="modal fade" id="allValuesModal${analysisId}" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title">Todos los valores de ${data.selectedVariable} (${data.sortedEntries.length} únicos)</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <input type="text" 
                                   class="form-control" 
                                   id="searchValues${analysisId}" 
                                   placeholder="Buscar valor..."
                                   onkeyup="filterPieValues(${analysisId})">
                        </div>
                        <div style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-sm table-hover" id="allValuesTable${analysisId}">
                                <thead style="position: sticky; top: 0; background: #1a1a1a;">
                                    <tr>
                                        <th>#</th>
                                        <th>Valor</th>
                                        <th>Cantidad</th>
                                        <th>Porcentaje</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.sortedEntries.map(([value, count], idx) => `
                                        <tr data-value="${value}">
                                            <td>${idx + 1}</td>
                                            <td title="${value}">${String(value).substring(0, 50)}${String(value).length > 50 ? '...' : ''}</td>
                                            <td>${count}</td>
                                            <td>${((count/total)*100).toFixed(2)}%</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-info" 
                                                        onclick="focusOnValue(${analysisId}, ${idx})">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <span class="me-auto text-muted">Total: ${total} valores</span>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal anterior si existe
    const existingModal = document.getElementById(`allValuesModal${analysisId}`);
    if (existingModal) {
        existingModal.remove();
    }
    
    // Agregar nuevo modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById(`allValuesModal${analysisId}`));
    modal.show();
}

// Función para filtrar valores en el modal
function filterPieValues(analysisId) {
    const searchText = document.getElementById(`searchValues${analysisId}`).value.toLowerCase();
    const rows = document.querySelectorAll(`#allValuesTable${analysisId} tbody tr`);
    
    rows.forEach(row => {
        const value = row.getAttribute('data-value').toLowerCase();
        row.style.display = value.includes(searchText) ? '' : 'none';
    });
}

// Función para enfocar en un valor específico
function focusOnValue(analysisId, valueIndex) {
    // Cerrar el modal
    const modal = bootstrap.Modal.getInstance(document.getElementById(`allValuesModal${analysisId}`));
    if (modal) modal.hide();
    
    // Actualizar el gráfico para mostrar desde ese valor
    const newMax = Math.min(valueIndex + 15, window[`pieChartData_${analysisId}`].sortedEntries.length);
    document.getElementById(`pieSliceCount${analysisId}`).value = newMax;
    updatePieChart(analysisId);
    
    // Hacer scroll al gráfico
    document.getElementById(`analysisResultContainer${analysisId}`).scrollIntoView({ behavior: 'smooth' });
}

// Función para generar análisis avanzados (boxplot, scatter, outlier_map)
async function generateAdvancedAnalysis(analysisId, analysisType) {
    const select = document.getElementById(`variableSelect${analysisId}`);
    const selectedVariable = select.value;
    const includeOutliers = document.getElementById(`includeOutliers${analysisId}`).checked;
    
    if (!selectedVariable) {
        showNotification('Error', 'Por favor selecciona una variable', 'warning');
        return;
    }
    
    const currentDataset = window.selectedDataset;
    if (!currentDataset || !currentDataset.id) {
        showNotification('Error', 'No hay dataset seleccionado', 'error');
        return;
    }
    
    const container = document.getElementById(`analysisResultContainer${analysisId}`);
    container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p>Generando análisis...</p></div>';
    
    try {
        // Usar el endpoint correcto según urls.py
        const url = `/api/datasets/${currentDataset.id}/columns/${encodeURIComponent(selectedVariable)}/analysis/`;
        
        // Preparar el body de la petición
        const requestBody = {
            analysis_type: analysisType,
            include_outliers: includeOutliers
        };
        
        // Para scatter plot, necesitamos una segunda variable
        if (analysisType === 'scatter') {
            const secondVariable = await selectSecondVariable(analysisId);
            if (!secondVariable) return;
            requestBody.second_variable = secondVariable;
        }
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Error al generar el análisis');
        }
        
        // Mostrar el resultado
        displayAdvancedAnalysisResult(analysisId, data, analysisType);
        
    } catch (error) {
        container.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> ${error.message}</div>`;
    }
}

// Función para seleccionar segunda variable para scatter plot
async function selectSecondVariable(analysisId) {
    const currentVariable = document.getElementById(`variableSelect${analysisId}`).value;
    const columns = Object.keys(window.currentDatasetData.stats || {});
    const numericColumns = columns.filter(col => {
        const stats = window.currentDatasetData.stats[col];
        return stats && stats.mean !== undefined && col !== currentVariable;
    });
    
    if (numericColumns.length === 0) {
        showNotification('Error', 'No hay otras variables numéricas disponibles', 'error');
        return null;
    }
    
    // Crear un modal simple para seleccionar la segunda variable
    const modalHtml = `
        <div class="modal fade" id="secondVariableModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title">Seleccionar segunda variable</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <label class="form-label">Variable Y para el scatter plot:</label>
                        <select class="form-select" id="secondVariableSelect">
                            ${numericColumns.map(col => `<option value="${col}">${col}</option>`).join('')}
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="confirmSecondVariable">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Agregar modal al body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('secondVariableModal'));
    
    return new Promise((resolve) => {
        document.getElementById('confirmSecondVariable').onclick = () => {
            const selected = document.getElementById('secondVariableSelect').value;
            modal.hide();
            document.getElementById('secondVariableModal').remove();
            resolve(selected);
        };
        
        document.getElementById('secondVariableModal').addEventListener('hidden.bs.modal', () => {
            document.getElementById('secondVariableModal').remove();
            resolve(null);
        });
        
        modal.show();
    });
}

// Función para mostrar resultados de análisis avanzados
function displayAdvancedAnalysisResult(analysisId, data, analysisType) {
    const container = document.getElementById(`analysisResultContainer${analysisId}`);
    
    let content = `
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <h6 class="mb-0 text-info">
                    <i class="bi bi-graph-up"></i> ${getAnalysisTitle(analysisType)} - ${data.column}
                </h6>
            </div>
            <div class="card-body">
    `;
    
    // Mostrar imagen si existe
    const imageUrl = data.data?.plot || data.plot || data.image;
    if (imageUrl) {
        content += `<img src="${imageUrl}" class="img-fluid mb-3" alt="${analysisType}">`;
    }
    
    // Mostrar estadísticas según el tipo
    if (data.statistics) {
        content += '<div class="alert alert-info">';
        
        switch(analysisType) {
            case 'boxplot':
                content += `
                    <strong>Estadísticas del Box Plot:</strong><br>
                    Q1 (25%): ${data.statistics.q1?.toFixed(2) || 'N/A'}<br>
                    Mediana (50%): ${data.statistics.median?.toFixed(2) || 'N/A'}<br>
                    Q3 (75%): ${data.statistics.q3?.toFixed(2) || 'N/A'}<br>
                    IQR: ${data.statistics.iqr?.toFixed(2) || 'N/A'}<br>
                    Outliers: ${data.statistics.n_outliers || 0}
                `;
                break;
                
            case 'outlier_map':
                content += `
                    <strong>Análisis de Outliers:</strong><br>
                    Total de valores: ${data.statistics.total_values || 0}<br>
                    Outliers detectados: ${data.statistics.n_outliers || 0} (${data.statistics.outlier_percentage?.toFixed(1) || 0}%)<br>
                    Método: ${data.statistics.method || 'IQR'}
                `;
                break;
                
            case 'scatter':
                content += `
                    <strong>Análisis de Correlación:</strong><br>
                    Variable X: ${data.column}<br>
                    Variable Y: ${data.second_column || 'N/A'}<br>
                    Correlación: ${data.statistics.correlation?.toFixed(3) || 'N/A'}<br>
                    Puntos: ${data.statistics.n_points || 0}
                `;
                break;
        }
        
        content += '</div>';
    }
    
    content += `
            </div>
        </div>
    `;
    
    container.innerHTML = content;
}

// Función auxiliar para obtener título del análisis
function getAnalysisTitle(analysisType) {
    const titles = {
        'boxplot': 'Box Plot',
        'outlier_map': 'Mapa de Outliers',
        'scatter': 'Scatter Plot',
        'histogram': 'Histograma'
    };
    return titles[analysisType] || analysisType;
}

// Nueva función para generar análisis LASSO con variable objetivo específica
async function generateLassoForVariable(analysisId) {
    const select = document.getElementById(`variableSelect${analysisId}`);
    const targetVariable = select.value;
    
    if (!targetVariable) {
        showNotification('Erreur', 'Veuillez sélectionner une variable cible', 'warning');
        return;
    }
    
    const currentDataset = window.selectedDataset;
    if (!currentDataset || !currentDataset.id) {
        showNotification('Erreur', 'Aucun dataset sélectionné', 'error');
        return;
    }
    
    try {
        const url = `/api/datasets/${currentDataset.id}/analysis/?type=lasso&target=${encodeURIComponent(targetVariable)}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Erreur lors de la génération de l\'analyse LASSO');
        }
        
        // Mostrar el análisis LASSO
        displayLassoAnalysisForVariable(analysisId, data);
        
    } catch (error) {
        showNotification('Erreur', error.message, 'error');
    }
}

// Función para mostrar el análisis LASSO para una variable
function displayLassoAnalysisForVariable(analysisId, data) {
    const container = document.getElementById(`analysisResultContainer${analysisId}`);
    if (!container) return;
    
    let content = `
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <h6 class="mb-0 text-info">
                    <i class="bi bi-funnel"></i> 
                    LASSO - Prédire ${data.target_column}
                </h6>
            </div>
            <div class="card-body">
                <img src="${data.image}" class="img-fluid" alt="lasso">
                <div class="mt-3">
                    <div class="alert alert-info">
                        <strong>Variable cible:</strong> ${data.target_column}
                        <br>
                        <strong>Meilleur Alpha:</strong> ${data.statistics.best_alpha.toExponential(2)}
                        <br>
                        <strong>Score R²:</strong> ${data.statistics.best_score.toFixed(3)}
                        <br>
                        <strong>Variables sélectionnées:</strong> ${data.statistics.n_features_selected} sur ${data.statistics.total_features}
                    </div>
                    
                    <h6 class="text-info">Variables Importantes pour prédire ${data.target_column}:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Variable</th>
                                    <th>Coefficient</th>
                                    <th>Impact</th>
                                </tr>
                            </thead>
                            <tbody>
    `;
    
    data.statistics.selected_features.forEach(([feature, coef]) => {
        const color = coef > 0 ? 'text-success' : 'text-danger';
        const impact = Math.abs(coef) > 0.5 ? 'Fort' : (Math.abs(coef) > 0.1 ? 'Moyen' : 'Faible');
        content += `
            <tr>
                <td>${feature}</td>
                <td class="${color}">${coef.toFixed(4)}</td>
                <td>${impact}</td>
            </tr>
        `;
    });
    
    content += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = content;
}

function generateHistogram(analysisId) {
    const select = document.getElementById(`variableSelect${analysisId}`);
    const selectedVariable = select.value;
    const includeOutliers = document.getElementById(`includeOutliers${analysisId}`).checked;
    
    if (!selectedVariable) {
        showNotification('Erreur', 'Veuillez sélectionner une variable', 'warning');
        return;
    }
    
    const data = window.currentDatasetData;
    if (!data || !data.stats) {
        showNotification('Erreur', 'Aucune donnée disponible', 'error');
        return;
    }
    
    const colStats = data.stats[selectedVariable];
    const isNumeric = select.options[select.selectedIndex].getAttribute('data-numeric') === 'true';
    
    // Mostrar contenedor
    document.getElementById(`histogramContainer${analysisId}`).style.display = 'block';
    document.getElementById(`variableStats${analysisId}`).style.display = 'block';
    
    // Mostrar controles de configuración para histogramas numéricos
    if (isNumeric) {
        document.getElementById(`histogramConfig${analysisId}`).style.display = 'flex';
        // Establecer valores por defecto
        if (!document.getElementById(`binMin${analysisId}`).value && colStats.min !== undefined) {
            document.getElementById(`binMin${analysisId}`).value = colStats.min;
        }
        if (!document.getElementById(`binMax${analysisId}`).value && colStats.max !== undefined) {
            document.getElementById(`binMax${analysisId}`).value = colStats.max;
        }
    } else {
        // Para variables de texto, mostrar configuración diferente
        const configContainer = document.getElementById(`histogramConfig${analysisId}`);
        configContainer.style.display = 'flex';
        // Cambiar las etiquetas y configuración para texto
        configContainer.innerHTML = `
            <div class="col-md-6">
                <label for="numCategories${analysisId}" class="form-label text-info small">Número de categorías a mostrar:</label>
                <input type="number" class="form-control form-control-sm" id="numCategories${analysisId}" value="10" min="5" max="50" onchange="updateHistogramBins(${analysisId})">
            </div>
            <div class="col-md-6">
                <label for="sortOrder${analysisId}" class="form-label text-info small">Ordenar por:</label>
                <select class="form-select form-select-sm" id="sortOrder${analysisId}" onchange="updateHistogramBins(${analysisId})">
                    <option value="frequency">Frecuencia (mayor a menor)</option>
                    <option value="alphabetical">Alfabético (A-Z)</option>
                    <option value="alphabetical_desc">Alfabético (Z-A)</option>
                </select>
            </div>
        `;
        
    }
    
    // Destruir gráfico anterior si existe
    if (analysisCharts[analysisId]) {
        analysisCharts[analysisId].destroy();
    }
    
    const canvas = document.getElementById(`variableHistogram${analysisId}`);
    const ctx = canvas.getContext('2d');
    
    if (isNumeric && colStats.histogram) {
        // Histograma para variables numéricas
        let bins, counts;
        
        // Usar los datos apropiados según el checkbox de outliers
        if (!includeOutliers && colStats.histogram.bins_no_outliers && colStats.histogram.outliers_info.outlier_count > 0) {
            // Usar histograma sin outliers
            bins = colStats.histogram.bins_no_outliers;
            counts = colStats.histogram.counts_no_outliers;
        } else {
            // Usar histograma completo
            bins = colStats.histogram.bins;
            counts = colStats.histogram.counts;
        }
        
        // Obtener configuración personalizada
        const numBins = parseInt(document.getElementById(`numBins${analysisId}`).value) || 20;
        const customMin = parseFloat(document.getElementById(`binMin${analysisId}`).value);
        const customMax = parseFloat(document.getElementById(`binMax${analysisId}`).value);
        
        // Recalcular bins si hay valores personalizados
        let labels = [];
        let adjustedCounts = counts;
        
        if (!isNaN(customMin) && !isNaN(customMax) && customMin < customMax) {
            // Crear nuevos bins basados en los valores personalizados
            const binWidth = (customMax - customMin) / numBins;
            const newBins = [];
            for (let i = 0; i <= numBins; i++) {
                newBins.push(customMin + i * binWidth);
            }
            
            // Recalcular los conteos para los nuevos bins
            adjustedCounts = new Array(numBins).fill(0);
            
            // Distribuir los datos originales en los nuevos bins
            for (let i = 0; i < bins.length - 1; i++) {
                const binStart = bins[i];
                const binEnd = bins[i + 1];
                const binCount = counts[i];
                
                // Encontrar en qué nuevos bins cae este rango
                for (let j = 0; j < newBins.length - 1; j++) {
                    const newBinStart = newBins[j];
                    const newBinEnd = newBins[j + 1];
                    
                    // Calcular la intersección
                    const overlapStart = Math.max(binStart, newBinStart);
                    const overlapEnd = Math.min(binEnd, newBinEnd);
                    
                    if (overlapStart < overlapEnd) {
                        // Hay intersección, distribuir proporcionalmente
                        const overlapRatio = (overlapEnd - overlapStart) / (binEnd - binStart);
                        adjustedCounts[j] += Math.round(binCount * overlapRatio);
                    }
                }
            }
            
            // Crear etiquetas con los nuevos bins
            for (let i = 0; i < newBins.length - 1; i++) {
                const decimals = binWidth < 1 ? 2 : (binWidth < 10 ? 1 : 0);
                labels.push(`${newBins[i].toFixed(decimals)} - ${newBins[i+1].toFixed(decimals)}`);
            }
        } else {
            // Usar bins originales
            for (let i = 0; i < bins.length - 1; i++) {
                labels.push(`${bins[i].toFixed(1)} - ${bins[i+1].toFixed(1)}`);
            }
        }
        
        analysisCharts[analysisId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: `Distribución de ${selectedVariable}`,
                    data: adjustedCounts,
                    backgroundColor: 'rgba(0, 212, 255, 0.5)',
                    borderColor: 'rgba(0, 212, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Histograma de ${selectedVariable}${!includeOutliers && colStats.histogram.outliers_info && colStats.histogram.outliers_info.outlier_count > 0 ? ' (sans outliers)' : ''}`,
                        color: '#00d4ff',
                        font: { size: 16 }
                    },
                    legend: { display: false }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Intervalos',
                            color: '#00d4ff'
                        },
                        ticks: { 
                            color: '#f0f9ff',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Frecuencia',
                            color: '#00d4ff'
                        },
                        beginAtZero: true,
                        ticks: { color: '#f0f9ff' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });
        
        // Mostrar información de outliers siempre si existe
        let outlierInfo = '';
        if (colStats.histogram && colStats.histogram.outliers_info && colStats.histogram.outliers_info.outlier_count > 0) {
            const info = colStats.histogram.outliers_info;
            if (!includeOutliers) {
                outlierInfo = `
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Outliers détectés et exclus:</strong> ${info.outlier_count} valeurs (${info.outlier_percentage.toFixed(1)}%) 
                        ont été exclues du graphique.<br>
                        <small>Valeurs en dehors de l'intervalle [${info.lower_bound.toFixed(2)}, ${info.upper_bound.toFixed(2)}]</small><br>
                        <small>IQR: ${info.iqr.toFixed(2)} (Q1: ${info.q1.toFixed(2)}, Q3: ${info.q3.toFixed(2)})</small>
                    </div>
                `;
            } else {
                outlierInfo = `
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>Outliers détectés:</strong> ${info.outlier_count} valeurs (${info.outlier_percentage.toFixed(1)}%) 
                        sont des outliers (inclus dans le graphique).<br>
                        <small>Valeurs en dehors de l'intervalle [${info.lower_bound.toFixed(2)}, ${info.upper_bound.toFixed(2)}]</small><br>
                        <small>IQR: ${info.iqr.toFixed(2)} (Q1: ${info.q1.toFixed(2)}, Q3: ${info.q3.toFixed(2)})</small>
                    </div>
                `;
            }
        } else if (colStats.histogram && colStats.histogram.outliers_info) {
            outlierInfo = `
                <div class="alert alert-success mt-3">
                    <i class="bi bi-check-circle"></i> 
                    <strong>Aucun outlier détecté</strong> dans cette variable.<br>
                    <small>Toutes les valeurs sont dans l'intervalle [${colStats.histogram.outliers_info.lower_bound.toFixed(2)}, ${colStats.histogram.outliers_info.upper_bound.toFixed(2)}]</small>
                </div>
            `;
        }
        
        // Mostrar estadísticas
        let decimalInfo = '';
        if (colStats.decimals_info) {
            decimalInfo = `
                <div class="col-md-4">
                    <small class="text-muted">Decimales:</small><br>
                    <strong>Común: ${colStats.decimals_info.most_common_decimals || 0}</strong><br>
                    <small>Máx: ${colStats.decimals_info.max_decimals || 0}, Prom: ${colStats.decimals_info.avg_decimals?.toFixed(1) || 0}</small>
                </div>
            `;
        }
        
        let magnitudeInfo = '';
        if (colStats.magnitude_info) {
            magnitudeInfo = `
                <div class="col-md-4">
                    <small class="text-muted">Orden de Magnitud:</small><br>
                    <strong>10<sup>${colStats.magnitude_info.avg_magnitude}</sup></strong><br>
                    <small>Rango: 10<sup>${colStats.magnitude_info.min_magnitude}</sup> a 10<sup>${colStats.magnitude_info.max_magnitude}</sup></small>
                </div>
            `;
        }
        
        document.getElementById(`variableStats${analysisId}`).innerHTML = `
            <div class="card bg-dark border-info">
                <div class="card-body">
                    <h6 class="text-info mb-3">Estadísticas de ${selectedVariable}</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted">Media:</small><br>
                            <strong>${colStats.mean?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Desviación Estándar:</small><br>
                            <strong>${colStats.std?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Mediana:</small><br>
                            <strong>${colStats.q50?.toFixed(2) || 'N/A'}</strong>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <small class="text-muted">Mínimo:</small><br>
                            <strong>${colStats.min?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Q1 (25%):</small><br>
                            <strong>${colStats.q25?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Q3 (75%):</small><br>
                            <strong>${colStats.q75?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Máximo:</small><br>
                            <strong>${colStats.max?.toFixed(2) || 'N/A'}</strong>
                        </div>
                    </div>
                    ${decimalInfo || magnitudeInfo ? `
                        <div class="row mt-3">
                            ${decimalInfo}
                            ${magnitudeInfo}
                        </div>
                    ` : ''}
                    ${outlierInfo}
                </div>
            </div>
        `;
        
        // Save analysis data for numeric variables
        analysisData[analysisId] = {
            variable: selectedVariable,
            isNumeric: true,
            stats: colStats,
            chartData: analysisCharts[analysisId] ? analysisCharts[analysisId].toBase64Image() : null,
            outlierInfo: colStats.histogram?.outliers_info || null
        };
    } else if (!isNumeric) {
        // Gráfico de barras para variables categóricas
        // Primero, obtener todos los datos de frecuencia disponibles
        let allData = [];
        
        if (colStats.value_counts) {
            allData = Object.entries(colStats.value_counts);
        } else if (colStats.categories) {
            allData = Object.entries(colStats.categories);
        } else if (colStats.top_values) {
            colStats.top_values.values.forEach((val, idx) => {
                allData.push([val, colStats.top_values.counts[idx]]);
            });
        }
        
        // Si no hay datos, intentar obtener datos completos
        if (allData.length === 0) {
            // Hacer una petición para obtener datos completos
            fetch(`/api/datasets/${window.selectedDataset.id}/columns/${encodeURIComponent(selectedVariable)}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(detailData => {
                if (detailData && !detailData.error) {
                    let valueCountsObj = detailData.value_counts_complete || detailData.value_counts || {};
                    
                    if (Object.keys(valueCountsObj).length === 0 && detailData.frequency_data) {
                        valueCountsObj = {};
                        detailData.frequency_data.forEach(item => {
                            if (item.value !== 'null') {
                                valueCountsObj[item.value] = item.count;
                            }
                        });
                    }
                    
                    allData = Object.entries(valueCountsObj);
                    
                    // Guardar los datos inmediatamente
                    window[`categoricalData_${analysisId}`] = {
                        allData: allData,
                        sortedData: allData,
                        selectedVariable: selectedVariable
                    };
                    
                    // Dar tiempo para que los elementos de configuración estén listos
                    setTimeout(() => {
                        generateCategoricalHistogramWithData(analysisId, selectedVariable, allData, colStats);
                    }, 100);
                }
            })
            .catch(error => {
                console.error('Error fetching column details:', error);
                // Usar los datos que tenemos
                if (allData.length > 0) {
                    window[`categoricalData_${analysisId}`] = {
                        allData: allData,
                        sortedData: allData,
                        selectedVariable: selectedVariable
                    };
                    setTimeout(() => {
                        generateCategoricalHistogramWithData(analysisId, selectedVariable, allData, colStats);
                    }, 100);
                }
            });
            return;
        }
        
        // Guardar los datos inmediatamente para que estén disponibles cuando se actualice
        window[`categoricalData_${analysisId}`] = {
            allData: allData,
            sortedData: allData,
            selectedVariable: selectedVariable
        };
        
        // Dar tiempo para que los elementos de configuración estén listos
        setTimeout(() => {
            generateCategoricalHistogramWithData(analysisId, selectedVariable, allData, colStats);
        }, 100);
    }
}

// Nueva función para generar histograma categórico con datos
function generateCategoricalHistogramWithData(analysisId, selectedVariable, allData, colStats) {
    const canvas = document.getElementById(`variableHistogram${analysisId}`);
    const ctx = canvas.getContext('2d');
    
    // Obtener configuración
    const numCategoriesElement = document.getElementById(`numCategories${analysisId}`);
    const sortOrderElement = document.getElementById(`sortOrder${analysisId}`);
    
    // Verificar que los elementos existen
    if (!numCategoriesElement || !sortOrderElement) {
        console.error('Configuration elements not found for analysis', analysisId);
        return;
    }
    
    const numCategories = parseInt(numCategoriesElement.value) || 10;
    const sortOrder = sortOrderElement.value || 'frequency';
    
    // Ordenar datos según la configuración
    let sortedData = [...allData];
    switch(sortOrder) {
        case 'frequency':
            sortedData.sort((a, b) => b[1] - a[1]); // Mayor a menor frecuencia
            break;
        case 'alphabetical':
            sortedData.sort((a, b) => String(a[0]).localeCompare(String(b[0]))); // A-Z
            break;
        case 'alphabetical_desc':
            sortedData.sort((a, b) => String(b[0]).localeCompare(String(a[0]))); // Z-A
            break;
    }
    
    // Limitar al número de categorías configurado
    const displayData = sortedData.slice(0, numCategories);
    const labels = displayData.map(([val, _]) => String(val).substring(0, 30) + (String(val).length > 30 ? '...' : ''));
    const counts = displayData.map(([_, count]) => count);
    
    // Calcular "otros" si hay más categorías
    let othersCount = 0;
    if (sortedData.length > numCategories) {
        for (let i = numCategories; i < sortedData.length; i++) {
            othersCount += sortedData[i][1];
        }
        labels.push('Otros');
        counts.push(othersCount);
    }
    
    // Destruir gráfico anterior si existe
    if (analysisCharts[analysisId]) {
        analysisCharts[analysisId].destroy();
    }
    
    analysisCharts[analysisId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: `Frecuencia de ${selectedVariable}`,
                data: counts,
                backgroundColor: 'rgba(16, 185, 129, 0.5)',
                borderColor: 'rgba(16, 185, 129, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: `Distribución de ${selectedVariable} (${numCategories < sortedData.length ? `Top ${numCategories} de ${sortedData.length}` : `Todos los ${sortedData.length}`} valores)`,
                    color: '#00d4ff',
                    font: { size: 16 }
                },
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const total = counts.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed.y / total) * 100).toFixed(1);
                            return `${percentage}% del total`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Categorías',
                        color: '#00d4ff'
                    },
                    ticks: { 
                        color: '#f0f9ff',
                        maxRotation: 45,
                        minRotation: 45,
                        callback: function(value, index) {
                            const label = this.getLabelForValue(value);
                            return label.length > 20 ? label.substring(0, 20) + '...' : label;
                        }
                    },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Frecuencia',
                        color: '#00d4ff'
                    },
                    beginAtZero: true,
                    ticks: { color: '#f0f9ff' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            },
            onClick: function(evt, activeElements) {
                if (activeElements.length > 0) {
                    const index = activeElements[0].index;
                    const label = labels[index];
                    if (label !== 'Otros') {
                        // Aquí puedes agregar funcionalidad al hacer clic en una barra
                        console.log('Clicked on:', label);
                    }
                }
            }
        }
    });
    
    // Mostrar estadísticas categóricas mejoradas
    const totalCount = allData.reduce((sum, [_, count]) => sum + count, 0);
    const uniqueCount = colStats.unique_count || allData.length;
    
    // Calcular el valor más frecuente
    const mostFrequent = sortedData[0];
    const leastFrequent = sortedData[sortedData.length - 1];
    
    document.getElementById(`variableStats${analysisId}`).innerHTML = `
        <div class="card bg-dark border-info">
            <div class="card-body">
                <h6 class="text-info mb-3">Información de ${selectedVariable}</h6>
                <div class="row">
                    <div class="col-md-3">
                        <small class="text-muted">Valores únicos:</small><br>
                        <strong>${uniqueCount}</strong>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Total de registros:</small><br>
                        <strong>${totalCount.toLocaleString()}</strong>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Valores nulos:</small><br>
                        <strong>${colStats.null_count || 0} (${colStats.null_percentage?.toFixed(1) || 0}%)</strong>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Mostrando:</small><br>
                        <strong>${numCategories < sortedData.length ? `Top ${numCategories}` : 'Todos'}</strong>
                    </div>
                </div>
                ${mostFrequent ? `
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <small class="text-muted">Valor más frecuente:</small><br>
                            <strong>${String(mostFrequent[0]).substring(0, 30)}${String(mostFrequent[0]).length > 30 ? '...' : ''}</strong>
                            <small class="text-info ms-2">(${mostFrequent[1]} veces - ${((mostFrequent[1]/totalCount)*100).toFixed(1)}%)</small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">Valor menos frecuente:</small><br>
                            <strong>${String(leastFrequent[0]).substring(0, 30)}${String(leastFrequent[0]).length > 30 ? '...' : ''}</strong>
                            <small class="text-info ms-2">(${leastFrequent[1]} veces - ${((leastFrequent[1]/totalCount)*100).toFixed(1)}%)</small>
                        </div>
                    </div>
                ` : ''}
                ${othersCount > 0 ? `
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Valores agrupados como "Otros":</strong> ${sortedData.length - numCategories} categorías
                        con un total de ${othersCount} registros (${((othersCount/totalCount)*100).toFixed(1)}% del total)
                    </div>
                ` : ''}
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="showAllCategoricalValues(${analysisId}, '${selectedVariable}')">
                        <i class="bi bi-list-ul"></i> Ver todos los valores
                    </button>
                    ${sortedData.length > numCategories ? `
                        <button class="btn btn-sm btn-outline-success ms-2" onclick="document.getElementById('numCategories${analysisId}').value = ${sortedData.length}; updateHistogramBins(${analysisId})">
                            <i class="bi bi-bar-chart-fill"></i> Mostrar todos en el gráfico
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    // Actualizar los datos guardados con los datos ordenados
    if (window[`categoricalData_${analysisId}`]) {
        window[`categoricalData_${analysisId}`].sortedData = sortedData;
    }
    
    // Save analysis data for report generation
    analysisData[analysisId] = {
        variable: selectedVariable,
        isNumeric: false,
        stats: colStats,
        chartData: analysisCharts[analysisId] ? analysisCharts[analysisId].toBase64Image() : null
    };
}

// Función para mostrar todos los valores categóricos en un modal
async function showAllCategoricalValues(analysisId, variableName) {
    // Mostrar loading mientras se cargan los datos
    const loadingModal = `
        <div class="modal fade" id="loadingModal${analysisId}" tabindex="-1">
            <div class="modal-dialog modal-sm">
                <div class="modal-content bg-dark">
                    <div class="modal-body text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando todos los valores...</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', loadingModal);
    const loading = new bootstrap.Modal(document.getElementById(`loadingModal${analysisId}`));
    loading.show();
    
    try {
        // Fetch complete data from the server
        const response = await fetch(`/api/datasets/${window.selectedDataset.id}/columns/${encodeURIComponent(variableName)}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const detailData = await response.json();
        let allValues = [];
        
        if (detailData && !detailData.error) {
            // Usar value_counts_complete si está disponible, sino usar value_counts
            let valueCountsObj = detailData.value_counts_complete || detailData.value_counts || {};
            
            // Si no hay value_counts pero hay frequency_data, usarlo
            if (Object.keys(valueCountsObj).length === 0 && detailData.frequency_data) {
                valueCountsObj = {};
                detailData.frequency_data.forEach(item => {
                    if (item.value !== 'null') {
                        valueCountsObj[item.value] = item.count;
                    }
                });
            }
            
            allValues = Object.entries(valueCountsObj);
        } else {
            // Si falla, usar los datos que tenemos
            const data = window[`categoricalData_${analysisId}`];
            if (data && data.allData) {
                allValues = [...data.allData];
            }
        }
        
        // Cerrar loading
        loading.hide();
        document.getElementById(`loadingModal${analysisId}`).remove();
        
        if (allValues.length === 0) {
            showNotification('Error', 'No se pudieron obtener los datos completos', 'error');
            return;
        }
        
        // Ordenar por frecuencia (mayor a menor) por defecto
        allValues.sort((a, b) => b[1] - a[1]);
        
        const total = allValues.reduce((sum, [_, count]) => sum + count, 0);
    
    // Crear modal con todos los valores
    const modalHtml = `
        <div class="modal fade" id="allCategoricalValuesModal${analysisId}" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title">Todos los valores de ${variableName} (${allValues.length} únicos)</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="text" 
                                       class="form-control" 
                                       id="searchCategoricalValues${analysisId}" 
                                       placeholder="Buscar valor..."
                                       onkeyup="filterCategoricalValues(${analysisId})">
                            </div>
                            <div class="col-md-6">
                                <select class="form-select" id="modalSortOrder${analysisId}" onchange="sortModalTable(${analysisId})">
                                    <option value="frequency">Ordenar por frecuencia</option>
                                    <option value="alphabetical">Ordenar alfabéticamente (A-Z)</option>
                                    <option value="alphabetical_desc">Ordenar alfabéticamente (Z-A)</option>
                                    <option value="value_asc">Ordenar por valor (menor a mayor)</option>
                                    <option value="value_desc">Ordenar por valor (mayor a menor)</option>
                                </select>
                            </div>
                        </div>
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i> Mostrando todos los <strong>${allValues.length}</strong> valores únicos
                        </div>
                        <div style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-sm table-hover" id="allCategoricalValuesTable${analysisId}">
                                <thead style="position: sticky; top: 0; background: #1a1a1a; z-index: 10;">
                                    <tr>
                                        <th style="width: 60px;">#</th>
                                        <th>Valor</th>
                                        <th style="width: 100px;">Frecuencia</th>
                                        <th style="width: 100px;">Porcentaje</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allValues.map(([value, count], idx) => `
                                        <tr data-value="${String(value).replace(/"/g, '&quot;')}" data-count="${count}" data-index="${idx + 1}">
                                            <td>${idx + 1}</td>
                                            <td title="${String(value).replace(/"/g, '&quot;')}">${String(value).substring(0, 50)}${String(value).length > 50 ? '...' : ''}</td>
                                            <td>${count.toLocaleString()}</td>
                                            <td>${((count/total)*100).toFixed(2)}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <span class="me-auto text-muted">
                            Total de registros: <strong>${total.toLocaleString()}</strong> | 
                            Valores únicos: <strong>${allValues.length}</strong>
                        </span>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal anterior si existe
    const existingModal = document.getElementById(`allCategoricalValuesModal${analysisId}`);
    if (existingModal) {
        existingModal.remove();
    }
    
    // Agregar nuevo modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById(`allCategoricalValuesModal${analysisId}`));
    modal.show();
    
    // Guardar los datos para el ordenamiento
    window[`modalData_${analysisId}`] = allValues;
    
    } catch (error) {
        console.error('Error loading all values:', error);
        // Cerrar loading si hay error
        const loadingElement = document.getElementById(`loadingModal${analysisId}`);
        if (loadingElement) {
            const loading = bootstrap.Modal.getInstance(loadingElement);
            if (loading) loading.hide();
            loadingElement.remove();
        }
        
        showNotification('Error', 'Error al cargar todos los valores', 'error');
    }
}

// Nueva función para ordenar la tabla del modal
function sortModalTable(analysisId) {
    const sortOrder = document.getElementById(`modalSortOrder${analysisId}`).value;
    const tableBody = document.querySelector(`#allCategoricalValuesTable${analysisId} tbody`);
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    const data = window[`modalData_${analysisId}`];
    
    if (!data) return;
    
    // Obtener el total para recalcular porcentajes
    const total = data.reduce((sum, [_, count]) => sum + count, 0);
    
    // Ordenar los datos según la selección
    let sortedData = [...data];
    switch(sortOrder) {
        case 'frequency':
            sortedData.sort((a, b) => b[1] - a[1]);
            break;
        case 'alphabetical':
            sortedData.sort((a, b) => String(a[0]).localeCompare(String(b[0])));
            break;
        case 'alphabetical_desc':
            sortedData.sort((a, b) => String(b[0]).localeCompare(String(a[0])));
            break;
        case 'value_asc':
            sortedData.sort((a, b) => {
                const aNum = parseFloat(a[0]);
                const bNum = parseFloat(b[0]);
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return aNum - bNum;
                }
                return String(a[0]).localeCompare(String(b[0]));
            });
            break;
        case 'value_desc':
            sortedData.sort((a, b) => {
                const aNum = parseFloat(a[0]);
                const bNum = parseFloat(b[0]);
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return bNum - aNum;
                }
                return String(b[0]).localeCompare(String(a[0]));
            });
            break;
    }
    
    // Regenerar el contenido de la tabla
    tableBody.innerHTML = sortedData.map(([value, count], idx) => `
        <tr data-value="${String(value).replace(/"/g, '&quot;')}" data-count="${count}" data-index="${idx + 1}">
            <td>${idx + 1}</td>
            <td title="${String(value).replace(/"/g, '&quot;')}">${String(value).substring(0, 50)}${String(value).length > 50 ? '...' : ''}</td>
            <td>${count.toLocaleString()}</td>
            <td>${((count/total)*100).toFixed(2)}%</td>
        </tr>
    `).join('');
    
    // Reaplicar el filtro si hay texto de búsqueda
    const searchText = document.getElementById(`searchCategoricalValues${analysisId}`).value;
    if (searchText) {
        filterCategoricalValues(analysisId);
    }
}

// Función para filtrar valores en el modal
function filterCategoricalValues(analysisId) {
    const searchText = document.getElementById(`searchCategoricalValues${analysisId}`).value.toLowerCase();
    const rows = document.querySelectorAll(`#allCategoricalValuesTable${analysisId} tbody tr`);
    
    rows.forEach(row => {
        const value = row.getAttribute('data-value').toLowerCase();
        row.style.display = value.includes(searchText) ? '' : 'none';
    });
}

// Actualizar estadísticas
function updateStats(datasetList) {
    const totalSize = datasetList.reduce((sum, d) => sum + (d.file_size || 0), 0);
    const totalRows = datasetList.reduce((sum, d) => sum + (d.row_count || 0), 0);
    const lastDate = datasetList.length > 0 ? 
        new Date(Math.max(...datasetList.map(d => new Date(d.uploaded_at || d.created_at)))).toLocaleDateString('fr-FR') : '-';
    
    document.getElementById('totalDatasets').textContent = datasetList.length;
    document.getElementById('totalSize').textContent = (totalSize / 1024 / 1024).toFixed(2) + ' MB';
    document.getElementById('totalRows').textContent = totalRows.toLocaleString();
    document.getElementById('lastUpdate').textContent = lastDate;
}

// Inicializar drag & drop
function initDragDrop() {
    const uploadArea = document.querySelector('.upload-area');
    
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    uploadArea.addEventListener('drop', handleDrop);
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('active');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('active');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('active');
    
    const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.csv'));
    if (files.length > 0) {
        handleFiles(files);
    } else {
        showNotification('Erreur', 'Veuillez déposer uniquement des fichiers CSV', 'error');
    }
}

function handleFileSelect(input) {
    const files = Array.from(input.files);
    if (files.length > 0) {
        handleFiles(files);
    }
}

// Traiter les fichiers
function handleFiles(files) {
    // Por ahora solo manejar un archivo a la vez
    if (files.length > 0) {
        showDatasetInfoModal(files[0]);
    }
}

// Variable global para almacenar archivos pendientes
let pendingFiles = [];

// Mostrar modal de información del dataset
function showDatasetInfoModal(file) {
    // Limpiar formulario
    document.getElementById('datasetName').value = file.name.replace('.csv', '');
    document.getElementById('datasetDescription').value = '';
    
    // Guardar archivo para uso posterior
    pendingFiles = [file];
    
    // Mostrar modal
    const modalElement = document.getElementById('datasetInfoModal');
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: false,  // Sin backdrop
        keyboard: true
    });
    modal.show();
}

// Proceder con la carga después de obtener la información
function proceedWithUpload() {
    const name = document.getElementById('datasetName').value.trim();
    const description = document.getElementById('datasetDescription').value.trim();
    
    if (pendingFiles.length > 0) {
        // Cerrar modal de información
        const infoModal = bootstrap.Modal.getInstance(document.getElementById('datasetInfoModal'));
        infoModal.hide();
        
        // Subir archivo con la información proporcionada
        uploadFile(pendingFiles[0], name, description);
    }
}

// Forcer la fermeture du modal d'upload
function forceCloseUploadModal() {
    const modalElement = document.getElementById('uploadProgressModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
        modal.hide();
    }
    // Nettoyer tous les backdrops et styles
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
}

// Handle file selection
function handleFileSelect(input) {
    const files = input.files;
    if (files.length === 0) return;
    
    // For now, handle only the first file
    const file = files[0];
    
    // Store the file temporarily
    document.getElementById('pendingFile').value = file.name;
    window.pendingFile = file;
    
    // Show the info modal
    const infoModal = new bootstrap.Modal(document.getElementById('datasetInfoModal'));
    document.getElementById('datasetName').value = file.name.replace('.csv', '');
    document.getElementById('datasetShortDescription').value = '';
    document.getElementById('datasetLongDescription').value = '';
    updateCharCount();
    infoModal.show();
    
    // Reset the file input
    input.value = '';
}

// Proceed with upload after info is filled
function proceedWithUpload() {
    const file = window.pendingFile;
    if (!file) {
        showNotification('Erreur', 'Aucun fichier sélectionné', 'error');
        return;
    }
    
    const customName = document.getElementById('datasetName').value;
    const shortDescription = document.getElementById('datasetShortDescription').value;
    const longDescription = document.getElementById('datasetLongDescription').value;
    
    // Hide the info modal
    const infoModal = bootstrap.Modal.getInstance(document.getElementById('datasetInfoModal'));
    infoModal.hide();
    
    // Start the upload
    uploadFile(file, customName, shortDescription, longDescription);
}

// Upload d'un fichier
function uploadFile(file, customName, shortDescription, longDescription) {
    // Nettoyer les modals existants avant d'en créer un nouveau
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
    
    const modalElement = document.getElementById('uploadProgressModal');
    // Vérifier si une instance existe déjà
    let modal = bootstrap.Modal.getInstance(modalElement);
    if (!modal) {
        modal = new bootstrap.Modal(modalElement, {
            backdrop: false,  // Sin backdrop
            keyboard: true
        });
    }
    document.getElementById('uploadFileName').textContent = file.name;
    modal.show();
    
    const formData = new FormData();
    formData.append('name', customName || file.name.replace('.csv', ''));
    formData.append('file', file);
    formData.append('short_description', shortDescription || '');
    formData.append('long_description', longDescription || '');
    
    // Simuler la progression
    let progress = 0;
    const progressBar = document.getElementById('uploadProgressBar');
    const progressInterval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
        progressBar.textContent = Math.round(progress) + '%';
    }, 200);
    
    fetch('/api/datasets/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || err.detail || 'Error al cargar el archivo');
            });
        }
        return response.json();
    })
    .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        document.getElementById('uploadStatus').textContent = 'Upload terminé avec succès!';
        
        setTimeout(() => {
            modal.hide();
            // Forcer la suppression du backdrop
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
            
            showNotification('Succès!', `Dataset "${file.name}" chargé avec succès`, 'success');
            loadDatasets();
        }, 1000);
    })
    .catch(error => {
        clearInterval(progressInterval);
        modal.hide();
        // Forcer la suppression du backdrop en cas d'erreur
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('overflow');
        document.body.style.removeProperty('padding-right');
        
        showNotification('Erreur', 'Erreur lors du chargement: ' + error.message, 'error');
    });
}


// Télécharger un dataset
function downloadDataset(datasetId) {
    const dataset = datasetId ? datasets.find(d => d.id === datasetId) : selectedDataset;
    if (!dataset) return;
    
    // Mostrar notificación de inicio de descarga
    showNotification('Téléchargement', `Téléchargement du dataset "${dataset.name}" en cours...`, 'info');
    
    // Descargar el archivo CSV
    window.location.href = `/api/datasets/${dataset.id}/download/`;
}

// Descargar reporte del análisis
function downloadReport() {
    if (!selectedDataset) return;
    
    showNotification('Génération du rapport', 'Génération du rapport d\'analyse en cours...', 'info');
    
    // Prepare chart data to send
    const chartsData = {};
    for (const [analysisId, data] of Object.entries(analysisData)) {
        if (analysisCharts[analysisId]) {
            chartsData[analysisId] = {
                variable: data.variable,
                isNumeric: data.isNumeric,
                chartImage: analysisCharts[analysisId].toBase64Image(),
                outlierInfo: data.outlierInfo
            };
        }
    }
    
    // Hacer petición para generar el reporte
    fetch(`/api/datasets/${selectedDataset.id}/report/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            charts: chartsData
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erreur lors de la génération du rapport');
        }
        return response.blob();
    })
    .then(blob => {
        // Crear URL temporal para descargar
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `rapport_${selectedDataset.name}_${new Date().toISOString().split('T')[0]}.html`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showNotification('Succès!', 'Rapport téléchargé avec succès', 'success');
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur', 'Erreur lors de la génération du rapport', 'error');
    });
}

// Supprimer un dataset
function deleteDataset(datasetId) {
    const dataset = datasetId ? datasets.find(d => d.id === datasetId) : selectedDataset;
    if (!dataset) return;
    
    Swal.fire({
        title: 'Êtes-vous sûr?',
        text: `Voulez-vous vraiment supprimer le dataset "${dataset.name}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Oui, supprimer',
        cancelButtonText: 'Annuler'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading('Suppression en cours...', 'Suppression du dataset de votre collection');
            
            fetch(`/api/datasets/${dataset.id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                hideLoading();
                if (response.ok) {
                    console.log(`Dataset ${dataset.id} eliminado exitosamente del servidor`);
                    showNotification('Succès!', 'Dataset supprimé avec succès', 'success');
                    
                    // Cerrar modal si está abierto
                    if (!datasetId) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('datasetDetailModal'));
                        if (modal) modal.hide();
                    }
                    
                    // Remover inmediatamente del array local para feedback instantáneo
                    datasets = datasets.filter(d => d.id !== dataset.id);
                    displayDatasets(datasets);
                    updateStats(datasets);
                    
                    // Luego recargar desde el servidor para asegurar consistencia
                    setTimeout(() => {
                        loadDatasets().then(() => {
                            console.log('Datasets recargados después de eliminación');
                        }).catch(error => {
                            console.error('Error recargando datasets:', error);
                        });
                    }, 500);
                } else {
                    console.error(`Error eliminando dataset: ${response.status}`);
                    response.text().then(text => {
                        console.error('Response text:', text);
                    });
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Erreur de suppression:', error);
                showNotification('Erreur', 'Erreur lors de la suppression: ' + error.message, 'error');
            });
        }
    });
}

// Duplicar un dataset
function duplicateDataset(datasetId, originalName) {
    const dataset = datasetId ? datasets.find(d => d.id === datasetId) : selectedDataset;
    if (!dataset) return;
    
    Swal.fire({
        title: 'Duplicar Dataset',
        text: `Ingrese el nombre para la copia del dataset "${dataset.name}"`,
        input: 'text',
        inputLabel: 'Nombre del nuevo dataset:',
        inputValue: `${dataset.name}_copia`,
        inputPlaceholder: 'Nombre del dataset duplicado',
        showCancelButton: true,
        confirmButtonColor: '#9333ea',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Duplicar',
        cancelButtonText: 'Cancelar',
        background: '#0a0e27',
        color: '#f0f9ff',
        inputValidator: (value) => {
            if (!value || !value.trim()) {
                return 'Por favor ingrese un nombre para el dataset';
            }
            // Check if name already exists
            const exists = datasets.some(d => d.name === value.trim());
            if (exists) {
                return 'Ya existe un dataset con ese nombre';
            }
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const newName = result.value.trim();
            showLoading('Duplicando dataset...', 'Creando una copia del dataset');
            
            fetch(`/api/datasets/${dataset.id}/duplicate/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    name: newName
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    showNotification('Éxito!', data.message || 'Dataset duplicado con éxito', 'success');
                    // Recargar la lista de datasets
                    loadDatasets();
                } else {
                    showNotification('Error', data.error || 'Error al duplicar el dataset', 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                showNotification('Error', 'Error al duplicar el dataset: ' + error.message, 'error');
            });
        }
    });
}

// Renombrar una columna del dataset
function renameColumn(columnName) {
    if (!selectedDataset) return;
    
    // Limpiar cualquier estado de modal anterior
    document.querySelectorAll('[aria-hidden="true"]').forEach(el => {
        el.removeAttribute('aria-hidden');
    });
    
    // Remover cualquier backdrop residual
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    
    // Asegurar que el body no tenga clases de modal
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
    
    // Cerrar cualquier modal de Bootstrap abierto
    const openModals = document.querySelectorAll('.modal.show');
    openModals.forEach(modal => {
        const bsModal = bootstrap.Modal.getInstance(modal);
        if (bsModal) {
            bsModal.hide();
        }
    });
    
    // Pequeña demora para asegurar que todo se limpie
    setTimeout(() => {
        Swal.fire({
        title: 'Renombrar columna',
        text: `Nombre actual: ${columnName}`,
        input: 'text',
        inputLabel: 'Nuevo nombre:',
        inputValue: columnName,
        inputPlaceholder: 'Ingrese el nuevo nombre de la columna',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#10b981',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Renombrar',
        cancelButtonText: 'Cancelar',
        background: '#0a0e27',
        color: '#f0f9ff',
        allowOutsideClick: false,
        allowEscapeKey: true,
        allowEnterKey: true,
        stopKeydownPropagation: false,
        customClass: {
            popup: 'swal-custom-popup',
            title: 'swal-custom-title',
            htmlContainer: 'swal-custom-text',
            confirmButton: 'swal-custom-button',
            cancelButton: 'btn btn-secondary',
            input: 'swal2-input-custom'
        },
        didOpen: () => {
            // Asegurar que no haya conflictos de aria-hidden
            const swalContainer = document.querySelector('.swal2-container');
            if (swalContainer) {
                swalContainer.removeAttribute('aria-hidden');
            }
            
            const input = Swal.getInput();
            if (input) {
                // Aplicar estilos al input
                input.style.backgroundColor = '#1a1e3a';
                input.style.color = '#f0f9ff';
                input.style.borderColor = '#2d3561';
                input.style.padding = '8px 12px';
                
                // Asegurar que el input sea accesible
                input.removeAttribute('aria-hidden');
                input.removeAttribute('disabled');
                input.removeAttribute('readonly');
                
                // Forzar el focus con múltiples intentos
                const focusInput = () => {
                    input.focus();
                    input.select();
                    
                    // Verificar si el input tiene focus
                    if (document.activeElement !== input) {
                        console.log('Intentando enfocar nuevamente...');
                        setTimeout(focusInput, 50);
                    } else {
                        console.log('Input enfocado correctamente');
                    }
                };
                
                // Iniciar el proceso de focus
                setTimeout(focusInput, 100);
            }
        },
        inputValidator: (value) => {
            if (!value || !value.trim()) {
                return 'Por favor ingrese un nombre válido';
            }
            if (value.trim() === columnName) {
                return 'El nuevo nombre debe ser diferente al actual';
            }
        },
        preConfirm: (newName) => {
            return newName.trim();
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const newName = result.value;
            showLoading('Renombrando columna...', `Cambiando "${columnName}" a "${newName}"`);
            
            fetch(`/api/datasets/${selectedDataset.id}/rename-column/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    old_name: columnName,
                    new_name: newName
                })
            })
            .then(response => {
                hideLoading();
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    });
                }
            })
            .then(data => {
                hideLoading();
                showNotification('¡Éxito!', `La columna "${columnName}" ha sido renombrada a "${newName}"`, 'success');
                
                // Limpiar datos almacenados en caché del cliente
                window.currentDatasetData = null;
                
                // Cerrar el modal actual para evitar conflictos
                const currentModal = bootstrap.Modal.getInstance(document.getElementById('datasetDetailModal'));
                if (currentModal) {
                    currentModal.hide();
                }
                
                // Limpiar cualquier backdrop residual
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('overflow');
                document.body.style.removeProperty('padding-right');
                
                // Esperar un momento y luego recargar los detalles del dataset
                setTimeout(() => {
                    showDatasetDetails(selectedDataset.id);
                }, 500);
            })
            .catch(error => {
                hideLoading();
                console.error('Error al renombrar columna:', error);
                showNotification('Error', 'Error al renombrar la columna: ' + error.message, 'error');
            });
        }
    });
    }, 100); // Fin del setTimeout
}

function deleteColumn(columnName) {
    if (!selectedDataset) return;
    
    Swal.fire({
        title: '¿Estás seguro?',
        text: `¿Deseas eliminar la columna "${columnName}" del dataset?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        background: '#0a0e27',
        color: '#f0f9ff',
        customClass: {
            popup: 'swal-custom-popup',
            title: 'swal-custom-title',
            htmlContainer: 'swal-custom-text',
            confirmButton: 'btn btn-danger',
            cancelButton: 'btn btn-secondary'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading('Eliminando columna...', `Eliminando la columna "${columnName}" del dataset`);
            
            fetch(`/api/datasets/${selectedDataset.id}/delete-column/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    column_name: columnName
                })
            })
            .then(response => {
                hideLoading();
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            })
            .then(data => {
                hideLoading();
                showNotification('¡Éxito!', `La columna "${columnName}" ha sido eliminada`, 'success');
                
                // Limpiar datos almacenados en caché del cliente
                window.currentDatasetData = null;
                
                // Cerrar el modal actual para evitar conflictos
                const currentModal = bootstrap.Modal.getInstance(document.getElementById('datasetDetailModal'));
                if (currentModal) {
                    currentModal.hide();
                }
                
                // Limpiar cualquier backdrop residual
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('overflow');
                document.body.style.removeProperty('padding-right');
                
                // Esperar un momento y luego recargar los detalles del dataset
                setTimeout(() => {
                    showDatasetDetails(selectedDataset.id);
                }, 500);
            })
            .catch(error => {
                hideLoading();
                console.error('Error al eliminar columna:', error);
                showNotification('Error', 'Error al eliminar la columna: ' + error.message, 'error');
            });
        }
    });
}

// Seleccionar una variable
function selectVariable(columnName, isNumeric) {
    // Remover selección previa
    document.querySelectorAll('.column-row').forEach(row => {
        row.classList.remove('selected');
    });
    
    // Agregar selección actual
    const currentRow = document.querySelector(`tr[data-column="${columnName}"]`);
    if (currentRow) {
        currentRow.classList.add('selected');
    }
    
    // Guardar variable seleccionada
    window.selectedVariable = {
        name: columnName,
        isNumeric: isNumeric
    };
}

// Mostrar valores únicos
function showUniqueValues(columnName) {
    const data = window.currentDatasetData;
    if (!data || !data.stats || !data.stats[columnName]) {
        showNotification('Error', 'No hay datos disponibles para esta columna', 'error');
        return;
    }
    
    const colStats = data.stats[columnName];
    let currentPage = 0;
    const itemsPerPage = 20;
    let frequencyData = [];
    let originalFrequencyData = [];
    let currentSort = 'frequency';
    let isLoading = false;
    
    // Crear contenido del modal
    let modalContent = `
        <div class="modal fade" id="uniqueValuesModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-list-ul"></i> Análisis de Valores - "${columnName}"
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <span class="badge bg-info">Total: ${colStats.unique_count || 0} valores únicos</span>
                            <span class="badge bg-warning ms-2">Nulos: ${colStats.null_count || 0}</span>
                            <span class="badge bg-success ms-2" id="totalRecords">Total registros: -</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-primary mb-0">Distribución de frecuencias:</h6>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-info active" onclick="sortValues('frequency')" id="sortFrequency">
                                    <i class="bi bi-sort-numeric-down"></i> Frecuencia
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="sortValues('value-asc')" id="sortValueAsc">
                                    <i class="bi bi-sort-alpha-down"></i> Valor ↑
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="sortValues('value-desc')" id="sortValueDesc">
                                    <i class="bi bi-sort-alpha-down-alt"></i> Valor ↓
                                </button>
                            </div>
                        </div>
                        <div id="uniqueValuesContent" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-center p-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal anterior si existe
    const existingModal = document.getElementById('uniqueValuesModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Agregar modal al documento
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // Mostrar modal
    const modalElement = document.getElementById('uniqueValuesModal');
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: false,  // Sin backdrop
        keyboard: true
    });
    modal.show();
    
    // Función para ordenar valores
    window.sortValues = function(sortType) {
        currentSort = sortType;
        currentPage = 0;
        
        // Actualizar botones activos
        document.querySelectorAll('#uniqueValuesModal .btn-group button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        if (sortType === 'frequency') {
            document.getElementById('sortFrequency').classList.add('active');
            frequencyData = [...originalFrequencyData];
        } else if (sortType === 'value-asc') {
            document.getElementById('sortValueAsc').classList.add('active');
            frequencyData = [...originalFrequencyData].sort((a, b) => {
                if (a.value === 'NaN') return 1;
                if (b.value === 'NaN') return -1;
                if (typeof a.value === 'number' && typeof b.value === 'number') {
                    return a.value - b.value;
                }
                return String(a.value).localeCompare(String(b.value));
            });
        } else if (sortType === 'value-desc') {
            document.getElementById('sortValueDesc').classList.add('active');
            frequencyData = [...originalFrequencyData].sort((a, b) => {
                if (a.value === 'NaN') return 1;
                if (b.value === 'NaN') return -1;
                if (typeof a.value === 'number' && typeof b.value === 'number') {
                    return b.value - a.value;
                }
                return String(b.value).localeCompare(String(a.value));
            });
        }
        
        // Re-renderizar
        const container = document.getElementById('uniqueValuesContent');
        container.innerHTML = '';
        renderValues();
    };
    
    // Función para cargar valores
    function loadUniqueValues() {
        if (isLoading) return;
        isLoading = true;
        
        fetch(`/api/datasets/${selectedDataset.id}/columns/${encodeURIComponent(columnName)}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                originalFrequencyData = data.frequency_data || [];
                frequencyData = [...originalFrequencyData];
                document.getElementById('totalRecords').textContent = `Total registros: ${data.total_count || 0}`;
                renderValues();
                isLoading = false;
            })
            .catch(error => {
                console.error('Error completo:', error);
                document.getElementById('uniqueValuesContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error al cargar los valores
                        <br><small>${error.message}</small>
                    </div>
                `;
                isLoading = false;
            });
    }
    
    // Función para renderizar valores
    function renderValues() {
        const container = document.getElementById('uniqueValuesContent');
        const startIdx = currentPage * itemsPerPage;
        const endIdx = Math.min(startIdx + itemsPerPage, frequencyData.length);
        
        if (currentPage === 0) {
            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>#</th>
                                <th>Valor</th>
                                <th>Frecuencia</th>
                                <th style="min-width: 200px;">Porcentaje</th>
                            </tr>
                        </thead>
                        <tbody id="frequencyTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="loadingIndicator" class="text-center mt-3" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Cargando más...</span>
                    </div>
                </div>
            `;
        }
        
        // Agregar filas
        const tbody = document.getElementById('frequencyTableBody');
        for (let i = startIdx; i < endIdx; i++) {
            const item = frequencyData[i];
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="text-muted">${i + 1}</td>
                <td><code>${item.value}</code></td>
                <td>${item.count.toLocaleString()}</td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="progress flex-grow-1" style="height: 20px;">
                            <div class="progress-bar ${item.percentage > 10 ? 'bg-primary' : 'bg-info'}" 
                                 role="progressbar" 
                                 style="width: ${item.percentage}%">
                                ${item.percentage > 5 ? item.percentage.toFixed(2) + '%' : ''}
                            </div>
                        </div>
                        <span class="ms-2 text-nowrap" style="min-width: 60px; text-align: right;">
                            ${item.percentage.toFixed(2)}%
                        </span>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        }
        
        // Configurar scroll infinito
        const scrollContainer = document.getElementById('uniqueValuesContent');
        scrollContainer.onscroll = function() {
            if (scrollContainer.scrollTop + scrollContainer.clientHeight >= scrollContainer.scrollHeight - 50) {
                if (currentPage * itemsPerPage < frequencyData.length) {
                    currentPage++;
                    document.getElementById('loadingIndicator').style.display = 'block';
                    setTimeout(() => {
                        renderValues();
                        document.getElementById('loadingIndicator').style.display = 'none';
                    }, 200);
                }
            }
        };
    }
    
    // Cargar valores iniciales
    loadUniqueValues();
    
    // Limpiar al cerrar
    document.getElementById('uniqueValuesModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
}

// Helper function para crear modales de manera segura
window.createModal = function(element, options = {}) {
    const defaultOptions = {
        backdrop: false,
        keyboard: true
    };
    const finalOptions = { ...defaultOptions, ...options };
    
    // Interceptar el constructor de Modal para evitar el warning
    const OriginalModal = bootstrap.Modal;
    bootstrap.Modal = function(element, config) {
        if (config && config.backdrop !== false) {
            console.warn('⚠️ Modal backdrop detected! Use backdrop: false to prevent gray overlay issues.');
        }
        console.log('Use createModal() helper function instead of new bootstrap.Modal()');
        return new OriginalModal(element, config);
    };
    
    const modal = new bootstrap.Modal(element, finalOptions);
    
    // Restaurar el constructor original
    bootstrap.Modal = OriginalModal;
    
    return modal;
}

// Variables globales para búsqueda en columna
window.currentColumnSearch = {
    columnName: '',
    datasetId: '',
    columnData: [],
    lastSearchResults: [],
    totalValues: 0,
    selectedPattern: [],
    patternGrouping: false,
    searchScope: 'first', // 'first', 'range', or 'all'
    searchLimit: 100,
    rangeStart: 1,
    rangeEnd: 100
};

// Abrir modal de búsqueda en columna
window.openColumnSearchModal = function(columnName, datasetId) {
    console.log('Opening search modal for column:', columnName, 'dataset:', datasetId);
    
    // Ensure DOM is ready
    if (document.readyState !== 'loading') {
        _openColumnSearchModal(columnName, datasetId);
    } else {
        document.addEventListener('DOMContentLoaded', function() {
            _openColumnSearchModal(columnName, datasetId);
        });
    }
}

function _openColumnSearchModal(columnName, datasetId) {
    window.currentColumnSearch.columnName = columnName;
    window.currentColumnSearch.datasetId = datasetId;
    
    // Verificar que el modal existe
    const modalElement = document.getElementById('columnSearchModal');
    if (!modalElement) {
        console.error('Modal element not found! Trying again in 500ms...');
        // Try again after a short delay
        setTimeout(() => {
            const modalEl = document.getElementById('columnSearchModal');
            if (modalEl) {
                _openColumnSearchModal(columnName, datasetId);
            } else {
                alert('Error: No se puede encontrar el modal de búsqueda. Por favor recarga la página.');
            }
        }, 500);
        return;
    }
    
    // Actualizar título del modal
    const columnNameElement = document.getElementById('searchColumnName');
    if (columnNameElement) {
        columnNameElement.textContent = columnName;
    }
    
    // Limpiar búsqueda anterior
    if (window.clearColumnSearch) {
        window.clearColumnSearch();
    }
    
    try {
        // Verificar si Bootstrap está cargado
        if (typeof bootstrap === 'undefined') {
            console.error('Bootstrap not loaded!');
            alert('Error: Bootstrap no está cargado. Por favor recarga la página.');
            return;
        }
        
        // Verificar primero que todos los elementos requeridos existan
        const requiredElements = ['searchColumnName', 'matchCount', 'totalCount', 'matchPercentage'];
        let missingElements = [];
        
        requiredElements.forEach(id => {
            if (!document.getElementById(id)) {
                missingElements.push(id);
            }
        });
        
        if (missingElements.length > 0) {
            console.error('Elementos faltantes en el modal:', missingElements);
            alert('Error: El modal no está completamente cargado. Por favor recarga la página.');
            return;
        }
        
        // Mostrar modal usando el helper
        const modal = window.createModal(modalElement);
        modal.show();
        
        console.log('Modal should be visible now');
    } catch (error) {
        console.error('Error showing modal:', error);
        // Fallback: try using jQuery if available
        if (typeof $ !== 'undefined') {
            $('#columnSearchModal').modal('show');
        } else {
            alert('Error al abrir el modal de búsqueda. Por favor recarga la página.');
        }
    }
}

// Establecer alcance de búsqueda
window.setSearchScope = async function(scope) {
    window.currentColumnSearch.searchScope = scope;
    
    const firstBtn = document.getElementById('searchFirstBtn');
    const rangeBtn = document.getElementById('searchRangeBtn');
    const allBtn = document.getElementById('searchAllBtn');
    const rangeSelector = document.getElementById('rangeSelector');
    
    // Reset all buttons
    [firstBtn, rangeBtn, allBtn].forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-secondary');
    });
    
    // Highlight active button and show/hide range selector
    switch(scope) {
        case 'first':
            firstBtn.classList.remove('btn-outline-secondary');
            firstBtn.classList.add('btn-primary');
            rangeSelector.style.display = 'none';
            break;
        case 'range':
            rangeBtn.classList.remove('btn-outline-secondary');
            rangeBtn.classList.add('btn-primary');
            rangeSelector.style.display = 'block';
            
            // Si es la primera vez que se selecciona rango, cargar datos para conocer el tamaño
            if (!window.currentColumnSearch.columnData || window.currentColumnSearch.columnData.length === 0) {
                try {
                    showLoading('Cargando información de la columna...');
                    const response = await fetch(`/api/datasets/${currentColumnSearch.datasetId}/column-data/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            column_name: currentColumnSearch.columnName
                        })
                    });
                    
                    if (response.ok) {
                        const responseData = await response.json();
                        const data = responseData.data || responseData;
                        window.currentColumnSearch.columnData = data.values || [];
                    }
                } catch (error) {
                    console.error('Error loading column data:', error);
                } finally {
                    hideLoading();
                }
            }
            
            updateRangeInfo();
            break;
        case 'all':
            allBtn.classList.remove('btn-outline-secondary');
            allBtn.classList.add('btn-primary');
            rangeSelector.style.display = 'none';
            break;
    }
}

// Actualizar información del rango
window.updateRangeInfo = function() {
    const startInput = document.getElementById('rangeStart');
    const endInput = document.getElementById('rangeEnd');
    let start = parseInt(startInput.value) || 1;
    let end = parseInt(endInput.value) || 100;
    
    // Si tenemos datos cargados, validar contra el tamaño real
    if (window.currentColumnSearch.columnData && window.currentColumnSearch.columnData.length > 0) {
        const maxLength = window.currentColumnSearch.columnData.length;
        
        // Validar y ajustar el valor inicial
        if (start < 1) {
            start = 1;
            startInput.value = start;
        } else if (start > maxLength) {
            start = maxLength;
            startInput.value = start;
        }
        
        // Validar y ajustar el valor final
        if (end < start) {
            end = start;
            endInput.value = end;
        } else if (end > maxLength) {
            end = maxLength;
            endInput.value = end;
        }
        
        // Establecer el atributo max en los inputs
        startInput.max = maxLength;
        endInput.max = maxLength;
        
        // Mostrar información adicional si se ajustó el valor
        const count = Math.max(0, end - start + 1);
        let infoText = `(${count} valores)`;
        if (end === maxLength && parseInt(endInput.value) > maxLength) {
            infoText += ` <small class="text-warning">Máx: ${maxLength}</small>`;
        }
        document.getElementById('rangeInfo').innerHTML = infoText;
    } else {
        // Si no hay datos, solo mostrar el conteo
        const count = Math.max(0, end - start + 1);
        document.getElementById('rangeInfo').textContent = `(${count} valores)`;
    }
    
    // Actualizar valores en el objeto global
    window.currentColumnSearch.rangeStart = start;
    window.currentColumnSearch.rangeEnd = end;
}

// Mostrar modal de configuración de límite
window.showLimitModal = function() {
    document.getElementById('customSearchLimit').value = window.currentColumnSearch.searchLimit;
    const modal = new bootstrap.Modal(document.getElementById('searchLimitModal'));
    modal.show();
}

// Actualizar modal de configuración
window.updateConfigModal = function() {
    const isFirst = document.getElementById('configFirst').checked;
    document.getElementById('configFirstOptions').style.display = isFirst ? 'block' : 'none';
    document.getElementById('configRangeOptions').style.display = isFirst ? 'none' : 'block';
}

// Aplicar límite personalizado
window.applyCustomLimit = async function() {
    if (document.getElementById('configFirst').checked) {
        const newLimit = parseInt(document.getElementById('customSearchLimit').value);
        if (newLimit > 0) {
            // Si tenemos datos, validar contra el tamaño real
            if (window.currentColumnSearch.columnData && window.currentColumnSearch.columnData.length > 0) {
                const maxLength = window.currentColumnSearch.columnData.length;
                const validatedLimit = Math.min(newLimit, maxLength);
                window.currentColumnSearch.searchLimit = validatedLimit;
                document.getElementById('limitValue').textContent = validatedLimit;
                if (validatedLimit !== newLimit) {
                    showNotification('Información', `El límite se ajustó al tamaño del dataset: ${validatedLimit}`, 'info');
                }
            } else {
                window.currentColumnSearch.searchLimit = newLimit;
                document.getElementById('limitValue').textContent = newLimit;
            }
            setSearchScope('first');
        }
    } else {
        let start = parseInt(document.getElementById('customRangeStart').value);
        let end = parseInt(document.getElementById('customRangeEnd').value);
        
        if (start > 0 && end >= start) {
            // Si tenemos datos, validar contra el tamaño real
            if (window.currentColumnSearch.columnData && window.currentColumnSearch.columnData.length > 0) {
                const maxLength = window.currentColumnSearch.columnData.length;
                start = Math.min(start, maxLength);
                end = Math.min(end, maxLength);
                
                if (end < start) {
                    end = start;
                }
            }
            
            window.currentColumnSearch.rangeStart = start;
            window.currentColumnSearch.rangeEnd = end;
            document.getElementById('rangeStart').value = start;
            document.getElementById('rangeEnd').value = end;
            await setSearchScope('range');
        }
    }
    bootstrap.Modal.getInstance(document.getElementById('searchLimitModal')).hide();
}

// Toggle patrón personalizado
window.togglePatternMode = function() {
    const patternRow = document.getElementById('patternSelectorRow');
    const toggleBtn = event.target.closest('button');
    const toggleText = document.getElementById('patternToggleText');
    
    if (patternRow.style.display === 'none') {
        patternRow.style.display = 'block';
        toggleBtn.classList.remove('btn-outline-info');
        toggleBtn.classList.add('btn-info');
        toggleText.textContent = 'Desactivar patrón personalizado';
        window.currentColumnSearch.patternGrouping = true;
        loadPatternData();
    } else {
        patternRow.style.display = 'none';
        toggleBtn.classList.remove('btn-info');
        toggleBtn.classList.add('btn-outline-info');
        toggleText.textContent = 'Activar patrón personalizado';
        window.currentColumnSearch.patternGrouping = false;
        window.currentColumnSearch.selectedPattern = [];
    }
}

// Actualizar interfaz según tipo de búsqueda
window.updateSearchInterface = function() {
    const searchType = document.getElementById('searchType').value;
    const searchHint = document.getElementById('searchHint');
    const searchValue = document.getElementById('searchValue');
    
    switch(searchType) {
        case 'contains':
            searchHint.textContent = 'Buscar valores que contengan este texto';
            searchValue.placeholder = 'Ej: cloud, 2023, etc.';
            break;
        case 'startsWith':
            searchHint.textContent = 'Buscar valores que empiecen con este texto';
            searchValue.placeholder = 'Ej: A, 2023-, http://, etc.';
            break;
        case 'endsWith':
            searchHint.textContent = 'Buscar valores que terminen con este texto';
            searchValue.placeholder = 'Ej: .com, 2023, ing, etc.';
            break;
        case 'equals':
            searchHint.textContent = 'Buscar valores exactamente iguales a este texto';
            searchValue.placeholder = 'Ej: Clear, 2023, 0, etc.';
            break;
        case 'regex':
            searchHint.textContent = 'Usar expresión regular (compatible con JavaScript)';
            searchValue.placeholder = 'Ej: ^[A-Z], \\d{4}$, etc.';
            break;
    }
}

// Realizar búsqueda en columna
window.performColumnSearch = async function() {
    const searchType = document.getElementById('searchType').value;
    const searchValue = document.getElementById('searchValue').value.trim();
    const isPatternMode = window.currentColumnSearch.patternGrouping;
    
    // Validar patrón si está activo
    if (isPatternMode && window.currentColumnSearch.selectedPattern.length === 0) {
        showNotification('Error', 'Selecciona al menos un carácter para el patrón', 'warning');
        return;
    }
    
    // Validar valor de búsqueda si no hay patrón
    if (!isPatternMode && !searchValue) {
        showNotification('Error', 'Por favor ingrese un valor de búsqueda', 'warning');
        return;
    }
    
    // Mostrar loading
    showLoading('Buscando en la columna...');
    
    try {
        // Obtener datos de la columna
        const response = await fetch(`/api/datasets/${currentColumnSearch.datasetId}/column-data/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                column_name: currentColumnSearch.columnName
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('API Error:', response.status, errorText);
            throw new Error(`Error ${response.status}: ${errorText || 'Error al obtener datos de la columna'}`);
        }
        
        const responseData = await response.json();
        console.log('API Response:', responseData);
        
        // Check if response has a data wrapper
        const data = responseData.data || responseData;
        currentColumnSearch.columnData = data.values || [];
        const totalDataLength = currentColumnSearch.columnData.length;
        
        // Validar y ajustar los valores del rango
        if (window.currentColumnSearch.searchScope === 'range') {
            // Asegurar que los valores estén dentro del rango válido
            let startValue = parseInt(document.getElementById('rangeStart').value) || 1;
            let endValue = parseInt(document.getElementById('rangeEnd').value) || 100;
            
            // Validar y ajustar valores
            startValue = Math.max(1, Math.min(startValue, totalDataLength));
            endValue = Math.max(startValue, Math.min(endValue, totalDataLength));
            
            // Actualizar los inputs si se ajustaron los valores
            if (startValue !== window.currentColumnSearch.rangeStart) {
                document.getElementById('rangeStart').value = startValue;
                window.currentColumnSearch.rangeStart = startValue;
            }
            if (endValue !== window.currentColumnSearch.rangeEnd) {
                document.getElementById('rangeEnd').value = endValue;
                window.currentColumnSearch.rangeEnd = endValue;
            }
            
            // Actualizar la información del rango
            updateRangeInfo();
        }
        
        // Determinar qué valores buscar según el alcance
        let dataToSearch;
        let searchedRange;
        
        switch(window.currentColumnSearch.searchScope) {
            case 'all':
                dataToSearch = currentColumnSearch.columnData;
                searchedRange = { start: 1, end: totalDataLength };
                break;
            case 'range':
                const start = (window.currentColumnSearch.rangeStart || 1) - 1; // Convert to 0-based index
                const end = window.currentColumnSearch.rangeEnd || Math.min(100, totalDataLength);
                dataToSearch = currentColumnSearch.columnData.slice(start, end);
                searchedRange = { start: start + 1, end: Math.min(end, totalDataLength) };
                break;
            case 'first':
            default:
                const limit = Math.min(window.currentColumnSearch.searchLimit, totalDataLength);
                dataToSearch = currentColumnSearch.columnData.slice(0, limit);
                searchedRange = { start: 1, end: limit };
                break;
        }
        
        // Guardar el rango buscado
        window.currentColumnSearch.searchedRange = searchedRange;
        
        // Filtrar datos según tipo de búsqueda
        let matchedValues = [];
        let matchedValuesWithIndex = [];
        const totalValues = currentColumnSearch.columnData.length;
        
        // Calcular el offset basado en el alcance de búsqueda
        let indexOffset = 0;
        switch(window.currentColumnSearch.searchScope) {
            case 'range':
                indexOffset = (window.currentColumnSearch.rangeStart || 1) - 1;
                break;
            case 'first':
            case 'all':
            default:
                indexOffset = 0;
                break;
        }
        
        dataToSearch.forEach((value, localIndex) => {
            const strValue = String(value);
            let matches = false;
            
            switch(searchType) {
                case 'contains':
                    matches = strValue.toLowerCase().includes(searchValue.toLowerCase());
                    break;
                case 'startsWith':
                    matches = strValue.toLowerCase().startsWith(searchValue.toLowerCase());
                    break;
                case 'endsWith':
                    matches = strValue.toLowerCase().endsWith(searchValue.toLowerCase());
                    break;
                case 'equals':
                    matches = strValue === searchValue;
                    break;
                case 'regex':
                    try {
                        const regex = new RegExp(searchValue, 'i');
                        matches = regex.test(strValue);
                    } catch(e) {
                        console.error('Invalid regex:', e);
                    }
                    break;
            }
            
            if (matches) {
                matchedValues.push(value);
                matchedValuesWithIndex.push({
                    value: value,
                    index: localIndex + indexOffset + 1 // Índice basado en 1
                });
            }
        });
        
        // Guardar resultados para poder re-procesarlos
        window.currentColumnSearch.lastSearchResults = matchedValues;
        window.currentColumnSearch.lastSearchResultsWithIndex = matchedValuesWithIndex;
        window.currentColumnSearch.totalValues = totalValues;
        
        // Mostrar resultados (usar el tamaño del rango buscado, no el total)
        displaySearchResults(matchedValuesWithIndex, dataToSearch.length);
        
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error', 'Error al realizar la búsqueda', 'error');
    } finally {
        hideLoading();
    }
}

// Mostrar resultados de búsqueda
window.displaySearchResults = function(matchedValuesWithIndex, searchedCount) {
    // Verificar que el modal esté abierto y los elementos existan
    const modal = document.getElementById('columnSearchModal');
    if (!modal || !modal.classList.contains('show')) {
        console.error('Modal de búsqueda no está visible');
        return;
    }
    
    const matchCount = matchedValuesWithIndex.length;
    const percentage = searchedCount > 0 ? (matchCount / searchedCount * 100).toFixed(2) : 0;
    
    // Actualizar estadísticas con verificación
    const matchCountEl = document.getElementById('matchCount');
    const totalCountEl = document.getElementById('totalCount');
    const matchPercentageEl = document.getElementById('matchPercentage');
    
    if (matchCountEl) matchCountEl.textContent = matchCount;
    if (totalCountEl) totalCountEl.textContent = searchedCount;
    if (matchPercentageEl) matchPercentageEl.textContent = percentage;
    
    // Mostrar información del rango si aplica
    if (window.currentColumnSearch.searchedRange && totalCountEl) {
        const range = window.currentColumnSearch.searchedRange;
        const totalCountElement = totalCountEl.parentElement;
        if (totalCountElement) {
            let rangeInfo = '';
            
            if (window.currentColumnSearch.searchScope === 'range') {
                rangeInfo = ` <small class="text-info">(índices ${range.start}-${range.end})</small>`;
            } else if (window.currentColumnSearch.searchScope === 'first') {
                rangeInfo = ` <small class="text-info">(primeros ${searchedCount})</small>`;
            }
            
            totalCountElement.innerHTML = `<strong>Coincidencias encontradas:</strong> ${matchCount} de ${searchedCount} valores${rangeInfo}`;
        }
    }
    
    // Mostrar lista de todos los valores coincidentes
    const matchedValuesList = document.getElementById('matchedValuesList');
    if (!matchedValuesList) {
        console.error('Elemento matchedValuesList no encontrado');
        return;
    }
    matchedValuesList.innerHTML = '';
    
    let displayData = [];
    
    if (matchCount === 0) {
        matchedValuesList.innerHTML = '<p class="text-muted">No se encontraron coincidencias</p>';
    } else {
        
        if (window.currentColumnSearch.patternGrouping && window.currentColumnSearch.selectedPattern.length > 0) {
            // Agrupar por patrón seleccionado
            const patternGroups = {};
            const pattern = window.currentColumnSearch.selectedPattern;
            
            matchedValuesWithIndex.forEach(item => {
                const strValue = String(item.value);
                // Extraer caracteres según el patrón seleccionado
                const patternKey = pattern.map(idx => strValue[idx] || '').join('');
                
                if (!patternGroups[patternKey]) {
                    patternGroups[patternKey] = {
                        example: item.value,
                        exampleIndex: item.index,
                        count: 0,
                        indices: [],
                        pattern: pattern.map(idx => ({
                            char: strValue[idx] || '',
                            index: idx
                        }))
                    };
                }
                patternGroups[patternKey].count++;
                patternGroups[patternKey].indices.push(item.index);
            });
            
            // Convertir a array y ordenar por frecuencia
            displayData = Object.entries(patternGroups)
                .sort((a, b) => b[1].count - a[1].count)
                .map(([key, data]) => ({
                    value: `Patrón: ${data.pattern.map(p => p.char).join('')} (ej: ${data.example} en índice ${data.exampleIndex})`,
                    count: data.count,
                    patternInfo: data.pattern,
                    indices: data.indices
                }));
                
            matchedValuesList.innerHTML = `
                <div class="mb-2">
                    <strong>Patrones únicos encontrados: ${displayData.length}</strong>
                    <small class="text-muted d-block">Agrupado por caracteres en posiciones: ${pattern.join(', ')}</small>
                </div>
            `;
        } else {
            // Mostrar valores con sus índices
            const valueMap = new Map();
            
            matchedValuesWithIndex.forEach(item => {
                const key = String(item.value);
                if (!valueMap.has(key)) {
                    valueMap.set(key, {
                        value: item.value,
                        count: 0,
                        indices: []
                    });
                }
                const data = valueMap.get(key);
                data.count++;
                data.indices.push(item.index);
            });
            
            displayData = Array.from(valueMap.values())
                .sort((a, b) => b.count - a.count)
                .map(data => ({
                    value: data.value,
                    count: data.count,
                    indices: data.indices
                }));
                
            matchedValuesList.innerHTML = `
                <div class="mb-2">
                    <strong>Valores únicos encontrados: ${displayData.length}</strong>
                    <small class="text-muted d-block">Total coincidencias: ${matchCount}</small>
                </div>
            `;
        }
        
        // Mostrar los datos con índices
        const listHtml = displayData.map(({value, count, indices}) => {
            // Mostrar los primeros 5 índices y agregar "..." si hay más
            const indicesToShow = indices.slice(0, 5);
            const indicesText = indicesToShow.join(', ') + (indices.length > 5 ? ', ...' : '');
            
            return `<div class="border-bottom py-1">
                <div class="d-flex justify-content-between">
                    <small>${value}</small>
                    <small class="text-muted">(${count})</small>
                </div>
                <div class="text-muted" style="font-size: 0.75rem;">
                    <i class="bi bi-hash"></i> Índices: ${indicesText}
                </div>
            </div>`;
        }).join('');
        
        matchedValuesList.innerHTML += listHtml;
    }
    
    // Crear gráfico circular (usar el total buscado, no el total del dataset)
    const nonMatchCount = searchedCount - matchCount;
    createSearchResultChart(matchCount, nonMatchCount);
    
    // Crear gráfico de valores únicos
    if (displayData && displayData.length > 0) {
        createUniqueValuesChart(displayData);
    }
    
    // Mostrar sección de resultados
    const searchResults = document.getElementById('searchResults');
    if (searchResults) {
        searchResults.style.display = 'block';
    } else {
        console.error('Elemento searchResults no encontrado');
    }
}

// Crear gráfico circular de resultados
window.createSearchResultChart = function(matchCount, nonMatchCount) {
    const canvas = document.getElementById('searchResultChart');
    if (!canvas) {
        console.error('Canvas searchResultChart no encontrado');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Destruir gráfico anterior si existe
    if (window.searchResultChart && typeof window.searchResultChart.destroy === 'function') {
        window.searchResultChart.destroy();
        window.searchResultChart = null;
    }
    
    window.searchResultChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Coincidencias', 'No coincidencias'],
            datasets: [{
                data: [matchCount, nonMatchCount],
                backgroundColor: ['#0d6efd', '#e9ecef'],
                borderColor: ['#0d6efd', '#dee2e6'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: function(event, elements) {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const label = this.data.labels[index];
                    
                    // Mostrar valores según el segmento clickeado
                    if (index === 0) {
                        // Mostrar coincidencias con índices
                        showChartValuesWithIndex('Valores coincidentes', window.currentColumnSearch.lastSearchResultsWithIndex);
                    } else {
                        // Mostrar no coincidencias
                        showNonMatchingValues();
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                },
                title: {
                    display: true,
                    text: 'Distribución de coincidencias'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(2);
                            return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                        }
                    }
                }
            },
            onHover: function(event, activeElements) {
                ctx.canvas.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// Crear gráfico de valores únicos
window.createUniqueValuesChart = function(displayData) {
    const canvas = document.getElementById('uniqueValuesChart');
    if (!canvas) {
        console.error('Canvas uniqueValuesChart no encontrado');
        return;
    }
    
    // Verificar que hay datos para mostrar
    if (!displayData || displayData.length === 0) {
        console.log('No hay datos para mostrar en el gráfico de valores únicos');
        canvas.style.display = 'none';
        return;
    }
    
    canvas.style.display = 'block';
    const ctx = canvas.getContext('2d');
    
    // Destruir gráfico anterior si existe
    if (window.uniqueValuesChart && typeof window.uniqueValuesChart.destroy === 'function') {
        window.uniqueValuesChart.destroy();
        window.uniqueValuesChart = null;
    }
    
    // Tomar los primeros 15 valores únicos más frecuentes
    const topValues = displayData.slice(0, 15);
    
    // Preparar datos para el gráfico
    const labels = topValues.map(item => {
        // Truncar etiquetas largas
        const label = String(item.value);
        return label.length > 30 ? label.substring(0, 27) + '...' : label;
    });
    
    const data = topValues.map(item => item.count);
    
    // Crear paleta de colores amigables y visuales
    const friendlyColors = [
        '#FF6B6B', // Coral suave
        '#4ECDC4', // Turquesa
        '#45B7D1', // Azul cielo
        '#96CEB4', // Verde menta
        '#FECA57', // Amarillo cálido
        '#FF9FF3', // Rosa pastel
        '#54A0FF', // Azul brillante
        '#48DBFB', // Azul claro
        '#A29BFE', // Lavanda
        '#FD79A8', // Rosa
        '#FDCB6E', // Naranja suave
        '#6C5CE7', // Púrpura
        '#00D2D3', // Cian
        '#FF6348', // Rojo coral
        '#30336B'  // Azul marino
    ];
    
    // Si hay más de 15 valores, generar colores adicionales con variaciones
    const colors = topValues.map((_, index) => {
        if (index < friendlyColors.length) {
            return friendlyColors[index];
        } else {
            // Generar variaciones de los colores base
            const baseColor = friendlyColors[index % friendlyColors.length];
            const hueShift = Math.floor(index / friendlyColors.length) * 20;
            return adjustColor(baseColor, hueShift);
        }
    });
    
    // Función auxiliar para ajustar colores (definida inline para simplicidad)
    function adjustColor(color, hueShift) {
        // Convertir hex a HSL y ajustar el hue
        const hex = color.replace('#', '');
        const r = parseInt(hex.substr(0, 2), 16) / 255;
        const g = parseInt(hex.substr(2, 2), 16) / 255;
        const b = parseInt(hex.substr(4, 2), 16) / 255;
        
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;
        
        if (max === min) {
            h = s = 0;
        } else {
            const d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch (max) {
                case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                case g: h = ((b - r) / d + 2) / 6; break;
                case b: h = ((r - g) / d + 4) / 6; break;
            }
        }
        
        h = (h * 360 + hueShift) % 360;
        return `hsl(${h}, ${s * 100}%, ${l * 100}%)`;
    }
    
    // Calcular el total de coincidencias para los porcentajes
    const totalMatches = window.currentColumnSearch.lastSearchResults.length;
    
    window.uniqueValuesChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderColor: '#ffffff',
                borderWidth: 2,
                hoverBorderColor: '#ffffff',
                hoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: function(event, elements) {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const valueData = topValues[index];
                    
                    // Usar la misma función que el gráfico circular para mostrar valores con índices
                    const valuesWithIndex = valueData.indices.map(idx => ({
                        value: valueData.value,
                        index: idx
                    }));
                    
                    showChartValuesWithIndex(`Valor: ${valueData.value}`, valuesWithIndex);
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                },
                title: {
                    display: true,
                    text: `Top ${topValues.length} valores únicos encontrados`
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            // Mostrar el valor completo en el tooltip
                            const index = context[0].dataIndex;
                            return topValues[index].value;
                        },
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const percentage = ((value / totalMatches) * 100).toFixed(2);
                            return `Frecuencia: ${value} (${percentage}%)`;
                        },
                        afterLabel: function(context) {
                            const index = context.dataIndex;
                            const indices = topValues[index].indices;
                            if (indices && indices.length > 0) {
                                const indicesToShow = indices.slice(0, 5);
                                const indicesText = indicesToShow.join(', ') + (indices.length > 5 ? ', ...' : '');
                                return `Índices: ${indicesText}`;
                            }
                            return '';
                        }
                    }
                }
            },
            onHover: function(event, activeElements) {
                ctx.canvas.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
            }
        }
    });
}

// Mostrar valores del gráfico con índices
window.showChartValuesWithIndex = function(title, valuesWithIndex) {
    // Crear modal si no existe
    let modal = document.getElementById('chartValuesModal');
    if (!modal) {
        const modalHtml = `
            <div class="modal fade" id="chartValuesModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="chartValuesTitle"></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-2">
                                <strong>Total: <span id="chartValueCount">0</span> valores</strong>
                            </div>
                            <div id="chartValuesList" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        modal = document.getElementById('chartValuesModal');
    }
    
    // Actualizar contenido
    document.getElementById('chartValuesTitle').textContent = title;
    document.getElementById('chartValueCount').textContent = valuesWithIndex.length;
    
    // Crear mapa de valores con índices
    const valueMap = new Map();
    valuesWithIndex.forEach(item => {
        const key = String(item.value);
        if (!valueMap.has(key)) {
            valueMap.set(key, {
                value: item.value,
                count: 0,
                indices: []
            });
        }
        const data = valueMap.get(key);
        data.count++;
        data.indices.push(item.index);
    });
    
    // Ordenar por frecuencia
    const sortedValues = Array.from(valueMap.values())
        .sort((a, b) => b.count - a.count);
    
    // Mostrar valores con índices
    const listHtml = sortedValues.map(({ value, count, indices }) => {
        // Mostrar los primeros 10 índices y agregar "..." si hay más
        const indicesToShow = indices.slice(0, 10);
        const indicesText = indicesToShow.join(', ') + (indices.length > 10 ? ', ...' : '');
        
        return `
            <div class="border-bottom py-2">
                <div class="d-flex justify-content-between">
                    <span>${value}</span>
                    <span class="badge bg-secondary">${count}</span>
                </div>
                <div class="text-muted" style="font-size: 0.8rem;">
                    <i class="bi bi-hash"></i> Índices: ${indicesText}
                </div>
            </div>
        `;
    }).join('');
    
    document.getElementById('chartValuesList').innerHTML = listHtml || '<p class="text-muted">No hay valores para mostrar</p>';
    
    // Mostrar modal
    new bootstrap.Modal(modal).show();
}

// Mantener la función original para compatibilidad
window.showChartValues = function(title, values) {
    // Convertir valores simples a formato con índice
    const valuesWithIndex = values.map((value, index) => ({
        value: value,
        index: index + 1
    }));
    showChartValuesWithIndex(title, valuesWithIndex);
}

// Mostrar valores no coincidentes
window.showNonMatchingValues = async function() {
    showLoading('Calculando valores no coincidentes...');
    
    try {
        // Obtener los valores buscados según el alcance
        let searchedValues;
        switch(window.currentColumnSearch.searchScope) {
            case 'all':
                searchedValues = window.currentColumnSearch.columnData;
                break;
            case 'range':
                const start = (window.currentColumnSearch.rangeStart || 1) - 1;
                const end = window.currentColumnSearch.rangeEnd || 100;
                searchedValues = window.currentColumnSearch.columnData.slice(start, end);
                break;
            case 'first':
            default:
                const limit = window.currentColumnSearch.searchLimit;
                searchedValues = window.currentColumnSearch.columnData.slice(0, limit);
                break;
        }
        
        // Filtrar los que no coincidieron
        const matchedSet = new Set(window.currentColumnSearch.lastSearchResults.map(v => String(v)));
        const nonMatching = searchedValues.filter(value => !matchedSet.has(String(value)));
        
        hideLoading();
        showChartValues('Valores no coincidentes', nonMatching);
        
    } catch (error) {
        hideLoading();
        showNotification('Error', 'Error al calcular valores no coincidentes', 'error');
    }
}

// Cargar datos para el patrón
window.loadPatternData = async function() {
    if (window.currentColumnSearch.columnData && window.currentColumnSearch.columnData.length > 0) {
        // Ya tenemos datos
        updatePatternExample();
        return;
    }
    
    showLoading('Cargando datos de la columna...');
    
    try {
        const response = await fetch(`/api/datasets/${currentColumnSearch.datasetId}/column-data/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                column_name: currentColumnSearch.columnName
            })
        });
        
        if (!response.ok) {
            throw new Error('Error al obtener datos de la columna');
        }
        
        const responseData = await response.json();
        const data = responseData.data || responseData;
        window.currentColumnSearch.columnData = data.values || [];
        window.currentColumnSearch.lastSearchResults = window.currentColumnSearch.columnData;
        window.currentColumnSearch.totalValues = window.currentColumnSearch.columnData.length;
        
        updatePatternExample();
        
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error', 'Error al cargar datos de la columna', 'error');
    }
    
    hideLoading();
}


// Variable para debouncing
let updatePatternTimeout = null;

// Actualizar ejemplo de patrón
window.updatePatternExample = function() {
    // Clear previous timeout
    if (updatePatternTimeout) {
        clearTimeout(updatePatternTimeout);
    }
    
    // Debounce para evitar actualizaciones muy rápidas
    updatePatternTimeout = setTimeout(() => {
        const input = document.getElementById('patternExampleIndex');
        const index = parseInt(input.value) - 1;
        const results = window.currentColumnSearch.lastSearchResults;
        
        if (!results || results.length === 0) {
            document.getElementById('patternCharacters').innerHTML = '<p class="text-dark">No hay resultados de búsqueda</p>';
            return;
        }
        
        // Validar índice
        const validIndex = Math.max(0, Math.min(index, results.length - 1));
        if (validIndex !== index) {
            input.value = validIndex + 1;
        }
        
        // Actualizar límites del input
        input.max = results.length;
        
        // Obtener el valor del ejemplo
        const exampleValue = String(results[validIndex]);
        
        // Si tenemos resultados con índices, mostrar también el índice del dataset
        let datasetIndexInfo = '';
        if (window.currentColumnSearch.lastSearchResultsWithIndex && window.currentColumnSearch.lastSearchResultsWithIndex[validIndex]) {
            const datasetIndex = window.currentColumnSearch.lastSearchResultsWithIndex[validIndex].index;
            datasetIndexInfo = ` <small class="text-muted">(Índice en dataset: ${datasetIndex})</small>`;
        }
        
        // Crear caracteres clickeables
        const charsHtml = exampleValue.split('').map((char, idx) => {
            const isSelected = window.currentColumnSearch.selectedPattern.includes(idx);
            return `<span class="pattern-char ${isSelected ? 'selected' : ''}" 
                         data-index="${idx}" 
                         onclick="togglePatternChar(${idx})">${char}</span>`;
        }).join('');
        
        document.getElementById('patternCharacters').innerHTML = charsHtml + datasetIndexInfo;
    }, 100); // 100ms debounce
}

// Toggle selección de carácter
window.togglePatternChar = function(index) {
    const pattern = window.currentColumnSearch.selectedPattern;
    const idx = pattern.indexOf(index);
    
    if (idx > -1) {
        pattern.splice(idx, 1);
    } else {
        pattern.push(index);
    }
    
    // Reordenar para mantener el orden de índices
    pattern.sort((a, b) => a - b);
    
    // Actualizar visualización
    updatePatternExample();
}

// Limpiar selección de patrón
window.clearPatternSelection = function() {
    window.currentColumnSearch.selectedPattern = [];
    updatePatternExample();
}


// Actualizar resultados cuando se cambia el toggle de agrupación
window.updateSearchResults = function() {
    if (window.currentColumnSearch.lastSearchResults && window.currentColumnSearch.lastSearchResults.length > 0) {
        displaySearchResults(window.currentColumnSearch.lastSearchResults, window.currentColumnSearch.totalValues);
    }
}

// Limpiar búsqueda
window.clearColumnSearch = function() {
    document.getElementById('searchValue').value = '';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('patternSelectorRow').style.display = 'none';
    document.getElementById('searchType').value = 'contains';
    
    // Reset pattern button
    const toggleBtn = document.querySelector('[onclick="togglePatternMode()"]');
    if (toggleBtn) {
        toggleBtn.classList.remove('btn-info');
        toggleBtn.classList.add('btn-outline-info');
        document.getElementById('patternToggleText').textContent = 'Activar patrón personalizado';
    }
    
    // Reset search scope
    window.currentColumnSearch.searchScope = 'limited';
    window.currentColumnSearch.searchLimit = 100;
    document.getElementById('limitValue').textContent = '100';
    setSearchScope('limited');
    
    updateSearchInterface();
    window.currentColumnSearch.lastSearchResults = [];
    window.currentColumnSearch.totalValues = 0;
    window.currentColumnSearch.selectedPattern = [];
    window.currentColumnSearch.patternGrouping = false;
    if (window.searchResultChart && typeof window.searchResultChart.destroy === 'function') {
        window.searchResultChart.destroy();
        window.searchResultChart = null;
    }
}

// Mostrar outliers
function showOutliers(columnName) {
    const data = window.currentDatasetData;
    if (!data || !data.stats || !data.stats[columnName]) {
        showNotification('Error', 'No hay datos disponibles para esta columna', 'error');
        return;
    }
    
    const colStats = data.stats[columnName];
    
    if (!colStats.q25 || !colStats.q75) {
        showNotification('Error', 'No se pueden calcular outliers para esta columna', 'warning');
        return;
    }
    
    // Calcular outliers localmente
    const iqr = colStats.q75 - colStats.q25;
    const lowerBound = colStats.q25 - (1.5 * iqr);
    const upperBound = colStats.q75 + (1.5 * iqr);
    
    // Variables para scroll infinito y filtrado
    let outlierValues = [];
    let filteredOutlierValues = [];
    let currentFilter = 'all';
    let outlierInfo = null;
    let currentPage = 0;
    const itemsPerPage = 20;
    let isLoading = false;
    
    // Crear contenido del modal
    let modalContent = `
        <div class="modal fade" id="outliersModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-exclamation-triangle"></i> Análisis de Outliers - "${columnName}"
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card bg-dark border-info">
                                    <div class="card-body">
                                        <h6 class="text-info">Método IQR (Rango Intercuartílico)</h6>
                                        <p class="mb-2"><strong>Q1 (25%):</strong> ${colStats.q25.toFixed(2)}</p>
                                        <p class="mb-2"><strong>Q3 (75%):</strong> ${colStats.q75.toFixed(2)}</p>
                                        <p class="mb-2"><strong>IQR:</strong> ${iqr.toFixed(2)}</p>
                                        <hr>
                                        <p class="mb-2"><strong>Límite inferior:</strong> ${lowerBound.toFixed(2)}</p>
                                        <p class="mb-0"><strong>Límite superior:</strong> ${upperBound.toFixed(2)}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-dark border-warning">
                                    <div class="card-body">
                                        <h6 class="text-warning">Resumen de Outliers</h6>
                                        <p class="mb-2">
                                            <i class="bi bi-arrow-down-circle"></i> 
                                            <strong>Valores por debajo:</strong> 
                                            <span class="text-info" id="outliersBelowCount">0</span>
                                        </p>
                                        <p class="mb-2">
                                            <i class="bi bi-arrow-up-circle"></i> 
                                            <strong>Valores por encima:</strong> 
                                            <span class="text-warning" id="outliersAboveCount">0</span>
                                        </p>
                                        <p class="mb-0">
                                            <i class="bi bi-sum"></i> 
                                            <strong>Total outliers:</strong> 
                                            <span class="text-danger" id="outliersTotal">0</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="text-primary mb-3">Diagrama de Caja (Box Plot)</h6>
                        <div class="text-center mb-4">
                            <canvas id="outlierBoxPlot" height="200"></canvas>
                        </div>
                        
                        <h6 class="text-primary mb-3">Valores Outliers Detectados</h6>
                        
                        <!-- Controles de filtrado -->
                        <div class="mb-3">
                            <div class="btn-group btn-group-sm w-100" role="group">
                                <button type="button" class="btn btn-outline-info active" id="filterAll" onclick="filterOutliers('all')">
                                    <i class="bi bi-list"></i> Todos
                                </button>
                                <button type="button" class="btn btn-outline-info" id="filterBelow" onclick="filterOutliers('below')">
                                    <i class="bi bi-arrow-down-circle"></i> Por debajo
                                </button>
                                <button type="button" class="btn btn-outline-info" id="filterAbove" onclick="filterOutliers('above')">
                                    <i class="bi bi-arrow-up-circle"></i> Por encima
                                </button>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    Mostrando: <span id="outlierFilterStatus" class="text-info">Todos los outliers</span> | 
                                    Total visible: <span id="visibleOutliersCount" class="text-warning">0</span>
                                </small>
                            </div>
                        </div>
                        
                        <div id="outlierValuesContent" style="max-height: 500px; overflow-y: auto; border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 5px; padding: 10px;">
                            <div class="text-center p-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3" id="outlierRangeInfo" style="display: none;">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                <strong>Rango de valores normales:</strong> [${lowerBound.toFixed(2)}, ${upperBound.toFixed(2)}]
                                <br>
                                <small>Los valores fuera de este rango se consideran outliers potenciales.</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal anterior si existe
    const existingModal = document.getElementById('outliersModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Agregar modal al documento
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // Mostrar modal
    const modalElement = document.getElementById('outliersModal');
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: false,  // Sin backdrop
        keyboard: true
    });
    modal.show();
    
    // Función para cargar outliers
    function loadOutliers() {
        if (isLoading) return;
        isLoading = true;
        
        // Mostrar el rango de outliers
        document.getElementById('outlierRangeInfo').style.display = 'block';
        
        fetch(`/api/datasets/${selectedDataset.id}/columns/${encodeURIComponent(columnName)}/`)
            .then(response => response.json())
            .then(data => {
                const outlierInfo = data.outlier_info;
                if (outlierInfo) {
                    outlierValues = outlierInfo.outlier_values || [];
                    renderOutliers();
                    
                    // Actualizar estadísticas en el DOM
                    if (outlierInfo && outlierValues.length > 0) {
                        // Calcular outliers por encima y por debajo
                        const belowCount = outlierValues.filter(v => v < outlierInfo.lower_bound).length;
                        const aboveCount = outlierValues.filter(v => v > outlierInfo.upper_bound).length;
                        
                        // Actualizar contadores
                        document.getElementById('outliersBelowCount').textContent = belowCount;
                        document.getElementById('outliersAboveCount').textContent = aboveCount;
                        document.getElementById('outliersTotal').textContent = outlierValues.length;
                    }
                    
                    // Crear box plot
                    setTimeout(() => {
                        const ctx = document.getElementById('outlierBoxPlot').getContext('2d');
                        new Chart(ctx, {
                            type: 'boxplot',
                            data: {
                                labels: [columnName],
                                datasets: [{
                                    label: 'Distribución',
                                    backgroundColor: 'rgba(0, 212, 255, 0.5)',
                                    borderColor: 'rgba(0, 212, 255, 1)',
                                    borderWidth: 1,
                                    outlierColor: '#ff0000',
                                    data: [{
                                        min: colStats.min,
                                        q1: outlierInfo.q1,
                                        median: colStats.q50,
                                        q3: outlierInfo.q3,
                                        max: colStats.max,
                                        outliers: outlierValues.slice(0, 50) // Mostrar máximo 50 outliers en el gráfico
                                    }]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const data = context.parsed;
                                                return [
                                                    `Min: ${data.min.toFixed(2)}`,
                                                    `Q1: ${data.q1.toFixed(2)}`,
                                                    `Mediana: ${data.median.toFixed(2)}`,
                                                    `Q3: ${data.q3.toFixed(2)}`,
                                                    `Max: ${data.max.toFixed(2)}`
                                                ];
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        ticks: { color: '#f0f9ff' },
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                    }
                                }
                            }
                        });
                    }, 100);
                }
                isLoading = false;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('outlierValuesContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error al cargar los outliers
                    </div>
                `;
                isLoading = false;
            });
    }
    
    // Función para filtrar outliers
    window.filterOutliers = function(type) {
        currentFilter = type;
        currentPage = 0;
        
        // Actualizar botones activos
        document.querySelectorAll('#outliersModal .btn-group button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        if (type === 'all') {
            document.getElementById('filterAll').classList.add('active');
            document.getElementById('outlierFilterStatus').textContent = 'Todos los outliers';
            filteredOutlierValues = outlierValues;
        } else if (type === 'below') {
            document.getElementById('filterBelow').classList.add('active');
            document.getElementById('outlierFilterStatus').textContent = 'Outliers por debajo del límite inferior';
            const lowerBound = colStats.q25 - (1.5 * (colStats.q75 - colStats.q25));
            filteredOutlierValues = outlierValues.filter(v => v < lowerBound);
        } else if (type === 'above') {
            document.getElementById('filterAbove').classList.add('active');
            document.getElementById('outlierFilterStatus').textContent = 'Outliers por encima del límite superior';
            const upperBound = colStats.q75 + (1.5 * (colStats.q75 - colStats.q25));
            filteredOutlierValues = outlierValues.filter(v => v > upperBound);
        }
        
        // Re-renderizar
        const container = document.getElementById('outlierValuesContent');
        container.innerHTML = '';
        renderOutliers();
    };
    
    // Función para renderizar outliers
    function renderOutliers() {
        const container = document.getElementById('outlierValuesContent');
        const valuesToRender = filteredOutlierValues.length > 0 || currentFilter !== 'all' ? filteredOutlierValues : outlierValues;
        const startIdx = currentPage * itemsPerPage;
        const endIdx = Math.min(startIdx + itemsPerPage, valuesToRender.length);
        
        // Actualizar contador de visibles
        document.getElementById('visibleOutliersCount').textContent = valuesToRender.length;
        
        if (currentPage === 0) {
            if (outlierValues.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> No se detectaron outliers en esta variable
                    </div>
                `;
                return;
            }
            
            if (valuesToRender.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No se encontraron outliers con los filtros actuales
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Valor</th>
                                <th>Tipo</th>
                            </tr>
                        </thead>
                        <tbody id="outlierTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="outlierLoadingIndicator" class="text-center mt-3" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Cargando más...</span>
                    </div>
                </div>
            `;
        }
        
        // Agregar valores
        const tbody = document.getElementById('outlierTableBody');
        const iqr = colStats.q75 - colStats.q25;
        const lowerBound = colStats.q25 - (1.5 * iqr);
        const upperBound = colStats.q75 + (1.5 * iqr);
        
        for (let i = startIdx; i < endIdx; i++) {
            const value = valuesToRender[i];
            const type = value < lowerBound ? 'Bajo' : 'Alto';
            const typeClass = value < lowerBound ? 'text-info' : 'text-warning';
            
            tbody.innerHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td><strong>${value.toFixed(4)}</strong></td>
                    <td><span class="${typeClass}">${type}</span></td>
                </tr>
            `;
        }
        
        // Configurar scroll infinito
        const scrollContainer = document.getElementById('outlierValuesContent');
        scrollContainer.onscroll = function() {
            if (scrollContainer.scrollTop + scrollContainer.clientHeight >= scrollContainer.scrollHeight - 50) {
                if (currentPage * itemsPerPage < valuesToRender.length) {
                    currentPage++;
                    document.getElementById('outlierLoadingIndicator').style.display = 'block';
                    setTimeout(() => {
                        renderOutliers();
                        document.getElementById('outlierLoadingIndicator').style.display = 'none';
                    }, 300);
                }
            }
        };
    }
    
    // Cargar outliers iniciales
    loadOutliers();
    
    // Limpiar al cerrar
    document.getElementById('outliersModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
}

// Función de limpieza de emergencia
function emergencyCleanup() {
    // Cerrar todos los modales abiertos
    document.querySelectorAll('.modal.show').forEach(modal => {
        const modalInstance = bootstrap.Modal.getInstance(modal);
        if (modalInstance) {
            modalInstance.hide();
        }
    });
    
    // Eliminar todos los backdrops
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    
    // Limpiar clases del body
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
    
    // Ocultar loading spinner
    hideLoading();
}

// Detectar tecla ESC para limpieza de emergencia
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        emergencyCleanup();
    }
});

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // Limpiar cualquier modal o backdrop residual al cargar la página
    emergencyCleanup();
    
    // Agregar listeners para limpiar cuando se ocultan los modals
    const uploadModal = document.getElementById('uploadProgressModal');
    uploadModal.addEventListener('hidden.bs.modal', function () {
        setTimeout(() => {
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        }, 100);
    });
    
    const detailModal = document.getElementById('datasetDetailModal');
    detailModal.addEventListener('hidden.bs.modal', function () {
        setTimeout(() => {
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        }, 100);
    });
    
    // Add event listener for column search modal
    const columnSearchModal = document.getElementById('columnSearchModal');
    if (columnSearchModal) {
        columnSearchModal.addEventListener('show.bs.modal', function (event) {
            console.log('Column search modal is being shown');
            // Button that triggered the modal
            const button = event.relatedTarget;
            if (button) {
                const columnName = button.getAttribute('data-column-name');
                const datasetId = button.getAttribute('data-dataset-id');
                
                console.log('Modal data:', { columnName, datasetId });
                
                if (columnName && datasetId) {
                    window.currentColumnSearch.columnName = columnName;
                    window.currentColumnSearch.datasetId = datasetId;
                    
                    // Update modal title
                    const columnNameElement = document.getElementById('searchColumnName');
                    if (columnNameElement) {
                        columnNameElement.textContent = columnName;
                    }
                    
                    // Clear previous search
                    if (window.clearColumnSearch) {
                        window.clearColumnSearch();
                    }
                }
            }
        });
    }
    
    // Cargar datasets con callback para manejar URL params
    loadDatasets().then(() => {
        // Verificar si hay un dataset específico para abrir
        const urlParams = new URLSearchParams(window.location.search);
        const datasetToOpen = urlParams.get('open');
        const shouldRefresh = urlParams.get('refresh');
        const hash = window.location.hash;
        
        // Si viene de una normalización, limpiar la URL y recargar
        if (shouldRefresh === 'true') {
            // Limpiar el parámetro de la URL
            const newUrl = window.location.pathname + window.location.hash;
            window.history.replaceState({}, document.title, newUrl);
            
            // Forzar recarga de datasets después de un breve delay
            setTimeout(() => {
                console.log('Forcing dataset reload after normalization...');
                loadDatasets();
            }, 500);
        }
        
        if (datasetToOpen) {
            // Abrir dataset desde parámetro URL
            setTimeout(() => {
                const datasetCard = document.querySelector(`[data-dataset-id="${datasetToOpen}"] .dataset-clickable`);
                if (datasetCard) {
                    datasetCard.click();
                }
            }, 500);
        } else if (hash && hash.startsWith('#dataset-')) {
            // Abrir dataset desde hash
            const datasetId = hash.replace('#dataset-', '');
            setTimeout(() => {
                const datasetCard = document.querySelector(`[data-dataset-id="${datasetId}"] .dataset-clickable`);
                if (datasetCard) {
                    datasetCard.click();
                }
            }, 500);
        }
    });
    initDragDrop();
    
    // Actualiser toutes les 30 secondes
    setInterval(loadDatasets, 30000);
});

// Función para generar análisis generales (correlación y PCA)
function generateGeneralAnalysis(analysisType) {
    if (!selectedDataset) {
        showNotification('Error', 'Por favor selecciona un dataset primero', 'error');
        return;
    }
    
    const container = document.getElementById('generalAnalysisContainer');
    
    // Mostrar loading
    container.innerHTML = `
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Generando análisis...</span>
            </div>
            <p class="mt-3">Generando ${analysisType === 'correlation' ? 'Matriz de Correlación' : 'Análisis PCA'}...</p>
        </div>
    `;
    
    // Hacer la petición al endpoint actualizado
    fetch(`/api/datasets/${selectedDataset.id}/analysis/?type=${analysisType}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'error') {
                throw new Error(data.error || 'Error desconocido');
            }
            
            // Mostrar el resultado
            let resultHtml = `
                <div class="analysis-result mt-3 p-3 bg-light rounded">
                    <h6 class="text-primary mb-3">
                        <i class="bi ${analysisType === 'correlation' ? 'bi-grid-3x3' : 'bi-arrows-angle-contract'}"></i>
                        ${analysisType === 'correlation' ? 'Matriz de Correlación' : 'Análisis PCA'}
                    </h6>
            `;
            
            // Mostrar imagen
            if (data.image) {
                resultHtml += `
                    <div class="text-center mb-3">
                        <img src="${data.image}" class="img-fluid" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    </div>
                `;
            }
            
            // Mostrar estadísticas
            if (data.statistics) {
                if (analysisType === 'correlation' && data.statistics.strong_correlations) {
                    resultHtml += `
                        <div class="mt-3">
                            <h6>Correlaciones Fuertes (|r| > 0.5):</h6>
                            <ul class="list-unstyled">
                    `;
                    data.statistics.strong_correlations.forEach(corr => {
                        const color = corr.correlation > 0 ? 'text-success' : 'text-danger';
                        resultHtml += `
                            <li>
                                <i class="bi bi-arrow-left-right ${color}"></i>
                                <strong>${corr.var1}</strong> ↔ <strong>${corr.var2}</strong>: 
                                <span class="${color}">${corr.correlation.toFixed(3)}</span>
                            </li>
                        `;
                    });
                    resultHtml += `</ul></div>`;
                } else if (analysisType === 'pca' && data.statistics) {
                    resultHtml += `
                        <div class="mt-3">
                            <p><strong>Variables analizadas:</strong> ${data.statistics.total_variables}</p>
                            <p><strong>Componentes para 95% varianza:</strong> ${data.statistics.n_components_95_variance}</p>
                            <h6>Varianza explicada por componente:</h6>
                            <ul class="list-unstyled">
                    `;
                    if (data.statistics.explained_variance_ratio) {
                        data.statistics.explained_variance_ratio.forEach((variance, idx) => {
                            resultHtml += `
                                <li>PC${idx + 1}: ${(variance * 100).toFixed(2)}%</li>
                            `;
                        });
                    }
                    resultHtml += `</ul></div>`;
                }
            }
            
            resultHtml += `</div>`;
            container.innerHTML = resultHtml;
        })
        .catch(error => {
            console.error('Error en análisis:', error);
            container.innerHTML = `
                <div class="alert alert-danger mt-3">
                    <i class="bi bi-exclamation-triangle"></i> Error al generar análisis
                    <br><small>${error.message}</small>
                </div>
            `;
        });
}

// Función para generar gráfico radar de todas las variables
function generateRadarChart() {
    if (!selectedDataset) {
        showNotification('Error', 'Por favor selecciona un dataset primero', 'error');
        return;
    }
    
    const container = document.getElementById('generalAnalysisContainer');
    const data = window.currentDatasetData;
    
    if (!data || !data.stats) {
        showNotification('Error', 'No hay datos disponibles', 'error');
        return;
    }
    
    // Filtrar solo variables numéricas
    const numericColumns = Object.keys(data.stats).filter(col => {
        const stats = data.stats[col];
        return stats && stats.mean !== undefined;
    });
    
    if (numericColumns.length < 3) {
        showNotification('Error', 'Se necesitan al menos 3 variables numéricas para el gráfico radar', 'warning');
        return;
    }
    
    // Mostrar loading
    container.innerHTML = `
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Generando gráfico radar...</span>
            </div>
            <p class="mt-3">Generando Gráfico Radar...</p>
        </div>
    `;
    
    // Preparar datos para el gráfico
    const labels = numericColumns;
    const datasets = [];
    
    // Dataset 1: Valores medios normalizados (0-1)
    const meanValues = numericColumns.map(col => {
        const stats = data.stats[col];
        const min = stats.min || 0;
        const max = stats.max || 1;
        const mean = stats.mean || 0;
        // Normalizar a escala 0-100
        return ((mean - min) / (max - min)) * 100;
    });
    
    datasets.push({
        label: 'Valores Medios (Normalizados)',
        data: meanValues,
        backgroundColor: 'rgba(0, 212, 255, 0.2)',
        borderColor: 'rgba(0, 212, 255, 1)',
        borderWidth: 2,
        pointBackgroundColor: 'rgba(0, 212, 255, 1)',
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: 'rgba(0, 212, 255, 1)'
    });
    
    // Dataset 2: Desviación estándar normalizada
    const stdValues = numericColumns.map(col => {
        const stats = data.stats[col];
        const std = stats.std || 0;
        const mean = stats.mean || 1;
        // Coeficiente de variación normalizado a escala 0-100
        const cv = mean !== 0 ? (std / Math.abs(mean)) * 100 : 0;
        return Math.min(cv, 100); // Limitar a 100
    });
    
    datasets.push({
        label: 'Variabilidad (Coef. Variación)',
        data: stdValues,
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        borderColor: 'rgba(255, 99, 132, 1)',
        borderWidth: 2,
        pointBackgroundColor: 'rgba(255, 99, 132, 1)',
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: 'rgba(255, 99, 132, 1)'
    });
    
    // Crear el gráfico
    setTimeout(() => {
        container.innerHTML = `
            <div class="analysis-result mt-3 p-3 bg-light rounded">
                <h6 class="text-primary mb-3">
                    <i class="bi bi-radar"></i> Gráfico Radar de Variables Numéricas
                </h6>
                <div class="row">
                    <div class="col-md-8">
                        <canvas id="radarChart" style="max-height: 500px;"></canvas>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-info">
                            <h6>Interpretación:</h6>
                            <ul class="mb-0">
                                <li><strong>Azul:</strong> Valores medios normalizados (0-100)</li>
                                <li><strong>Rojo:</strong> Variabilidad relativa de cada variable</li>
                                <li>Variables con valores altos en azul tienen valores medios más cercanos a su máximo</li>
                                <li>Variables con valores altos en rojo tienen mayor dispersión relativa</li>
                            </ul>
                        </div>
                        <div class="mt-3">
                            <h6>Variables incluidas (${numericColumns.length}):</h6>
                            <ul class="list-unstyled" style="max-height: 300px; overflow-y: auto;">
                                ${numericColumns.map(col => `
                                    <li class="mb-1">
                                        <i class="bi bi-dot"></i> ${col}
                                        <small class="text-muted">
                                            (μ: ${data.stats[col].mean?.toFixed(2) || 'N/A'})
                                        </small>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Configurar y crear el gráfico
        const ctx = document.getElementById('radarChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Análisis Multivariable del Dataset'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.r || context.parsed.y;
                                const variable = context.label;
                                const stats = data.stats[variable];
                                
                                let tooltipText = `${label}: ${value.toFixed(2)}%`;
                                if (context.datasetIndex === 0 && stats) {
                                    tooltipText += `\nMedia real: ${stats.mean?.toFixed(2) || 'N/A'}`;
                                    tooltipText += `\nRango: [${stats.min?.toFixed(2) || 'N/A'}, ${stats.max?.toFixed(2) || 'N/A'}]`;
                                } else if (context.datasetIndex === 1 && stats) {
                                    tooltipText += `\nDesv. Estándar: ${stats.std?.toFixed(2) || 'N/A'}`;
                                }
                                return tooltipText;
                            }
                        }
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20,
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        pointLabels: {
                            font: {
                                size: 10
                            },
                            callback: function(value) {
                                // Truncar nombres largos
                                return value.length > 15 ? value.substring(0, 12) + '...' : value;
                            }
                        }
                    }
                }
            }
        });
    }, 100);
}

// Variables del editor de dataset
let editorModal = null;
let selectedEditorColumn = null;
let columnFrequencyData = {};

// Función para abrir el editor desde el modal de detalles
function openDatasetEditorFromModal() {
    if (!window.currentDatasetData || !window.selectedDataset) {
        showNotification('Error', 'Primero debes cargar el análisis del dataset', 'error');
        return;
    }
    
    // Cerrar el modal de detalles
    const detailModal = bootstrap.Modal.getInstance(document.getElementById('datasetDetailModal'));
    if (detailModal) {
        detailModal.hide();
    }
    
    // Esperar un momento y abrir el editor
    setTimeout(() => {
        openDatasetEditor();
    }, 300);
}

// Función para abrir el editor de dataset
function openDatasetEditor() {
    if (!window.currentDatasetData) {
        showNotification('Error', 'Primero debes cargar el análisis del dataset', 'error');
        return;
    }
    
    // Inicializar el modal si no existe
    if (!editorModal) {
        editorModal = new bootstrap.Modal(document.getElementById('datasetEditorModal'));
    }
    
    // Limpiar selección previa
    selectedEditorColumn = null;
    document.getElementById('columnEditPanel').style.display = 'none';
    document.getElementById('noColumnSelected').style.display = 'block';
    
    // Llenar la lista de columnas
    populateColumnList();
    
    // Mostrar el modal
    editorModal.show();
}

// Función para llenar la lista de columnas
function populateColumnList() {
    const columnList = document.getElementById('columnListEditor');
    const columns = window.currentDatasetData.columns || [];
    const stats = window.currentDatasetData.stats || {};
    
    let html = '';
    columns.forEach(col => {
        const colStats = stats[col] || {};
        const nullPercentage = colStats.null_percentage || 0;
        const uniqueCount = colStats.unique_count || 0;
        const colType = colStats.type || 'unknown';
        const isNumeric = colType === 'numeric' || colType === 'numeric_string';
        
        // Determine display type
        let displayType = colType;
        if (colType === 'numeric') displayType = 'numérico';
        else if (colType === 'numeric_string') displayType = 'numérico (texto)';
        else if (colType === 'text') displayType = 'texto';
        else if (colType === 'categorical') displayType = 'categórico';
        else if (colType === 'datetime') displayType = 'fecha/hora';
        else if (colType === 'insufficient_data') displayType = 'insuficiente';
        
        html += `
            <a href="#" class="list-group-item list-group-item-action" 
               onclick="selectColumnForEdit('${col}')" data-column="${col}">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1 text-white">${col}</h6>
                    <small>
                        <span class="badge bg-${isNumeric ? 'success' : colType === 'categorical' ? 'warning' : 'info'}">
                            ${displayType}
                        </span>
                    </small>
                </div>
                <small class="text-info">
                    ${uniqueCount} valores únicos | ${nullPercentage.toFixed(1)}% nulos
                </small>
            </a>
        `;
    });
    
    columnList.innerHTML = html;
}

// Función para seleccionar una columna para editar
function selectColumnForEdit(columnName) {
    selectedEditorColumn = columnName;
    
    // Actualizar UI
    document.querySelectorAll('#columnListEditor .list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`#columnListEditor [data-column="${columnName}"]`).classList.add('active');
    
    // Mostrar panel de edición
    document.getElementById('columnEditPanel').style.display = 'block';
    document.getElementById('noColumnSelected').style.display = 'none';
    document.getElementById('selectedColumnName').textContent = columnName;
    
    // Cargar estadísticas
    loadColumnStatistics(columnName);
    
    // Cargar valores únicos y frecuencias
    loadColumnFrequencies(columnName);
}

// Función para cargar estadísticas de la columna
function loadColumnStatistics(columnName) {
    const stats = window.currentDatasetData.stats[columnName] || {};
    const statsDiv = document.getElementById('columnStatistics');
    
    let html = '<div class="row">';
    
    if (stats.is_numeric) {
        html += `
            <div class="col-md-6">
                <p><strong class="text-warning">Media:</strong> <span class="text-white">${stats.mean?.toFixed(4) || 'N/A'}</span></p>
                <p><strong class="text-warning">Desviación estándar:</strong> <span class="text-white">${stats.std?.toFixed(4) || 'N/A'}</span></p>
                <p><strong class="text-warning">Mínimo:</strong> <span class="text-white">${stats.min || 'N/A'}</span></p>
            </div>
            <div class="col-md-6">
                <p><strong class="text-warning">Máximo:</strong> <span class="text-white">${stats.max || 'N/A'}</span></p>
                <p><strong class="text-warning">Valores únicos:</strong> <span class="text-white">${stats.unique_count || 0}</span></p>
                <p><strong class="text-warning">Valores nulos:</strong> <span class="text-white">${stats.null_count || 0} (${stats.null_percentage?.toFixed(2) || 0}%)</span></p>
            </div>
        `;
    } else {
        html += `
            <div class="col-md-6">
                <p><strong class="text-warning">Tipo:</strong> <span class="text-white">${stats.python_type || 'unknown'}</span></p>
                <p><strong class="text-warning">Valores únicos:</strong> <span class="text-white">${stats.unique_count || 0}</span></p>
            </div>
            <div class="col-md-6">
                <p><strong class="text-warning">Valores nulos:</strong> <span class="text-white">${stats.null_count || 0} (${stats.null_percentage?.toFixed(2) || 0}%)</span></p>
                <p><strong class="text-warning">Filas totales:</strong> <span class="text-white">${window.currentDatasetData.row_count || 0}</span></p>
            </div>
        `;
    }
    
    html += '</div>';
    statsDiv.innerHTML = html;
}

// Función para cargar frecuencias de valores
async function loadColumnFrequencies(columnName) {
    showLoading('Cargando valores únicos...', 'Por favor espera');
    
    try {
        const response = await fetch(`/api/datasets/${window.selectedDataset.id}/columns/${encodeURIComponent(columnName)}/`);
        const data = await response.json();
        
        hideLoading();
        
        if (response.ok && data.frequency_data) {
            columnFrequencyData[columnName] = data.frequency_data;
            displayFrequencyTable(data.frequency_data);
        } else {
            showNotification('Error', 'No se pudieron cargar los valores únicos', 'error');
        }
    } catch (error) {
        hideLoading();
        console.error('Error:', error);
        showNotification('Error', 'Error al cargar los valores únicos', 'error');
    }
}

// Función para mostrar la tabla de frecuencias
function displayFrequencyTable(frequencyData) {
    const tableDiv = document.getElementById('uniqueValuesTable');
    
    if (!frequencyData || frequencyData.length === 0) {
        tableDiv.innerHTML = '<p class="text-muted">No hay datos de frecuencia disponibles</p>';
        return;
    }
    
    let html = `
        <table class="table table-sm table-dark table-hover">
            <thead>
                <tr>
                    <th class="text-info">Valor</th>
                    <th class="text-info">Frecuencia</th>
                    <th class="text-info">Porcentaje</th>
                    <th class="text-info">Acción</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    frequencyData.forEach(item => {
        const percentage = item.percentage || 0;
        const barColor = percentage < 1 ? 'bg-danger' : percentage < 5 ? 'bg-warning' : 'bg-info';
        
        html += `
            <tr data-value="${item.value}" data-percentage="${percentage}">
                <td><code class="text-white">${item.value}</code></td>
                <td class="text-white">${item.count.toLocaleString()}</td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="progress flex-grow-1" style="height: 25px; min-width: 150px;">
                            <div class="progress-bar ${barColor}" role="progressbar" 
                                 style="width: ${Math.max(percentage, 10)}%">
                                ${percentage.toFixed(2)}%
                            </div>
                        </div>
                        <span class="ms-2 text-white" style="min-width: 60px; text-align: right;">
                            <strong>${percentage.toFixed(2)}%</strong>
                        </span>
                    </div>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" 
                            onclick="removeSpecificValue('${item.value}')"
                            title="Eliminar todas las filas con este valor">
                        <i class="bi bi-x"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    
    if (frequencyData.length > 50) {
        html += `<p class="text-muted text-center">Mostrando los primeros 50 valores de ${frequencyData.length} totales</p>`;
    }
    
    tableDiv.innerHTML = html;
}

// Función para aplicar filtro por porcentaje
async function applyPercentageFilter() {
    const threshold = parseFloat(document.getElementById('percentageThreshold').value);
    
    if (isNaN(threshold) || threshold < 0 || threshold > 100) {
        showNotification('Error', 'Por favor ingresa un porcentaje válido entre 0 y 100', 'error');
        return;
    }
    
    if (!selectedEditorColumn || !columnFrequencyData[selectedEditorColumn]) {
        showNotification('Error', 'Primero selecciona una columna', 'error');
        return;
    }
    
    const valuesToRemove = columnFrequencyData[selectedEditorColumn]
        .filter(item => item.percentage < threshold)
        .map(item => item.value);
    
    if (valuesToRemove.length === 0) {
        showNotification('Info', `No hay valores con menos del ${threshold}% de frecuencia`, 'info');
        return;
    }
    
    const result = await Swal.fire({
        title: '¿Confirmar filtrado?',
        html: `Se eliminarán todas las filas donde "${selectedEditorColumn}" tenga uno de estos ${valuesToRemove.length} valores:<br>
               <small class="text-muted">${valuesToRemove.slice(0, 10).join(', ')}${valuesToRemove.length > 10 ? '...' : ''}</small>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Sí, filtrar',
        cancelButtonText: 'Cancelar',
        background: '#0a0e27',
        color: '#f0f9ff'
    });
    
    if (result.isConfirmed) {
        await filterDatasetByValues(selectedEditorColumn, valuesToRemove);
    }
}

// Función para filtrar el dataset
async function filterDatasetByValues(columnName, valuesToRemove) {
    showLoading('Filtrando dataset...', 'Esto puede tomar un momento');
    
    try {
        const response = await fetch(`/api/datasets/${window.selectedDataset.id}/filter-values/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                column_name: columnName,
                values_to_remove: valuesToRemove
            })
        });
        
        hideLoading();
        
        if (response.ok) {
            const data = await response.json();
            showNotification('¡Éxito!', `Se eliminaron ${data.rows_removed || 0} filas del dataset`, 'success');
            
            // Cerrar el modal y recargar
            editorModal.hide();
            setTimeout(() => window.location.reload(), 1500);
        } else {
            const errorData = await response.json();
            showNotification('Error', errorData.error || 'Error al filtrar el dataset', 'error');
        }
    } catch (error) {
        hideLoading();
        console.error('Error:', error);
        showNotification('Error', 'Error de conexión al filtrar el dataset', 'error');
    }
}

// Funciones auxiliares para el editor
function renameColumnFromEditor() {
    if (selectedEditorColumn) {
        editorModal.hide();
        setTimeout(() => renameColumn(selectedEditorColumn), 300);
    }
}

function deleteColumnFromEditor() {
    if (selectedEditorColumn) {
        editorModal.hide();
        setTimeout(() => deleteColumn(selectedEditorColumn), 300);
    }
}

function removeNullValues() {
    if (!selectedEditorColumn) return;
    
    Swal.fire({
        title: '¿Eliminar valores nulos?',
        text: `Se eliminarán todas las filas donde "${selectedEditorColumn}" tenga valores nulos`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        background: '#0a0e27',
        color: '#f0f9ff'
    }).then(async (result) => {
        if (result.isConfirmed) {
            await removeNullsFromColumn(selectedEditorColumn);
        }
    });
}

async function removeNullsFromColumn(columnName) {
    showLoading('Eliminando valores nulos...', 'Por favor espera');
    
    try {
        const response = await fetch(`/api/datasets/${window.selectedDataset.id}/remove-nulls/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                column_name: columnName
            })
        });
        
        hideLoading();
        
        if (response.ok) {
            const data = await response.json();
            showNotification('¡Éxito!', `Se eliminaron ${data.rows_removed || 0} filas con valores nulos`, 'success');
            
            editorModal.hide();
            setTimeout(() => window.location.reload(), 1500);
        } else {
            const errorData = await response.json();
            showNotification('Error', errorData.error || 'Error al eliminar valores nulos', 'error');
        }
    } catch (error) {
        hideLoading();
        console.error('Error:', error);
        showNotification('Error', 'Error de conexión', 'error');
    }
}

function removeAllNullRows() {
    Swal.fire({
        title: '¿Eliminar filas con cualquier valor nulo?',
        html: `<p>Se eliminarán todas las filas que contengan al menos un valor nulo en cualquier columna.</p>
               <p class="text-warning"><strong>¡Advertencia!</strong> Esta acción puede eliminar muchas filas del dataset.</p>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Sí, eliminar todas',
        cancelButtonText: 'Cancelar',
        background: '#0a0e27',
        color: '#f0f9ff'
    }).then(async (result) => {
        if (result.isConfirmed) {
            await removeAllNullRowsFromDataset();
        }
    });
}

async function removeAllNullRowsFromDataset() {
    showLoading('Eliminando filas con valores nulos...', 'Por favor espera');
    
    try {
        const response = await fetch(`/api/datasets/${window.selectedDataset.id}/remove-all-null-rows/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        
        hideLoading();
        
        if (response.ok) {
            const data = await response.json();
            showNotification('¡Éxito!', `Se eliminaron ${data.rows_removed || 0} filas que contenían valores nulos`, 'success');
            
            editorModal.hide();
            setTimeout(() => window.location.reload(), 1500);
        } else {
            const errorData = await response.json();
            showNotification('Error', errorData.error || 'Error al eliminar filas con valores nulos', 'error');
        }
    } catch (error) {
        hideLoading();
        console.error('Error:', error);
        showNotification('Error', 'Error de conexión', 'error');
    }
}

function fillNullValues() {
    if (!selectedEditorColumn) return;
    
    const stats = window.currentDatasetData.stats[selectedEditorColumn];
    const isNumeric = stats?.is_numeric;
    
    // Primero mostrar el modal para seleccionar el método
    Swal.fire({
        title: 'Rellenar valores nulos',
        html: `
            <div class="text-start">
                <p>¿Cómo deseas rellenar los valores nulos de <strong>"${selectedEditorColumn}"</strong>?</p>
                <label class="form-label">Método de relleno:</label>
                <select class="form-select mb-3" id="fillMethod">
                    ${isNumeric ? `
                        <option value="mean">Media de los valores existentes</option>
                        <option value="median">Mediana de los valores existentes</option>
                        <option value="mode">Moda (valor más frecuente)</option>
                        <option value="zero">Cero (0)</option>
                        <option value="ffill">Valor anterior (forward fill)</option>
                        <option value="bfill">Valor siguiente (backward fill)</option>
                        <option value="interpolate">Interpolación lineal</option>
                    ` : `
                        <option value="mode">Moda (valor más frecuente)</option>
                        <option value="empty">Cadena vacía ("")</option>
                        <option value="unknown">Texto "Unknown"</option>
                        <option value="ffill">Valor anterior (forward fill)</option>
                        <option value="bfill">Valor siguiente (backward fill)</option>
                    `}
                    <option value="custom">Valor personalizado</option>
                </select>
                
                <div class="alert alert-info mt-3" style="font-size: 0.875rem;">
                    <i class="bi bi-info-circle"></i>
                    <strong>Nota:</strong> ${stats.null_count || 0} valores nulos serán reemplazados en esta columna.
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Continuar',
        cancelButtonText: 'Cancelar',
        background: '#0a0e27',
        color: '#f0f9ff',
        customClass: {
            popup: 'swal-dark-theme',
            htmlContainer: 'swal-dark-content'
        },
        preConfirm: () => {
            return document.getElementById('fillMethod').value;
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            const method = result.value;
            
            if (method === 'custom') {
                // Si es personalizado, mostrar un segundo modal para el valor
                const { value: customValue } = await Swal.fire({
                    title: 'Valor personalizado',
                    input: 'text',
                    inputLabel: `Ingresa el valor para reemplazar los nulos en "${selectedEditorColumn}"`,
                    inputPlaceholder: isNumeric ? 'Ej: 0, -1, 999' : 'Ej: N/A, Sin datos, etc.',
                    inputAttributes: {
                        style: 'background-color: #1a1e3a; color: #f0f9ff; border: 1px solid #2d3561;'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Rellenar',
                    cancelButtonText: 'Cancelar',
                    background: '#0a0e27',
                    color: '#f0f9ff',
                    customClass: {
                        popup: 'swal-dark-theme',
                        htmlContainer: 'swal-dark-content',
                        input: 'swal2-input-custom'
                    },
                    inputValidator: (value) => {
                        if (!value) {
                            return 'Por favor ingresa un valor personalizado';
                        }
                    },
                    didOpen: () => {
                        // Asegurar que el input nativo de SweetAlert2 funcione
                        const swalInput = Swal.getInput();
                        if (swalInput) {
                            swalInput.focus();
                        }
                    }
                });
                
                if (customValue) {
                    await fillNullsInColumn(selectedEditorColumn, 'custom', customValue);
                }
            } else {
                // Si no es custom, proceder directamente
                await fillNullsInColumn(selectedEditorColumn, method, null);
            }
        }
    });
}

async function fillNullsInColumn(columnName, method, customValue) {
    showLoading('Rellenando valores nulos...', 'Por favor espera');
    
    try {
        const response = await fetch(`/api/datasets/${window.selectedDataset.id}/fill-nulls/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                column_name: columnName,
                method: method,
                custom_value: customValue
            })
        });
        
        hideLoading();
        
        if (response.ok) {
            const data = await response.json();
            showNotification('¡Éxito!', `Se rellenaron ${data.nulls_filled || 0} valores nulos`, 'success');
            
            editorModal.hide();
            setTimeout(() => window.location.reload(), 1500);
        } else {
            const errorData = await response.json();
            showNotification('Error', errorData.error || 'Error al rellenar valores nulos', 'error');
        }
    } catch (error) {
        hideLoading();
        console.error('Error:', error);
        showNotification('Error', 'Error de conexión', 'error');
    }
}

function removeSpecificValue(value) {
    Swal.fire({
        title: '¿Eliminar filas con este valor?',
        text: `Se eliminarán todas las filas donde "${selectedEditorColumn}" = "${value}"`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        background: '#0a0e27',
        color: '#f0f9ff'
    }).then(async (result) => {
        if (result.isConfirmed) {
            await filterDatasetByValues(selectedEditorColumn, [value]);
        }
    });
}

// Variables globales para búsqueda avanzada
let advancedSearchData = {
    columnName: null,
    searchResults: [],
    searchResultsWithIndex: [],
    patternMode: false,
    selectedPattern: [],
    searchScope: 'first',
    searchLimit: 100
};

// Función para abrir el editor avanzado
function openAdvancedEditor() {
    if (!selectedEditorColumn) {
        showNotification('Error', 'Selecciona una columna primero', 'error');
        return;
    }
    
    // Cerrar el editor principal
    editorModal.hide();
    
    // Resetear el estado del modal avanzado
    advancedSearchData = {
        columnName: selectedEditorColumn,
        searchResults: [],
        searchResultsWithIndex: [],
        indicesToReplace: [],
        patternMode: false,
        selectedPattern: [],
        partialReplaceMode: false,
        partialReplacePattern: [],
        partialReplaceType: 'complete',
        charReplaceMode: false,
        charToFind: '',
        charToReplace: '',
        searchScope: 'first',
        searchLimit: 100,
        applyToAll: false
    };
    
    // Destruir gráficos existentes si existen
    if (window.advSearchResultChart && typeof window.advSearchResultChart.destroy === 'function') {
        window.advSearchResultChart.destroy();
        window.advSearchResultChart = null;
    }
    if (window.advUniqueValuesChart && typeof window.advUniqueValuesChart.destroy === 'function') {
        window.advUniqueValuesChart.destroy();
        window.advUniqueValuesChart = null;
    }
    
    // Resetear campos del formulario
    document.getElementById('advancedColumnName').textContent = selectedEditorColumn;
    document.getElementById('advSearchType').value = 'contains';
    document.getElementById('advSearchValue').value = '';
    document.getElementById('advReplaceValue').value = '';
    document.getElementById('advCaseSensitive').checked = false;
    document.getElementById('advReplacePositions').value = '';
    
    // Ocultar resultados y preview
    document.getElementById('advSearchResults').style.display = 'none';
    document.getElementById('advReplacePreview').style.display = 'none';
    document.getElementById('partialReplaceSelector').style.display = 'none';
    document.getElementById('partialReplaceToggleText').textContent = 'Activar reemplazo parcial';
    document.getElementById('charReplaceSelector').style.display = 'none';
    document.getElementById('charReplaceToggleText').textContent = 'Activar reemplazo de subcadena';
    document.getElementById('charToFind').value = '';
    document.getElementById('charToReplace').value = '';
    document.getElementById('charReplaceExample').style.display = 'none';
    
    // Resetear opciones de alcance de ejecución
    document.getElementById('execScopeSearch').checked = true;
    document.getElementById('executionRangeSelector').style.display = 'none';
    document.getElementById('execRangeStart').value = '1';
    document.getElementById('execRangeEnd').value = '1000';
    
    // Habilitar botón de vista previa (el de ejecutar se habilita después de la vista previa)
    document.getElementById('previewReplaceBtn').disabled = false;
    document.getElementById('executeReplaceBtn').disabled = true;
    
    // Establecer alcance inicial
    setAdvSearchScope('first');
    
    // Abrir el modal avanzado
    const advModal = new bootstrap.Modal(document.getElementById('advancedSearchReplaceModal'));
    advModal.show();
}

// Función para establecer el alcance de búsqueda avanzada
function setAdvSearchScope(scope) {
    advancedSearchData.searchScope = scope;
    
    // Actualizar botones activos
    document.getElementById('advSearchFirstBtn').classList.toggle('btn-primary', scope === 'first');
    document.getElementById('advSearchFirstBtn').classList.toggle('btn-outline-secondary', scope !== 'first');
    
    document.getElementById('advSearchRangeBtn').classList.toggle('btn-primary', scope === 'range');
    document.getElementById('advSearchRangeBtn').classList.toggle('btn-outline-secondary', scope !== 'range');
    
    document.getElementById('advSearchAllBtn').classList.toggle('btn-primary', scope === 'all');
    document.getElementById('advSearchAllBtn').classList.toggle('btn-outline-secondary', scope !== 'all');
    
    // Mostrar/ocultar selector de rango
    document.getElementById('advRangeSelector').style.display = scope === 'range' ? 'block' : 'none';
}

// Función para mostrar modal de límite avanzado
function showAdvLimitModal() {
    const limitModal = new bootstrap.Modal(document.getElementById('searchLimitModal'));
    // Marcar que estamos en el modo avanzado
    window.advancedLimitMode = true;
    limitModal.show();
}

// Función para aplicar límite personalizado
function applyCustomLimit() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('searchLimitModal'));
    
    if (document.getElementById('configFirst').checked) {
        const limit = parseInt(document.getElementById('customSearchLimit').value) || 100;
        
        if (window.advancedLimitMode) {
            advancedSearchData.searchLimit = limit;
            advancedSearchData.searchScope = 'first';
            document.getElementById('advLimitValue').textContent = limit;
            setAdvSearchScope('first');
        } else {
            searchLimit = limit;
            searchScope = 'first';
            document.getElementById('limitValue').textContent = limit;
            setSearchScope('first');
        }
    } else if (document.getElementById('configRange').checked) {
        const start = parseInt(document.getElementById('customRangeStart').value) || 1;
        const end = parseInt(document.getElementById('customRangeEnd').value) || 100;
        
        if (window.advancedLimitMode) {
            document.getElementById('advRangeStart').value = start;
            document.getElementById('advRangeEnd').value = end;
            setAdvSearchScope('range');
        } else {
            document.getElementById('rangeStart').value = start;
            document.getElementById('rangeEnd').value = end;
            setSearchScope('range');
        }
    }
    
    window.advancedLimitMode = false;
    modal.hide();
}

// Función para actualizar el modal de configuración
function updateConfigModal() {
    const firstSelected = document.getElementById('configFirst').checked;
    document.getElementById('configFirstOptions').style.display = firstSelected ? 'block' : 'none';
    document.getElementById('configRangeOptions').style.display = firstSelected ? 'none' : 'block';
}

// Actualizar interfaz de búsqueda avanzada según el tipo
function updateAdvancedSearchInterface() {
    const searchType = document.getElementById('advSearchType').value;
    const hint = document.getElementById('advSearchHint');
    
    switch(searchType) {
        case 'contains':
            hint.textContent = 'Buscar valores que contengan este texto';
            break;
        case 'startsWith':
            hint.textContent = 'Buscar valores que empiecen con este texto';
            break;
        case 'endsWith':
            hint.textContent = 'Buscar valores que terminen con este texto';
            break;
        case 'equals':
            hint.textContent = 'Buscar valores exactamente iguales';
            break;
        case 'regex':
            hint.textContent = 'Usar expresión regular (ej: ^[A-Z]\\d+$)';
            break;
    }
}

// Función para activar/desactivar el modo patrón avanzado
function toggleAdvPatternMode() {
    advancedSearchData.patternMode = !advancedSearchData.patternMode;
    
    const toggleText = document.getElementById('advPatternToggleText');
    const patternRow = document.getElementById('advPatternSelectorRow');
    
    if (advancedSearchData.patternMode) {
        toggleText.textContent = 'Desactivar patrón personalizado';
        patternRow.style.display = 'block';
        updateAdvPatternExample();
    } else {
        toggleText.textContent = 'Activar patrón personalizado';
        patternRow.style.display = 'none';
        advancedSearchData.selectedPattern = [];
    }
}

// Actualizar ejemplo de patrón avanzado
function updateAdvPatternExample() {
    const exampleIndex = parseInt(document.getElementById('advPatternExampleIndex').value) - 1;
    
    if (advancedSearchData.searchResults && advancedSearchData.searchResults.length > 0) {
        const example = advancedSearchData.searchResults[Math.min(exampleIndex, advancedSearchData.searchResults.length - 1)];
        displayAdvPatternCharacters(String(example));
    }
}

// Mostrar caracteres para seleccionar patrón avanzado
function displayAdvPatternCharacters(value) {
    const container = document.getElementById('advPatternCharacters');
    container.innerHTML = '';
    
    const chars = value.split('');
    chars.forEach((char, index) => {
        const span = document.createElement('span');
        span.textContent = char;
        span.className = 'pattern-char';
        span.style.cursor = 'pointer';
        span.style.padding = '2px 4px';
        span.style.margin = '0 1px';
        span.style.borderRadius = '3px';
        span.style.transition = 'all 0.2s';
        
        if (advancedSearchData.selectedPattern.includes(index)) {
            span.style.backgroundColor = '#00d4ff';
            span.style.color = '#000';
        } else {
            span.style.backgroundColor = 'transparent';
            span.style.color = '#fff';
        }
        
        span.onclick = () => {
            const idx = advancedSearchData.selectedPattern.indexOf(index);
            if (idx > -1) {
                advancedSearchData.selectedPattern.splice(idx, 1);
            } else {
                advancedSearchData.selectedPattern.push(index);
            }
            displayAdvPatternCharacters(value);
        };
        
        container.appendChild(span);
    });
}

// Función para búsqueda avanzada
async function performAdvancedSearch() {
    const searchType = document.getElementById('advSearchType').value;
    const searchValue = document.getElementById('advSearchValue').value;
    
    if (!searchValue && searchType !== 'equals') {
        showNotification('Error', 'Ingresa un valor a buscar', 'error');
        return;
    }
    
    showLoading('Buscando...', 'Analizando columna');
    
    try {
        // Primero obtener todos los datos de la columna
        const response = await fetch(`/api/datasets/${window.selectedDataset.id}/column-data/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                column_name: advancedSearchData.columnName
            })
        });
        
        const data = await response.json();
        const columnData = data.values || [];
        
        // Aplicar búsqueda según el alcance
        let searchData = columnData;
        if (advancedSearchData.searchScope === 'first') {
            searchData = columnData.slice(0, advancedSearchData.searchLimit);
        } else if (advancedSearchData.searchScope === 'range') {
            const start = parseInt(document.getElementById('advRangeStart').value) - 1;
            const end = parseInt(document.getElementById('advRangeEnd').value);
            searchData = columnData.slice(start, end);
        }
        
        // Aplicar filtro según tipo
        const matchedIndices = [];
        searchData.forEach((value, index) => {
            const strValue = String(value || '');
            const strSearch = String(searchValue);
            const caseSensitive = document.getElementById('advCaseSensitive').checked;
            
            let matches = false;
            const compareValue = caseSensitive ? strValue : strValue.toLowerCase();
            const compareSearch = caseSensitive ? strSearch : strSearch.toLowerCase();
            
            switch(searchType) {
                case 'contains':
                    matches = compareValue.includes(compareSearch);
                    break;
                case 'startsWith':
                    matches = compareValue.startsWith(compareSearch);
                    break;
                case 'endsWith':
                    matches = compareValue.endsWith(compareSearch);
                    break;
                case 'equals':
                    matches = compareValue === compareSearch;
                    break;
                case 'regex':
                    try {
                        const regex = new RegExp(searchValue, caseSensitive ? 'g' : 'gi');
                        matches = regex.test(strValue);
                    } catch(e) {
                        showNotification('Error', 'Expresión regular inválida', 'error');
                        hideLoading();
                        return;
                    }
                    break;
            }
            
            if (matches) {
                matchedIndices.push({
                    index: index + (advancedSearchData.searchScope === 'range' ? parseInt(document.getElementById('advRangeStart').value) - 1 : 0),
                    value: value
                });
            }
        });
        
        advancedSearchData.searchResults = matchedIndices.map(item => item.value);
        advancedSearchData.searchResultsWithIndex = matchedIndices;
        
        // Mostrar resultados
        displayAdvancedSearchResults(matchedIndices, searchData.length);
        
        // El botón de preview siempre está habilitado
        const previewBtn = document.getElementById('previewReplaceBtn');
        if (previewBtn) {
            previewBtn.disabled = false;
            console.log('Coincidencias encontradas:', matchedIndices.length);
        }
        
        // Actualizar texto de alcance de búsqueda
        const scopeHint = document.getElementById('execScopeSearchHint');
        if (scopeHint) {
            let scopeText = 'Se aplicará ';
            if (advancedSearchData.searchScope === 'first') {
                scopeText += `en los primeros ${advancedSearchData.searchLimit} valores`;
            } else if (advancedSearchData.searchScope === 'range') {
                const start = parseInt(document.getElementById('advRangeStart').value);
                const end = parseInt(document.getElementById('advRangeEnd').value);
                scopeText += `en el rango de filas ${start} a ${end}`;
            } else {
                scopeText += 'en todo el dataset';
            }
            scopeHint.textContent = scopeText;
        }
        
        hideLoading();
        
    } catch (error) {
        hideLoading();
        console.error('Error:', error);
        showNotification('Error', 'Error al realizar la búsqueda', 'error');
    }
}

// Mostrar resultados de búsqueda avanzada
function displayAdvancedSearchResults(matches, totalSearched) {
    document.getElementById('advSearchResults').style.display = 'block';
    document.getElementById('advMatchCount').textContent = matches.length;
    document.getElementById('advTotalCount').textContent = totalSearched;
    document.getElementById('advMatchPercentage').textContent = ((matches.length / totalSearched) * 100).toFixed(2);
    
    // Mostrar lista de coincidencias
    const listDiv = document.getElementById('advMatchedValuesList');
    const uniqueValues = {};
    
    matches.forEach(item => {
        const key = String(item.value);
        if (!uniqueValues[key]) {
            uniqueValues[key] = { value: item.value, count: 0, indices: [] };
        }
        uniqueValues[key].count++;
        uniqueValues[key].indices.push(item.index);
    });
    
    let html = '<div class="text-info mb-2">Valores únicos encontrados: ' + Object.keys(uniqueValues).length + '</div>';
    Object.values(uniqueValues).forEach(item => {
        const indices = item.indices.slice(0, 5).join(', ') + (item.indices.length > 5 ? '...' : '');
        html += `
            <div class="border-bottom py-1">
                <div class="d-flex justify-content-between">
                    <code class="text-white">${item.value}</code>
                    <span class="text-muted">(${item.count})</span>
                </div>
                <small class="text-muted">Índices: ${indices}</small>
            </div>
        `;
    });
    
    listDiv.innerHTML = html;
    
    // Crear gráfico de pastel para coincidencias
    const canvas = document.getElementById('advSearchResultChart');
    if (!canvas) {
        console.error('Canvas advSearchResultChart no encontrado');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    if (window.advSearchResultChart && typeof window.advSearchResultChart.destroy === 'function') {
        window.advSearchResultChart.destroy();
        window.advSearchResultChart = null;
    }
    
    window.advSearchResultChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Coincidencias', 'No coincidencias'],
            datasets: [{
                data: [matches.length, totalSearched - matches.length],
                backgroundColor: ['rgba(0, 212, 255, 0.8)', 'rgba(128, 128, 128, 0.3)'],
                borderColor: ['rgba(0, 212, 255, 1)', 'rgba(128, 128, 128, 0.5)'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#f0f9ff' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const percentage = ((context.parsed / totalSearched) * 100).toFixed(1);
                            return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
    
    // Crear gráfico de barras para valores únicos
    const uniqueCanvas = document.getElementById('advUniqueValuesChart');
    if (!uniqueCanvas) {
        console.error('Canvas advUniqueValuesChart no encontrado');
        return;
    }
    
    const uniqueCtx = uniqueCanvas.getContext('2d');
    if (window.advUniqueValuesChart && typeof window.advUniqueValuesChart.destroy === 'function') {
        window.advUniqueValuesChart.destroy();
        window.advUniqueValuesChart = null;
    }
    
    // Ordenar valores únicos por frecuencia
    const sortedUnique = Object.values(uniqueValues).sort((a, b) => b.count - a.count);
    const topValues = sortedUnique.slice(0, 10);
    
    window.advUniqueValuesChart = new Chart(uniqueCtx, {
        type: 'bar',
        data: {
            labels: topValues.map(v => String(v.value).substring(0, 20) + (String(v.value).length > 20 ? '...' : '')),
            datasets: [{
                label: 'Frecuencia',
                data: topValues.map(v => v.count),
                backgroundColor: 'rgba(0, 212, 255, 0.6)',
                borderColor: 'rgba(0, 212, 255, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: 'Top 10 Valores Más Frecuentes',
                    color: '#00d4ff'
                }
            },
            scales: {
                x: {
                    ticks: { 
                        color: '#f0f9ff',
                        maxRotation: 45,
                        minRotation: 45
                    },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    beginAtZero: true,
                    ticks: { color: '#f0f9ff' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            }
        }
    });
}

// Mostrar ayuda de índices
function showPositionHelp() {
    Swal.fire({
        title: 'Ayuda: Índices de Reemplazo',
        html: `
            <div class="text-start">
                <p>Puedes especificar qué coincidencias reemplazar usando los siguientes formatos:</p>
                <ul>
                    <li><code>1</code> - Reemplaza solo la primera coincidencia</li>
                    <li><code>1,3,5</code> - Reemplaza las coincidencias 1, 3 y 5</li>
                    <li><code>1-10</code> - Reemplaza de la coincidencia 1 a la 10</li>
                    <li><code>1,3,5-10,15</code> - Combinación de índices individuales y rangos</li>
                </ul>
                <p class="text-warning mt-3">
                    <i class="bi bi-exclamation-triangle"></i> Nota: Los índices empiezan en 1
                </p>
            </div>
        `,
        icon: 'info',
        confirmButtonText: 'Entendido',
        confirmButtonColor: '#10b981',
        background: '#0a0e27',
        color: '#f0f9ff',
        customClass: {
            popup: 'swal-custom-popup',
            title: 'swal-custom-title',
            htmlContainer: 'swal-custom-text',
            confirmButton: 'btn btn-success'
        }
    });
}

// Vista previa de reemplazo
async function previewReplacement() {
    console.log('Ejecutando previewReplacement');
    
    const replaceValue = document.getElementById('advReplaceValue').value;
    const positions = document.getElementById('advReplacePositions').value;
    
    // Si no hay búsqueda previa, hacer una búsqueda implícita
    if (!advancedSearchData.searchResultsWithIndex || advancedSearchData.searchResultsWithIndex.length === 0) {
        // Si hay un valor de búsqueda, realizar la búsqueda
        const searchValue = document.getElementById('advSearchValue').value;
        if (searchValue) {
            await performAdvancedSearch();
            // Si después de la búsqueda no hay resultados, salir
            if (!advancedSearchData.searchResultsWithIndex || advancedSearchData.searchResultsWithIndex.length === 0) {
                showNotification('Info', 'No se encontraron coincidencias para reemplazar', 'info');
                return;
            }
        } else {
            // Si no hay valor de búsqueda, preguntar si quiere reemplazar en todo
            const result = await Swal.fire({
                title: 'Sin búsqueda previa',
                text: '¿Deseas aplicar el reemplazo a todos los valores de la columna?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, aplicar a todos',
                cancelButtonText: 'Cancelar',
                background: '#0a0e27',
                color: '#f0f9ff',
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280',
                customClass: {
                    popup: 'swal-custom-popup',
                    title: 'swal-custom-title',
                    htmlContainer: 'swal-custom-text'
                }
            });
            
            if (!result.isConfirmed) {
                return;
            }
            
            // Marcar que se aplicará a todos
            advancedSearchData.applyToAll = true;
        }
    }
    
    // Validar reemplazo parcial si está activo
    if (advancedSearchData.partialReplaceMode && !validatePartialReplacement()) {
        return;
    }
    
    console.log('Datos de reemplazo:', { replaceValue, positions });
    
    let indicesToReplace = [];
    
    // Si se marcó aplicar a todos (sin búsqueda previa)
    if (advancedSearchData.applyToAll) {
        // Obtener una muestra para la vista previa
        try {
            const response = await fetch(`/api/datasets/${window.selectedDataset.id}/column-sample/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    column_name: advancedSearchData.columnName,
                    count: 20  // Obtener 20 ejemplos para la vista previa
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                indicesToReplace = data.samples.map((value, index) => ({
                    index: index,
                    value: value
                }));
            }
        } catch (error) {
            console.error('Error al obtener muestra:', error);
        }
    } else if (positions && positions.trim()) {
        // Parsear posiciones específicas
        const parts = positions.split(',');
        const validIndices = new Set();
        
        parts.forEach(part => {
            if (part.includes('-')) {
                const [start, end] = part.split('-').map(n => parseInt(n.trim()) - 1);
                for (let i = start; i <= end && i < advancedSearchData.searchResultsWithIndex.length; i++) {
                    validIndices.add(i);
                }
            } else {
                const idx = parseInt(part.trim()) - 1;
                if (idx >= 0 && idx < advancedSearchData.searchResultsWithIndex.length) {
                    validIndices.add(idx);
                }
            }
        });
        
        indicesToReplace = Array.from(validIndices).map(i => advancedSearchData.searchResultsWithIndex[i]);
    } else {
        // Si no hay posiciones específicas, reemplazar todas las coincidencias
        indicesToReplace = advancedSearchData.searchResultsWithIndex || [];
    }
    
    // Mostrar preview
    document.getElementById('advReplacePreview').style.display = 'block';
    document.getElementById('advReplaceCount').textContent = indicesToReplace.length;
    
    const tbody = document.getElementById('advReplacePreviewTable');
    tbody.innerHTML = '';
    
    indicesToReplace.slice(0, 20).forEach(item => {
        let newValue = replaceValue || '(vacío)';
        
        // Si está activo el reemplazo de subcadena
        if (advancedSearchData.charReplaceMode && advancedSearchData.charToFind) {
            const originalValue = String(item.value);
            // Si charToReplace está vacío, se eliminará la subcadena
            const replacement = advancedSearchData.charToReplace || '';
            newValue = originalValue.split(advancedSearchData.charToFind).join(replacement);
        }
        // Si está activo el reemplazo parcial, mostrar el resultado
        else if (advancedSearchData.partialReplaceMode && advancedSearchData.partialReplacePattern.length > 0) {
            const originalValue = String(item.value);
            const pattern = advancedSearchData.partialReplacePattern;
            
            if (advancedSearchData.partialReplaceType === 'complete') {
                // Modo completo: reemplazar toda la selección por el valor completo
                let partialValue = '';
                let isInSelection = false;
                let selectionReplaced = false;
                
                for (let i = 0; i < originalValue.length; i++) {
                    if (pattern.includes(i)) {
                        if (!isInSelection) {
                            partialValue += replaceValue;
                            isInSelection = true;
                            selectionReplaced = true;
                        }
                    } else {
                        partialValue += originalValue[i];
                        isInSelection = false;
                    }
                }
                newValue = partialValue;
            } else {
                // Modo carácter por carácter
                if (replaceValue.length === pattern.length) {
                    let partialValue = '';
                    let replaceIndex = 0;
                    for (let i = 0; i < originalValue.length; i++) {
                        if (pattern.includes(i)) {
                            partialValue += replaceValue[replaceIndex++];
                        } else {
                            partialValue += originalValue[i];
                        }
                    }
                    newValue = partialValue;
                } else {
                    newValue = `<span class="text-danger">Error: longitud no coincide</span>`;
                }
            }
        }
        
        tbody.innerHTML += `
            <tr>
                <td>${item.index + 1}</td>
                <td><code>${item.value}</code></td>
                <td><code class="text-warning">${newValue}</code></td>
            </tr>
        `;
    });
    
    if (indicesToReplace.length > 20) {
        tbody.innerHTML += `
            <tr>
                <td colspan="3" class="text-center text-muted">... y ${indicesToReplace.length - 20} más</td>
            </tr>
        `;
    }
    
    // Habilitar botón de ejecución
    const executeBtn = document.getElementById('executeReplaceBtn');
    if (executeBtn) {
        executeBtn.disabled = indicesToReplace.length === 0;
        console.log('Índices a reemplazar:', indicesToReplace.length, 'Botón ejecutar habilitado:', !executeBtn.disabled);
    }
    
    // Guardar los índices para la ejecución
    advancedSearchData.indicesToReplace = indicesToReplace;
}

// Ejecutar reemplazo
async function executeReplacement() {
    const replaceValue = document.getElementById('advReplaceValue').value;
    
    // Obtener alcance de ejecución
    const executionScope = document.querySelector('input[name="executionScope"]:checked').value;
    let scopeText = '';
    let scopeDetails = '';
    
    if (executionScope === 'search') {
        scopeText = 'Solo en el alcance de búsqueda';
        if (advancedSearchData.searchScope === 'first') {
            scopeDetails = `Se buscarán coincidencias en los primeros ${advancedSearchData.searchLimit} valores`;
        } else if (advancedSearchData.searchScope === 'range') {
            const start = parseInt(document.getElementById('advRangeStart').value);
            const end = parseInt(document.getElementById('advRangeEnd').value);
            scopeDetails = `Se buscarán coincidencias en las filas ${start} a ${end}`;
        } else {
            scopeDetails = 'Se buscarán coincidencias en todo el dataset';
        }
    } else if (executionScope === 'all') {
        scopeText = 'En todo el dataset';
        scopeDetails = 'Se aplicará el reemplazo buscando en todas las filas';
    } else if (executionScope === 'custom') {
        const start = parseInt(document.getElementById('execRangeStart').value);
        const end = parseInt(document.getElementById('execRangeEnd').value);
        const total = end - start + 1;
        scopeText = `En rango personalizado`;
        scopeDetails = `Se aplicará en las filas ${start} a ${end} (${total} filas)`;
    }
    
    const matchCount = document.getElementById('advReplaceCount').textContent;
    
    const result = await Swal.fire({
        title: '¿Confirmar reemplazo?',
        html: `
            <div class="text-start">
                <p><strong>Coincidencias encontradas:</strong> ${matchCount}</p>
                <p><strong>Alcance de ejecución:</strong> ${scopeText}</p>
                <p class="text-muted small">${scopeDetails}</p>
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Sí, reemplazar',
        cancelButtonText: 'Cancelar',
        background: '#0a0e27',
        color: '#f0f9ff',
        customClass: {
            popup: 'swal-custom-popup',
            title: 'swal-custom-title',
            htmlContainer: 'swal-custom-text',
            confirmButton: 'btn btn-danger',
            cancelButton: 'btn btn-secondary'
        }
    });
    
    if (result.isConfirmed) {
        showLoading('Aplicando cambios...', 'Esto puede tomar un momento');
        
        try {
            const positions = document.getElementById('advReplacePositions').value;
            let indices = [];
            
            if (positions && positions.trim()) {
                // Usar posiciones específicas
                const parts = positions.split(',');
                parts.forEach(part => {
                    if (part.includes('-')) {
                        const [start, end] = part.split('-').map(n => parseInt(n.trim()) - 1);
                        for (let i = start; i <= end && i < advancedSearchData.searchResultsWithIndex.length; i++) {
                            indices.push(advancedSearchData.searchResultsWithIndex[i].index);
                        }
                    } else {
                        const idx = parseInt(part.trim()) - 1;
                        if (idx >= 0 && idx < advancedSearchData.searchResultsWithIndex.length) {
                            indices.push(advancedSearchData.searchResultsWithIndex[idx].index);
                        }
                    }
                });
            } else {
                indices = advancedSearchData.searchResultsWithIndex.map(item => item.index);
            }
            
            // Preparar parámetros según el alcance
            let executionParams = {
                column_name: advancedSearchData.columnName,
                indices: indices,
                new_value: replaceValue,
                partial_replace: advancedSearchData.partialReplaceMode,
                partial_pattern: advancedSearchData.partialReplacePattern,
                partial_type: advancedSearchData.partialReplaceType,
                char_replace: advancedSearchData.charReplaceMode,
                char_to_find: advancedSearchData.charToFind,
                char_to_replace: advancedSearchData.charToReplace,
                execution_scope: executionScope,
                apply_to_all: advancedSearchData.applyToAll || false
            };
            
            // Añadir parámetros específicos según el alcance
            if (executionScope === 'search') {
                executionParams.search_scope = advancedSearchData.searchScope;
                if (advancedSearchData.searchScope === 'first') {
                    executionParams.search_limit = advancedSearchData.searchLimit;
                } else if (advancedSearchData.searchScope === 'range') {
                    executionParams.search_range_start = parseInt(document.getElementById('advRangeStart').value) - 1;
                    executionParams.search_range_end = parseInt(document.getElementById('advRangeEnd').value);
                }
            } else if (executionScope === 'custom') {
                executionParams.custom_range_start = parseInt(document.getElementById('execRangeStart').value) - 1;
                executionParams.custom_range_end = parseInt(document.getElementById('execRangeEnd').value);
            }
            
            const response = await fetch(`/api/datasets/${window.selectedDataset.id}/replace-values/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(executionParams)
            });
            
            hideLoading();
            
            if (response.ok) {
                showNotification('¡Éxito!', 'Valores reemplazados correctamente', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showNotification('Error', 'Error al reemplazar valores', 'error');
            }
        } catch (error) {
            hideLoading();
            console.error('Error:', error);
            showNotification('Error', 'Error de conexión', 'error');
        }
    }
}

// Función para actualizar el estado de los botones de reemplazo
function updateReplaceButtons() {
    const previewBtn = document.getElementById('previewReplaceBtn');
    
    // El botón de vista previa siempre está habilitado
    if (previewBtn) {
        previewBtn.disabled = false;
    }
}

// Función para alternar el modo de reemplazo parcial
function togglePartialReplace() {
    advancedSearchData.partialReplaceMode = !advancedSearchData.partialReplaceMode;
    const selector = document.getElementById('partialReplaceSelector');
    const toggleBtn = document.getElementById('partialReplaceToggleText');
    
    if (advancedSearchData.partialReplaceMode) {
        selector.style.display = 'block';
        toggleBtn.textContent = 'Desactivar reemplazo parcial';
        updatePartialExample();
        updatePartialMode();
        
        // Si está activo el reemplazo de carácter, desactivarlo
        if (advancedSearchData.charReplaceMode) {
            toggleCharReplace();
        }
    } else {
        selector.style.display = 'none';
        toggleBtn.textContent = 'Activar reemplazo parcial';
        advancedSearchData.partialReplacePattern = [];
        document.getElementById('partialWarning').style.display = 'none';
    }
}

// Función para actualizar el modo de reemplazo parcial
function updatePartialMode() {
    const mode = document.querySelector('input[name="partialMode"]:checked').value;
    advancedSearchData.partialReplaceType = mode;
    updatePartialExample();
    validatePartialReplacement();
}

// Función para actualizar el ejemplo de reemplazo parcial
async function updatePartialExample() {
    const exampleIndex = parseInt(document.getElementById('partialExampleIndex').value) || 1;
    const charsDiv = document.getElementById('partialCharacters');
    
    let exampleValue = '';
    
    // Si hay resultados de búsqueda, usar esos
    if (advancedSearchData.searchResultsWithIndex && advancedSearchData.searchResultsWithIndex.length > 0) {
        const maxIndex = advancedSearchData.searchResultsWithIndex.length;
        if (exampleIndex > maxIndex) {
            document.getElementById('partialExampleIndex').value = maxIndex;
            updatePartialExample();
            return;
        }
        exampleValue = String(advancedSearchData.searchResultsWithIndex[exampleIndex - 1].value);
    } else {
        // Si no hay búsqueda, obtener un ejemplo del dataset
        try {
            const response = await fetch(`/api/datasets/${window.selectedDataset.id}/column-sample/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    column_name: advancedSearchData.columnName,
                    index: exampleIndex - 1
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                exampleValue = String(data.value || '');
            } else {
                charsDiv.innerHTML = '<span class="text-muted">No se pudo obtener el ejemplo</span>';
                return;
            }
        } catch (error) {
            charsDiv.innerHTML = '<span class="text-muted">Error al obtener el ejemplo</span>';
            return;
        }
    }
    
    // Crear caracteres clickeables
    let html = '';
    for (let i = 0; i < exampleValue.length; i++) {
        const isSelected = advancedSearchData.partialReplacePattern.includes(i);
        html += `<span 
            class="character-selector ${isSelected ? 'selected' : ''}"
            onclick="togglePartialCharacter(${i})"
            style="cursor: pointer; padding: 2px 4px; margin: 1px; 
                   background-color: ${isSelected ? 'rgba(255, 193, 7, 0.3)' : 'transparent'};
                   border: 1px solid ${isSelected ? '#ffc107' : 'rgba(255, 255, 255, 0.2)'};
                   border-radius: 3px;">
            ${exampleValue[i] === ' ' ? '␣' : exampleValue[i]}
        </span>`;
    }
    
    charsDiv.innerHTML = html;
}

// Función para alternar la selección de un carácter
function togglePartialCharacter(index) {
    const pattern = advancedSearchData.partialReplacePattern;
    const pos = pattern.indexOf(index);
    
    if (pos === -1) {
        pattern.push(index);
    } else {
        pattern.splice(pos, 1);
    }
    
    // Ordenar el patrón
    pattern.sort((a, b) => a - b);
    
    updatePartialExample();
    validatePartialReplacement();
}

// Función para validar el reemplazo parcial
function validatePartialReplacement() {
    const warning = document.getElementById('partialWarning');
    const warningText = document.getElementById('partialWarningText');
    const replaceValue = document.getElementById('advReplaceValue').value;
    const pattern = advancedSearchData.partialReplacePattern;
    
    if (advancedSearchData.partialReplaceType === 'charByChar' && pattern.length > 0) {
        if (replaceValue.length !== pattern.length) {
            warning.style.display = 'block';
            warningText.textContent = `Debes seleccionar ${replaceValue.length} caracteres para el modo carácter por carácter. Actualmente: ${pattern.length} seleccionados.`;
            return false;
        }
    }
    
    warning.style.display = 'none';
    return true;
}

// Función para alternar el modo de reemplazo de subcadena
function toggleCharReplace() {
    advancedSearchData.charReplaceMode = !advancedSearchData.charReplaceMode;
    const selector = document.getElementById('charReplaceSelector');
    const toggleBtn = document.getElementById('charReplaceToggleText');
    
    if (advancedSearchData.charReplaceMode) {
        selector.style.display = 'block';
        toggleBtn.textContent = 'Desactivar reemplazo de subcadena';
        
        // Si está activo el reemplazo parcial, desactivarlo
        if (advancedSearchData.partialReplaceMode) {
            togglePartialReplace();
        }
        
        validateCharReplace();
    } else {
        selector.style.display = 'none';
        toggleBtn.textContent = 'Activar reemplazo de subcadena';
        advancedSearchData.charToFind = '';
        advancedSearchData.charToReplace = '';
        document.getElementById('charToFind').value = '';
        document.getElementById('charToReplace').value = '';
        document.getElementById('charReplaceExample').style.display = 'none';
    }
}

// Función para validar el reemplazo de subcadena
function validateCharReplace() {
    const charToFind = document.getElementById('charToFind').value;
    const charToReplace = document.getElementById('charToReplace').value;
    
    advancedSearchData.charToFind = charToFind;
    advancedSearchData.charToReplace = charToReplace;
    
    // Mostrar ejemplo si hay resultados de búsqueda y valores ingresados
    const exampleDiv = document.getElementById('charReplaceExample');
    const exampleText = document.getElementById('charReplaceExampleText');
    
    if (charToFind && advancedSearchData.searchResultsWithIndex && advancedSearchData.searchResultsWithIndex.length > 0) {
        const firstValue = String(advancedSearchData.searchResultsWithIndex[0].value);
        if (firstValue.includes(charToFind)) {
            const newValue = firstValue.split(charToFind).join(charToReplace || '(vacío)');
            exampleDiv.style.display = 'block';
            exampleText.innerHTML = `"${firstValue}" → "${newValue}"`;
        } else {
            exampleDiv.style.display = 'block';
            exampleText.innerHTML = `La subcadena "${charToFind}" no se encuentra en el primer valor`;
        }
    } else {
        exampleDiv.style.display = 'none';
    }
    
    return charToFind.length > 0;
}

// Función para alternar el selector de rango de ejecución
function toggleExecutionRange() {
    const customRadio = document.getElementById('execScopeCustom');
    const rangeSelector = document.getElementById('executionRangeSelector');
    
    if (customRadio.checked) {
        rangeSelector.style.display = 'block';
        updateExecutionRangeInfo();
    } else {
        rangeSelector.style.display = 'none';
    }
}

// Función para actualizar la información del rango de ejecución
function updateExecutionRangeInfo() {
    const start = parseInt(document.getElementById('execRangeStart').value) || 1;
    const end = parseInt(document.getElementById('execRangeEnd').value) || 1000;
    const info = document.getElementById('execRangeInfo');
    
    if (start > end) {
        info.textContent = '(Rango inválido)';
        info.className = 'text-danger ms-2';
    } else {
        const total = end - start + 1;
        info.textContent = `(${total} filas)`;
        info.className = 'text-muted ms-2';
    }
}

// Función para alternar el selector de rango de manipulación de texto
function toggleTextManipRange() {
    const rangeRadio = document.getElementById('textManipScopeRange');
    const rangeSelector = document.getElementById('textManipRangeSelector');
    
    if (rangeRadio.checked) {
        rangeSelector.style.display = 'block';
        updateTextManipRangeInfo();
    } else {
        rangeSelector.style.display = 'none';
    }
}

// Función para actualizar la información del rango de manipulación de texto
function updateTextManipRangeInfo() {
    const start = parseInt(document.getElementById('textManipRangeStart').value) || 1;
    const end = parseInt(document.getElementById('textManipRangeEnd').value) || 100;
    const info = document.getElementById('textManipRangeInfo');
    
    if (start > end) {
        info.textContent = '(Rango inválido)';
        info.className = 'text-danger ms-2';
    } else {
        const total = end - start + 1;
        info.textContent = `(${total} filas)`;
        info.className = 'text-muted ms-2';
    }
}

// Función para manipulación de texto
function openTextManipulation() {
    if (!selectedEditorColumn) {
        showNotification('Error', 'Selecciona una columna primero', 'error');
        return;
    }
    
    editorModal.hide();
    document.getElementById('textManipColumnName').textContent = selectedEditorColumn;
    
    // Resetear opciones de alcance
    document.getElementById('textManipScopeAll').checked = true;
    document.getElementById('textManipRangeSelector').style.display = 'none';
    document.getElementById('textManipRangeStart').value = '1';
    document.getElementById('textManipRangeEnd').value = '100';
    
    const textModal = new bootstrap.Modal(document.getElementById('textManipulationModal'));
    textModal.show();
    
    updateTextOperationOptions();
}

// Actualizar opciones según operación de texto
function updateTextOperationOptions() {
    const operation = document.getElementById('textOperation').value;
    const optionsDiv = document.getElementById('textOperationOptions');
    
    let html = '';
    
    switch(operation) {
        case 'truncate':
            html = `
                <div class="mb-3">
                    <label class="form-label">Longitud máxima</label>
                    <input type="number" class="form-control bg-dark text-light border-secondary" id="truncateLength" value="50" min="1">
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="truncateEllipsis" checked>
                    <label class="form-check-label" for="truncateEllipsis">
                        Agregar "..." al final
                    </label>
                </div>
            `;
            break;
            
        case 'extract':
            html = `
                <div class="mb-3">
                    <label class="form-label">Posición inicial</label>
                    <input type="number" class="form-control bg-dark text-light border-secondary" id="extractStart" value="1" min="1">
                </div>
                <div class="mb-3">
                    <label class="form-label">Longitud</label>
                    <input type="number" class="form-control bg-dark text-light border-secondary" id="extractLength" value="10" min="1">
                </div>
            `;
            break;
            
        case 'remove_chars':
            html = `
                <div class="mb-3">
                    <label class="form-label">Caracteres a eliminar</label>
                    <input type="text" class="form-control bg-dark text-light border-secondary" id="removeChars" placeholder="Ej: .,;:">
                </div>
            `;
            break;
            
        case 'case':
            html = `
                <div class="mb-3">
                    <label class="form-label">Tipo de conversión</label>
                    <select class="form-select bg-dark text-light border-secondary" id="caseType">
                        <option value="upper">MAYÚSCULAS</option>
                        <option value="lower">minúsculas</option>
                        <option value="title">Tipo Título</option>
                        <option value="capitalize">Primera letra mayúscula</option>
                    </select>
                </div>
            `;
            break;
            
        case 'trim':
            html = `
                <div class="mb-3">
                    <label class="form-label">Tipo de eliminación</label>
                    <select class="form-select bg-dark text-light border-secondary" id="trimType">
                        <option value="both">Ambos lados</option>
                        <option value="left">Solo izquierda</option>
                        <option value="right">Solo derecha</option>
                    </select>
                </div>
            `;
            break;
            
        case 'split':
            html = `
                <div class="mb-3">
                    <label class="form-label">Separador</label>
                    <input type="text" class="form-control bg-dark text-light border-secondary" id="splitSeparator" value=",">
                </div>
                <div class="mb-3">
                    <label class="form-label">Mantener parte</label>
                    <select class="form-select bg-dark text-light border-secondary" id="splitPart">
                        <option value="0">Primera</option>
                        <option value="1">Segunda</option>
                        <option value="-1">Última</option>
                    </select>
                </div>
            `;
            break;
            
        case 'pad':
            html = `
                <div class="mb-3">
                    <label class="form-label">Longitud total</label>
                    <input type="number" class="form-control bg-dark text-light border-secondary" id="padLength" value="10" min="1">
                </div>
                <div class="mb-3">
                    <label class="form-label">Carácter de relleno</label>
                    <input type="text" class="form-control bg-dark text-light border-secondary" id="padChar" value="0" maxlength="1">
                </div>
                <div class="mb-3">
                    <label class="form-label">Dirección</label>
                    <select class="form-select bg-dark text-light border-secondary" id="padDirection">
                        <option value="left">Izquierda</option>
                        <option value="right">Derecha</option>
                    </select>
                </div>
            `;
            break;
    }
    
    optionsDiv.innerHTML = html;
}

// Vista previa de manipulación de texto
async function previewTextManipulation() {
    showLoading('Generando vista previa...', 'Por favor espera');
    
    try {
        const operation = document.getElementById('textOperation').value;
        const response = await fetch(`/api/datasets/${window.selectedDataset.id}/text-manipulation-preview/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                column_name: selectedEditorColumn,
                operation: operation,
                params: getTextOperationParams()
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.preview) {
            displayTextManipulationPreview(data.preview);
            document.getElementById('executeTextManipBtn').disabled = false;
        } else {
            showNotification('Error', data.error || 'Error al generar vista previa', 'error');
        }
        
        hideLoading();
    } catch (error) {
        hideLoading();
        console.error('Error:', error);
        showNotification('Error', 'Error de conexión', 'error');
    }
}

// Obtener parámetros de operación de texto
function getTextOperationParams() {
    const operation = document.getElementById('textOperation').value;
    const params = {};
    
    switch(operation) {
        case 'truncate':
            params.length = parseInt(document.getElementById('truncateLength').value);
            params.ellipsis = document.getElementById('truncateEllipsis').checked;
            break;
        case 'extract':
            params.start = parseInt(document.getElementById('extractStart').value) - 1;
            params.length = parseInt(document.getElementById('extractLength').value);
            break;
        case 'remove_chars':
            params.chars = document.getElementById('removeChars').value;
            break;
        case 'case':
            params.type = document.getElementById('caseType').value;
            break;
        case 'trim':
            params.type = document.getElementById('trimType').value;
            break;
        case 'split':
            params.separator = document.getElementById('splitSeparator').value;
            params.part = parseInt(document.getElementById('splitPart').value);
            break;
        case 'pad':
            params.length = parseInt(document.getElementById('padLength').value);
            params.char = document.getElementById('padChar').value;
            params.direction = document.getElementById('padDirection').value;
            break;
    }
    
    return params;
}

// Mostrar vista previa de manipulación de texto
function displayTextManipulationPreview(preview) {
    const previewDiv = document.getElementById('textManipPreview');
    
    let html = '<table class="table table-sm table-dark">';
    html += '<thead><tr><th>Original</th><th>Transformado</th></tr></thead><tbody>';
    
    preview.forEach(item => {
        html += `
            <tr>
                <td><code>${item.original}</code></td>
                <td><code class="text-warning">${item.transformed}</code></td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    previewDiv.innerHTML = html;
}

// Ejecutar manipulación de texto
async function executeTextManipulation() {
    // Obtener alcance seleccionado
    const scope = document.querySelector('input[name="textManipScope"]:checked').value;
    let scopeText = '';
    
    if (scope === 'all') {
        scopeText = 'Se modificarán todos los valores de la columna';
    } else if (scope === 'range') {
        const start = parseInt(document.getElementById('textManipRangeStart').value);
        const end = parseInt(document.getElementById('textManipRangeEnd').value);
        scopeText = `Se modificarán los valores de las filas ${start} a ${end}`;
    }
    
    const result = await Swal.fire({
        title: '¿Aplicar transformación?',
        text: scopeText,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, aplicar',
        cancelButtonText: 'Cancelar',
        background: '#0a0e27',
        color: '#f0f9ff',
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        customClass: {
            popup: 'swal-custom-popup',
            title: 'swal-custom-title',
            htmlContainer: 'swal-custom-text',
            confirmButton: 'btn btn-danger',
            cancelButton: 'btn btn-secondary'
        }
    });
    
    if (result.isConfirmed) {
        showLoading('Aplicando transformación...', 'Esto puede tomar un momento');
        
        try {
            const operation = document.getElementById('textOperation').value;
            const params = getTextOperationParams();
            
            // Añadir parámetros de alcance
            if (scope === 'range') {
                params.range_start = parseInt(document.getElementById('textManipRangeStart').value) - 1;
                params.range_end = parseInt(document.getElementById('textManipRangeEnd').value);
            }
            
            const response = await fetch(`/api/datasets/${window.selectedDataset.id}/text-manipulation/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    column_name: selectedEditorColumn,
                    operation: operation,
                    params: params,
                    scope: scope
                })
            });
            
            hideLoading();
            
            if (response.ok) {
                showNotification('¡Éxito!', 'Transformación aplicada correctamente', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                const data = await response.json();
                showNotification('Error', data.error || 'Error al aplicar transformación', 'error');
            }
        } catch (error) {
            hideLoading();
            console.error('Error:', error);
            showNotification('Error', 'Error de conexión', 'error');
        }
    }
}

// Función para transformaciones numéricas
function openNumericTransform() {
    if (!selectedEditorColumn) {
        showNotification('Error', 'Selecciona una columna primero', 'error');
        return;
    }
    
    // Verificar que la columna sea numérica
    const colStats = window.currentDatasetData.stats[selectedEditorColumn];
    if (!colStats || colStats.mean === undefined) {
        showNotification('Error', 'Esta función solo está disponible para columnas numéricas', 'error');
        return;
    }
    
    editorModal.hide();
    document.getElementById('numericColumnName').textContent = selectedEditorColumn;
    
    const numericModal = new bootstrap.Modal(document.getElementById('numericTransformModal'));
    numericModal.show();
    
    updateNumericOperationOptions();
}

// Actualizar opciones según operación numérica
function updateNumericOperationOptions() {
    const operation = document.getElementById('numericOperation').value;
    const optionsDiv = document.getElementById('numericOperationOptions');
    
    let html = '';
    
    switch(operation) {
        case 'round':
            html = `
                <div class="mb-3">
                    <label class="form-label">Decimales</label>
                    <input type="number" class="form-control bg-dark text-light border-secondary" id="roundDecimals" value="2" min="0">
                </div>
            `;
            break;
            
        case 'scale':
            html = `
                <div class="mb-3">
                    <label class="form-label">Factor de escala</label>
                    <input type="number" class="form-control bg-dark text-light border-secondary" id="scaleFactor" value="1" step="0.1">
                </div>
            `;
            break;
            
        case 'clip':
            html = `
                <div class="mb-3">
                    <label class="form-label">Valor mínimo</label>
                    <input type="number" class="form-control bg-dark text-light border-secondary" id="clipMin" step="any">
                </div>
                <div class="mb-3">
                    <label class="form-label">Valor máximo</label>
                    <input type="number" class="form-control bg-dark text-light border-secondary" id="clipMax" step="any">
                </div>
            `;
            break;
            
        case 'arithmetic':
            html = `
                <div class="mb-3">
                    <label class="form-label">Operación</label>
                    <select class="form-select bg-dark text-light border-secondary" id="arithmeticOp">
                        <option value="add">Sumar</option>
                        <option value="subtract">Restar</option>
                        <option value="multiply">Multiplicar</option>
                        <option value="divide">Dividir</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Valor</label>
                    <input type="number" class="form-control bg-dark text-light border-secondary" id="arithmeticValue" value="1" step="any">
                </div>
            `;
            break;
            
        case 'log':
            html = `
                <div class="mb-3">
                    <label class="form-label">Base del logaritmo</label>
                    <select class="form-select bg-dark text-light border-secondary" id="logBase">
                        <option value="natural">Natural (ln)</option>
                        <option value="10">Base 10</option>
                        <option value="2">Base 2</option>
                    </select>
                </div>
            `;
            break;
            
        case 'power':
            html = `
                <div class="mb-3">
                    <label class="form-label">Exponente</label>
                    <input type="number" class="form-control bg-dark text-light border-secondary" id="powerExponent" value="2" step="any">
                </div>
            `;
            break;
    }
    
    optionsDiv.innerHTML = html;
}

// Vista previa de transformación numérica
async function previewNumericTransform() {
    showLoading('Generando vista previa...', 'Por favor espera');
    
    try {
        const operation = document.getElementById('numericOperation').value;
        const response = await fetch(`/api/datasets/${window.selectedDataset.id}/numeric-transform-preview/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                column_name: selectedEditorColumn,
                operation: operation,
                params: getNumericOperationParams()
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.preview) {
            displayNumericTransformPreview(data.preview, data.stats);
            document.getElementById('executeNumericBtn').disabled = false;
        } else {
            showNotification('Error', data.error || 'Error al generar vista previa', 'error');
        }
        
        hideLoading();
    } catch (error) {
        hideLoading();
        console.error('Error:', error);
        showNotification('Error', 'Error de conexión', 'error');
    }
}

// Obtener parámetros de operación numérica
function getNumericOperationParams() {
    const operation = document.getElementById('numericOperation').value;
    const params = {};
    
    switch(operation) {
        case 'round':
            params.decimals = parseInt(document.getElementById('roundDecimals').value);
            break;
        case 'scale':
            params.factor = parseFloat(document.getElementById('scaleFactor').value);
            break;
        case 'clip':
            params.min = parseFloat(document.getElementById('clipMin').value);
            params.max = parseFloat(document.getElementById('clipMax').value);
            break;
        case 'arithmetic':
            params.operation = document.getElementById('arithmeticOp').value;
            params.value = parseFloat(document.getElementById('arithmeticValue').value);
            break;
        case 'log':
            params.base = document.getElementById('logBase').value;
            break;
        case 'power':
            params.exponent = parseFloat(document.getElementById('powerExponent').value);
            break;
    }
    
    return params;
}

// Mostrar vista previa de transformación numérica
function displayNumericTransformPreview(preview, stats) {
    const previewDiv = document.getElementById('numericTransformPreview');
    
    let html = '';
    
    if (stats) {
        html += `
            <div class="mb-3 p-2 bg-secondary rounded">
                <h6 class="text-info">Estadísticas después de transformación:</h6>
                <small>
                    Media: ${stats.mean.toFixed(4)} | 
                    Mediana: ${stats.median.toFixed(4)} | 
                    Desv. Est.: ${stats.std.toFixed(4)} |
                    Mín: ${stats.min.toFixed(4)} | 
                    Máx: ${stats.max.toFixed(4)}
                </small>
            </div>
        `;
    }
    
    html += '<table class="table table-sm table-dark">';
    html += '<thead><tr><th>Original</th><th>Transformado</th><th>Cambio</th></tr></thead><tbody>';
    
    preview.forEach(item => {
        const change = item.transformed - item.original;
        const changeColor = change > 0 ? 'text-success' : change < 0 ? 'text-danger' : 'text-muted';
        
        html += `
            <tr>
                <td>${item.original.toFixed(4)}</td>
                <td class="text-warning">${item.transformed.toFixed(4)}</td>
                <td class="${changeColor}">${change > 0 ? '+' : ''}${change.toFixed(4)}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    previewDiv.innerHTML = html;
}

// Ejecutar transformación numérica
async function executeNumericTransform() {
    const result = await Swal.fire({
        title: '¿Aplicar transformación?',
        text: 'Se modificarán todos los valores numéricos de la columna',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, aplicar',
        cancelButtonText: 'Cancelar'
    });
    
    if (result.isConfirmed) {
        showLoading('Aplicando transformación...', 'Esto puede tomar un momento');
        
        try {
            const operation = document.getElementById('numericOperation').value;
            const response = await fetch(`/api/datasets/${window.selectedDataset.id}/numeric-transform/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    column_name: selectedEditorColumn,
                    operation: operation,
                    params: getNumericOperationParams()
                })
            });
            
            hideLoading();
            
            if (response.ok) {
                showNotification('¡Éxito!', 'Transformación aplicada correctamente', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                const data = await response.json();
                showNotification('Error', data.error || 'Error al aplicar transformación', 'error');
            }
        } catch (error) {
            hideLoading();
            console.error('Error:', error);
            showNotification('Error', 'Error de conexión', 'error');
        }
    }
}

// Event listener para limpiar cuando se cierra el modal de búsqueda
document.addEventListener('DOMContentLoaded', function() {
    const searchModal = document.getElementById('columnSearchModal');
    if (searchModal) {
        searchModal.addEventListener('hidden.bs.modal', function () {
            // Limpiar el gráfico si existe
            if (window.searchResultChart && typeof window.searchResultChart.destroy === 'function') {
                window.searchResultChart.destroy();
                window.searchResultChart = null;
            }
            
            // No limpiar todos los datos aquí, solo resetear la UI
            // Mantener los datos de columna para mejorar el rendimiento
            document.getElementById('searchResults').style.display = 'none';
        });
        
        // Asegurar que el modal esté disponible globalmente
        searchModal.addEventListener('shown.bs.modal', function () {
            // Verificar que todos los elementos necesarios estén presentes
            const requiredElements = [
                'searchColumnName',
                'searchType',
                'searchValue',
                'matchCount',
                'totalCount',
                'matchPercentage',
                'matchedValuesList',
                'searchResultChart',
                'searchResults'
            ];
            
            let allElementsPresent = true;
            requiredElements.forEach(id => {
                if (!document.getElementById(id)) {
                    console.error(`Elemento requerido no encontrado: ${id}`);
                    allElementsPresent = false;
                }
            });
            
            if (!allElementsPresent) {
                showNotification('Error', 'Error al inicializar el modal de búsqueda. Por favor recarga la página.', 'error');
            }
        });
    }
});
</script>


<!-- Script para funciones comunes de dataset -->
<script src="{% static 'js/dataset-common.js' %}?v={% now 'U' %}"></script>

<!-- Script para análisis avanzados -->
<script src="{% static 'js/dataset-analysis.js' %}?v={% now 'U' %}"></script>

{% endblock %}