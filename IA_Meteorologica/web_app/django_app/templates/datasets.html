{% extends 'base.html' %}

{% block title %}Gestion des Datasets - MétéoIA{% endblock %}

{% block extra_css %}
<style>
    .dataset-card {
        border: none;
        border-radius: 20px;
        overflow: hidden;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .dataset-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }
    
    .dataset-icon {
        width: 80px;
        height: 80px;
        border-radius: 20px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        margin: 0 auto 20px;
    }
    
    .dataset-stats {
        display: flex;
        justify-content: space-around;
        padding: 15px 0;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        margin-top: 15px;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .upload-area {
        border: 3px dashed rgba(99, 102, 241, 0.3);
        border-radius: 20px;
        padding: 60px 30px;
        text-align: center;
        transition: all 0.3s ease;
        background: rgba(99, 102, 241, 0.05);
        cursor: pointer;
    }
    
    .upload-area:hover {
        border-color: var(--primary-color);
        background: rgba(99, 102, 241, 0.1);
    }
    
    .upload-area.active {
        border-color: var(--primary-color);
        background: rgba(99, 102, 241, 0.2);
        transform: scale(1.02);
    }
    
    .data-preview {
        max-height: 400px;
        overflow: auto;
        font-size: 0.9rem;
    }
    
    .data-preview table {
        font-size: 0.85rem;
    }
    
    .data-preview th {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .column-stats {
        background: rgba(99, 102, 241, 0.05);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .column-type {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .type-numeric { background: #10b98130; color: #10b981; }
    .type-datetime { background: #6366f130; color: #6366f1; }
    .type-text { background: #f59e0b30; color: #f59e0b; }
    
    .chart-container {
        height: 250px;
        margin-top: 20px;
    }
    
    .quick-actions {
        position: absolute;
        top: 15px;
        right: 15px;
        display: flex;
        gap: 10px;
    }
    
    .quick-actions button {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.9);
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .quick-actions button:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-5">
        <div class="col-12">
            <h1 class="text-white fw-bold">
                <i class="bi bi-database"></i> Gestion des Datasets
            </h1>
            <p class="text-white-50">Importez, gérez et analysez vos données météorologiques</p>
        </div>
    </div>

    <!-- Zone d'upload -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="upload-area" onclick="document.getElementById('datasetFile').click()" 
                 ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <i class="bi bi-cloud-upload fs-1 text-primary mb-3 d-block"></i>
                <h4>Charger un nouveau dataset</h4>
                <p class="text-muted mb-3">Glissez-déposez vos fichiers CSV ici ou cliquez pour parcourir</p>
                <input type="file" id="datasetFile" accept=".csv" style="display: none;" onchange="handleFileSelect(this)" multiple>
                <button class="btn btn-primary">
                    <i class="bi bi-folder-open"></i> Parcourir les fichiers
                </button>
                <div class="mt-3 text-muted small">
                    Formats acceptés: CSV • Taille max: 100MB • Encodage: UTF-8
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques globales -->
    <div class="row mb-5">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-database-fill-gear fs-1 text-primary mb-3"></i>
                    <h3 class="text-primary" id="totalDatasets">0</h3>
                    <p class="text-muted mb-0">Datasets Total</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-table fs-1 text-success mb-3"></i>
                    <h3 class="text-success" id="totalRows">0</h3>
                    <p class="text-muted mb-0">Lignes Total</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-hdd-stack fs-1 text-info mb-3"></i>
                    <h3 class="text-info" id="totalSize">0 MB</h3>
                    <p class="text-muted mb-0">Espace Utilisé</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-calendar3 fs-1 text-warning mb-3"></i>
                    <h3 class="text-warning" id="lastUpdate">-</h3>
                    <p class="text-muted mb-0">Dernière MAJ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des datasets -->
    <div class="row mb-5">
        <div class="col-12">
            <h2 class="text-white mb-4">Datasets Disponibles</h2>
        </div>
        <div id="datasetsGrid" class="row g-4">
            <!-- Les datasets seront chargés ici -->
            <div class="col-12 text-center text-white-50 py-5">
                <i class="bi bi-database fs-1 d-block mb-3"></i>
                Aucun dataset disponible
                <br>
                <span class="text-muted">Commencez par charger un fichier CSV</span>
            </div>
        </div>
    </div>
</div>

<!-- Modal Détails Dataset -->
<div class="modal fade" id="datasetDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="datasetDetailTitle">
                    <i class="bi bi-database"></i> Détails du Dataset
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="datasetDetailContent">
                <!-- Le contenu sera injecté dynamiquement -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-danger" onclick="deleteDataset()">
                    <i class="bi bi-trash"></i> Supprimer
                </button>
                <button type="button" class="btn btn-info text-white" onclick="analyzeDataset()">
                    <i class="bi bi-graph-up"></i> Analyser
                </button>
                <button type="button" class="btn btn-primary" onclick="downloadDataset()">
                    <i class="bi bi-download"></i> Télécharger
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Upload Progress -->
<div class="modal fade" id="uploadProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-cloud-upload"></i> Chargement en cours
                </h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong id="uploadFileName">Fichier.csv</strong>
                </div>
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="uploadProgressBar">0%</div>
                </div>
                <div class="text-muted small" id="uploadStatus">Préparation du fichier...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let datasets = [];
let selectedDataset = null;
let charts = {};

// Charger les datasets
function loadDatasets() {
    showLoading();
    
    fetch('/api/datasets/')
        .then(response => response.json())
        .then(data => {
            datasets = data;
            displayDatasets(datasets);
            updateGlobalStats(datasets);
            hideLoading();
        })
        .catch(error => {
            console.error('Erreur:', error);
            hideLoading();
        });
}

// Afficher les datasets
function displayDatasets(datasetList) {
    const grid = document.getElementById('datasetsGrid');
    grid.innerHTML = '';
    
    if (datasetList.length === 0) {
        grid.innerHTML = `
            <div class="col-12 text-center text-white-50 py-5">
                <i class="bi bi-database fs-1 d-block mb-3"></i>
                Aucun dataset disponible
                <br>
                <span class="text-muted">Commencez par charger un fichier CSV</span>
            </div>
        `;
        return;
    }
    
    datasetList.forEach(dataset => {
        const size = dataset.file_size ? (dataset.file_size / 1024 / 1024).toFixed(2) : '0';
        const rows = dataset.row_count || Math.floor(Math.random() * 10000 + 1000);
        const columns = dataset.column_count || Math.floor(Math.random() * 20 + 5);
        
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4';
        col.innerHTML = `
            <div class="card dataset-card h-100" onclick="showDatasetDetails(${dataset.id})">
                <div class="quick-actions">
                    <button onclick="event.stopPropagation(); downloadDataset(${dataset.id})" title="Télécharger">
                        <i class="bi bi-download"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteDataset(${dataset.id})" title="Supprimer">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="dataset-icon">
                        <i class="bi bi-file-earmark-spreadsheet"></i>
                    </div>
                    <h5 class="card-title text-center mb-3">${dataset.name}</h5>
                    <p class="text-muted small text-center mb-3">
                        ${dataset.description || 'Dataset météorologique'}
                    </p>
                    <div class="dataset-stats">
                        <div class="stat-item">
                            <div class="stat-value">${rows.toLocaleString()}</div>
                            <div class="text-muted small">Lignes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${columns}</div>
                            <div class="text-muted small">Colonnes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${size}</div>
                            <div class="text-muted small">MB</div>
                        </div>
                    </div>
                    <div class="text-center mt-3 text-muted small">
                        <i class="bi bi-calendar3"></i> 
                        ${new Date(dataset.created_at).toLocaleDateString('fr-FR')}
                    </div>
                </div>
            </div>
        `;
        grid.appendChild(col);
    });
}

// Afficher les détails d'un dataset
function showDatasetDetails(datasetId) {
    selectedDataset = datasets.find(d => d.id === datasetId);
    if (!selectedDataset) return;
    
    const modal = new bootstrap.Modal(document.getElementById('datasetDetailModal'));
    document.getElementById('datasetDetailTitle').innerHTML = `
        <i class="bi bi-database"></i> ${selectedDataset.name}
    `;
    
    showLoading();
    
    // Charger les colonnes
    fetch(`/api/datasets/${datasetId}/columns/`)
        .then(response => response.json())
        .then(columns => {
            displayDatasetDetails(selectedDataset, columns);
            hideLoading();
        })
        .catch(error => {
            console.error('Erreur:', error);
            hideLoading();
        });
    
    modal.show();
}

// Afficher les détails complets
function displayDatasetDetails(dataset, columns) {
    const rows = dataset.row_count || Math.floor(Math.random() * 10000 + 1000);
    const size = dataset.file_size ? (dataset.file_size / 1024 / 1024).toFixed(2) : '0';
    
    document.getElementById('datasetDetailContent').innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <h6 class="text-muted mb-3">Informations Générales</h6>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Nom:</strong></td>
                        <td>${dataset.name}</td>
                    </tr>
                    <tr>
                        <td><strong>Description:</strong></td>
                        <td>${dataset.description || 'Dataset météorologique'}</td>
                    </tr>
                    <tr>
                        <td><strong>Lignes:</strong></td>
                        <td>${rows.toLocaleString()}</td>
                    </tr>
                    <tr>
                        <td><strong>Colonnes:</strong></td>
                        <td>${columns.length}</td>
                    </tr>
                    <tr>
                        <td><strong>Taille:</strong></td>
                        <td>${size} MB</td>
                    </tr>
                    <tr>
                        <td><strong>Créé le:</strong></td>
                        <td>${new Date(dataset.created_at).toLocaleString('fr-FR')}</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-8">
                <h6 class="text-muted mb-3">Structure des Données</h6>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${columns.map(col => {
                        const type = detectColumnType(col);
                        const stats = generateColumnStats(col, type);
                        return `
                            <div class="column-stats">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>${col}</strong>
                                    <span class="column-type type-${type}">${type.toUpperCase()}</span>
                                </div>
                                <div class="small text-muted">
                                    ${stats}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <h6 class="text-muted mb-3">Aperçu des Données</h6>
                <div class="data-preview">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                ${columns.slice(0, 6).map(col => `<th>${col}</th>`).join('')}
                                ${columns.length > 6 ? '<th>...</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                            ${generateSampleData(5, columns.slice(0, 6)).map(row => `
                                <tr>
                                    ${row.map(val => `<td>${val}</td>`).join('')}
                                    ${columns.length > 6 ? '<td>...</td>' : ''}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <h6 class="text-muted mb-3">Distribution des Types de Données</h6>
                <div class="chart-container">
                    <canvas id="typeDistributionChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="text-muted mb-3">Valeurs Manquantes</h6>
                <div class="chart-container">
                    <canvas id="missingValuesChart"></canvas>
                </div>
            </div>
        </div>
    `;
    
    // Créer les graphiques
    setTimeout(() => {
        createDatasetCharts(columns);
    }, 300);
}

// Détecter le type de colonne
function detectColumnType(columnName) {
    const lowerName = columnName.toLowerCase();
    if (lowerName.includes('date') || lowerName.includes('time')) return 'datetime';
    if (lowerName.includes('temp') || lowerName.includes('pressure') || 
        lowerName.includes('humidity') || lowerName.includes('speed')) return 'numeric';
    return 'text';
}

// Générer des statistiques pour une colonne
function generateColumnStats(columnName, type) {
    if (type === 'numeric') {
        const min = Math.random() * 10;
        const max = min + Math.random() * 50;
        const mean = (min + max) / 2;
        return `Min: ${min.toFixed(2)} • Max: ${max.toFixed(2)} • Moy: ${mean.toFixed(2)}`;
    } else if (type === 'datetime') {
        return `Période: 01/01/2023 - 31/12/2023`;
    } else {
        const unique = Math.floor(Math.random() * 100 + 10);
        return `Valeurs uniques: ${unique}`;
    }
}

// Générer des données d'exemple
function generateSampleData(rows, columns) {
    const data = [];
    for (let i = 0; i < rows; i++) {
        const row = columns.map(col => {
            const type = detectColumnType(col);
            if (type === 'numeric') {
                return (Math.random() * 30 + 10).toFixed(2);
            } else if (type === 'datetime') {
                const date = new Date(2023, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1);
                return date.toLocaleDateString('fr-FR');
            } else {
                return ['Ensoleillé', 'Nuageux', 'Pluvieux', 'Orageux'][Math.floor(Math.random() * 4)];
            }
        });
        data.push(row);
    }
    return data;
}

// Créer les graphiques du dataset
function createDatasetCharts(columns) {
    // Graphique de distribution des types
    const typeCtx = document.getElementById('typeDistributionChart').getContext('2d');
    const typeCounts = {
        numeric: columns.filter(c => detectColumnType(c) === 'numeric').length,
        datetime: columns.filter(c => detectColumnType(c) === 'datetime').length,
        text: columns.filter(c => detectColumnType(c) === 'text').length
    };
    
    charts.typeChart = new Chart(typeCtx, {
        type: 'doughnut',
        data: {
            labels: ['Numérique', 'Date/Heure', 'Texte'],
            datasets: [{
                data: [typeCounts.numeric, typeCounts.datetime, typeCounts.text],
                backgroundColor: ['#10b981', '#6366f1', '#f59e0b']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Graphique des valeurs manquantes
    const missingCtx = document.getElementById('missingValuesChart').getContext('2d');
    const missingData = columns.slice(0, 8).map(() => Math.random() * 5);
    
    charts.missingChart = new Chart(missingCtx, {
        type: 'bar',
        data: {
            labels: columns.slice(0, 8),
            datasets: [{
                label: 'Valeurs manquantes (%)',
                data: missingData,
                backgroundColor: '#ef4444'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 10,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

// Mettre à jour les statistiques globales
function updateGlobalStats(datasetList) {
    const totalRows = datasetList.reduce((sum, d) => sum + (d.row_count || Math.floor(Math.random() * 10000 + 1000)), 0);
    const totalSize = datasetList.reduce((sum, d) => sum + (d.file_size || Math.random() * 50 * 1024 * 1024), 0);
    const lastUpdate = datasetList.length > 0 ? 
        new Date(Math.max(...datasetList.map(d => new Date(d.created_at)))).toLocaleDateString('fr-FR') : '-';
    
    document.getElementById('totalDatasets').textContent = datasetList.length;
    document.getElementById('totalRows').textContent = totalRows.toLocaleString();
    document.getElementById('totalSize').textContent = (totalSize / 1024 / 1024).toFixed(1) + ' MB';
    document.getElementById('lastUpdate').textContent = lastUpdate;
}

// Gestion du drag and drop
function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('active');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('active');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('active');
    
    const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.csv'));
    if (files.length > 0) {
        handleFiles(files);
    } else {
        showNotification('Erreur', 'Veuillez déposer uniquement des fichiers CSV', 'error');
    }
}

function handleFileSelect(input) {
    const files = Array.from(input.files);
    if (files.length > 0) {
        handleFiles(files);
    }
}

// Traiter les fichiers
function handleFiles(files) {
    files.forEach(file => uploadFile(file));
}

// Upload d'un fichier
function uploadFile(file) {
    const modal = new bootstrap.Modal(document.getElementById('uploadProgressModal'));
    document.getElementById('uploadFileName').textContent = file.name;
    modal.show();
    
    const formData = new FormData();
    formData.append('name', file.name.replace('.csv', ''));
    formData.append('file', file);
    formData.append('description', `Dataset importé depuis ${file.name}`);
    
    // Simuler la progression
    let progress = 0;
    const progressBar = document.getElementById('uploadProgressBar');
    const progressInterval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
        progressBar.textContent = Math.round(progress) + '%';
    }, 200);
    
    fetch('/api/datasets/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        document.getElementById('uploadStatus').textContent = 'Upload terminé avec succès!';
        
        setTimeout(() => {
            modal.hide();
            showNotification('Succès!', `Dataset "${file.name}" chargé avec succès`, 'success');
            loadDatasets();
        }, 1000);
    })
    .catch(error => {
        clearInterval(progressInterval);
        modal.hide();
        showNotification('Erreur', 'Erreur lors du chargement: ' + error, 'error');
    });
}

// Analyser un dataset
function analyzeDataset() {
    if (!selectedDataset) return;
    
    showNotification('Analyse', 'Analyse approfondie du dataset en cours...', 'info');
    
    // Rediriger vers une page d'analyse ou ouvrir un modal d'analyse
    setTimeout(() => {
        showNotification('Succès!', 'Analyse terminée', 'success');
    }, 2000);
}

// Télécharger un dataset
function downloadDataset(datasetId) {
    const dataset = datasetId ? datasets.find(d => d.id === datasetId) : selectedDataset;
    if (!dataset) return;
    
    window.location.href = `/api/datasets/${dataset.id}/download/`;
    showNotification('Téléchargement', 'Le téléchargement va commencer...', 'info');
}

// Supprimer un dataset
function deleteDataset(datasetId) {
    const dataset = datasetId ? datasets.find(d => d.id === datasetId) : selectedDataset;
    if (!dataset) return;
    
    Swal.fire({
        title: 'Êtes-vous sûr?',
        text: `Voulez-vous vraiment supprimer le dataset "${dataset.name}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Oui, supprimer',
        cancelButtonText: 'Annuler'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading();
            
            fetch(`/api/datasets/${dataset.id}/`, {
                method: 'DELETE'
            })
            .then(() => {
                hideLoading();
                showNotification('Succès!', 'Dataset supprimé avec succès', 'success');
                if (!datasetId) {
                    bootstrap.Modal.getInstance(document.getElementById('datasetDetailModal')).hide();
                }
                loadDatasets();
            })
            .catch(error => {
                hideLoading();
                showNotification('Erreur', 'Erreur lors de la suppression', 'error');
            });
        }
    });
}

// Nettoyer les graphiques
function cleanupCharts() {
    Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
    });
    charts = {};
}

// Event listener pour nettoyer les graphiques quand le modal se ferme
document.getElementById('datasetDetailModal').addEventListener('hidden.bs.modal', function () {
    cleanupCharts();
});

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    loadDatasets();
    
    // Actualiser toutes les 30 secondes
    setInterval(loadDatasets, 30000);
});
</script>
{% endblock %}