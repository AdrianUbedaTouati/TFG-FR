{% extends 'base.html' %}
{% load static %}

{% block title %}Datasets - IA Météorologique{% endblock %}

{% block extra_css %}
<style>
    /* Estilos mejorados para datasets */
    .dataset-card {
        background: rgba(10, 14, 39, 0.8);
        border: 2px solid rgba(0, 212, 255, 0.3);
        border-radius: 20px;
        padding: 15px 25px 20px 25px;
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 380px;
        width: 350px;
        min-width: 350px;
        max-width: 350px;
    }
    
    /* Forzar reset de hover cuando el mouse no está sobre la tarjeta */
    .dataset-card:not(:hover) {
        transform: translateY(0) !important;
        border-color: rgba(0, 212, 255, 0.3) !important;
        box-shadow: none !important;
    }
    
    .dataset-card:not(:hover)::before {
        opacity: 0 !important;
    }
    
    .dataset-clickable {
        cursor: pointer;
    }
    
    .dataset-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(0, 212, 255, 0.1) 0%, transparent 70%);
        transform: rotate(45deg);
        transition: all 0.5s ease;
        opacity: 0;
        pointer-events: none; /* Evitar que interfiera con los clicks */
    }
    
    .dataset-card:hover {
        transform: translateY(-10px);
        border-color: rgba(0, 212, 255, 0.8);
        box-shadow: 0 15px 40px rgba(0, 212, 255, 0.3);
    }
    
    .dataset-card:hover::before {
        opacity: 1;
    }
    
    .dataset-icon {
        font-size: 3rem;
        background: linear-gradient(135deg, #00d4ff, #0099ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
        text-align: center;
    }
    
    .dataset-card .card-title {
        color: white !important;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .dataset-card .card-body {
        display: flex;
        flex-direction: column;
        flex: 1;
        width: 100%;
    }
    
    .dataset-card p {
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .dataset-stats {
        display: flex;
        justify-content: space-around;
        margin-top: auto;
        margin-bottom: 10px;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.3rem;
        font-weight: bold;
        color: #00d4ff;
    }
    
    .upload-area {
        background: rgba(0, 212, 255, 0.05);
        border: 3px dashed rgba(0, 212, 255, 0.5);
        border-radius: 20px;
        padding: 60px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .upload-area:hover {
        border-color: #00d4ff;
        background: rgba(0, 212, 255, 0.1);
    }
    
    .upload-area.active {
        border-color: #00ff88;
        background: rgba(0, 255, 136, 0.1);
        box-shadow: inset 0 0 30px rgba(0, 255, 136, 0.2);
    }
    
    .quick-actions {
        position: absolute;
        top: 10px;
        right: 15px;
        display: flex;
        gap: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 100;
    }
    
    .dataset-card:hover .quick-actions {
        opacity: 1;
    }
    
    .quick-actions button {
        background: rgba(0, 212, 255, 0.2);
        border: 2px solid rgba(0, 212, 255, 0.4);
        color: #00d4ff;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        transition: all 0.2s ease;
        cursor: pointer;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        margin: 0;
    }
    
    .quick-actions button:hover {
        background: rgba(0, 212, 255, 0.8);
        transform: scale(1.1);
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.8);
        border-color: #00d4ff;
        color: white;
    }
    
    .quick-actions button:active {
        transform: scale(0.95);
        background: rgba(0, 212, 255, 1);
    }
    
    .quick-actions button:focus {
        outline: 2px solid #00d4ff;
        outline-offset: 2px;
    }
    
    
    
    /* Estilos para checkbox de outliers */
    .form-check-input:checked {
        background-color: #00d4ff;
        border-color: #00d4ff;
    }
    
    .form-check-input:focus {
        border-color: #00d4ff;
        box-shadow: 0 0 0 0.25rem rgba(0, 212, 255, 0.25);
    }
    
    /* Colores específicos para cada acción */
    .quick-actions button[data-action="normalize"]:hover {
        background: rgba(0, 212, 255, 0.8);
        border-color: #00d4ff;
    }
    
    .quick-actions button[data-action="download"]:hover {
        background: rgba(16, 185, 129, 0.8);
        border-color: #10b981;
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);
    }
    
    .quick-actions button[data-action="delete"]:hover {
        background: rgba(239, 68, 68, 0.8);
        border-color: #ef4444;
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
    }
    
    /* Estilos para el modal de detalles */
    .column-stats {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.8s ease;
        cursor: pointer;
    }
    
    .column-stats:hover {
        background: rgba(0, 212, 255, 0.1);
        border-color: rgba(0, 212, 255, 0.5);
    }
    
    .column-stats.selected {
        background: rgba(0, 212, 255, 0.15);
        border-color: rgba(0, 212, 255, 0.8);
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
    }
    
    .column-type {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .column-type.type-numeric {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }
    
    .column-type.type-text {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }
    
    .column-type.type-datetime {
        background: rgba(168, 85, 247, 0.2);
        color: #a855f7;
    }
    
    .data-preview {
        background: rgba(10, 14, 39, 0.5);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 20px;
        overflow-x: auto;
    }
    
    .data-preview table {
        color: #f0f9ff;
    }
    
    .data-preview th {
        background: rgba(0, 212, 255, 0.1);
        color: #00d4ff;
        font-weight: 600;
        border-color: rgba(0, 212, 255, 0.2);
    }
    
    .data-preview td {
        border-color: rgba(0, 212, 255, 0.1);
    }
    
    .chart-container {
        background: rgba(10, 14, 39, 0.5);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 20px;
    }
    
    /* Estilos para los análisis */
    .stat-card {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 15px;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        background: rgba(0, 212, 255, 0.1);
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
    }
    
    .accordion-button {
        background: rgba(0, 212, 255, 0.05);
        color: #f0f9ff;
    }
    
    .accordion-button:not(.collapsed) {
        background: rgba(0, 212, 255, 0.1);
        color: #00d4ff;
    }
    
    .accordion-body {
        background: rgba(10, 14, 39, 0.5);
        border-top: 1px solid rgba(0, 212, 255, 0.2);
    }
    
    .column-row {
        cursor: pointer;
        transition: background-color 0.8s ease;
    }
    
    .column-row:hover {
        background-color: rgba(0, 212, 255, 0.05);
    }
    
    .column-row.selected {
        background-color: rgba(0, 212, 255, 0.15);
    }
    
    /* Estilos para la tabla de frecuencias */
    .table-responsive {
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 8px;
    }
    
    .progress {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    /* Estilos para datasets agrupados */
    .dataset-group {
        background: rgba(10, 14, 39, 0.4);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 25px;
        transition: all 0.3s ease;
    }
    
    .dataset-group:hover {
        border-color: rgba(0, 212, 255, 0.5);
        background: rgba(10, 14, 39, 0.6);
    }
    
    .dataset-group-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(0, 212, 255, 0.3);
    }
    
    .dataset-group-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #00d4ff;
        margin: 0;
    }
    
    .dataset-cards-container {
        display: flex;
        gap: 20px;
        overflow-x: auto;
        padding: 10px 0;
        align-items: flex-start;
        height: 400px;
    }
    
    .dataset-cards-container::-webkit-scrollbar {
        height: 8px;
    }
    
    .dataset-cards-container::-webkit-scrollbar-track {
        background: rgba(0, 212, 255, 0.1);
        border-radius: 4px;
    }
    
    .dataset-cards-container::-webkit-scrollbar-thumb {
        background: rgba(0, 212, 255, 0.5);
        border-radius: 4px;
    }
    
    .dataset-cards-container::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 212, 255, 0.7);
    }
    
    .dataset-card.original {
        border-color: rgba(0, 212, 255, 0.6);
        background: rgba(0, 212, 255, 0.1);
        flex-shrink: 0;
    }
    
    .dataset-card.normalized {
        border-color: rgba(255, 0, 255, 0.4);
        background: rgba(255, 0, 255, 0.05);
        flex-shrink: 0;
    }
    
    .normalization-arrow {
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(0, 212, 255, 0.6);
        font-size: 2rem;
        padding: 0 10px;
        flex-shrink: 0;
    }
    
    /* Estilos para el árbol genealógico */
    .genealogy-tree {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 15px;
        font-family: monospace;
    }
    
    .genealogy-item {
        padding: 5px 0;
        transition: all 0.3s ease;
    }
    
    .genealogy-item:hover {
        background: rgba(0, 212, 255, 0.1);
        padding-left: 10px;
        border-radius: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-5">
        <div class="col-12">
            <h1 class="text-white fw-bold">
                <i class="bi bi-database"></i> Gestion des Datasets
            </h1>
            <p class="text-white-50">Importez et gérez vos données météorologiques</p>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-database-fill text-primary" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="totalDatasets">0</h3>
                    <p class="text-muted mb-0">Datasets Totaux</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-hdd-fill text-success" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="totalSize">0 MB</h3>
                    <p class="text-muted mb-0">Espace Utilisé</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-bar-chart-fill text-info" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="totalRows">0</h3>
                    <p class="text-muted mb-0">Lignes Totales</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-calendar3 text-warning" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="lastUpdate">-</h3>
                    <p class="text-muted mb-0">Dernière Mise à Jour</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Upload Area -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <i class="bi bi-cloud-arrow-up" style="font-size: 4rem; color: #00d4ff;"></i>
                <h4 class="mt-3 text-white">Glissez vos fichiers CSV ici</h4>
                <p class="text-muted">ou cliquez pour parcourir</p>
                <input type="file" id="fileInput" multiple accept=".csv" style="display: none;" onchange="handleFileSelect(this)">
            </div>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-primary">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label for="searchFilter" class="form-label text-info">Rechercher par nom</label>
                            <input type="text" class="form-control" id="searchFilter" 
                                   placeholder="Nom du dataset..." onkeyup="filterDatasets()">
                        </div>
                        <div class="col-md-4">
                            <label for="parentFilter" class="form-label text-info">Filtrer par dataset original</label>
                            <select class="form-select" id="parentFilter" onchange="filterDatasets()">
                                <option value="">Tous les datasets</option>
                                <option value="original">Seulement originaux</option>
                                <option value="normalized">Seulement normalisés</option>
                                <!-- Les options de datasets spécifiques seront ajoutées dynamiquement -->
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-info">Tri</label>
                            <select class="form-select" id="sortFilter" onchange="filterDatasets()">
                                <option value="name">Par nom</option>
                                <option value="date">Par date</option>
                                <option value="size">Par taille</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Datasets Grid -->
    <div id="datasetsContainer">
        <!-- Les datasets groupés seront chargés ici -->
    </div>
</div>

<!-- Modal Detail Dataset -->
<div class="modal fade" id="datasetDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="datasetDetailTitle">
                    <i class="bi bi-database"></i> Détails du Dataset
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="datasetDetailContent">
                <!-- Le contenu sera chargé dynamiquement -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Fermer
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteDataset()">
                    <i class="bi bi-trash"></i> Supprimer
                </button>
                <button type="button" class="btn btn-success" onclick="downloadDataset()">
                    <i class="bi bi-file-earmark-csv"></i> Télécharger Dataset
                </button>
                <button type="button" class="btn btn-primary" onclick="downloadReport()">
                    <i class="bi bi-file-earmark-pdf"></i> Télécharger Rapport
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Información del Dataset -->
<div class="modal fade" id="datasetInfoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i> Información del Dataset
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="datasetInfoForm">
                    <div class="mb-3">
                        <label for="datasetName" class="form-label">Nombre del Dataset</label>
                        <input type="text" class="form-control" id="datasetName" required>
                        <small class="text-muted">Si no especifica un nombre, se usará el nombre del archivo</small>
                    </div>
                    <div class="mb-3">
                        <label for="datasetShortDescription" class="form-label">Descripción corta <small class="text-muted" id="charCount">(0/80)</small></label>
                        <input type="text" class="form-control" id="datasetShortDescription" 
                               placeholder="Descripción breve para las tarjetas..."
                               maxlength="80" oninput="updateCharCount()">
                    </div>
                    <div class="mb-3">
                        <label for="datasetLongDescription" class="form-label">Descripción detallada <small class="text-muted">(opcional)</small></label>
                        <textarea class="form-control" id="datasetLongDescription" rows="3" 
                                  placeholder="Descripción completa del dataset, fuente de datos, metodología..."></textarea>
                    </div>
                    <input type="hidden" id="pendingFile">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="proceedWithUpload()">
                    <i class="bi bi-cloud-arrow-up"></i> Subir Dataset
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Upload Progress -->
<div class="modal fade" id="uploadProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-cloud-upload"></i> Chargement en cours
                </h5>
                <button type="button" class="btn-close" onclick="forceCloseUploadModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong id="uploadFileName">Fichier.csv</strong>
                </div>
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="uploadProgressBar">0%</div>
                </div>
                <div class="text-muted small" id="uploadStatus">Préparation du fichier...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="forceCloseUploadModal()">
                    <i class="bi bi-x-circle"></i> Annuler
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/@sgratzl/chartjs-chart-boxplot@3"></script>
<script>
let datasets = [];
let selectedDataset = null;
let charts = {};
let analysisCount = 1;
let analysisCharts = {}; // Store multiple charts by analysis ID
let analysisData = {}; // Store analysis data for report generation

// Función para obtener el CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Normalizar dataset
function normalizeDataset(datasetId) {
    window.location.href = `/datasets/${datasetId}/normalize/`;
}

// Charger les datasets
function loadDatasets() {
    showLoading('Chargement des datasets...', 'Récupération de vos fichiers de données');
    return fetch('/api/datasets/')
        .then(response => response.json())
        .then(data => {
            datasets = data;
            displayDatasets(data);
            updateStats(data);
            hideLoading();
            return data;
        })
        .catch(error => {
            console.error('Erreur:', error);
            hideLoading();
            showNotification('Erreur', 'Impossible de charger les datasets', 'error');
            throw error;
        });
}

// Encontrar el dataset original raíz
function findRootParent(datasetList, dataset) {
    if (!dataset.is_normalized || !dataset.parent_dataset) {
        return dataset;
    }
    
    const parent = datasetList.find(d => d.id === dataset.parent_dataset);
    if (!parent) {
        return null;
    }
    
    // Si el padre también es normalizado, buscar recursivamente
    if (parent.is_normalized && parent.parent_dataset) {
        return findRootParent(datasetList, parent);
    }
    
    return parent;
}

// Afficher les datasets
function displayDatasets(datasetList) {
    console.log('displayDatasets called with:', datasetList);
    const container = document.getElementById('datasetsContainer');
    if (!container) {
        console.error('Container datasetsContainer not found!');
        return;
    }
    container.innerHTML = '';
    
    // Debug: ver qué datos estamos recibiendo
    console.log('Datasets recibidos:', datasetList);
    
    if (!datasetList || datasetList.length === 0) {
        container.innerHTML = `
            <div class="text-center p-5">
                <p class="text-muted">Aucun dataset disponible. Importez votre premier dataset!</p>
            </div>
        `;
        return;
    }
    
    // Agrupar datasets por dataset original
    const datasetGroups = {};
    const originalDatasets = [];
    
    console.log('Grouping datasets...');
    
    // Primero identificar datasets originales
    datasetList.forEach(dataset => {
        console.log('Processing dataset:', dataset.name, 'is_normalized:', dataset.is_normalized);
        if (!dataset.is_normalized) {
            originalDatasets.push(dataset);
            datasetGroups[dataset.id] = {
                original: dataset,
                normalized: []
            };
        }
    });
    
    console.log('Original datasets found:', originalDatasets.length);
    console.log('Dataset groups:', datasetGroups);
    
    // Luego asignar datasets normalizados a sus originales
    datasetList.forEach(dataset => {
        if (dataset.is_normalized && dataset.parent_dataset) {
            console.log(`Dataset normalizado: ${dataset.name}, parent: ${dataset.parent_dataset}`);
            if (datasetGroups[dataset.parent_dataset]) {
                datasetGroups[dataset.parent_dataset].normalized.push(dataset);
            } else {
                // Si el padre no está en el grupo (porque también es normalizado), 
                // buscar el dataset original raíz
                let rootParent = findRootParent(datasetList, dataset);
                if (rootParent && datasetGroups[rootParent.id]) {
                    console.log(`Asignando ${dataset.name} al grupo raíz: ${rootParent.name}`);
                    datasetGroups[rootParent.id].normalized.push(dataset);
                }
            }
        }
    });
    
    // Ordenar normalizados por fecha (más antiguo primero - orden cronológico)
    Object.values(datasetGroups).forEach(group => {
        group.normalized.sort((a, b) => new Date(a.uploaded_at) - new Date(b.uploaded_at));
    });
    
    // Actualizar el filtro de datasets originales
    updateParentFilter(originalDatasets);
    
    // Mostrar grupos
    Object.values(datasetGroups).forEach(group => {
        displayDatasetGroup(group);
    });
    
    // Agrupar datasets huérfanos por root_dataset_id
    const orphanGroups = {};
    datasetList.forEach(dataset => {
        if (dataset.is_normalized && !dataset.parent_dataset && dataset.root_dataset_id) {
            if (!orphanGroups[dataset.root_dataset_id]) {
                orphanGroups[dataset.root_dataset_id] = [];
            }
            orphanGroups[dataset.root_dataset_id].push(dataset);
        }
    });
    
    // Mostrar grupos de huérfanos
    Object.entries(orphanGroups).forEach(([rootId, orphans]) => {
        // Ordenar por fecha
        orphans.sort((a, b) => new Date(a.uploaded_at) - new Date(b.uploaded_at));
        displayOrphanGroup(rootId, orphans);
    });
    
    // Mostrar datasets huérfanos sin root_dataset_id
    datasetList.forEach(dataset => {
        if (dataset.is_normalized && !dataset.parent_dataset && !dataset.root_dataset_id) {
            displayOrphanDataset(dataset);
        }
    });
}

// Actualizar filtro de datasets originales
function updateParentFilter(originalDatasets) {
    const filter = document.getElementById('parentFilter');
    const currentValue = filter.value;
    
    // Mantener las primeras 3 opciones
    filter.innerHTML = `
        <option value="">Tous les datasets</option>
        <option value="original">Seulement originaux</option>
        <option value="normalized">Seulement normalisés</option>
    `;
    
    // Añadir datasets originales
    if (originalDatasets.length > 0) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = 'Par dataset original';
        originalDatasets.forEach(dataset => {
            const option = document.createElement('option');
            option.value = dataset.id;
            option.textContent = dataset.name;
            optgroup.appendChild(option);
        });
        filter.appendChild(optgroup);
    }
    
    // Restaurar valor seleccionado
    filter.value = currentValue;
}

// Mostrar grupo de datasets
function displayDatasetGroup(group) {
    const container = document.getElementById('datasetsContainer');
    
    const groupDiv = document.createElement('div');
    groupDiv.className = 'dataset-group';
    groupDiv.setAttribute('data-group-id', group.original.id);
    
    // Header del grupo
    const header = document.createElement('div');
    header.className = 'dataset-group-header';
    header.innerHTML = `
        <h3 class="dataset-group-title">
            <i class="bi bi-folder2-open"></i> ${group.original.name}
            <span class="badge bg-primary ms-2">${group.normalized.length} normalizaciones</span>
        </h3>
        <div>
            <span class="text-muted small">
                <i class="bi bi-calendar3"></i> ${new Date(group.original.uploaded_at).toLocaleDateString('fr-FR')}
            </span>
        </div>
    `;
    
    // Contenedor de tarjetas
    const cardsContainer = document.createElement('div');
    cardsContainer.className = 'dataset-cards-container';
    
    // Tarjeta original
    const originalCard = createDatasetCard(group.original, 'original');
    cardsContainer.appendChild(originalCard);
    
    // Flecha separadora si hay normalizaciones
    if (group.normalized.length > 0) {
        const arrow = document.createElement('div');
        arrow.className = 'normalization-arrow';
        arrow.innerHTML = '<i class="bi bi-arrow-right-circle"></i>';
        cardsContainer.appendChild(arrow);
    }
    
    // Tarjetas normalizadas
    group.normalized.forEach(dataset => {
        const normalizedCard = createDatasetCard(dataset, 'normalized');
        cardsContainer.appendChild(normalizedCard);
    });
    
    groupDiv.appendChild(header);
    groupDiv.appendChild(cardsContainer);
    container.appendChild(groupDiv);
}

// Mostrar grupo de datasets huérfanos
function displayOrphanGroup(rootId, orphans) {
    const container = document.getElementById('datasetsContainer');
    
    const groupDiv = document.createElement('div');
    groupDiv.className = 'dataset-group';
    groupDiv.setAttribute('data-group-id', `orphan-${rootId}`);
    
    // Obtener el nombre del dataset original del primer huérfano
    const originalName = orphans[0].parent_dataset_name || 'Dataset eliminado';
    
    const header = document.createElement('div');
    header.className = 'dataset-group-header';
    header.innerHTML = `
        <h3 class="dataset-group-title">
            <i class="bi bi-folder2-open"></i> ${originalName}
            <span class="badge bg-warning ms-2">Original eliminado</span>
            <span class="badge bg-primary ms-2">${orphans.length} normalizaciones</span>
        </h3>
    `;
    
    const cardsContainer = document.createElement('div');
    cardsContainer.className = 'dataset-cards-container';
    
    // Mostrar todos los datasets huérfanos del grupo
    orphans.forEach(dataset => {
        const card = createDatasetCard(dataset, 'normalized');
        cardsContainer.appendChild(card);
    });
    
    groupDiv.appendChild(header);
    groupDiv.appendChild(cardsContainer);
    container.appendChild(groupDiv);
}

// Mostrar dataset huérfano individual
function displayOrphanDataset(dataset) {
    const container = document.getElementById('datasetsContainer');
    
    const groupDiv = document.createElement('div');
    groupDiv.className = 'dataset-group';
    groupDiv.setAttribute('data-dataset-id', dataset.id);
    
    const header = document.createElement('div');
    header.className = 'dataset-group-header';
    const parentName = dataset.parent_dataset_name || 'Dataset eliminado';
    header.innerHTML = `
        <h3 class="dataset-group-title">
            <i class="bi bi-file-earmark-question"></i> ${parentName}
            <span class="badge bg-warning ms-2">Original eliminado</span>
        </h3>
    `;
    
    const cardsContainer = document.createElement('div');
    cardsContainer.className = 'dataset-cards-container';
    
    const card = createDatasetCard(dataset, 'normalized');
    cardsContainer.appendChild(card);
    
    groupDiv.appendChild(header);
    groupDiv.appendChild(cardsContainer);
    container.appendChild(groupDiv);
}

// Crear tarjeta de dataset
function createDatasetCard(dataset, type = 'original') {
    const card = document.createElement('div');
    card.className = `card dataset-card ${type} h-100`;
    card.setAttribute('data-dataset-id', dataset.id);
    
    const size = dataset.file_size ? (dataset.file_size / 1024 / 1024).toFixed(2) : '0';
    
    // Crear el contenedor de acciones rápidas
    const quickActions = document.createElement('div');
    quickActions.className = 'quick-actions';
        
    // Botón Normalizar
    const btnNormalize = document.createElement('button');
    btnNormalize.type = 'button';
    btnNormalize.className = 'action-btn';
    btnNormalize.setAttribute('data-action', 'normalize');
    btnNormalize.setAttribute('data-dataset-id', dataset.id);
    btnNormalize.title = 'Normalizar';
    btnNormalize.innerHTML = '<i class="bi bi-sliders"></i>';
    
    // Botón Descargar
    const btnDownload = document.createElement('button');
    btnDownload.type = 'button';
    btnDownload.className = 'action-btn';
    btnDownload.setAttribute('data-action', 'download');
    btnDownload.setAttribute('data-dataset-id', dataset.id);
    btnDownload.title = 'Descargar';
    btnDownload.innerHTML = '<i class="bi bi-download"></i>';
    
    // Botón Eliminar
    const btnDelete = document.createElement('button');
    btnDelete.type = 'button';
    btnDelete.className = 'action-btn';
    btnDelete.setAttribute('data-action', 'delete');
    btnDelete.setAttribute('data-dataset-id', dataset.id);
    btnDelete.title = 'Eliminar';
    btnDelete.innerHTML = '<i class="bi bi-trash"></i>';
    
    quickActions.appendChild(btnNormalize);
    quickActions.appendChild(btnDownload);
    quickActions.appendChild(btnDelete);
    
    // Crear el cuerpo de la tarjeta
    const cardBody = document.createElement('div');
    cardBody.className = 'card-body';
    // Determinar si es un dataset normalizado
    const isNormalized = dataset.is_normalized || dataset.name.includes('_normalizacion_');
    
    cardBody.innerHTML = `
        <div class="dataset-icon">
            <i class="bi ${isNormalized ? 'bi-sliders' : 'bi-file-earmark-spreadsheet'}"></i>
        </div>
        <h5 class="card-title text-center mb-1" style="font-weight: 600; font-size: 1.1rem; min-height: 35px; display: flex; align-items: center; justify-content: center;">
            ${dataset.name}
        </h5>
        ${dataset.is_normalized && dataset.parent_dataset_name ? `
            <p class="text-center small mb-1" style="color: #00d4ff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                <i class="bi bi-arrow-return-right"></i> Desde: <strong>${dataset.parent_dataset_name}</strong>
            </p>
        ` : '<div style="height: 20px;"></div>'}
        <p class="text-muted small text-center mb-2" style="font-size: 0.85rem; opacity: 0.8; line-height: 1.3;">
            ${dataset.short_description || dataset.display_description || 'Dataset météorologique'}
        </p>
        <div class="dataset-stats">
            <div class="stat-item">
                <div class="stat-value">${(dataset.row_count || 0).toLocaleString('fr-FR')}</div>
                <div class="text-muted small">Lignes</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">${dataset.column_count || 0}</div>
                <div class="text-muted small">Colonnes</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">${size}</div>
                <div class="text-muted small">MB</div>
            </div>
        </div>
        <div class="text-center mt-auto pt-2" style="border-top: 1px solid rgba(0, 212, 255, 0.2); color: #00d4ff; font-size: 0.8rem;">
            <i class="bi bi-clock"></i> 
            ${dataset.uploaded_at ? `${new Date(dataset.uploaded_at).toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric' 
            })} à ${new Date(dataset.uploaded_at).toLocaleTimeString('fr-FR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            })}` : 'Date inconnue'}
        </div>
    `;
    
    // Ensamblar la tarjeta
    card.appendChild(quickActions);
    card.appendChild(cardBody);
    
    // Agregar eventos directamente a la tarjeta
    card.addEventListener('click', function(e) {
        // Solo procesar clic si no es en un botón
        if (!e.target.closest('.action-btn')) {
            showDatasetDetails(dataset.id);
        }
    });
    
    card.addEventListener('mouseenter', function() {
        this.classList.add('hover');
    });
    
    card.addEventListener('mouseleave', function() {
        this.classList.remove('hover');
    });
    
    // Eventos para los botones
    btnNormalize.addEventListener('click', function(e) {
        e.stopPropagation();
        normalizeDataset(dataset.id);
    });
    
    btnDownload.addEventListener('click', function(e) {
        e.stopPropagation();
        downloadDataset(dataset.id);
    });
    
    btnDelete.addEventListener('click', function(e) {
        e.stopPropagation();
        deleteDataset(dataset.id);
    });
    
    return card;
}

// Filtrar datasets
function filterDatasets() {
    const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
    const parentFilter = document.getElementById('parentFilter').value;
    const sortBy = document.getElementById('sortFilter').value;
    
    // Obtener todos los grupos
    const groups = document.querySelectorAll('.dataset-group');
    
    groups.forEach(group => {
        let shouldShowGroup = false;
        const cards = group.querySelectorAll('.dataset-card');
        
        cards.forEach(card => {
            const datasetId = card.getAttribute('data-dataset-id');
            const dataset = datasets.find(d => d.id == datasetId);
            
            if (!dataset) return;
            
            let shouldShow = true;
            
            // Filtro por nombre
            if (searchTerm && !dataset.name.toLowerCase().includes(searchTerm)) {
                shouldShow = false;
            }
            
            // Filtro por tipo
            if (parentFilter === 'original' && dataset.is_normalized) {
                shouldShow = false;
            } else if (parentFilter === 'normalized' && !dataset.is_normalized) {
                shouldShow = false;
            } else if (parentFilter && parentFilter !== 'original' && parentFilter !== 'normalized') {
                // Filtro por dataset original específico
                if (!dataset.parent_dataset || dataset.parent_dataset != parentFilter) {
                    shouldShow = false;
                }
            }
            
            card.style.display = shouldShow ? '' : 'none';
            if (shouldShow) shouldShowGroup = true;
        });
        
        group.style.display = shouldShowGroup ? '' : 'none';
    });
    
    // Reordenar si es necesario
    if (sortBy !== 'name') {
        sortDatasets(sortBy);
    }
}

// Ordenar datasets
function sortDatasets(sortBy) {
    const container = document.getElementById('datasetsContainer');
    const groups = Array.from(container.querySelectorAll('.dataset-group'));
    
    groups.sort((a, b) => {
        const aId = a.getAttribute('data-group-id') || a.getAttribute('data-dataset-id');
        const bId = b.getAttribute('data-group-id') || b.getAttribute('data-dataset-id');
        
        const aDataset = datasets.find(d => d.id == aId);
        const bDataset = datasets.find(d => d.id == bId);
        
        if (!aDataset || !bDataset) return 0;
        
        switch(sortBy) {
            case 'date':
                return new Date(bDataset.uploaded_at) - new Date(aDataset.uploaded_at);
            case 'size':
                return (bDataset.file_size || 0) - (aDataset.file_size || 0);
            default:
                return aDataset.name.localeCompare(bDataset.name);
        }
    });
    
    // Reordenar en el DOM
    groups.forEach(group => container.appendChild(group));
}

// Función para truncar la descripción
function truncateDescription(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

// Actualizar contador de caracteres
function updateCharCount() {
    const input = document.getElementById('datasetShortDescription');
    const charCount = document.getElementById('charCount');
    if (input && charCount) {
        const current = input.value.length;
        charCount.textContent = `(${current}/80)`;
        charCount.style.color = current >= 80 ? '#ff6b6b' : '#6c757d';
    }
}

// Función vacía ya que los eventos se agregan directamente en displayDatasets
function setupDatasetCardListeners() {
    // Los eventos ya se agregan directamente al crear las tarjetas
}

// Afficher les détails d'un dataset
function showDatasetDetails(datasetId) {
    selectedDataset = datasets.find(d => d.id === datasetId);
    window.selectedDataset = selectedDataset;  // Hacer accesible globalmente
    if (!selectedDataset) return;
    
    // Fermer tous les modals ouverts d'abord
    document.querySelectorAll('.modal.show').forEach(modalEl => {
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) {
            modalInstance.hide();
        }
    });
    
    // Attendre un peu pour que Bootstrap nettoie
    setTimeout(() => {
        // Limpiar cualquier modal o backdrop previo
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('overflow');
        document.body.style.removeProperty('padding-right');
        
        // Asegurar que no haya loading activo
        hideLoading();
        
        const modalElement = document.getElementById('datasetDetailModal');
        // Verificar si ya existe una instancia
        let modal = bootstrap.Modal.getInstance(modalElement);
        if (!modal) {
            modal = new bootstrap.Modal(modalElement, {
                backdrop: false,  // Sin backdrop
                keyboard: true
            });
        }
        
        document.getElementById('datasetDetailTitle').innerHTML = `
            <i class="bi bi-database"></i> ${selectedDataset.name}
        `;
        
        // Mostrar loading en el contenido
        document.getElementById('datasetDetailContent').innerHTML = `
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Cargando análisis del dataset...</p>
            </div>
        `;
        
        // Mostrar el modal
        modal.show();
        
        // Cargar los datos del dataset
        fetch(`/api/datasets/${datasetId}/columns/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                displayDatasetDetails(selectedDataset, data);
            })
            .catch(error => {
                console.error('Error completo:', error);
                document.getElementById('datasetDetailContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error al cargar los detalles del dataset
                        <br><small>${error.message}</small>
                    </div>
                `;
            });
    }, 100);
}

// Mostrar análisis completo del dataset
function displayDatasetDetails(dataset, data) {
    const shape = data.shape || [0, 0];
    const rows = shape[0];
    const cols = shape[1];
    const stats = data.stats || {};
    const preview = data.preview || {};
    const columns = data.columns || [];
    const memoryUsage = data.memory_usage ? 
        (typeof data.memory_usage === 'object' ? data.memory_usage.total_mb : data.memory_usage).toFixed(2) : '0';
    const totalNulls = data.total_null_count || 0;
    
    // Guardar datos en variable global para uso posterior
    window.currentDatasetData = data;
    window.selectedDataset = dataset;  // Asegurar que el dataset esté disponible globalmente
    
    // Reset analysis data for new dataset
    analysisCount = 1;
    analysisCharts = {};
    analysisData = {};
    
    // Información de descripciones
    let descriptionsSection = `
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card bg-dark border-info">
                    <div class="card-body">
                        <h5 class="text-info mb-3"><i class="bi bi-info-circle"></i> Información del Dataset</h5>
                        ${dataset.short_description || dataset.display_description ? `
                            <div class="mb-2">
                                <strong class="text-muted">Descripción corta:</strong>
                                <p class="mb-0">${dataset.short_description || dataset.display_description || 'Sin descripción'}</p>
                            </div>
                        ` : ''}
                        ${dataset.long_description ? `
                            <div class="mb-2">
                                <strong class="text-muted">Descripción detallada:</strong>
                                <p class="mb-0">${dataset.long_description}</p>
                            </div>
                        ` : ''}
                        ${dataset.is_normalized && dataset.parent_dataset_name ? `
                            <div class="mb-2">
                                <strong class="text-muted">Dataset padre directo:</strong>
                                <p class="mb-0">${dataset.parent_dataset_name}</p>
                            </div>
                        ` : ''}
                        ${dataset.is_normalized && dataset.genealogy && dataset.genealogy.length > 0 ? `
                            <div class="mb-2">
                                <strong class="text-muted">Árbol genealógico completo:</strong>
                                <div class="genealogy-tree mt-2">
                                    ${dataset.genealogy.map((ancestor, index) => `
                                        <div class="genealogy-item" style="margin-left: ${index * 20}px;">
                                            <i class="bi bi-arrow-return-right text-info"></i>
                                            <span class="${!ancestor.exists ? 'text-warning' : ''}">${ancestor.name}</span>
                                            ${!ancestor.exists ? '<span class="badge bg-warning ms-2">Eliminado</span>' : ''}
                                        </div>
                                    `).join('')}
                                    <div class="genealogy-item" style="margin-left: ${dataset.genealogy.length * 20}px;">
                                        <i class="bi bi-arrow-return-right text-success"></i>
                                        <strong>${dataset.name}</strong> <span class="badge bg-success ms-2">Actual</span>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        <div>
                            <strong class="text-muted">Fecha de creación:</strong>
                            <p class="mb-0">${new Date(dataset.uploaded_at).toLocaleString('es-ES')}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Preview de datos
    let dataPreview = `
        <div class="row mb-4">
            <div class="col-md-12">
                <h5 class="text-primary mb-3"><i class="bi bi-eye"></i> Vista Previa de Datos (Primeras 10 filas)</h5>
                <div class="table-responsive" style="max-height: 300px; overflow: auto;">
                    <table class="table table-sm table-striped table-hover">
                        <thead class="table-dark sticky-top">
                            <tr>
                                ${columns.map(col => `<th class="text-nowrap">${col}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    // Generar filas del preview
    for (let i = 0; i < 10 && i < rows; i++) {
        dataPreview += '<tr>';
        columns.forEach(col => {
            const value = preview[col] && preview[col][i] !== undefined ? preview[col][i] : '';
            dataPreview += `<td class="text-nowrap">${value}</td>`;
        });
        dataPreview += '</tr>';
    }
    
    dataPreview += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Selector de variable y generador de histograma
    let variableSelector = `
        <div class="row mb-4">
            <div class="col-md-12">
                <h5 class="text-primary mb-3"><i class="bi bi-bar-chart-line"></i> Analyse de Distribution</h5>
                <div id="analysisContainer">
                    <div class="card bg-dark border-primary mb-3 analysis-card" data-analysis-id="1">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <label for="variableSelect1" class="form-label text-info">Sélectionner Variable:</label>
                                    <select class="form-select variable-select" id="variableSelect1" data-analysis-id="1" onchange="updateAnalysisButton(1)">
                                        <option value="">-- Sélectionnez une variable --</option>
                                        ${columns.map(col => {
                                            const colStats = stats[col] || {};
                                            const dtype = colStats.dtype || 'unknown';
                                            const isNumeric = colStats.mean !== undefined;
                                            
                                            let typeLabel = dtype;
                                            if (dtype.includes('int') || dtype.includes('float')) {
                                                typeLabel = '📊 Numérique';
                                            } else if (dtype.includes('datetime')) {
                                                typeLabel = '📅 Date/Heure';
                                            } else if (dtype.includes('numeric (stored as text)')) {
                                                typeLabel = '🔢 Numérique (texte)';
                                            } else if (dtype.includes('object')) {
                                                typeLabel = '📝 Texte';
                                            }
                                            
                                            return `<option value="${col}" data-numeric="${isNumeric}" data-dtype="${dtype}">${col} - ${typeLabel}</option>`;
                                        }).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <select class="form-select" id="analysisType1" onchange="updateAnalysisButton(1)">
                                        <option value="histogram">Histogramme</option>
                                        <option value="outlier_map" class="numeric-only">Carte des Outliers</option>
                                        <option value="boxplot" class="numeric-only">Box Plot</option>
                                        <option value="scatter" class="numeric-only">Scatter Plot (2 variables)</option>
                                        <option value="lasso" class="numeric-only">LASSO (Sélection de variables)</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="includeOutliers1" checked onchange="handleOutliersChange(1)">
                                        <label class="form-check-label text-info" for="includeOutliers1">
                                            Inclure outliers
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-primary w-100" id="analysisButton1" onclick="executeAnalysis(1)">
                                        <i class="bi bi-graph-up"></i> Générer
                                    </button>
                                </div>
                            </div>
                            <div class="row mt-2" id="histogramConfig1" style="display: none;">
                                <div class="col-md-4">
                                    <label for="numBins1" class="form-label text-info small">Nombre d'intervalles:</label>
                                    <input type="number" class="form-control form-control-sm" id="numBins1" value="20" min="5" max="50" onchange="updateHistogramBins(1)">
                                </div>
                                <div class="col-md-4">
                                    <label for="binMin1" class="form-label text-info small">Valeur minimale:</label>
                                    <input type="number" class="form-control form-control-sm" id="binMin1" step="any" onchange="updateHistogramBins(1)">
                                </div>
                                <div class="col-md-4">
                                    <label for="binMax1" class="form-label text-info small">Valeur maximale:</label>
                                    <input type="number" class="form-control form-control-sm" id="binMax1" step="any" onchange="updateHistogramBins(1)">
                                </div>
                            </div>
                            <div class="mt-4" id="histogramContainer1" style="display: none;">
                                <canvas id="variableHistogram1" height="400"></canvas>
                            </div>
                            <div class="mt-3" id="variableStats1" style="display: none;">
                                <!-- Les statistiques de la variable sélectionnée apparaîtront ici -->
                            </div>
                            <div class="mt-3" id="analysisResultContainer1">
                                <!-- Les résultats des analyses avancées apparaîtront ici -->
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success btn-lg w-100" onclick="addNewAnalysis()">
                    <i class="bi bi-plus-circle"></i> Ajouter une autre analyse de variable
                </button>
            </div>
        </div>
        
        <!-- Análisis Generales del Dataset -->
        <div class="row mb-4">
            <div class="col-md-12">
                <h5 class="text-primary mb-3"><i class="bi bi-diagram-3"></i> Analyses Générales du Dataset</h5>
                <div class="btn-group d-flex flex-wrap mb-3" role="group">
                    <button class="btn btn-outline-info" onclick="generateGeneralAnalysis('correlation')">
                        <i class="bi bi-grid-3x3"></i> Matrice de Corrélation
                    </button>
                    <button class="btn btn-outline-warning" onclick="generateGeneralAnalysis('pca')">
                        <i class="bi bi-arrows-angle-contract"></i> Analyse PCA
                    </button>
                </div>
                <div id="generalAnalysisContainer">
                    <!-- Les analyses générales apparaîtront ici -->
                </div>
            </div>
        </div>
    `;
    
    // Info general compacta
    let generalInfo = `
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3">
                            <i class="bi bi-table text-primary" style="font-size: 1.5rem;"></i>
                            <h6 class="mt-2 mb-0">${rows.toLocaleString()} × ${cols}</h6>
                            <small class="text-muted">Dimensiones</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3">
                            <i class="bi bi-hdd text-success" style="font-size: 1.5rem;"></i>
                            <h6 class="mt-2 mb-0">${memoryUsage} MB</h6>
                            <small class="text-muted">Memoria</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3">
                            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 1.5rem;"></i>
                            <h6 class="mt-2 mb-0">${totalNulls.toLocaleString()}</h6>
                            <small class="text-muted">Valores Nulos</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3">
                            <i class="bi bi-percent text-info" style="font-size: 1.5rem;"></i>
                            <h6 class="mt-2 mb-0">${rows > 0 ? ((totalNulls / (rows * cols)) * 100).toFixed(2) : '0'}%</h6>
                            <small class="text-muted">Faltantes</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Análisis detallado (simplificado)
    let detailedAnalysis = `
        <div class="row mb-4">
            <div class="col-md-12">
                <h5 class="text-primary mb-3"><i class="bi bi-list-columns-reverse"></i> Información de Variables</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Variable</th>
                                <th>Tipo Python</th>
                                <th>Valores Únicos</th>
                                <th>Nulos</th>
                                <th>% Nulos</th>
                                <th>Estadísticas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${columns.map(col => {
                                const colStats = stats[col] || {};
                                const dtype = colStats.dtype || 'unknown';
                                const isNumeric = colStats.mean !== undefined;
                                
                                // Determinar el color y el icono según el tipo
                                let badgeClass = 'secondary';
                                let typeIcon = 'bi-question-circle';
                                let displayType = dtype;
                                let pythonType = 'object';
                                
                                if (dtype.includes('int64')) {
                                    badgeClass = 'success';
                                    typeIcon = 'bi-123';
                                    displayType = 'Numérico';
                                    pythonType = 'int';
                                } else if (dtype.includes('float64')) {
                                    badgeClass = 'success';
                                    typeIcon = 'bi-123';
                                    displayType = 'Numérico';
                                    pythonType = 'float';
                                } else if (dtype.includes('datetime')) {
                                    badgeClass = 'warning';
                                    typeIcon = 'bi-calendar-date';
                                    displayType = 'Fecha/Hora';
                                    pythonType = 'datetime';
                                } else if (dtype.includes('numeric (stored as text)')) {
                                    badgeClass = 'primary';
                                    typeIcon = 'bi-hash';
                                    displayType = 'Numérico (como texto)';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (URL)')) {
                                    badgeClass = 'info';
                                    typeIcon = 'bi-link-45deg';
                                    displayType = 'URL';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (Email)')) {
                                    badgeClass = 'info';
                                    typeIcon = 'bi-envelope';
                                    displayType = 'Email';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (ID/Code)')) {
                                    badgeClass = 'secondary';
                                    typeIcon = 'bi-upc';
                                    displayType = 'ID/Código';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (Boolean text)')) {
                                    badgeClass = 'danger';
                                    typeIcon = 'bi-toggle-on';
                                    displayType = 'Booleano (texto)';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (str)')) {
                                    badgeClass = 'info';
                                    typeIcon = 'bi-fonts';
                                    displayType = 'Texto';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (')) {
                                    // Extraer el tipo específico del paréntesis
                                    const match = dtype.match(/object \(([^)]+)\)/);
                                    badgeClass = 'info';
                                    typeIcon = 'bi-box';
                                    displayType = match ? match[1] : 'Objeto';
                                    pythonType = 'object';
                                } else if (dtype.includes('object')) {
                                    badgeClass = 'info';
                                    typeIcon = 'bi-fonts';
                                    displayType = 'Texto';
                                    pythonType = 'str';
                                } else if (dtype.includes('bool')) {
                                    badgeClass = 'danger';
                                    typeIcon = 'bi-toggle-on';
                                    displayType = 'Booleano';
                                    pythonType = 'bool';
                                }
                                
                                return `
                                    <tr class="column-row" data-column="${col}" onclick="selectVariable('${col}', ${isNumeric})">
                                        <td><strong>${col}</strong></td>
                                        <td>
                                            <span class="badge bg-${badgeClass}">
                                                <i class="bi ${typeIcon}"></i> ${pythonType}
                                            </span>
                                            <small class="text-muted d-block">${displayType}</small>
                                        </td>
                                        <td>${colStats.unique_count || 0}</td>
                                        <td>${colStats.null_count || 0}</td>
                                        <td>${colStats.null_percentage ? colStats.null_percentage.toFixed(1) : '0'}%</td>
                                        <td>
                                            ${isNumeric ? 
                                                `<small>
                                                    μ=${colStats.mean?.toFixed(2) || 'N/A'}, σ=${colStats.std?.toFixed(2) || 'N/A'}
                                                    ${colStats.decimals_info ? `<br>Decimales: ${colStats.decimals_info.most_common_decimals || 0}` : ''}
                                                    ${colStats.magnitude_info ? `<br>Magnitud: 10<sup>${colStats.magnitude_info.avg_magnitude}</sup>` : ''}
                                                </small>` : 
                                                `<small>${colStats.unique_count} valores únicos</small>`
                                            }
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); showUniqueValues('${col}')" title="Ver valores únicos">
                                                <i class="bi bi-list-ul"></i>
                                            </button>
                                            ${isNumeric ? `
                                                <button class="btn btn-sm btn-outline-warning ms-1" onclick="event.stopPropagation(); showOutliers('${col}')" title="Ver outliers">
                                                    <i class="bi bi-exclamation-triangle"></i>
                                                </button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Combinar todo
    document.getElementById('datasetDetailContent').innerHTML = 
        descriptionsSection + dataPreview + variableSelector + generalInfo + detailedAnalysis;
    
    // Actualizar el botón de análisis para la primera variable
    setTimeout(() => {
        updateAnalysisButton(1);
    }, 100);
}

// Generar gráficos del dataset
function generateDatasetCharts(columns, stats) {
    // Destruir gráficos existentes
    Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
    });
    charts = {};
    
    // Gráfico de tipos de datos
    const dataTypes = {};
    columns.forEach(col => {
        const dtype = stats[col]?.dtype || 'unknown';
        const type = dtype.includes('float') || dtype.includes('int') ? 'Numérico' : 
                     dtype.includes('object') ? 'Texto' : 
                     dtype.includes('datetime') ? 'Fecha' : 'Otro';
        dataTypes[type] = (dataTypes[type] || 0) + 1;
    });
    
    const ctx1 = document.getElementById('dataTypesChart');
    if (ctx1) {
        charts.dataTypes = new Chart(ctx1, {
            type: 'pie',
            data: {
                labels: Object.keys(dataTypes),
                datasets: [{
                    data: Object.values(dataTypes),
                    backgroundColor: ['#10b981', '#3b82f6', '#a855f7', '#f59e0b']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#f0f9ff' }
                    }
                }
            }
        });
    }
    
    // Gráfico de datos faltantes
    const nullData = columns.map(col => stats[col]?.null_percentage || 0);
    const ctx2 = document.getElementById('missingDataChart');
    if (ctx2) {
        charts.missingData = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: columns,
                datasets: [{
                    label: 'Porcentaje de valores nulos',
                    data: nullData,
                    backgroundColor: 'rgba(239, 68, 68, 0.5)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { color: '#f0f9ff' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    x: {
                        ticks: { 
                            color: '#f0f9ff',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
    
    // Gráficos individuales por columna
    columns.forEach((col, index) => {
        const colStats = stats[col];
        if (!colStats) return;
        
        const canvasId = `chart_${index}_${col.replace(/[^a-zA-Z0-9]/g, '_')}`;
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        
        if (colStats.histogram) {
            // Histograma para datos numéricos
            const bins = colStats.histogram.bins;
            const counts = colStats.histogram.counts;
            const labels = [];
            for (let i = 0; i < bins.length - 1; i++) {
                labels.push(`${bins[i].toFixed(1)}-${bins[i+1].toFixed(1)}`);
            }
            
            charts[canvasId] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frecuencia',
                        data: counts,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#f0f9ff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#f0f9ff',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        } else if (colStats.top_values) {
            // Gráfico de barras para datos categóricos
            charts[canvasId] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: colStats.top_values.values,
                    datasets: [{
                        label: 'Frecuencia',
                        data: colStats.top_values.counts,
                        backgroundColor: 'rgba(16, 185, 129, 0.5)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#f0f9ff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#f0f9ff',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    });
}

// Generar histograma para variable seleccionada
// Function to add new analysis section
function addNewAnalysis() {
    analysisCount++;
    const data = window.currentDatasetData;
    const columns = data.columns || [];
    const stats = data.stats || {};
    
    const newAnalysisHTML = `
        <div class="card bg-dark border-primary mb-3 analysis-card" data-analysis-id="${analysisCount}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="text-info mb-0">Analyse ${analysisCount}</h6>
                    <button class="btn btn-sm btn-danger" onclick="removeAnalysis(${analysisCount})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <label for="variableSelect${analysisCount}" class="form-label text-info">Sélectionner Variable:</label>
                        <select class="form-select variable-select" id="variableSelect${analysisCount}" data-analysis-id="${analysisCount}" onchange="updateAnalysisButton(${analysisCount})">
                            <option value="">-- Sélectionnez une variable --</option>
                            ${columns.map(col => {
                                const colStats = stats[col] || {};
                                const dtype = colStats.dtype || 'unknown';
                                const isNumeric = colStats.mean !== undefined;
                                
                                let typeLabel = dtype;
                                if (dtype.includes('int') || dtype.includes('float')) {
                                    typeLabel = '📊 Numérique';
                                } else if (dtype.includes('datetime')) {
                                    typeLabel = '📅 Date/Heure';
                                } else if (dtype.includes('numeric (stored as text)')) {
                                    typeLabel = '🔢 Numérique (texte)';
                                } else if (dtype.includes('object')) {
                                    typeLabel = '📝 Texte';
                                }
                                
                                return `<option value="${col}" data-numeric="${isNumeric}" data-dtype="${dtype}">${col} - ${typeLabel}</option>`;
                            }).join('')}
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <select class="form-select" id="analysisType${analysisCount}" onchange="updateAnalysisButton(${analysisCount})">
                            <option value="histogram">Histogramme</option>
                            <option value="outlier_map" class="numeric-only">Carte des Outliers</option>
                            <option value="boxplot" class="numeric-only">Box Plot</option>
                            <option value="scatter" class="numeric-only">Scatter Plot (2 variables)</option>
                            <option value="lasso" class="numeric-only">LASSO (Sélection de variables)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="includeOutliers${analysisCount}" checked onchange="handleOutliersChange(${analysisCount})">
                            <label class="form-check-label text-info" for="includeOutliers${analysisCount}">
                                Inclure outliers
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" id="analysisButton${analysisCount}" onclick="executeAnalysis(${analysisCount})">
                            <i class="bi bi-graph-up"></i> Générer
                        </button>
                    </div>
                </div>
                <div class="row mt-2" id="histogramConfig${analysisCount}" style="display: none;">
                    <div class="col-md-4">
                        <label for="numBins${analysisCount}" class="form-label text-info small">Nombre d'intervalles:</label>
                        <input type="number" class="form-control form-control-sm" id="numBins${analysisCount}" value="20" min="5" max="50" onchange="updateHistogramBins(${analysisCount})">
                    </div>
                    <div class="col-md-4">
                        <label for="binMin${analysisCount}" class="form-label text-info small">Valeur minimale:</label>
                        <input type="number" class="form-control form-control-sm" id="binMin${analysisCount}" step="any" onchange="updateHistogramBins(${analysisCount})">
                    </div>
                    <div class="col-md-4">
                        <label for="binMax${analysisCount}" class="form-label text-info small">Valeur maximale:</label>
                        <input type="number" class="form-control form-control-sm" id="binMax${analysisCount}" step="any" onchange="updateHistogramBins(${analysisCount})">
                    </div>
                </div>
                <div class="mt-4" id="histogramContainer${analysisCount}" style="display: none;">
                    <canvas id="variableHistogram${analysisCount}" height="400"></canvas>
                </div>
                <div class="mt-3" id="variableStats${analysisCount}" style="display: none;">
                    <!-- Les statistiques de la variable sélectionnée apparaîtront ici -->
                </div>
                <div class="mt-3" id="analysisResultContainer${analysisCount}">
                    <!-- Les résultats des analyses avancées apparaîtront ici -->
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('analysisContainer').insertAdjacentHTML('beforeend', newAnalysisHTML);
}

// Function to remove an analysis
function removeAnalysis(analysisId) {
    const analysisCard = document.querySelector(`[data-analysis-id="${analysisId}"]`);
    if (analysisCard) {
        // Destroy chart if exists
        if (analysisCharts[analysisId]) {
            analysisCharts[analysisId].destroy();
            delete analysisCharts[analysisId];
        }
        // Remove data
        delete analysisData[analysisId];
        // Remove DOM element
        analysisCard.remove();
    }
}

// Nueva función para actualizar el botón según el tipo de análisis
function updateAnalysisButton(analysisId) {
    const variableSelect = document.getElementById(`variableSelect${analysisId}`);
    const analysisTypeSelect = document.getElementById(`analysisType${analysisId}`);
    const selectedOption = variableSelect.options[variableSelect.selectedIndex];
    const isNumeric = selectedOption && selectedOption.getAttribute('data-numeric') === 'true';
    
    // Mostrar/ocultar opciones según el tipo de variable
    const numericOptions = analysisTypeSelect.querySelectorAll('.numeric-only');
    numericOptions.forEach(option => {
        option.style.display = isNumeric ? 'block' : 'none';
    });
    
    // Si la opción seleccionada no es válida para el tipo de variable, cambiar a histograma
    const selectedAnalysis = analysisTypeSelect.value;
    if (!isNumeric && ['outlier_map', 'boxplot', 'scatter', 'lasso'].includes(selectedAnalysis)) {
        analysisTypeSelect.value = 'histogram';
    }
}

// Nueva función para ejecutar el análisis seleccionado
function handleOutliersChange(analysisId) {
    // Si ya hay un gráfico generado, regenerarlo con la nueva configuración
    const analysisType = document.getElementById(`analysisType${analysisId}`).value;
    const selectedVariable = document.getElementById(`variableSelect${analysisId}`).value;
    
    if (selectedVariable && analysisType === 'histogram') {
        generateHistogram(analysisId);
    }
}

// Función para actualizar el histograma cuando se cambian los bins
function updateHistogramBins(analysisId) {
    const analysisType = document.getElementById(`analysisType${analysisId}`).value;
    const selectedVariable = document.getElementById(`variableSelect${analysisId}`).value;
    
    if (selectedVariable && analysisType === 'histogram' && analysisCharts[analysisId]) {
        generateHistogram(analysisId);
    }
}

function executeAnalysis(analysisId) {
    const analysisType = document.getElementById(`analysisType${analysisId}`).value;
    
    switch(analysisType) {
        case 'histogram':
            generateHistogram(analysisId);
            break;
        case 'outlier_map':
        case 'boxplot':
        case 'scatter':
            generateAdvancedAnalysis(analysisId, analysisType);
            break;
        case 'lasso':
            generateLassoForVariable(analysisId);
            break;
        default:
            generateHistogram(analysisId);
    }
}

// Nueva función para generar análisis LASSO con variable objetivo específica
async function generateLassoForVariable(analysisId) {
    const select = document.getElementById(`variableSelect${analysisId}`);
    const targetVariable = select.value;
    
    if (!targetVariable) {
        showNotification('Erreur', 'Veuillez sélectionner une variable cible', 'warning');
        return;
    }
    
    const currentDataset = window.selectedDataset;
    if (!currentDataset || !currentDataset.id) {
        showNotification('Erreur', 'Aucun dataset sélectionné', 'error');
        return;
    }
    
    try {
        const url = `/api/datasets/${currentDataset.id}/analysis/?type=lasso&target=${encodeURIComponent(targetVariable)}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Erreur lors de la génération de l\'analyse LASSO');
        }
        
        // Mostrar el análisis LASSO
        displayLassoAnalysisForVariable(analysisId, data);
        
    } catch (error) {
        showNotification('Erreur', error.message, 'error');
    }
}

// Función para mostrar el análisis LASSO para una variable
function displayLassoAnalysisForVariable(analysisId, data) {
    const container = document.getElementById(`analysisResultContainer${analysisId}`);
    if (!container) return;
    
    let content = `
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <h6 class="mb-0 text-info">
                    <i class="bi bi-funnel"></i> 
                    LASSO - Prédire ${data.target_column}
                </h6>
            </div>
            <div class="card-body">
                <img src="${data.image}" class="img-fluid" alt="lasso">
                <div class="mt-3">
                    <div class="alert alert-info">
                        <strong>Variable cible:</strong> ${data.target_column}
                        <br>
                        <strong>Meilleur Alpha:</strong> ${data.statistics.best_alpha.toExponential(2)}
                        <br>
                        <strong>Score R²:</strong> ${data.statistics.best_score.toFixed(3)}
                        <br>
                        <strong>Variables sélectionnées:</strong> ${data.statistics.n_features_selected} sur ${data.statistics.total_features}
                    </div>
                    
                    <h6 class="text-info">Variables Importantes pour prédire ${data.target_column}:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Variable</th>
                                    <th>Coefficient</th>
                                    <th>Impact</th>
                                </tr>
                            </thead>
                            <tbody>
    `;
    
    data.statistics.selected_features.forEach(([feature, coef]) => {
        const color = coef > 0 ? 'text-success' : 'text-danger';
        const impact = Math.abs(coef) > 0.5 ? 'Fort' : (Math.abs(coef) > 0.1 ? 'Moyen' : 'Faible');
        content += `
            <tr>
                <td>${feature}</td>
                <td class="${color}">${coef.toFixed(4)}</td>
                <td>${impact}</td>
            </tr>
        `;
    });
    
    content += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = content;
}

function generateHistogram(analysisId) {
    const select = document.getElementById(`variableSelect${analysisId}`);
    const selectedVariable = select.value;
    const includeOutliers = document.getElementById(`includeOutliers${analysisId}`).checked;
    
    if (!selectedVariable) {
        showNotification('Erreur', 'Veuillez sélectionner une variable', 'warning');
        return;
    }
    
    const data = window.currentDatasetData;
    if (!data || !data.stats) {
        showNotification('Erreur', 'Aucune donnée disponible', 'error');
        return;
    }
    
    const colStats = data.stats[selectedVariable];
    const isNumeric = select.options[select.selectedIndex].getAttribute('data-numeric') === 'true';
    
    // Mostrar contenedor
    document.getElementById(`histogramContainer${analysisId}`).style.display = 'block';
    document.getElementById(`variableStats${analysisId}`).style.display = 'block';
    
    // Mostrar controles de configuración para histogramas numéricos
    if (isNumeric) {
        document.getElementById(`histogramConfig${analysisId}`).style.display = 'flex';
        // Establecer valores por defecto
        if (!document.getElementById(`binMin${analysisId}`).value && colStats.min !== undefined) {
            document.getElementById(`binMin${analysisId}`).value = colStats.min;
        }
        if (!document.getElementById(`binMax${analysisId}`).value && colStats.max !== undefined) {
            document.getElementById(`binMax${analysisId}`).value = colStats.max;
        }
    } else {
        document.getElementById(`histogramConfig${analysisId}`).style.display = 'none';
    }
    
    // Destruir gráfico anterior si existe
    if (analysisCharts[analysisId]) {
        analysisCharts[analysisId].destroy();
    }
    
    const canvas = document.getElementById(`variableHistogram${analysisId}`);
    const ctx = canvas.getContext('2d');
    
    if (isNumeric && colStats.histogram) {
        // Histograma para variables numéricas
        let bins, counts;
        
        // Usar los datos apropiados según el checkbox de outliers
        if (!includeOutliers && colStats.histogram.bins_no_outliers && colStats.histogram.outliers_info.outlier_count > 0) {
            // Usar histograma sin outliers
            bins = colStats.histogram.bins_no_outliers;
            counts = colStats.histogram.counts_no_outliers;
        } else {
            // Usar histograma completo
            bins = colStats.histogram.bins;
            counts = colStats.histogram.counts;
        }
        
        // Obtener configuración personalizada
        const numBins = parseInt(document.getElementById(`numBins${analysisId}`).value) || 20;
        const customMin = parseFloat(document.getElementById(`binMin${analysisId}`).value);
        const customMax = parseFloat(document.getElementById(`binMax${analysisId}`).value);
        
        // Recalcular bins si hay valores personalizados
        let labels = [];
        let adjustedCounts = counts;
        
        if (!isNaN(customMin) && !isNaN(customMax) && customMin < customMax) {
            // Crear nuevos bins basados en los valores personalizados
            const binWidth = (customMax - customMin) / numBins;
            const newBins = [];
            for (let i = 0; i <= numBins; i++) {
                newBins.push(customMin + i * binWidth);
            }
            
            // Recalcular los conteos para los nuevos bins
            adjustedCounts = new Array(numBins).fill(0);
            
            // Distribuir los datos originales en los nuevos bins
            for (let i = 0; i < bins.length - 1; i++) {
                const binStart = bins[i];
                const binEnd = bins[i + 1];
                const binCount = counts[i];
                
                // Encontrar en qué nuevos bins cae este rango
                for (let j = 0; j < newBins.length - 1; j++) {
                    const newBinStart = newBins[j];
                    const newBinEnd = newBins[j + 1];
                    
                    // Calcular la intersección
                    const overlapStart = Math.max(binStart, newBinStart);
                    const overlapEnd = Math.min(binEnd, newBinEnd);
                    
                    if (overlapStart < overlapEnd) {
                        // Hay intersección, distribuir proporcionalmente
                        const overlapRatio = (overlapEnd - overlapStart) / (binEnd - binStart);
                        adjustedCounts[j] += Math.round(binCount * overlapRatio);
                    }
                }
            }
            
            // Crear etiquetas con los nuevos bins
            for (let i = 0; i < newBins.length - 1; i++) {
                const decimals = binWidth < 1 ? 2 : (binWidth < 10 ? 1 : 0);
                labels.push(`${newBins[i].toFixed(decimals)} - ${newBins[i+1].toFixed(decimals)}`);
            }
        } else {
            // Usar bins originales
            for (let i = 0; i < bins.length - 1; i++) {
                labels.push(`${bins[i].toFixed(1)} - ${bins[i+1].toFixed(1)}`);
            }
        }
        
        analysisCharts[analysisId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: `Distribución de ${selectedVariable}`,
                    data: adjustedCounts,
                    backgroundColor: 'rgba(0, 212, 255, 0.5)',
                    borderColor: 'rgba(0, 212, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Histograma de ${selectedVariable}${!includeOutliers && colStats.histogram.outliers_info && colStats.histogram.outliers_info.outlier_count > 0 ? ' (sans outliers)' : ''}`,
                        color: '#00d4ff',
                        font: { size: 16 }
                    },
                    legend: { display: false }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Intervalos',
                            color: '#00d4ff'
                        },
                        ticks: { 
                            color: '#f0f9ff',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Frecuencia',
                            color: '#00d4ff'
                        },
                        beginAtZero: true,
                        ticks: { color: '#f0f9ff' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });
        
        // Mostrar información de outliers siempre si existe
        let outlierInfo = '';
        if (colStats.histogram && colStats.histogram.outliers_info && colStats.histogram.outliers_info.outlier_count > 0) {
            const info = colStats.histogram.outliers_info;
            if (!includeOutliers) {
                outlierInfo = `
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Outliers détectés et exclus:</strong> ${info.outlier_count} valeurs (${info.outlier_percentage.toFixed(1)}%) 
                        ont été exclues du graphique.<br>
                        <small>Valeurs en dehors de l'intervalle [${info.lower_bound.toFixed(2)}, ${info.upper_bound.toFixed(2)}]</small><br>
                        <small>IQR: ${info.iqr.toFixed(2)} (Q1: ${info.q1.toFixed(2)}, Q3: ${info.q3.toFixed(2)})</small>
                    </div>
                `;
            } else {
                outlierInfo = `
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>Outliers détectés:</strong> ${info.outlier_count} valeurs (${info.outlier_percentage.toFixed(1)}%) 
                        sont des outliers (inclus dans le graphique).<br>
                        <small>Valeurs en dehors de l'intervalle [${info.lower_bound.toFixed(2)}, ${info.upper_bound.toFixed(2)}]</small><br>
                        <small>IQR: ${info.iqr.toFixed(2)} (Q1: ${info.q1.toFixed(2)}, Q3: ${info.q3.toFixed(2)})</small>
                    </div>
                `;
            }
        } else if (colStats.histogram && colStats.histogram.outliers_info) {
            outlierInfo = `
                <div class="alert alert-success mt-3">
                    <i class="bi bi-check-circle"></i> 
                    <strong>Aucun outlier détecté</strong> dans cette variable.<br>
                    <small>Toutes les valeurs sont dans l'intervalle [${colStats.histogram.outliers_info.lower_bound.toFixed(2)}, ${colStats.histogram.outliers_info.upper_bound.toFixed(2)}]</small>
                </div>
            `;
        }
        
        // Mostrar estadísticas
        let decimalInfo = '';
        if (colStats.decimals_info) {
            decimalInfo = `
                <div class="col-md-4">
                    <small class="text-muted">Decimales:</small><br>
                    <strong>Común: ${colStats.decimals_info.most_common_decimals || 0}</strong><br>
                    <small>Máx: ${colStats.decimals_info.max_decimals || 0}, Prom: ${colStats.decimals_info.avg_decimals?.toFixed(1) || 0}</small>
                </div>
            `;
        }
        
        let magnitudeInfo = '';
        if (colStats.magnitude_info) {
            magnitudeInfo = `
                <div class="col-md-4">
                    <small class="text-muted">Orden de Magnitud:</small><br>
                    <strong>10<sup>${colStats.magnitude_info.avg_magnitude}</sup></strong><br>
                    <small>Rango: 10<sup>${colStats.magnitude_info.min_magnitude}</sup> a 10<sup>${colStats.magnitude_info.max_magnitude}</sup></small>
                </div>
            `;
        }
        
        document.getElementById(`variableStats${analysisId}`).innerHTML = `
            <div class="card bg-dark border-info">
                <div class="card-body">
                    <h6 class="text-info mb-3">Estadísticas de ${selectedVariable}</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted">Media:</small><br>
                            <strong>${colStats.mean?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Desviación Estándar:</small><br>
                            <strong>${colStats.std?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Mediana:</small><br>
                            <strong>${colStats.q50?.toFixed(2) || 'N/A'}</strong>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <small class="text-muted">Mínimo:</small><br>
                            <strong>${colStats.min?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Q1 (25%):</small><br>
                            <strong>${colStats.q25?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Q3 (75%):</small><br>
                            <strong>${colStats.q75?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Máximo:</small><br>
                            <strong>${colStats.max?.toFixed(2) || 'N/A'}</strong>
                        </div>
                    </div>
                    ${decimalInfo || magnitudeInfo ? `
                        <div class="row mt-3">
                            ${decimalInfo}
                            ${magnitudeInfo}
                        </div>
                    ` : ''}
                    ${outlierInfo}
                </div>
            </div>
        `;
    } else if (!isNumeric && colStats.top_values) {
        // Gráfico de barras para variables categóricas
        analysisCharts[analysisId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: colStats.top_values.values,
                datasets: [{
                    label: `Frecuencia de ${selectedVariable}`,
                    data: colStats.top_values.counts,
                    backgroundColor: 'rgba(16, 185, 129, 0.5)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Distribución de ${selectedVariable} (Top 10 valores)`,
                        color: '#00d4ff',
                        font: { size: 16 }
                    },
                    legend: { display: false }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Categorías',
                            color: '#00d4ff'
                        },
                        ticks: { 
                            color: '#f0f9ff',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Frecuencia',
                            color: '#00d4ff'
                        },
                        beginAtZero: true,
                        ticks: { color: '#f0f9ff' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });
        
        // Mostrar estadísticas categóricas
        document.getElementById(`variableStats${analysisId}`).innerHTML = `
            <div class="card bg-dark border-info">
                <div class="card-body">
                    <h6 class="text-info mb-3">Información de ${selectedVariable}</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted">Valores únicos:</small><br>
                            <strong>${colStats.unique_count || 0}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Valores nulos:</small><br>
                            <strong>${colStats.null_count || 0} (${colStats.null_percentage?.toFixed(1) || 0}%)</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Moda:</small><br>
                            <strong>${colStats.top_values?.values[0] || 'N/A'}</strong>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        document.getElementById(`histogramContainer${analysisId}`).innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> Aucune donnée de distribution disponible pour cette variable
            </div>
        `;
        document.getElementById(`variableStats${analysisId}`).innerHTML = '';
    }
    
    // Save analysis data for report generation
    analysisData[analysisId] = {
        variable: selectedVariable,
        isNumeric: isNumeric,
        stats: colStats,
        chartData: analysisCharts[analysisId] ? analysisCharts[analysisId].toBase64Image() : null,
        outlierInfo: colStats.histogram?.outliers_info || null
    };
}

// Actualizar estadísticas
function updateStats(datasetList) {
    const totalSize = datasetList.reduce((sum, d) => sum + (d.file_size || 0), 0);
    const totalRows = datasetList.reduce((sum, d) => sum + (d.row_count || 0), 0);
    const lastDate = datasetList.length > 0 ? 
        new Date(Math.max(...datasetList.map(d => new Date(d.uploaded_at || d.created_at)))).toLocaleDateString('fr-FR') : '-';
    
    document.getElementById('totalDatasets').textContent = datasetList.length;
    document.getElementById('totalSize').textContent = (totalSize / 1024 / 1024).toFixed(2) + ' MB';
    document.getElementById('totalRows').textContent = totalRows.toLocaleString();
    document.getElementById('lastUpdate').textContent = lastDate;
}

// Inicializar drag & drop
function initDragDrop() {
    const uploadArea = document.querySelector('.upload-area');
    
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    uploadArea.addEventListener('drop', handleDrop);
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('active');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('active');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('active');
    
    const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.csv'));
    if (files.length > 0) {
        handleFiles(files);
    } else {
        showNotification('Erreur', 'Veuillez déposer uniquement des fichiers CSV', 'error');
    }
}

function handleFileSelect(input) {
    const files = Array.from(input.files);
    if (files.length > 0) {
        handleFiles(files);
    }
}

// Traiter les fichiers
function handleFiles(files) {
    // Por ahora solo manejar un archivo a la vez
    if (files.length > 0) {
        showDatasetInfoModal(files[0]);
    }
}

// Variable global para almacenar archivos pendientes
let pendingFiles = [];

// Mostrar modal de información del dataset
function showDatasetInfoModal(file) {
    // Limpiar formulario
    document.getElementById('datasetName').value = file.name.replace('.csv', '');
    document.getElementById('datasetDescription').value = '';
    
    // Guardar archivo para uso posterior
    pendingFiles = [file];
    
    // Mostrar modal
    const modalElement = document.getElementById('datasetInfoModal');
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: false,  // Sin backdrop
        keyboard: true
    });
    modal.show();
}

// Proceder con la carga después de obtener la información
function proceedWithUpload() {
    const name = document.getElementById('datasetName').value.trim();
    const description = document.getElementById('datasetDescription').value.trim();
    
    if (pendingFiles.length > 0) {
        // Cerrar modal de información
        const infoModal = bootstrap.Modal.getInstance(document.getElementById('datasetInfoModal'));
        infoModal.hide();
        
        // Subir archivo con la información proporcionada
        uploadFile(pendingFiles[0], name, description);
    }
}

// Forcer la fermeture du modal d'upload
function forceCloseUploadModal() {
    const modalElement = document.getElementById('uploadProgressModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
        modal.hide();
    }
    // Nettoyer tous les backdrops et styles
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
}

// Upload d'un fichier
function uploadFile(file, customName, customDescription) {
    // Nettoyer les modals existants avant d'en créer un nouveau
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
    
    const modalElement = document.getElementById('uploadProgressModal');
    // Vérifier si une instance existe déjà
    let modal = bootstrap.Modal.getInstance(modalElement);
    if (!modal) {
        modal = new bootstrap.Modal(modalElement, {
            backdrop: false,  // Sin backdrop
            keyboard: true
        });
    }
    document.getElementById('uploadFileName').textContent = file.name;
    modal.show();
    
    const formData = new FormData();
    formData.append('name', customName || file.name.replace('.csv', ''));
    formData.append('file', file);
    formData.append('short_description', shortDescription || '');
    formData.append('long_description', longDescription || '');
    
    // Simuler la progression
    let progress = 0;
    const progressBar = document.getElementById('uploadProgressBar');
    const progressInterval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
        progressBar.textContent = Math.round(progress) + '%';
    }, 200);
    
    fetch('/api/datasets/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        document.getElementById('uploadStatus').textContent = 'Upload terminé avec succès!';
        
        setTimeout(() => {
            modal.hide();
            // Forcer la suppression du backdrop
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
            
            showNotification('Succès!', `Dataset "${file.name}" chargé avec succès`, 'success');
            loadDatasets();
        }, 1000);
    })
    .catch(error => {
        clearInterval(progressInterval);
        modal.hide();
        // Forcer la suppression du backdrop en cas d'erreur
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('overflow');
        document.body.style.removeProperty('padding-right');
        
        showNotification('Erreur', 'Erreur lors du chargement: ' + error, 'error');
    });
}


// Télécharger un dataset
function downloadDataset(datasetId) {
    const dataset = datasetId ? datasets.find(d => d.id === datasetId) : selectedDataset;
    if (!dataset) return;
    
    // Mostrar notificación de inicio de descarga
    showNotification('Téléchargement', `Téléchargement du dataset "${dataset.name}" en cours...`, 'info');
    
    // Descargar el archivo CSV
    window.location.href = `/api/datasets/${dataset.id}/download/`;
}

// Descargar reporte del análisis
function downloadReport() {
    if (!selectedDataset) return;
    
    showNotification('Génération du rapport', 'Génération du rapport d\'analyse en cours...', 'info');
    
    // Prepare chart data to send
    const chartsData = {};
    for (const [analysisId, data] of Object.entries(analysisData)) {
        if (analysisCharts[analysisId]) {
            chartsData[analysisId] = {
                variable: data.variable,
                isNumeric: data.isNumeric,
                chartImage: analysisCharts[analysisId].toBase64Image(),
                outlierInfo: data.outlierInfo
            };
        }
    }
    
    // Hacer petición para generar el reporte
    fetch(`/api/datasets/${selectedDataset.id}/report/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            charts: chartsData
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erreur lors de la génération du rapport');
        }
        return response.blob();
    })
    .then(blob => {
        // Crear URL temporal para descargar
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `rapport_${selectedDataset.name}_${new Date().toISOString().split('T')[0]}.html`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showNotification('Succès!', 'Rapport téléchargé avec succès', 'success');
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur', 'Erreur lors de la génération du rapport', 'error');
    });
}

// Supprimer un dataset
function deleteDataset(datasetId) {
    const dataset = datasetId ? datasets.find(d => d.id === datasetId) : selectedDataset;
    if (!dataset) return;
    
    Swal.fire({
        title: 'Êtes-vous sûr?',
        text: `Voulez-vous vraiment supprimer le dataset "${dataset.name}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Oui, supprimer',
        cancelButtonText: 'Annuler'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading('Suppression en cours...', 'Suppression du dataset de votre collection');
            
            fetch(`/api/datasets/${dataset.id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                hideLoading();
                if (response.ok) {
                    showNotification('Succès!', 'Dataset supprimé avec succès', 'success');
                    if (!datasetId) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('datasetDetailModal'));
                        if (modal) modal.hide();
                    }
                    loadDatasets();
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Erreur de suppression:', error);
                showNotification('Erreur', 'Erreur lors de la suppression: ' + error.message, 'error');
            });
        }
    });
}

// Seleccionar una variable
function selectVariable(columnName, isNumeric) {
    // Remover selección previa
    document.querySelectorAll('.column-row').forEach(row => {
        row.classList.remove('selected');
    });
    
    // Agregar selección actual
    const currentRow = document.querySelector(`tr[data-column="${columnName}"]`);
    if (currentRow) {
        currentRow.classList.add('selected');
    }
    
    // Guardar variable seleccionada
    window.selectedVariable = {
        name: columnName,
        isNumeric: isNumeric
    };
}

// Mostrar valores únicos
function showUniqueValues(columnName) {
    const data = window.currentDatasetData;
    if (!data || !data.stats || !data.stats[columnName]) {
        showNotification('Error', 'No hay datos disponibles para esta columna', 'error');
        return;
    }
    
    const colStats = data.stats[columnName];
    let currentPage = 0;
    const itemsPerPage = 20;
    let frequencyData = [];
    let originalFrequencyData = [];
    let currentSort = 'frequency';
    let isLoading = false;
    
    // Crear contenido del modal
    let modalContent = `
        <div class="modal fade" id="uniqueValuesModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-list-ul"></i> Análisis de Valores - "${columnName}"
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <span class="badge bg-info">Total: ${colStats.unique_count || 0} valores únicos</span>
                            <span class="badge bg-warning ms-2">Nulos: ${colStats.null_count || 0}</span>
                            <span class="badge bg-success ms-2" id="totalRecords">Total registros: -</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-primary mb-0">Distribución de frecuencias:</h6>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-info active" onclick="sortValues('frequency')" id="sortFrequency">
                                    <i class="bi bi-sort-numeric-down"></i> Frecuencia
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="sortValues('value-asc')" id="sortValueAsc">
                                    <i class="bi bi-sort-alpha-down"></i> Valor ↑
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="sortValues('value-desc')" id="sortValueDesc">
                                    <i class="bi bi-sort-alpha-down-alt"></i> Valor ↓
                                </button>
                            </div>
                        </div>
                        <div id="uniqueValuesContent" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-center p-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal anterior si existe
    const existingModal = document.getElementById('uniqueValuesModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Agregar modal al documento
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // Mostrar modal
    const modalElement = document.getElementById('uniqueValuesModal');
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: false,  // Sin backdrop
        keyboard: true
    });
    modal.show();
    
    // Función para ordenar valores
    window.sortValues = function(sortType) {
        currentSort = sortType;
        currentPage = 0;
        
        // Actualizar botones activos
        document.querySelectorAll('#uniqueValuesModal .btn-group button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        if (sortType === 'frequency') {
            document.getElementById('sortFrequency').classList.add('active');
            frequencyData = [...originalFrequencyData];
        } else if (sortType === 'value-asc') {
            document.getElementById('sortValueAsc').classList.add('active');
            frequencyData = [...originalFrequencyData].sort((a, b) => {
                if (a.value === 'NaN') return 1;
                if (b.value === 'NaN') return -1;
                if (typeof a.value === 'number' && typeof b.value === 'number') {
                    return a.value - b.value;
                }
                return String(a.value).localeCompare(String(b.value));
            });
        } else if (sortType === 'value-desc') {
            document.getElementById('sortValueDesc').classList.add('active');
            frequencyData = [...originalFrequencyData].sort((a, b) => {
                if (a.value === 'NaN') return 1;
                if (b.value === 'NaN') return -1;
                if (typeof a.value === 'number' && typeof b.value === 'number') {
                    return b.value - a.value;
                }
                return String(b.value).localeCompare(String(a.value));
            });
        }
        
        // Re-renderizar
        const container = document.getElementById('uniqueValuesContent');
        container.innerHTML = '';
        renderValues();
    };
    
    // Función para cargar valores
    function loadUniqueValues() {
        if (isLoading) return;
        isLoading = true;
        
        fetch(`/api/datasets/${selectedDataset.id}/columns/${encodeURIComponent(columnName)}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                originalFrequencyData = data.frequency_data || [];
                frequencyData = [...originalFrequencyData];
                document.getElementById('totalRecords').textContent = `Total registros: ${data.total_count || 0}`;
                renderValues();
                isLoading = false;
            })
            .catch(error => {
                console.error('Error completo:', error);
                document.getElementById('uniqueValuesContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error al cargar los valores
                        <br><small>${error.message}</small>
                    </div>
                `;
                isLoading = false;
            });
    }
    
    // Función para renderizar valores
    function renderValues() {
        const container = document.getElementById('uniqueValuesContent');
        const startIdx = currentPage * itemsPerPage;
        const endIdx = Math.min(startIdx + itemsPerPage, frequencyData.length);
        
        if (currentPage === 0) {
            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>#</th>
                                <th>Valor</th>
                                <th>Frecuencia</th>
                                <th style="min-width: 200px;">Porcentaje</th>
                            </tr>
                        </thead>
                        <tbody id="frequencyTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="loadingIndicator" class="text-center mt-3" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Cargando más...</span>
                    </div>
                </div>
            `;
        }
        
        // Agregar filas
        const tbody = document.getElementById('frequencyTableBody');
        for (let i = startIdx; i < endIdx; i++) {
            const item = frequencyData[i];
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="text-muted">${i + 1}</td>
                <td><code>${item.value}</code></td>
                <td>${item.count.toLocaleString()}</td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="progress flex-grow-1" style="height: 20px;">
                            <div class="progress-bar ${item.percentage > 10 ? 'bg-primary' : 'bg-info'}" 
                                 role="progressbar" 
                                 style="width: ${item.percentage}%">
                                ${item.percentage > 5 ? item.percentage.toFixed(2) + '%' : ''}
                            </div>
                        </div>
                        <span class="ms-2 text-nowrap" style="min-width: 60px; text-align: right;">
                            ${item.percentage.toFixed(2)}%
                        </span>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        }
        
        // Configurar scroll infinito
        const scrollContainer = document.getElementById('uniqueValuesContent');
        scrollContainer.onscroll = function() {
            if (scrollContainer.scrollTop + scrollContainer.clientHeight >= scrollContainer.scrollHeight - 50) {
                if (currentPage * itemsPerPage < frequencyData.length) {
                    currentPage++;
                    document.getElementById('loadingIndicator').style.display = 'block';
                    setTimeout(() => {
                        renderValues();
                        document.getElementById('loadingIndicator').style.display = 'none';
                    }, 200);
                }
            }
        };
    }
    
    // Cargar valores iniciales
    loadUniqueValues();
    
    // Limpiar al cerrar
    document.getElementById('uniqueValuesModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
}

// Mostrar outliers
function showOutliers(columnName) {
    const data = window.currentDatasetData;
    if (!data || !data.stats || !data.stats[columnName]) {
        showNotification('Error', 'No hay datos disponibles para esta columna', 'error');
        return;
    }
    
    const colStats = data.stats[columnName];
    
    if (!colStats.q25 || !colStats.q75) {
        showNotification('Error', 'No se pueden calcular outliers para esta columna', 'warning');
        return;
    }
    
    // Calcular outliers localmente
    const iqr = colStats.q75 - colStats.q25;
    const lowerBound = colStats.q25 - (1.5 * iqr);
    const upperBound = colStats.q75 + (1.5 * iqr);
    
    // Variables para scroll infinito y filtrado
    let outlierValues = [];
    let filteredOutlierValues = [];
    let currentFilter = 'all';
    let outlierInfo = null;
    let currentPage = 0;
    const itemsPerPage = 20;
    let isLoading = false;
    
    // Crear contenido del modal
    let modalContent = `
        <div class="modal fade" id="outliersModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-exclamation-triangle"></i> Análisis de Outliers - "${columnName}"
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card bg-dark border-info">
                                    <div class="card-body">
                                        <h6 class="text-info">Método IQR (Rango Intercuartílico)</h6>
                                        <p class="mb-2"><strong>Q1 (25%):</strong> ${colStats.q25.toFixed(2)}</p>
                                        <p class="mb-2"><strong>Q3 (75%):</strong> ${colStats.q75.toFixed(2)}</p>
                                        <p class="mb-2"><strong>IQR:</strong> ${iqr.toFixed(2)}</p>
                                        <hr>
                                        <p class="mb-2"><strong>Límite inferior:</strong> ${lowerBound.toFixed(2)}</p>
                                        <p class="mb-0"><strong>Límite superior:</strong> ${upperBound.toFixed(2)}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-dark border-warning">
                                    <div class="card-body">
                                        <h6 class="text-warning">Resumen de Outliers</h6>
                                        <p class="mb-2">
                                            <i class="bi bi-arrow-down-circle"></i> 
                                            <strong>Valores por debajo:</strong> 
                                            <span class="text-info" id="outliersBelowCount">0</span>
                                        </p>
                                        <p class="mb-2">
                                            <i class="bi bi-arrow-up-circle"></i> 
                                            <strong>Valores por encima:</strong> 
                                            <span class="text-warning" id="outliersAboveCount">0</span>
                                        </p>
                                        <p class="mb-0">
                                            <i class="bi bi-sum"></i> 
                                            <strong>Total outliers:</strong> 
                                            <span class="text-danger" id="outliersTotal">0</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="text-primary mb-3">Diagrama de Caja (Box Plot)</h6>
                        <div class="text-center mb-4">
                            <canvas id="outlierBoxPlot" height="200"></canvas>
                        </div>
                        
                        <h6 class="text-primary mb-3">Valores Outliers Detectados</h6>
                        
                        <!-- Controles de filtrado -->
                        <div class="mb-3">
                            <div class="btn-group btn-group-sm w-100" role="group">
                                <button type="button" class="btn btn-outline-info active" id="filterAll" onclick="filterOutliers('all')">
                                    <i class="bi bi-list"></i> Todos
                                </button>
                                <button type="button" class="btn btn-outline-info" id="filterBelow" onclick="filterOutliers('below')">
                                    <i class="bi bi-arrow-down-circle"></i> Por debajo
                                </button>
                                <button type="button" class="btn btn-outline-info" id="filterAbove" onclick="filterOutliers('above')">
                                    <i class="bi bi-arrow-up-circle"></i> Por encima
                                </button>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    Mostrando: <span id="outlierFilterStatus" class="text-info">Todos los outliers</span> | 
                                    Total visible: <span id="visibleOutliersCount" class="text-warning">0</span>
                                </small>
                            </div>
                        </div>
                        
                        <div id="outlierValuesContent" style="max-height: 500px; overflow-y: auto; border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 5px; padding: 10px;">
                            <div class="text-center p-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3" id="outlierRangeInfo" style="display: none;">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                <strong>Rango de valores normales:</strong> [${lowerBound.toFixed(2)}, ${upperBound.toFixed(2)}]
                                <br>
                                <small>Los valores fuera de este rango se consideran outliers potenciales.</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal anterior si existe
    const existingModal = document.getElementById('outliersModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Agregar modal al documento
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // Mostrar modal
    const modalElement = document.getElementById('outliersModal');
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: false,  // Sin backdrop
        keyboard: true
    });
    modal.show();
    
    // Función para cargar outliers
    function loadOutliers() {
        if (isLoading) return;
        isLoading = true;
        
        // Mostrar el rango de outliers
        document.getElementById('outlierRangeInfo').style.display = 'block';
        
        fetch(`/api/datasets/${selectedDataset.id}/columns/${encodeURIComponent(columnName)}/`)
            .then(response => response.json())
            .then(data => {
                const outlierInfo = data.outlier_info;
                if (outlierInfo) {
                    outlierValues = outlierInfo.outlier_values || [];
                    renderOutliers();
                    
                    // Actualizar estadísticas en el DOM
                    if (outlierInfo && outlierValues.length > 0) {
                        // Calcular outliers por encima y por debajo
                        const belowCount = outlierValues.filter(v => v < outlierInfo.lower_bound).length;
                        const aboveCount = outlierValues.filter(v => v > outlierInfo.upper_bound).length;
                        
                        // Actualizar contadores
                        document.getElementById('outliersBelowCount').textContent = belowCount;
                        document.getElementById('outliersAboveCount').textContent = aboveCount;
                        document.getElementById('outliersTotal').textContent = outlierValues.length;
                    }
                    
                    // Crear box plot
                    setTimeout(() => {
                        const ctx = document.getElementById('outlierBoxPlot').getContext('2d');
                        new Chart(ctx, {
                            type: 'boxplot',
                            data: {
                                labels: [columnName],
                                datasets: [{
                                    label: 'Distribución',
                                    backgroundColor: 'rgba(0, 212, 255, 0.5)',
                                    borderColor: 'rgba(0, 212, 255, 1)',
                                    borderWidth: 1,
                                    outlierColor: '#ff0000',
                                    data: [{
                                        min: colStats.min,
                                        q1: outlierInfo.q1,
                                        median: colStats.q50,
                                        q3: outlierInfo.q3,
                                        max: colStats.max,
                                        outliers: outlierValues.slice(0, 50) // Mostrar máximo 50 outliers en el gráfico
                                    }]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const data = context.parsed;
                                                return [
                                                    `Min: ${data.min.toFixed(2)}`,
                                                    `Q1: ${data.q1.toFixed(2)}`,
                                                    `Mediana: ${data.median.toFixed(2)}`,
                                                    `Q3: ${data.q3.toFixed(2)}`,
                                                    `Max: ${data.max.toFixed(2)}`
                                                ];
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        ticks: { color: '#f0f9ff' },
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                    }
                                }
                            }
                        });
                    }, 100);
                }
                isLoading = false;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('outlierValuesContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error al cargar los outliers
                    </div>
                `;
                isLoading = false;
            });
    }
    
    // Función para filtrar outliers
    window.filterOutliers = function(type) {
        currentFilter = type;
        currentPage = 0;
        
        // Actualizar botones activos
        document.querySelectorAll('#outliersModal .btn-group button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        if (type === 'all') {
            document.getElementById('filterAll').classList.add('active');
            document.getElementById('outlierFilterStatus').textContent = 'Todos los outliers';
            filteredOutlierValues = outlierValues;
        } else if (type === 'below') {
            document.getElementById('filterBelow').classList.add('active');
            document.getElementById('outlierFilterStatus').textContent = 'Outliers por debajo del límite inferior';
            const lowerBound = colStats.q25 - (1.5 * (colStats.q75 - colStats.q25));
            filteredOutlierValues = outlierValues.filter(v => v < lowerBound);
        } else if (type === 'above') {
            document.getElementById('filterAbove').classList.add('active');
            document.getElementById('outlierFilterStatus').textContent = 'Outliers por encima del límite superior';
            const upperBound = colStats.q75 + (1.5 * (colStats.q75 - colStats.q25));
            filteredOutlierValues = outlierValues.filter(v => v > upperBound);
        }
        
        // Re-renderizar
        const container = document.getElementById('outlierValuesContent');
        container.innerHTML = '';
        renderOutliers();
    };
    
    // Función para renderizar outliers
    function renderOutliers() {
        const container = document.getElementById('outlierValuesContent');
        const valuesToRender = filteredOutlierValues.length > 0 || currentFilter !== 'all' ? filteredOutlierValues : outlierValues;
        const startIdx = currentPage * itemsPerPage;
        const endIdx = Math.min(startIdx + itemsPerPage, valuesToRender.length);
        
        // Actualizar contador de visibles
        document.getElementById('visibleOutliersCount').textContent = valuesToRender.length;
        
        if (currentPage === 0) {
            if (outlierValues.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> No se detectaron outliers en esta variable
                    </div>
                `;
                return;
            }
            
            if (valuesToRender.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No se encontraron outliers con los filtros actuales
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Valor</th>
                                <th>Tipo</th>
                            </tr>
                        </thead>
                        <tbody id="outlierTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="outlierLoadingIndicator" class="text-center mt-3" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Cargando más...</span>
                    </div>
                </div>
            `;
        }
        
        // Agregar valores
        const tbody = document.getElementById('outlierTableBody');
        const iqr = colStats.q75 - colStats.q25;
        const lowerBound = colStats.q25 - (1.5 * iqr);
        const upperBound = colStats.q75 + (1.5 * iqr);
        
        for (let i = startIdx; i < endIdx; i++) {
            const value = valuesToRender[i];
            const type = value < lowerBound ? 'Bajo' : 'Alto';
            const typeClass = value < lowerBound ? 'text-info' : 'text-warning';
            
            tbody.innerHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td><strong>${value.toFixed(4)}</strong></td>
                    <td><span class="${typeClass}">${type}</span></td>
                </tr>
            `;
        }
        
        // Configurar scroll infinito
        const scrollContainer = document.getElementById('outlierValuesContent');
        scrollContainer.onscroll = function() {
            if (scrollContainer.scrollTop + scrollContainer.clientHeight >= scrollContainer.scrollHeight - 50) {
                if (currentPage * itemsPerPage < valuesToRender.length) {
                    currentPage++;
                    document.getElementById('outlierLoadingIndicator').style.display = 'block';
                    setTimeout(() => {
                        renderOutliers();
                        document.getElementById('outlierLoadingIndicator').style.display = 'none';
                    }, 300);
                }
            }
        };
    }
    
    // Cargar outliers iniciales
    loadOutliers();
    
    // Limpiar al cerrar
    document.getElementById('outliersModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
}

// Función de limpieza de emergencia
function emergencyCleanup() {
    // Cerrar todos los modales abiertos
    document.querySelectorAll('.modal.show').forEach(modal => {
        const modalInstance = bootstrap.Modal.getInstance(modal);
        if (modalInstance) {
            modalInstance.hide();
        }
    });
    
    // Eliminar todos los backdrops
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    
    // Limpiar clases del body
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
    
    // Ocultar loading spinner
    hideLoading();
}

// Detectar tecla ESC para limpieza de emergencia
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        emergencyCleanup();
    }
});

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // Limpiar cualquier modal o backdrop residual al cargar la página
    emergencyCleanup();
    
    // Agregar listeners para limpiar cuando se ocultan los modals
    const uploadModal = document.getElementById('uploadProgressModal');
    uploadModal.addEventListener('hidden.bs.modal', function () {
        setTimeout(() => {
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        }, 100);
    });
    
    const detailModal = document.getElementById('datasetDetailModal');
    detailModal.addEventListener('hidden.bs.modal', function () {
        setTimeout(() => {
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        }, 100);
    });
    
    // Cargar datasets con callback para manejar URL params
    loadDatasets().then(() => {
        // Verificar si hay un dataset específico para abrir
        const urlParams = new URLSearchParams(window.location.search);
        const datasetToOpen = urlParams.get('open');
        const shouldRefresh = urlParams.get('refresh');
        const hash = window.location.hash;
        
        // Si viene de una normalización, limpiar la URL y recargar
        if (shouldRefresh === 'true') {
            // Limpiar el parámetro de la URL
            const newUrl = window.location.pathname + window.location.hash;
            window.history.replaceState({}, document.title, newUrl);
            
            // Forzar recarga de datasets después de un breve delay
            setTimeout(() => {
                console.log('Forcing dataset reload after normalization...');
                loadDatasets();
            }, 500);
        }
        
        if (datasetToOpen) {
            // Abrir dataset desde parámetro URL
            setTimeout(() => {
                const datasetCard = document.querySelector(`[data-dataset-id="${datasetToOpen}"] .dataset-clickable`);
                if (datasetCard) {
                    datasetCard.click();
                }
            }, 500);
        } else if (hash && hash.startsWith('#dataset-')) {
            // Abrir dataset desde hash
            const datasetId = hash.replace('#dataset-', '');
            setTimeout(() => {
                const datasetCard = document.querySelector(`[data-dataset-id="${datasetId}"] .dataset-clickable`);
                if (datasetCard) {
                    datasetCard.click();
                }
            }, 500);
        }
    });
    initDragDrop();
    
    // Actualiser toutes les 30 secondes
    setInterval(loadDatasets, 30000);
});
</script>

<!-- Script para análisis avanzados -->
<script src="{% static 'js/dataset-analysis.js' %}"></script>

{% endblock %}