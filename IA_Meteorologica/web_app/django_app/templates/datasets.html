{% extends 'base.html' %}
{% load static %}

{% block title %}Datasets - IA M√©t√©orologique{% endblock %}

{% block extra_css %}
<style>
    /* Estilos mejorados para datasets */
    .dataset-card {
        background: rgba(10, 14, 39, 0.8);
        border: 2px solid rgba(0, 212, 255, 0.3);
        border-radius: 20px;
        padding: 30px;
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }
    
    .dataset-card::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(0, 212, 255, 0.1) 0%, transparent 70%);
        transform: rotate(45deg);
        transition: all 0.5s ease;
        opacity: 0;
    }
    
    .dataset-card:hover {
        transform: translateY(-10px);
        border-color: rgba(0, 212, 255, 0.8);
        box-shadow: 0 15px 40px rgba(0, 212, 255, 0.3);
    }
    
    .dataset-card:hover::before {
        opacity: 1;
    }
    
    .dataset-icon {
        font-size: 4rem;
        background: linear-gradient(135deg, #00d4ff, #0099ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .dataset-card .card-title {
        color: white !important;
    }
    
    .dataset-stats {
        display: flex;
        justify-content: space-around;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(0, 212, 255, 0.2);
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #00d4ff;
    }
    
    .upload-area {
        background: rgba(0, 212, 255, 0.05);
        border: 3px dashed rgba(0, 212, 255, 0.5);
        border-radius: 20px;
        padding: 60px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .upload-area:hover {
        border-color: #00d4ff;
        background: rgba(0, 212, 255, 0.1);
    }
    
    .upload-area.active {
        border-color: #00ff88;
        background: rgba(0, 255, 136, 0.1);
        box-shadow: inset 0 0 30px rgba(0, 255, 136, 0.2);
    }
    
    .quick-actions {
        position: absolute;
        top: 15px;
        right: 15px;
        display: flex;
        gap: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .dataset-card:hover .quick-actions {
        opacity: 1;
    }
    
    .quick-actions button {
        background: rgba(0, 212, 255, 0.2);
        border: 1px solid rgba(0, 212, 255, 0.5);
        color: #00d4ff;
        padding: 8px 12px;
        border-radius: 10px;
        transition: all 0.3s ease;
    }
    
    .quick-actions button:hover {
        background: rgba(0, 212, 255, 0.4);
        transform: scale(1.1);
    }
    
    /* Estilos para el modal de detalles */
    .column-stats {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.8s ease;
        cursor: pointer;
    }
    
    .column-stats:hover {
        background: rgba(0, 212, 255, 0.1);
        border-color: rgba(0, 212, 255, 0.5);
    }
    
    .column-stats.selected {
        background: rgba(0, 212, 255, 0.15);
        border-color: rgba(0, 212, 255, 0.8);
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
    }
    
    .column-type {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .column-type.type-numeric {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }
    
    .column-type.type-text {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }
    
    .column-type.type-datetime {
        background: rgba(168, 85, 247, 0.2);
        color: #a855f7;
    }
    
    .data-preview {
        background: rgba(10, 14, 39, 0.5);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 20px;
        overflow-x: auto;
    }
    
    .data-preview table {
        color: #f0f9ff;
    }
    
    .data-preview th {
        background: rgba(0, 212, 255, 0.1);
        color: #00d4ff;
        font-weight: 600;
        border-color: rgba(0, 212, 255, 0.2);
    }
    
    .data-preview td {
        border-color: rgba(0, 212, 255, 0.1);
    }
    
    .chart-container {
        background: rgba(10, 14, 39, 0.5);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 20px;
    }
    
    /* Estilos para los an√°lisis */
    .stat-card {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 15px;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        background: rgba(0, 212, 255, 0.1);
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
    }
    
    .accordion-button {
        background: rgba(0, 212, 255, 0.05);
        color: #f0f9ff;
    }
    
    .accordion-button:not(.collapsed) {
        background: rgba(0, 212, 255, 0.1);
        color: #00d4ff;
    }
    
    .accordion-body {
        background: rgba(10, 14, 39, 0.5);
        border-top: 1px solid rgba(0, 212, 255, 0.2);
    }
    
    .column-row {
        cursor: pointer;
        transition: background-color 0.8s ease;
    }
    
    .column-row:hover {
        background-color: rgba(0, 212, 255, 0.05);
    }
    
    .column-row.selected {
        background-color: rgba(0, 212, 255, 0.15);
    }
    
    /* Estilos para la tabla de frecuencias */
    .table-responsive {
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 8px;
    }
    
    .progress {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-5">
        <div class="col-12">
            <h1 class="text-white fw-bold">
                <i class="bi bi-database"></i> Gestion des Datasets
            </h1>
            <p class="text-white-50">Importez et g√©rez vos donn√©es m√©t√©orologiques</p>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-database-fill text-primary" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="totalDatasets">0</h3>
                    <p class="text-muted mb-0">Datasets Totaux</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-hdd-fill text-success" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="totalSize">0 MB</h3>
                    <p class="text-muted mb-0">Espace Utilis√©</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-bar-chart-fill text-info" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="totalRows">0</h3>
                    <p class="text-muted mb-0">Lignes Totales</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-calendar3 text-warning" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="lastUpdate">-</h3>
                    <p class="text-muted mb-0">Derni√®re Mise √† Jour</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Upload Area -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <i class="bi bi-cloud-arrow-up" style="font-size: 4rem; color: #00d4ff;"></i>
                <h4 class="mt-3 text-white">Glissez vos fichiers CSV ici</h4>
                <p class="text-muted">ou cliquez pour parcourir</p>
                <input type="file" id="fileInput" multiple accept=".csv" style="display: none;" onchange="handleFileSelect(this)">
            </div>
        </div>
    </div>
    
    <!-- Datasets Grid -->
    <div class="row g-4" id="datasetsGrid">
        <!-- Les datasets seront charg√©s ici -->
    </div>
</div>

<!-- Modal Detail Dataset -->
<div class="modal fade" id="datasetDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="datasetDetailTitle">
                    <i class="bi bi-database"></i> D√©tails du Dataset
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="datasetDetailContent">
                <!-- Le contenu sera charg√© dynamiquement -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Fermer
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteDataset()">
                    <i class="bi bi-trash"></i> Supprimer
                </button>
                <button type="button" class="btn btn-success" onclick="downloadDataset()">
                    <i class="bi bi-file-earmark-csv"></i> T√©l√©charger Dataset
                </button>
                <button type="button" class="btn btn-primary" onclick="downloadReport()">
                    <i class="bi bi-file-earmark-pdf"></i> T√©l√©charger Rapport
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Upload Progress -->
<div class="modal fade" id="uploadProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-cloud-upload"></i> Chargement en cours
                </h5>
                <button type="button" class="btn-close" onclick="forceCloseUploadModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong id="uploadFileName">Fichier.csv</strong>
                </div>
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="uploadProgressBar">0%</div>
                </div>
                <div class="text-muted small" id="uploadStatus">Pr√©paration du fichier...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="forceCloseUploadModal()">
                    <i class="bi bi-x-circle"></i> Annuler
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/@sgratzl/chartjs-chart-boxplot@3"></script>
<script>
let datasets = [];
let selectedDataset = null;
let charts = {};
let analysisCount = 1;
let analysisCharts = {}; // Store multiple charts by analysis ID
let analysisData = {}; // Store analysis data for report generation

// Funci√≥n para obtener el CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Charger les datasets
function loadDatasets() {
    showLoading();
    
    fetch('/api/datasets/')
        .then(response => response.json())
        .then(data => {
            datasets = data;
            displayDatasets(data);
            updateStats(data);
            hideLoading();
        })
        .catch(error => {
            console.error('Erreur:', error);
            hideLoading();
            showNotification('Erreur', 'Impossible de charger les datasets', 'error');
        });
}

// Afficher les datasets
function displayDatasets(datasetList) {
    const grid = document.getElementById('datasetsGrid');
    grid.innerHTML = '';
    
    if (datasetList.length === 0) {
        grid.innerHTML = `
            <div class="col-12 text-center">
                <p class="text-muted">Aucun dataset disponible. Importez votre premier dataset!</p>
            </div>
        `;
        return;
    }
    
    datasetList.forEach(dataset => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4';
        const size = dataset.file_size ? (dataset.file_size / 1024 / 1024).toFixed(2) : '0';
        
        col.innerHTML = `
            <div class="card dataset-card h-100" onclick="showDatasetDetails(${dataset.id})">
                <div class="quick-actions">
                    <button onclick="event.stopPropagation(); downloadDataset(${dataset.id})" title="T√©l√©charger">
                        <i class="bi bi-download"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteDataset(${dataset.id})" title="Supprimer">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="dataset-icon">
                        <i class="bi bi-file-earmark-spreadsheet"></i>
                    </div>
                    <h5 class="card-title text-center mb-2" style="font-weight: 600; font-size: 1.3rem;">
                        ${dataset.name}
                    </h5>
                    <p class="text-muted small text-center mb-4" style="font-size: 0.85rem; opacity: 0.8;">
                        ${dataset.description || 'Dataset m√©t√©orologique'}
                    </p>
                    <div class="dataset-stats">
                        <div class="stat-item">
                            <div class="stat-value">${(dataset.row_count || 0).toLocaleString('fr-FR')}</div>
                            <div class="text-muted small">Lignes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${dataset.column_count || 0}</div>
                            <div class="text-muted small">Colonnes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${size}</div>
                            <div class="text-muted small">MB</div>
                        </div>
                    </div>
                    <div class="text-center mt-4 pt-3" style="border-top: 1px solid rgba(0, 212, 255, 0.2); color: #00d4ff; font-size: 0.9rem;">
                        <i class="bi bi-calendar3"></i> 
                        Import√© le ${dataset.uploaded_at ? new Date(dataset.uploaded_at).toLocaleDateString('fr-FR', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        }) : 'Date inconnue'}
                    </div>
                </div>
            </div>
        `;
        grid.appendChild(col);
    });
}

// Afficher les d√©tails d'un dataset
function showDatasetDetails(datasetId) {
    selectedDataset = datasets.find(d => d.id === datasetId);
    window.selectedDataset = selectedDataset;  // Hacer accesible globalmente
    if (!selectedDataset) return;
    
    // Fermer tous les modals ouverts d'abord
    document.querySelectorAll('.modal.show').forEach(modalEl => {
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) {
            modalInstance.hide();
        }
    });
    
    // Attendre un peu pour que Bootstrap nettoie
    setTimeout(() => {
        // Limpiar cualquier modal o backdrop previo
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('overflow');
        document.body.style.removeProperty('padding-right');
        
        // Asegurar que no haya loading activo
        hideLoading();
        
        const modalElement = document.getElementById('datasetDetailModal');
        // Verificar si ya existe una instancia
        let modal = bootstrap.Modal.getInstance(modalElement);
        if (!modal) {
            modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: true
            });
        }
        
        document.getElementById('datasetDetailTitle').innerHTML = `
            <i class="bi bi-database"></i> ${selectedDataset.name}
        `;
        
        // Mostrar loading en el contenido
        document.getElementById('datasetDetailContent').innerHTML = `
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Cargando an√°lisis del dataset...</p>
            </div>
        `;
        
        // Mostrar el modal
        modal.show();
        
        // Cargar los datos del dataset
        fetch(`/api/datasets/${datasetId}/columns/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                displayDatasetDetails(selectedDataset, data);
            })
            .catch(error => {
                console.error('Error completo:', error);
                document.getElementById('datasetDetailContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error al cargar los detalles del dataset
                        <br><small>${error.message}</small>
                    </div>
                `;
            });
    }, 100);
}

// Mostrar an√°lisis completo del dataset
function displayDatasetDetails(dataset, data) {
    const shape = data.shape || [0, 0];
    const rows = shape[0];
    const cols = shape[1];
    const stats = data.stats || {};
    const preview = data.preview || {};
    const columns = data.columns || [];
    const memoryUsage = data.memory_usage ? data.memory_usage.toFixed(2) : '0';
    const totalNulls = data.total_null_count || 0;
    
    // Guardar datos en variable global para uso posterior
    window.currentDatasetData = data;
    window.selectedDataset = dataset;  // Asegurar que el dataset est√© disponible globalmente
    
    // Reset analysis data for new dataset
    analysisCount = 1;
    analysisCharts = {};
    analysisData = {};
    
    // Preview de datos PRIMERO
    let dataPreview = `
        <div class="row mb-4">
            <div class="col-md-12">
                <h5 class="text-primary mb-3"><i class="bi bi-eye"></i> Vista Previa de Datos (Primeras 10 filas)</h5>
                <div class="table-responsive" style="max-height: 300px; overflow: auto;">
                    <table class="table table-sm table-striped table-hover">
                        <thead class="table-dark sticky-top">
                            <tr>
                                ${columns.map(col => `<th class="text-nowrap">${col}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    // Generar filas del preview
    for (let i = 0; i < 10 && i < rows; i++) {
        dataPreview += '<tr>';
        columns.forEach(col => {
            const value = preview[col] && preview[col][i] !== undefined ? preview[col][i] : '';
            dataPreview += `<td class="text-nowrap">${value}</td>`;
        });
        dataPreview += '</tr>';
    }
    
    dataPreview += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Selector de variable y generador de histograma
    let variableSelector = `
        <div class="row mb-4">
            <div class="col-md-12">
                <h5 class="text-primary mb-3"><i class="bi bi-bar-chart-line"></i> Analyse de Distribution</h5>
                <div id="analysisContainer">
                    <div class="card bg-dark border-primary mb-3 analysis-card" data-analysis-id="1">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <label for="variableSelect1" class="form-label text-info">S√©lectionner Variable:</label>
                                    <select class="form-select variable-select" id="variableSelect1" data-analysis-id="1" onchange="updateAnalysisButton(1)">
                                        <option value="">-- S√©lectionnez une variable --</option>
                                        ${columns.map(col => {
                                            const colStats = stats[col] || {};
                                            const dtype = colStats.dtype || 'unknown';
                                            const isNumeric = colStats.mean !== undefined;
                                            
                                            let typeLabel = dtype;
                                            if (dtype.includes('int') || dtype.includes('float')) {
                                                typeLabel = 'üìä Num√©rique';
                                            } else if (dtype.includes('datetime')) {
                                                typeLabel = 'üìÖ Date/Heure';
                                            } else if (dtype.includes('numeric (stored as text)')) {
                                                typeLabel = 'üî¢ Num√©rique (texte)';
                                            } else if (dtype.includes('object')) {
                                                typeLabel = 'üìù Texte';
                                            }
                                            
                                            return `<option value="${col}" data-numeric="${isNumeric}" data-dtype="${dtype}">${col} - ${typeLabel}</option>`;
                                        }).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-8">
                                    <select class="form-select" id="analysisType1" onchange="updateAnalysisButton(1)">
                                        <option value="histogram">Histogramme</option>
                                        <option value="outlier_map" class="numeric-only">Carte des Outliers</option>
                                        <option value="boxplot" class="numeric-only">Box Plot</option>
                                        <option value="scatter" class="numeric-only">Scatter Plot (2 variables)</option>
                                        <option value="lasso" class="numeric-only">LASSO (S√©lection de variables)</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-primary w-100" id="analysisButton1" onclick="executeAnalysis(1)">
                                        <i class="bi bi-graph-up"></i> G√©n√©rer Analyse
                                    </button>
                                </div>
                            </div>
                            <div class="mt-4" id="histogramContainer1" style="display: none;">
                                <canvas id="variableHistogram1" height="400"></canvas>
                            </div>
                            <div class="mt-3" id="variableStats1" style="display: none;">
                                <!-- Les statistiques de la variable s√©lectionn√©e appara√Ætront ici -->
                            </div>
                            <div class="mt-3" id="analysisResultContainer1">
                                <!-- Les r√©sultats des analyses avanc√©es appara√Ætront ici -->
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success btn-lg w-100" onclick="addNewAnalysis()">
                    <i class="bi bi-plus-circle"></i> Ajouter une autre analyse de variable
                </button>
            </div>
        </div>
        
        <!-- An√°lisis Generales del Dataset -->
        <div class="row mb-4">
            <div class="col-md-12">
                <h5 class="text-primary mb-3"><i class="bi bi-diagram-3"></i> Analyses G√©n√©rales du Dataset</h5>
                <div class="btn-group d-flex flex-wrap mb-3" role="group">
                    <button class="btn btn-outline-info" onclick="generateGeneralAnalysis('correlation')">
                        <i class="bi bi-grid-3x3"></i> Matrice de Corr√©lation
                    </button>
                    <button class="btn btn-outline-warning" onclick="generateGeneralAnalysis('pca')">
                        <i class="bi bi-arrows-angle-contract"></i> Analyse PCA
                    </button>
                </div>
                <div id="generalAnalysisContainer">
                    <!-- Les analyses g√©n√©rales appara√Ætront ici -->
                </div>
            </div>
        </div>
    `;
    
    // Info general compacta
    let generalInfo = `
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3">
                            <i class="bi bi-table text-primary" style="font-size: 1.5rem;"></i>
                            <h6 class="mt-2 mb-0">${rows.toLocaleString()} √ó ${cols}</h6>
                            <small class="text-muted">Dimensiones</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3">
                            <i class="bi bi-hdd text-success" style="font-size: 1.5rem;"></i>
                            <h6 class="mt-2 mb-0">${memoryUsage} MB</h6>
                            <small class="text-muted">Memoria</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3">
                            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 1.5rem;"></i>
                            <h6 class="mt-2 mb-0">${totalNulls.toLocaleString()}</h6>
                            <small class="text-muted">Valores Nulos</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3">
                            <i class="bi bi-percent text-info" style="font-size: 1.5rem;"></i>
                            <h6 class="mt-2 mb-0">${rows > 0 ? ((totalNulls / (rows * cols)) * 100).toFixed(2) : '0'}%</h6>
                            <small class="text-muted">Faltantes</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // An√°lisis detallado (simplificado)
    let detailedAnalysis = `
        <div class="row mb-4">
            <div class="col-md-12">
                <h5 class="text-primary mb-3"><i class="bi bi-list-columns-reverse"></i> Informaci√≥n de Variables</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Variable</th>
                                <th>Tipo Python</th>
                                <th>Valores √önicos</th>
                                <th>Nulos</th>
                                <th>% Nulos</th>
                                <th>Estad√≠sticas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${columns.map(col => {
                                const colStats = stats[col] || {};
                                const dtype = colStats.dtype || 'unknown';
                                const isNumeric = colStats.mean !== undefined;
                                
                                // Determinar el color y el icono seg√∫n el tipo
                                let badgeClass = 'secondary';
                                let typeIcon = 'bi-question-circle';
                                let displayType = dtype;
                                let pythonType = 'object';
                                
                                if (dtype.includes('int64')) {
                                    badgeClass = 'success';
                                    typeIcon = 'bi-123';
                                    displayType = 'Num√©rico';
                                    pythonType = 'int';
                                } else if (dtype.includes('float64')) {
                                    badgeClass = 'success';
                                    typeIcon = 'bi-123';
                                    displayType = 'Num√©rico';
                                    pythonType = 'float';
                                } else if (dtype.includes('datetime')) {
                                    badgeClass = 'warning';
                                    typeIcon = 'bi-calendar-date';
                                    displayType = 'Fecha/Hora';
                                    pythonType = 'datetime';
                                } else if (dtype.includes('numeric (stored as text)')) {
                                    badgeClass = 'primary';
                                    typeIcon = 'bi-hash';
                                    displayType = 'Num√©rico (como texto)';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (URL)')) {
                                    badgeClass = 'info';
                                    typeIcon = 'bi-link-45deg';
                                    displayType = 'URL';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (Email)')) {
                                    badgeClass = 'info';
                                    typeIcon = 'bi-envelope';
                                    displayType = 'Email';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (ID/Code)')) {
                                    badgeClass = 'secondary';
                                    typeIcon = 'bi-upc';
                                    displayType = 'ID/C√≥digo';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (Boolean text)')) {
                                    badgeClass = 'danger';
                                    typeIcon = 'bi-toggle-on';
                                    displayType = 'Booleano (texto)';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (str)')) {
                                    badgeClass = 'info';
                                    typeIcon = 'bi-fonts';
                                    displayType = 'Texto';
                                    pythonType = 'str';
                                } else if (dtype.includes('object (')) {
                                    // Extraer el tipo espec√≠fico del par√©ntesis
                                    const match = dtype.match(/object \(([^)]+)\)/);
                                    badgeClass = 'info';
                                    typeIcon = 'bi-box';
                                    displayType = match ? match[1] : 'Objeto';
                                    pythonType = 'object';
                                } else if (dtype.includes('object')) {
                                    badgeClass = 'info';
                                    typeIcon = 'bi-fonts';
                                    displayType = 'Texto';
                                    pythonType = 'str';
                                } else if (dtype.includes('bool')) {
                                    badgeClass = 'danger';
                                    typeIcon = 'bi-toggle-on';
                                    displayType = 'Booleano';
                                    pythonType = 'bool';
                                }
                                
                                return `
                                    <tr class="column-row" data-column="${col}" onclick="selectVariable('${col}', ${isNumeric})">
                                        <td><strong>${col}</strong></td>
                                        <td>
                                            <span class="badge bg-${badgeClass}">
                                                <i class="bi ${typeIcon}"></i> ${pythonType}
                                            </span>
                                            <small class="text-muted d-block">${displayType}</small>
                                        </td>
                                        <td>${colStats.unique_count || 0}</td>
                                        <td>${colStats.null_count || 0}</td>
                                        <td>${colStats.null_percentage ? colStats.null_percentage.toFixed(1) : '0'}%</td>
                                        <td>
                                            ${isNumeric ? 
                                                `<small>
                                                    Œº=${colStats.mean?.toFixed(2) || 'N/A'}, œÉ=${colStats.std?.toFixed(2) || 'N/A'}
                                                    ${colStats.decimals_info ? `<br>Decimales: ${colStats.decimals_info.most_common_decimals || 0}` : ''}
                                                    ${colStats.magnitude_info ? `<br>Magnitud: 10<sup>${colStats.magnitude_info.avg_magnitude}</sup>` : ''}
                                                </small>` : 
                                                `<small>${colStats.unique_count} valores √∫nicos</small>`
                                            }
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); showUniqueValues('${col}')" title="Ver valores √∫nicos">
                                                <i class="bi bi-list-ul"></i>
                                            </button>
                                            ${isNumeric ? `
                                                <button class="btn btn-sm btn-outline-warning ms-1" onclick="event.stopPropagation(); showOutliers('${col}')" title="Ver outliers">
                                                    <i class="bi bi-exclamation-triangle"></i>
                                                </button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Combinar todo
    document.getElementById('datasetDetailContent').innerHTML = 
        dataPreview + variableSelector + generalInfo + detailedAnalysis;
    
    // Actualizar el bot√≥n de an√°lisis para la primera variable
    setTimeout(() => {
        updateAnalysisButton(1);
    }, 100);
}

// Generar gr√°ficos del dataset
function generateDatasetCharts(columns, stats) {
    // Destruir gr√°ficos existentes
    Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
    });
    charts = {};
    
    // Gr√°fico de tipos de datos
    const dataTypes = {};
    columns.forEach(col => {
        const dtype = stats[col]?.dtype || 'unknown';
        const type = dtype.includes('float') || dtype.includes('int') ? 'Num√©rico' : 
                     dtype.includes('object') ? 'Texto' : 
                     dtype.includes('datetime') ? 'Fecha' : 'Otro';
        dataTypes[type] = (dataTypes[type] || 0) + 1;
    });
    
    const ctx1 = document.getElementById('dataTypesChart');
    if (ctx1) {
        charts.dataTypes = new Chart(ctx1, {
            type: 'pie',
            data: {
                labels: Object.keys(dataTypes),
                datasets: [{
                    data: Object.values(dataTypes),
                    backgroundColor: ['#10b981', '#3b82f6', '#a855f7', '#f59e0b']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#f0f9ff' }
                    }
                }
            }
        });
    }
    
    // Gr√°fico de datos faltantes
    const nullData = columns.map(col => stats[col]?.null_percentage || 0);
    const ctx2 = document.getElementById('missingDataChart');
    if (ctx2) {
        charts.missingData = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: columns,
                datasets: [{
                    label: 'Porcentaje de valores nulos',
                    data: nullData,
                    backgroundColor: 'rgba(239, 68, 68, 0.5)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { color: '#f0f9ff' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    x: {
                        ticks: { 
                            color: '#f0f9ff',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
    
    // Gr√°ficos individuales por columna
    columns.forEach((col, index) => {
        const colStats = stats[col];
        if (!colStats) return;
        
        const canvasId = `chart_${index}_${col.replace(/[^a-zA-Z0-9]/g, '_')}`;
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        
        if (colStats.histogram) {
            // Histograma para datos num√©ricos
            const bins = colStats.histogram.bins;
            const counts = colStats.histogram.counts;
            const labels = [];
            for (let i = 0; i < bins.length - 1; i++) {
                labels.push(`${bins[i].toFixed(1)}-${bins[i+1].toFixed(1)}`);
            }
            
            charts[canvasId] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frecuencia',
                        data: counts,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#f0f9ff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#f0f9ff',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        } else if (colStats.top_values) {
            // Gr√°fico de barras para datos categ√≥ricos
            charts[canvasId] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: colStats.top_values.values,
                    datasets: [{
                        label: 'Frecuencia',
                        data: colStats.top_values.counts,
                        backgroundColor: 'rgba(16, 185, 129, 0.5)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#f0f9ff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#f0f9ff',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    });
}

// Generar histograma para variable seleccionada
// Function to add new analysis section
function addNewAnalysis() {
    analysisCount++;
    const data = window.currentDatasetData;
    const columns = data.columns || [];
    const stats = data.stats || {};
    
    const newAnalysisHTML = `
        <div class="card bg-dark border-primary mb-3 analysis-card" data-analysis-id="${analysisCount}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="text-info mb-0">Analyse ${analysisCount}</h6>
                    <button class="btn btn-sm btn-danger" onclick="removeAnalysis(${analysisCount})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <label for="variableSelect${analysisCount}" class="form-label text-info">S√©lectionner Variable:</label>
                        <select class="form-select variable-select" id="variableSelect${analysisCount}" data-analysis-id="${analysisCount}" onchange="updateAnalysisButton(${analysisCount})">
                            <option value="">-- S√©lectionnez une variable --</option>
                            ${columns.map(col => {
                                const colStats = stats[col] || {};
                                const dtype = colStats.dtype || 'unknown';
                                const isNumeric = colStats.mean !== undefined;
                                
                                let typeLabel = dtype;
                                if (dtype.includes('int') || dtype.includes('float')) {
                                    typeLabel = 'üìä Num√©rique';
                                } else if (dtype.includes('datetime')) {
                                    typeLabel = 'üìÖ Date/Heure';
                                } else if (dtype.includes('numeric (stored as text)')) {
                                    typeLabel = 'üî¢ Num√©rique (texte)';
                                } else if (dtype.includes('object')) {
                                    typeLabel = 'üìù Texte';
                                }
                                
                                return `<option value="${col}" data-numeric="${isNumeric}" data-dtype="${dtype}">${col} - ${typeLabel}</option>`;
                            }).join('')}
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-8">
                        <select class="form-select" id="analysisType${analysisCount}" onchange="updateAnalysisButton(${analysisCount})">
                            <option value="histogram">Histogramme</option>
                            <option value="outlier_map" class="numeric-only">Carte des Outliers</option>
                            <option value="boxplot" class="numeric-only">Box Plot</option>
                            <option value="scatter" class="numeric-only">Scatter Plot (2 variables)</option>
                            <option value="lasso" class="numeric-only">LASSO (S√©lection de variables)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" id="analysisButton${analysisCount}" onclick="executeAnalysis(${analysisCount})">
                            <i class="bi bi-graph-up"></i> G√©n√©rer Analyse
                        </button>
                    </div>
                </div>
                <div class="mt-4" id="histogramContainer${analysisCount}" style="display: none;">
                    <canvas id="variableHistogram${analysisCount}" height="400"></canvas>
                </div>
                <div class="mt-3" id="variableStats${analysisCount}" style="display: none;">
                    <!-- Les statistiques de la variable s√©lectionn√©e appara√Ætront ici -->
                </div>
                <div class="mt-3" id="analysisResultContainer${analysisCount}">
                    <!-- Les r√©sultats des analyses avanc√©es appara√Ætront ici -->
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('analysisContainer').insertAdjacentHTML('beforeend', newAnalysisHTML);
}

// Function to remove an analysis
function removeAnalysis(analysisId) {
    const analysisCard = document.querySelector(`[data-analysis-id="${analysisId}"]`);
    if (analysisCard) {
        // Destroy chart if exists
        if (analysisCharts[analysisId]) {
            analysisCharts[analysisId].destroy();
            delete analysisCharts[analysisId];
        }
        // Remove data
        delete analysisData[analysisId];
        // Remove DOM element
        analysisCard.remove();
    }
}

// Nueva funci√≥n para actualizar el bot√≥n seg√∫n el tipo de an√°lisis
function updateAnalysisButton(analysisId) {
    const variableSelect = document.getElementById(`variableSelect${analysisId}`);
    const analysisTypeSelect = document.getElementById(`analysisType${analysisId}`);
    const selectedOption = variableSelect.options[variableSelect.selectedIndex];
    const isNumeric = selectedOption && selectedOption.getAttribute('data-numeric') === 'true';
    
    // Mostrar/ocultar opciones seg√∫n el tipo de variable
    const numericOptions = analysisTypeSelect.querySelectorAll('.numeric-only');
    numericOptions.forEach(option => {
        option.style.display = isNumeric ? 'block' : 'none';
    });
    
    // Si la opci√≥n seleccionada no es v√°lida para el tipo de variable, cambiar a histograma
    const selectedAnalysis = analysisTypeSelect.value;
    if (!isNumeric && ['outlier_map', 'boxplot', 'scatter', 'lasso'].includes(selectedAnalysis)) {
        analysisTypeSelect.value = 'histogram';
    }
}

// Nueva funci√≥n para ejecutar el an√°lisis seleccionado
function executeAnalysis(analysisId) {
    const analysisType = document.getElementById(`analysisType${analysisId}`).value;
    
    switch(analysisType) {
        case 'histogram':
            generateHistogram(analysisId);
            break;
        case 'outlier_map':
        case 'boxplot':
        case 'scatter':
            generateAdvancedAnalysis(analysisId, analysisType);
            break;
        case 'lasso':
            generateLassoForVariable(analysisId);
            break;
        default:
            generateHistogram(analysisId);
    }
}

// Nueva funci√≥n para generar an√°lisis LASSO con variable objetivo espec√≠fica
async function generateLassoForVariable(analysisId) {
    const select = document.getElementById(`variableSelect${analysisId}`);
    const targetVariable = select.value;
    
    if (!targetVariable) {
        showNotification('Erreur', 'Veuillez s√©lectionner une variable cible', 'warning');
        return;
    }
    
    const currentDataset = window.selectedDataset;
    if (!currentDataset || !currentDataset.id) {
        showNotification('Erreur', 'Aucun dataset s√©lectionn√©', 'error');
        return;
    }
    
    try {
        const url = `/api/datasets/${currentDataset.id}/analysis/?type=lasso&target=${encodeURIComponent(targetVariable)}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Erreur lors de la g√©n√©ration de l\'analyse LASSO');
        }
        
        // Mostrar el an√°lisis LASSO
        displayLassoAnalysisForVariable(analysisId, data);
        
    } catch (error) {
        showNotification('Erreur', error.message, 'error');
    }
}

// Funci√≥n para mostrar el an√°lisis LASSO para una variable
function displayLassoAnalysisForVariable(analysisId, data) {
    const container = document.getElementById(`analysisResultContainer${analysisId}`);
    if (!container) return;
    
    let content = `
        <div class="card bg-dark border-secondary">
            <div class="card-header">
                <h6 class="mb-0 text-info">
                    <i class="bi bi-funnel"></i> 
                    LASSO - Pr√©dire ${data.target_column}
                </h6>
            </div>
            <div class="card-body">
                <img src="${data.image}" class="img-fluid" alt="lasso">
                <div class="mt-3">
                    <div class="alert alert-info">
                        <strong>Variable cible:</strong> ${data.target_column}
                        <br>
                        <strong>Meilleur Alpha:</strong> ${data.statistics.best_alpha.toExponential(2)}
                        <br>
                        <strong>Score R¬≤:</strong> ${data.statistics.best_score.toFixed(3)}
                        <br>
                        <strong>Variables s√©lectionn√©es:</strong> ${data.statistics.n_features_selected} sur ${data.statistics.total_features}
                    </div>
                    
                    <h6 class="text-info">Variables Importantes pour pr√©dire ${data.target_column}:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Variable</th>
                                    <th>Coefficient</th>
                                    <th>Impact</th>
                                </tr>
                            </thead>
                            <tbody>
    `;
    
    data.statistics.selected_features.forEach(([feature, coef]) => {
        const color = coef > 0 ? 'text-success' : 'text-danger';
        const impact = Math.abs(coef) > 0.5 ? 'Fort' : (Math.abs(coef) > 0.1 ? 'Moyen' : 'Faible');
        content += `
            <tr>
                <td>${feature}</td>
                <td class="${color}">${coef.toFixed(4)}</td>
                <td>${impact}</td>
            </tr>
        `;
    });
    
    content += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = content;
}

function generateHistogram(analysisId) {
    const select = document.getElementById(`variableSelect${analysisId}`);
    const selectedVariable = select.value;
    
    if (!selectedVariable) {
        showNotification('Erreur', 'Veuillez s√©lectionner une variable', 'warning');
        return;
    }
    
    const data = window.currentDatasetData;
    if (!data || !data.stats) {
        showNotification('Erreur', 'Aucune donn√©e disponible', 'error');
        return;
    }
    
    const colStats = data.stats[selectedVariable];
    const isNumeric = select.options[select.selectedIndex].getAttribute('data-numeric') === 'true';
    
    // Mostrar contenedor
    document.getElementById(`histogramContainer${analysisId}`).style.display = 'block';
    document.getElementById(`variableStats${analysisId}`).style.display = 'block';
    
    // Destruir gr√°fico anterior si existe
    if (analysisCharts[analysisId]) {
        analysisCharts[analysisId].destroy();
    }
    
    const canvas = document.getElementById(`variableHistogram${analysisId}`);
    const ctx = canvas.getContext('2d');
    
    if (isNumeric && colStats.histogram) {
        // Histograma para variables num√©ricas
        const bins = colStats.histogram.bins;
        const counts = colStats.histogram.counts;
        const labels = [];
        
        for (let i = 0; i < bins.length - 1; i++) {
            labels.push(`${bins[i].toFixed(1)} - ${bins[i+1].toFixed(1)}`);
        }
        
        analysisCharts[analysisId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: `Distribuci√≥n de ${selectedVariable}`,
                    data: counts,
                    backgroundColor: 'rgba(0, 212, 255, 0.5)',
                    borderColor: 'rgba(0, 212, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Histograma de ${selectedVariable}`,
                        color: '#00d4ff',
                        font: { size: 16 }
                    },
                    legend: { display: false }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Intervalos',
                            color: '#00d4ff'
                        },
                        ticks: { 
                            color: '#f0f9ff',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Frecuencia',
                            color: '#00d4ff'
                        },
                        beginAtZero: true,
                        ticks: { color: '#f0f9ff' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });
        
        // Mostrar informaci√≥n de outliers si existe
        let outlierInfo = '';
        if (colStats.histogram && colStats.histogram.outliers_info && colStats.histogram.outliers_info.removed_count > 0) {
            const info = colStats.histogram.outliers_info;
            outlierInfo = `
                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>Outliers exclus:</strong> ${info.removed_count} valeurs (${((info.removed_count / info.total_before) * 100).toFixed(1)}%) 
                    ont √©t√© exclues du graphique.<br>
                    <small>Valeurs en dehors de l'intervalle [${info.lower_bound.toFixed(2)}, ${info.upper_bound.toFixed(2)}] (m√©thode IQR)</small>
                </div>
            `;
        }
        
        // Mostrar estad√≠sticas
        let decimalInfo = '';
        if (colStats.decimals_info) {
            decimalInfo = `
                <div class="col-md-4">
                    <small class="text-muted">Decimales:</small><br>
                    <strong>Com√∫n: ${colStats.decimals_info.most_common_decimals || 0}</strong><br>
                    <small>M√°x: ${colStats.decimals_info.max_decimals || 0}, Prom: ${colStats.decimals_info.avg_decimals?.toFixed(1) || 0}</small>
                </div>
            `;
        }
        
        let magnitudeInfo = '';
        if (colStats.magnitude_info) {
            magnitudeInfo = `
                <div class="col-md-4">
                    <small class="text-muted">Orden de Magnitud:</small><br>
                    <strong>10<sup>${colStats.magnitude_info.avg_magnitude}</sup></strong><br>
                    <small>Rango: 10<sup>${colStats.magnitude_info.min_magnitude}</sup> a 10<sup>${colStats.magnitude_info.max_magnitude}</sup></small>
                </div>
            `;
        }
        
        document.getElementById(`variableStats${analysisId}`).innerHTML = `
            <div class="card bg-dark border-info">
                <div class="card-body">
                    <h6 class="text-info mb-3">Estad√≠sticas de ${selectedVariable}</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted">Media:</small><br>
                            <strong>${colStats.mean?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Desviaci√≥n Est√°ndar:</small><br>
                            <strong>${colStats.std?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Mediana:</small><br>
                            <strong>${colStats.q50?.toFixed(2) || 'N/A'}</strong>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <small class="text-muted">M√≠nimo:</small><br>
                            <strong>${colStats.min?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Q1 (25%):</small><br>
                            <strong>${colStats.q25?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Q3 (75%):</small><br>
                            <strong>${colStats.q75?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">M√°ximo:</small><br>
                            <strong>${colStats.max?.toFixed(2) || 'N/A'}</strong>
                        </div>
                    </div>
                    ${decimalInfo || magnitudeInfo ? `
                        <div class="row mt-3">
                            ${decimalInfo}
                            ${magnitudeInfo}
                        </div>
                    ` : ''}
                    ${outlierInfo}
                </div>
            </div>
        `;
    } else if (!isNumeric && colStats.top_values) {
        // Gr√°fico de barras para variables categ√≥ricas
        analysisCharts[analysisId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: colStats.top_values.values,
                datasets: [{
                    label: `Frecuencia de ${selectedVariable}`,
                    data: colStats.top_values.counts,
                    backgroundColor: 'rgba(16, 185, 129, 0.5)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Distribuci√≥n de ${selectedVariable} (Top 10 valores)`,
                        color: '#00d4ff',
                        font: { size: 16 }
                    },
                    legend: { display: false }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Categor√≠as',
                            color: '#00d4ff'
                        },
                        ticks: { 
                            color: '#f0f9ff',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Frecuencia',
                            color: '#00d4ff'
                        },
                        beginAtZero: true,
                        ticks: { color: '#f0f9ff' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });
        
        // Mostrar estad√≠sticas categ√≥ricas
        document.getElementById(`variableStats${analysisId}`).innerHTML = `
            <div class="card bg-dark border-info">
                <div class="card-body">
                    <h6 class="text-info mb-3">Informaci√≥n de ${selectedVariable}</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted">Valores √∫nicos:</small><br>
                            <strong>${colStats.unique_count || 0}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Valores nulos:</small><br>
                            <strong>${colStats.null_count || 0} (${colStats.null_percentage?.toFixed(1) || 0}%)</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Moda:</small><br>
                            <strong>${colStats.top_values?.values[0] || 'N/A'}</strong>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        document.getElementById(`histogramContainer${analysisId}`).innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> Aucune donn√©e de distribution disponible pour cette variable
            </div>
        `;
        document.getElementById(`variableStats${analysisId}`).innerHTML = '';
    }
    
    // Save analysis data for report generation
    analysisData[analysisId] = {
        variable: selectedVariable,
        isNumeric: isNumeric,
        stats: colStats,
        chartData: analysisCharts[analysisId] ? analysisCharts[analysisId].toBase64Image() : null,
        outlierInfo: colStats.histogram?.outliers_info || null
    };
}

// Actualizar estad√≠sticas
function updateStats(datasetList) {
    const totalSize = datasetList.reduce((sum, d) => sum + (d.file_size || 0), 0);
    const totalRows = datasetList.reduce((sum, d) => sum + (d.row_count || 0), 0);
    const lastDate = datasetList.length > 0 ? 
        new Date(Math.max(...datasetList.map(d => new Date(d.uploaded_at || d.created_at)))).toLocaleDateString('fr-FR') : '-';
    
    document.getElementById('totalDatasets').textContent = datasetList.length;
    document.getElementById('totalSize').textContent = (totalSize / 1024 / 1024).toFixed(2) + ' MB';
    document.getElementById('totalRows').textContent = totalRows.toLocaleString();
    document.getElementById('lastUpdate').textContent = lastDate;
}

// Inicializar drag & drop
function initDragDrop() {
    const uploadArea = document.querySelector('.upload-area');
    
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    uploadArea.addEventListener('drop', handleDrop);
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('active');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('active');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('active');
    
    const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.csv'));
    if (files.length > 0) {
        handleFiles(files);
    } else {
        showNotification('Erreur', 'Veuillez d√©poser uniquement des fichiers CSV', 'error');
    }
}

function handleFileSelect(input) {
    const files = Array.from(input.files);
    if (files.length > 0) {
        handleFiles(files);
    }
}

// Traiter les fichiers
function handleFiles(files) {
    files.forEach(file => uploadFile(file));
}

// Forcer la fermeture du modal d'upload
function forceCloseUploadModal() {
    const modalElement = document.getElementById('uploadProgressModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
        modal.hide();
    }
    // Nettoyer tous les backdrops et styles
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
}

// Upload d'un fichier
function uploadFile(file) {
    // Nettoyer les modals existants avant d'en cr√©er un nouveau
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
    
    const modalElement = document.getElementById('uploadProgressModal');
    // V√©rifier si une instance existe d√©j√†
    let modal = bootstrap.Modal.getInstance(modalElement);
    if (!modal) {
        modal = new bootstrap.Modal(modalElement, {
            backdrop: 'static',
            keyboard: false
        });
    }
    document.getElementById('uploadFileName').textContent = file.name;
    modal.show();
    
    const formData = new FormData();
    formData.append('name', file.name.replace('.csv', ''));
    formData.append('file', file);
    formData.append('description', `Dataset import√© depuis ${file.name}`);
    
    // Simuler la progression
    let progress = 0;
    const progressBar = document.getElementById('uploadProgressBar');
    const progressInterval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
        progressBar.textContent = Math.round(progress) + '%';
    }, 200);
    
    fetch('/api/datasets/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        document.getElementById('uploadStatus').textContent = 'Upload termin√© avec succ√®s!';
        
        setTimeout(() => {
            modal.hide();
            // Forcer la suppression du backdrop
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
            
            showNotification('Succ√®s!', `Dataset "${file.name}" charg√© avec succ√®s`, 'success');
            loadDatasets();
        }, 1000);
    })
    .catch(error => {
        clearInterval(progressInterval);
        modal.hide();
        // Forcer la suppression du backdrop en cas d'erreur
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('overflow');
        document.body.style.removeProperty('padding-right');
        
        showNotification('Erreur', 'Erreur lors du chargement: ' + error, 'error');
    });
}


// T√©l√©charger un dataset
function downloadDataset(datasetId) {
    const dataset = datasetId ? datasets.find(d => d.id === datasetId) : selectedDataset;
    if (!dataset) return;
    
    // Mostrar notificaci√≥n de inicio de descarga
    showNotification('T√©l√©chargement', `T√©l√©chargement du dataset "${dataset.name}" en cours...`, 'info');
    
    // Descargar el archivo CSV
    window.location.href = `/api/datasets/${dataset.id}/download/`;
}

// Descargar reporte del an√°lisis
function downloadReport() {
    if (!selectedDataset) return;
    
    showNotification('G√©n√©ration du rapport', 'G√©n√©ration du rapport d\'analyse en cours...', 'info');
    
    // Prepare chart data to send
    const chartsData = {};
    for (const [analysisId, data] of Object.entries(analysisData)) {
        if (analysisCharts[analysisId]) {
            chartsData[analysisId] = {
                variable: data.variable,
                isNumeric: data.isNumeric,
                chartImage: analysisCharts[analysisId].toBase64Image(),
                outlierInfo: data.outlierInfo
            };
        }
    }
    
    // Hacer petici√≥n para generar el reporte
    fetch(`/api/datasets/${selectedDataset.id}/report/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            charts: chartsData
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erreur lors de la g√©n√©ration du rapport');
        }
        return response.blob();
    })
    .then(blob => {
        // Crear URL temporal para descargar
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `rapport_${selectedDataset.name}_${new Date().toISOString().split('T')[0]}.html`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showNotification('Succ√®s!', 'Rapport t√©l√©charg√© avec succ√®s', 'success');
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur', 'Erreur lors de la g√©n√©ration du rapport', 'error');
    });
}

// Supprimer un dataset
function deleteDataset(datasetId) {
    const dataset = datasetId ? datasets.find(d => d.id === datasetId) : selectedDataset;
    if (!dataset) return;
    
    Swal.fire({
        title: '√ätes-vous s√ªr?',
        text: `Voulez-vous vraiment supprimer le dataset "${dataset.name}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Oui, supprimer',
        cancelButtonText: 'Annuler'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading();
            
            fetch(`/api/datasets/${dataset.id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                hideLoading();
                if (response.ok) {
                    showNotification('Succ√®s!', 'Dataset supprim√© avec succ√®s', 'success');
                    if (!datasetId) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('datasetDetailModal'));
                        if (modal) modal.hide();
                    }
                    loadDatasets();
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Erreur de suppression:', error);
                showNotification('Erreur', 'Erreur lors de la suppression: ' + error.message, 'error');
            });
        }
    });
}

// Seleccionar una variable
function selectVariable(columnName, isNumeric) {
    // Remover selecci√≥n previa
    document.querySelectorAll('.column-row').forEach(row => {
        row.classList.remove('selected');
    });
    
    // Agregar selecci√≥n actual
    const currentRow = document.querySelector(`tr[data-column="${columnName}"]`);
    if (currentRow) {
        currentRow.classList.add('selected');
    }
    
    // Guardar variable seleccionada
    window.selectedVariable = {
        name: columnName,
        isNumeric: isNumeric
    };
}

// Mostrar valores √∫nicos
function showUniqueValues(columnName) {
    const data = window.currentDatasetData;
    if (!data || !data.stats || !data.stats[columnName]) {
        showNotification('Error', 'No hay datos disponibles para esta columna', 'error');
        return;
    }
    
    const colStats = data.stats[columnName];
    let currentPage = 0;
    const itemsPerPage = 20;
    let frequencyData = [];
    let originalFrequencyData = [];
    let currentSort = 'frequency';
    let isLoading = false;
    
    // Crear contenido del modal
    let modalContent = `
        <div class="modal fade" id="uniqueValuesModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-list-ul"></i> An√°lisis de Valores - "${columnName}"
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <span class="badge bg-info">Total: ${colStats.unique_count || 0} valores √∫nicos</span>
                            <span class="badge bg-warning ms-2">Nulos: ${colStats.null_count || 0}</span>
                            <span class="badge bg-success ms-2" id="totalRecords">Total registros: -</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-primary mb-0">Distribuci√≥n de frecuencias:</h6>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-info active" onclick="sortValues('frequency')" id="sortFrequency">
                                    <i class="bi bi-sort-numeric-down"></i> Frecuencia
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="sortValues('value-asc')" id="sortValueAsc">
                                    <i class="bi bi-sort-alpha-down"></i> Valor ‚Üë
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="sortValues('value-desc')" id="sortValueDesc">
                                    <i class="bi bi-sort-alpha-down-alt"></i> Valor ‚Üì
                                </button>
                            </div>
                        </div>
                        <div id="uniqueValuesContent" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-center p-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal anterior si existe
    const existingModal = document.getElementById('uniqueValuesModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Agregar modal al documento
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('uniqueValuesModal'));
    modal.show();
    
    // Funci√≥n para ordenar valores
    window.sortValues = function(sortType) {
        currentSort = sortType;
        currentPage = 0;
        
        // Actualizar botones activos
        document.querySelectorAll('#uniqueValuesModal .btn-group button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        if (sortType === 'frequency') {
            document.getElementById('sortFrequency').classList.add('active');
            frequencyData = [...originalFrequencyData];
        } else if (sortType === 'value-asc') {
            document.getElementById('sortValueAsc').classList.add('active');
            frequencyData = [...originalFrequencyData].sort((a, b) => {
                if (a.value === 'NaN') return 1;
                if (b.value === 'NaN') return -1;
                if (typeof a.value === 'number' && typeof b.value === 'number') {
                    return a.value - b.value;
                }
                return String(a.value).localeCompare(String(b.value));
            });
        } else if (sortType === 'value-desc') {
            document.getElementById('sortValueDesc').classList.add('active');
            frequencyData = [...originalFrequencyData].sort((a, b) => {
                if (a.value === 'NaN') return 1;
                if (b.value === 'NaN') return -1;
                if (typeof a.value === 'number' && typeof b.value === 'number') {
                    return b.value - a.value;
                }
                return String(b.value).localeCompare(String(a.value));
            });
        }
        
        // Re-renderizar
        const container = document.getElementById('uniqueValuesContent');
        container.innerHTML = '';
        renderValues();
    };
    
    // Funci√≥n para cargar valores
    function loadUniqueValues() {
        if (isLoading) return;
        isLoading = true;
        
        fetch(`/api/datasets/${selectedDataset.id}/columns/${encodeURIComponent(columnName)}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                originalFrequencyData = data.frequency_data || [];
                frequencyData = [...originalFrequencyData];
                document.getElementById('totalRecords').textContent = `Total registros: ${data.total_count || 0}`;
                renderValues();
                isLoading = false;
            })
            .catch(error => {
                console.error('Error completo:', error);
                document.getElementById('uniqueValuesContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error al cargar los valores
                        <br><small>${error.message}</small>
                    </div>
                `;
                isLoading = false;
            });
    }
    
    // Funci√≥n para renderizar valores
    function renderValues() {
        const container = document.getElementById('uniqueValuesContent');
        const startIdx = currentPage * itemsPerPage;
        const endIdx = Math.min(startIdx + itemsPerPage, frequencyData.length);
        
        if (currentPage === 0) {
            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>#</th>
                                <th>Valor</th>
                                <th>Frecuencia</th>
                                <th style="min-width: 200px;">Porcentaje</th>
                            </tr>
                        </thead>
                        <tbody id="frequencyTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="loadingIndicator" class="text-center mt-3" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Cargando m√°s...</span>
                    </div>
                </div>
            `;
        }
        
        // Agregar filas
        const tbody = document.getElementById('frequencyTableBody');
        for (let i = startIdx; i < endIdx; i++) {
            const item = frequencyData[i];
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="text-muted">${i + 1}</td>
                <td><code>${item.value}</code></td>
                <td>${item.count.toLocaleString()}</td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="progress flex-grow-1" style="height: 20px;">
                            <div class="progress-bar ${item.percentage > 10 ? 'bg-primary' : 'bg-info'}" 
                                 role="progressbar" 
                                 style="width: ${item.percentage}%">
                                ${item.percentage > 5 ? item.percentage.toFixed(2) + '%' : ''}
                            </div>
                        </div>
                        <span class="ms-2 text-nowrap" style="min-width: 60px; text-align: right;">
                            ${item.percentage.toFixed(2)}%
                        </span>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        }
        
        // Configurar scroll infinito
        const scrollContainer = document.getElementById('uniqueValuesContent');
        scrollContainer.onscroll = function() {
            if (scrollContainer.scrollTop + scrollContainer.clientHeight >= scrollContainer.scrollHeight - 50) {
                if (currentPage * itemsPerPage < frequencyData.length) {
                    currentPage++;
                    document.getElementById('loadingIndicator').style.display = 'block';
                    setTimeout(() => {
                        renderValues();
                        document.getElementById('loadingIndicator').style.display = 'none';
                    }, 200);
                }
            }
        };
    }
    
    // Cargar valores iniciales
    loadUniqueValues();
    
    // Limpiar al cerrar
    document.getElementById('uniqueValuesModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
}

// Mostrar outliers
function showOutliers(columnName) {
    const data = window.currentDatasetData;
    if (!data || !data.stats || !data.stats[columnName]) {
        showNotification('Error', 'No hay datos disponibles para esta columna', 'error');
        return;
    }
    
    const colStats = data.stats[columnName];
    
    if (!colStats.q25 || !colStats.q75) {
        showNotification('Error', 'No se pueden calcular outliers para esta columna', 'warning');
        return;
    }
    
    // Calcular outliers localmente
    const iqr = colStats.q75 - colStats.q25;
    const lowerBound = colStats.q25 - (1.5 * iqr);
    const upperBound = colStats.q75 + (1.5 * iqr);
    
    // Variables para scroll infinito
    let outlierValues = [];
    let currentPage = 0;
    const itemsPerPage = 20;
    let isLoading = false;
    
    // Crear contenido del modal
    let modalContent = `
        <div class="modal fade" id="outliersModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-exclamation-triangle"></i> An√°lisis de Outliers - "${columnName}"
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card bg-dark border-info">
                                    <div class="card-body">
                                        <h6 class="text-info">M√©todo IQR (Rango Intercuart√≠lico)</h6>
                                        <p class="mb-2"><strong>Q1 (25%):</strong> ${colStats.q25.toFixed(2)}</p>
                                        <p class="mb-2"><strong>Q3 (75%):</strong> ${colStats.q75.toFixed(2)}</p>
                                        <p class="mb-2"><strong>IQR:</strong> ${iqr.toFixed(2)}</p>
                                        <hr>
                                        <p class="mb-2"><strong>L√≠mite inferior:</strong> ${lowerBound.toFixed(2)}</p>
                                        <p class="mb-0"><strong>L√≠mite superior:</strong> ${upperBound.toFixed(2)}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-dark border-warning">
                                    <div class="card-body">
                                        <h6 class="text-warning">Resumen de Outliers</h6>
                                        <p class="mb-2">
                                            <i class="bi bi-arrow-down-circle"></i> 
                                            <strong>Valores por debajo:</strong> 
                                            ${colStats.min < lowerBound ? 
                                                `<span class="text-danger">S√≠ (min: ${colStats.min.toFixed(2)})</span>` : 
                                                '<span class="text-success">No</span>'}
                                        </p>
                                        <p class="mb-2">
                                            <i class="bi bi-arrow-up-circle"></i> 
                                            <strong>Valores por encima:</strong> 
                                            ${colStats.max > upperBound ? 
                                                `<span class="text-danger">S√≠ (max: ${colStats.max.toFixed(2)})</span>` : 
                                                '<span class="text-success">No</span>'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="text-primary mb-3">Diagrama de Caja (Box Plot)</h6>
                        <div class="text-center mb-4">
                            <canvas id="outlierBoxPlot" height="200"></canvas>
                        </div>
                        
                        <h6 class="text-primary mb-3">Valores Outliers Detectados</h6>
                        <div id="outlierValuesContent" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center p-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3" id="outlierRangeInfo" style="display: none;">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                <strong>Rango de valores normales:</strong> [${lowerBound.toFixed(2)}, ${upperBound.toFixed(2)}]
                                <br>
                                <small>Los valores fuera de este rango se consideran outliers potenciales.</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal anterior si existe
    const existingModal = document.getElementById('outliersModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Agregar modal al documento
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('outliersModal'));
    modal.show();
    
    // Funci√≥n para cargar outliers
    function loadOutliers() {
        if (isLoading) return;
        isLoading = true;
        
        // Mostrar el rango de outliers
        document.getElementById('outlierRangeInfo').style.display = 'block';
        
        fetch(`/api/datasets/${selectedDataset.id}/columns/${encodeURIComponent(columnName)}/`)
            .then(response => response.json())
            .then(data => {
                const outlierInfo = data.outlier_info;
                if (outlierInfo) {
                    outlierValues = outlierInfo.outlier_values || [];
                    renderOutliers();
                    
                    // Actualizar estad√≠sticas en el DOM
                    if (outlierInfo) {
                        // Actualizar el contador de outliers
                        const outlierCountEl = document.querySelector('.card-body .text-danger');
                        if (outlierCountEl) {
                            outlierCountEl.textContent = outlierInfo.outlier_count;
                        }
                        
                        // Actualizar el porcentaje
                        const outlierPercentEl = document.querySelector('.card-body .text-warning');
                        if (outlierPercentEl) {
                            outlierPercentEl.textContent = outlierInfo.outlier_percentage.toFixed(2) + '%';
                        }
                    }
                    
                    // Crear box plot
                    setTimeout(() => {
                        const ctx = document.getElementById('outlierBoxPlot').getContext('2d');
                        new Chart(ctx, {
                            type: 'boxplot',
                            data: {
                                labels: [columnName],
                                datasets: [{
                                    label: 'Distribuci√≥n',
                                    backgroundColor: 'rgba(0, 212, 255, 0.5)',
                                    borderColor: 'rgba(0, 212, 255, 1)',
                                    borderWidth: 1,
                                    outlierColor: '#ff0000',
                                    data: [{
                                        min: colStats.min,
                                        q1: outlierInfo.q1,
                                        median: colStats.q50,
                                        q3: outlierInfo.q3,
                                        max: colStats.max,
                                        outliers: outlierValues.slice(0, 50) // Mostrar m√°ximo 50 outliers en el gr√°fico
                                    }]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const data = context.parsed;
                                                return [
                                                    `Min: ${data.min.toFixed(2)}`,
                                                    `Q1: ${data.q1.toFixed(2)}`,
                                                    `Mediana: ${data.median.toFixed(2)}`,
                                                    `Q3: ${data.q3.toFixed(2)}`,
                                                    `Max: ${data.max.toFixed(2)}`
                                                ];
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        ticks: { color: '#f0f9ff' },
                                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                    }
                                }
                            }
                        });
                    }, 100);
                }
                isLoading = false;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('outlierValuesContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error al cargar los outliers
                    </div>
                `;
                isLoading = false;
            });
    }
    
    // Funci√≥n para renderizar outliers
    function renderOutliers() {
        const container = document.getElementById('outlierValuesContent');
        const startIdx = currentPage * itemsPerPage;
        const endIdx = Math.min(startIdx + itemsPerPage, outlierValues.length);
        
        if (currentPage === 0) {
            if (outlierValues.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> No se detectaron outliers en esta variable
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Valor</th>
                                <th>Tipo</th>
                            </tr>
                        </thead>
                        <tbody id="outlierTableBody">
                        </tbody>
                    </table>
                </div>
                <div id="outlierLoadingIndicator" class="text-center mt-3" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Cargando m√°s...</span>
                    </div>
                </div>
            `;
        }
        
        // Agregar valores
        const tbody = document.getElementById('outlierTableBody');
        const iqr = colStats.q75 - colStats.q25;
        const lowerBound = colStats.q25 - (1.5 * iqr);
        const upperBound = colStats.q75 + (1.5 * iqr);
        
        for (let i = startIdx; i < endIdx; i++) {
            const value = outlierValues[i];
            const type = value < lowerBound ? 'Bajo' : 'Alto';
            const typeClass = value < lowerBound ? 'text-info' : 'text-warning';
            
            tbody.innerHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td><strong>${value.toFixed(4)}</strong></td>
                    <td><span class="${typeClass}">${type}</span></td>
                </tr>
            `;
        }
        
        // Configurar scroll infinito
        const scrollContainer = document.getElementById('outlierValuesContent');
        scrollContainer.onscroll = function() {
            if (scrollContainer.scrollTop + scrollContainer.clientHeight >= scrollContainer.scrollHeight - 50) {
                if (currentPage * itemsPerPage < outlierValues.length) {
                    currentPage++;
                    document.getElementById('outlierLoadingIndicator').style.display = 'block';
                    setTimeout(() => {
                        renderOutliers();
                        document.getElementById('outlierLoadingIndicator').style.display = 'none';
                    }, 300);
                }
            }
        };
    }
    
    // Cargar outliers iniciales
    loadOutliers();
    
    // Limpiar al cerrar
    document.getElementById('outliersModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
}

// Funci√≥n de limpieza de emergencia
function emergencyCleanup() {
    // Cerrar todos los modales abiertos
    document.querySelectorAll('.modal.show').forEach(modal => {
        const modalInstance = bootstrap.Modal.getInstance(modal);
        if (modalInstance) {
            modalInstance.hide();
        }
    });
    
    // Eliminar todos los backdrops
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    
    // Limpiar clases del body
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
    
    // Ocultar loading spinner
    hideLoading();
}

// Detectar tecla ESC para limpieza de emergencia
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        emergencyCleanup();
    }
});

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // Limpiar cualquier modal o backdrop residual al cargar la p√°gina
    emergencyCleanup();
    
    // Agregar listeners para limpiar cuando se ocultan los modals
    const uploadModal = document.getElementById('uploadProgressModal');
    uploadModal.addEventListener('hidden.bs.modal', function () {
        setTimeout(() => {
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        }, 100);
    });
    
    const detailModal = document.getElementById('datasetDetailModal');
    detailModal.addEventListener('hidden.bs.modal', function () {
        setTimeout(() => {
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        }, 100);
    });
    
    loadDatasets();
    initDragDrop();
    
    // Actualiser toutes les 30 secondes
    setInterval(loadDatasets, 30000);
});
</script>

<!-- Script para an√°lisis avanzados -->
<script src="{% static 'js/dataset-analysis.js' %}"></script>

{% endblock %}