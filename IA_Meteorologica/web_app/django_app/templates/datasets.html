{% extends 'base.html' %}

{% block title %}Datasets - IA M√©t√©orologique{% endblock %}

{% block extra_css %}
<style>
    /* Estilos mejorados para datasets */
    .dataset-card {
        background: rgba(10, 14, 39, 0.8);
        border: 2px solid rgba(0, 212, 255, 0.3);
        border-radius: 20px;
        padding: 30px;
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }
    
    .dataset-card::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(0, 212, 255, 0.1) 0%, transparent 70%);
        transform: rotate(45deg);
        transition: all 0.5s ease;
        opacity: 0;
    }
    
    .dataset-card:hover {
        transform: translateY(-10px);
        border-color: rgba(0, 212, 255, 0.8);
        box-shadow: 0 15px 40px rgba(0, 212, 255, 0.3);
    }
    
    .dataset-card:hover::before {
        opacity: 1;
    }
    
    .dataset-icon {
        font-size: 4rem;
        background: linear-gradient(135deg, #00d4ff, #0099ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .dataset-stats {
        display: flex;
        justify-content: space-around;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(0, 212, 255, 0.2);
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #00d4ff;
    }
    
    .upload-area {
        background: rgba(0, 212, 255, 0.05);
        border: 3px dashed rgba(0, 212, 255, 0.5);
        border-radius: 20px;
        padding: 60px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .upload-area:hover {
        border-color: #00d4ff;
        background: rgba(0, 212, 255, 0.1);
    }
    
    .upload-area.active {
        border-color: #00ff88;
        background: rgba(0, 255, 136, 0.1);
        box-shadow: inset 0 0 30px rgba(0, 255, 136, 0.2);
    }
    
    .quick-actions {
        position: absolute;
        top: 15px;
        right: 15px;
        display: flex;
        gap: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .dataset-card:hover .quick-actions {
        opacity: 1;
    }
    
    .quick-actions button {
        background: rgba(0, 212, 255, 0.2);
        border: 1px solid rgba(0, 212, 255, 0.5);
        color: #00d4ff;
        padding: 8px 12px;
        border-radius: 10px;
        transition: all 0.3s ease;
    }
    
    .quick-actions button:hover {
        background: rgba(0, 212, 255, 0.4);
        transform: scale(1.1);
    }
    
    /* Estilos para el modal de detalles */
    .column-stats {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }
    
    .column-stats:hover {
        background: rgba(0, 212, 255, 0.1);
        border-color: rgba(0, 212, 255, 0.5);
    }
    
    .column-type {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .column-type.type-numeric {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }
    
    .column-type.type-text {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }
    
    .column-type.type-datetime {
        background: rgba(168, 85, 247, 0.2);
        color: #a855f7;
    }
    
    .data-preview {
        background: rgba(10, 14, 39, 0.5);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 20px;
        overflow-x: auto;
    }
    
    .data-preview table {
        color: #f0f9ff;
    }
    
    .data-preview th {
        background: rgba(0, 212, 255, 0.1);
        color: #00d4ff;
        font-weight: 600;
        border-color: rgba(0, 212, 255, 0.2);
    }
    
    .data-preview td {
        border-color: rgba(0, 212, 255, 0.1);
    }
    
    .chart-container {
        background: rgba(10, 14, 39, 0.5);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 10px;
        padding: 20px;
    }
    
    /* Estilos para los an√°lisis */
    .stat-card {
        background: rgba(0, 212, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 15px;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        background: rgba(0, 212, 255, 0.1);
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
    }
    
    .accordion-button {
        background: rgba(0, 212, 255, 0.05);
        color: #f0f9ff;
    }
    
    .accordion-button:not(.collapsed) {
        background: rgba(0, 212, 255, 0.1);
        color: #00d4ff;
    }
    
    .accordion-body {
        background: rgba(10, 14, 39, 0.5);
        border-top: 1px solid rgba(0, 212, 255, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-5">
        <div class="col-12">
            <h1 class="text-white fw-bold">
                <i class="bi bi-database"></i> Gestion des Datasets
            </h1>
            <p class="text-white-50">Importez et g√©rez vos donn√©es m√©t√©orologiques</p>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-database-fill text-primary" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="totalDatasets">0</h3>
                    <p class="text-muted mb-0">Datasets Total</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-hdd-fill text-success" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="totalSize">0 MB</h3>
                    <p class="text-muted mb-0">Espace Utilis√©</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-bar-chart-fill text-info" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="totalRows">0</h3>
                    <p class="text-muted mb-0">Lignes Totales</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-calendar3 text-warning" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="lastUpdate">-</h3>
                    <p class="text-muted mb-0">Derni√®re Mise √† Jour</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Upload Area -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <i class="bi bi-cloud-arrow-up" style="font-size: 4rem; color: #00d4ff;"></i>
                <h4 class="mt-3 text-white">Glissez vos fichiers CSV ici</h4>
                <p class="text-muted">ou cliquez pour parcourir</p>
                <input type="file" id="fileInput" multiple accept=".csv" style="display: none;" onchange="handleFileSelect(this)">
            </div>
        </div>
    </div>
    
    <!-- Datasets Grid -->
    <div class="row g-4" id="datasetsGrid">
        <!-- Les datasets seront charg√©s ici -->
    </div>
</div>

<!-- Modal Detail Dataset -->
<div class="modal fade" id="datasetDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="datasetDetailTitle">
                    <i class="bi bi-database"></i> D√©tails du Dataset
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="datasetDetailContent">
                <!-- Le contenu sera charg√© dynamiquement -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Fermer
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteDataset()">
                    <i class="bi bi-trash"></i> Supprimer
                </button>
                <button type="button" class="btn btn-info" onclick="analyzeDataset()">
                    <i class="bi bi-graph-up"></i> Analyser
                </button>
                <button type="button" class="btn btn-primary" onclick="downloadDataset()">
                    <i class="bi bi-download"></i> T√©l√©charger
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Upload Progress -->
<div class="modal fade" id="uploadProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-cloud-upload"></i> Chargement en cours
                </h5>
                <button type="button" class="btn-close" onclick="forceCloseUploadModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong id="uploadFileName">Fichier.csv</strong>
                </div>
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="uploadProgressBar">0%</div>
                </div>
                <div class="text-muted small" id="uploadStatus">Pr√©paration du fichier...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="forceCloseUploadModal()">
                    <i class="bi bi-x-circle"></i> Annuler
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let datasets = [];
let selectedDataset = null;
let charts = {};

// Funci√≥n para obtener el CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Charger les datasets
function loadDatasets() {
    showLoading();
    
    fetch('/api/datasets/')
        .then(response => response.json())
        .then(data => {
            datasets = data;
            displayDatasets(data);
            updateStats(data);
            hideLoading();
        })
        .catch(error => {
            console.error('Erreur:', error);
            hideLoading();
            showNotification('Erreur', 'Impossible de charger les datasets', 'error');
        });
}

// Afficher les datasets
function displayDatasets(datasetList) {
    const grid = document.getElementById('datasetsGrid');
    grid.innerHTML = '';
    
    if (datasetList.length === 0) {
        grid.innerHTML = `
            <div class="col-12 text-center">
                <p class="text-muted">Aucun dataset disponible. Importez votre premier dataset!</p>
            </div>
        `;
        return;
    }
    
    datasetList.forEach(dataset => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4';
        const size = dataset.file_size ? (dataset.file_size / 1024 / 1024).toFixed(2) : '0';
        
        col.innerHTML = `
            <div class="card dataset-card h-100" onclick="showDatasetDetails(${dataset.id})">
                <div class="quick-actions">
                    <button onclick="event.stopPropagation(); downloadDataset(${dataset.id})" title="T√©l√©charger">
                        <i class="bi bi-download"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteDataset(${dataset.id})" title="Supprimer">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="dataset-icon">
                        <i class="bi bi-file-earmark-spreadsheet"></i>
                    </div>
                    <h5 class="card-title text-center mb-3">${dataset.name}</h5>
                    <p class="text-muted small text-center mb-3">
                        ${dataset.description || 'Dataset m√©t√©orologique'}
                    </p>
                    <div class="dataset-stats">
                        <div class="stat-item">
                            <div class="stat-value">${dataset.row_count || 0}</div>
                            <div class="text-muted small">Lignes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${dataset.column_count || 0}</div>
                            <div class="text-muted small">Colonnes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${size}</div>
                            <div class="text-muted small">MB</div>
                        </div>
                    </div>
                    <div class="text-center mt-3 text-muted small">
                        <i class="bi bi-calendar3"></i> 
                        ${dataset.created_at ? new Date(dataset.created_at).toLocaleDateString('fr-FR') : 'Date inconnue'}
                    </div>
                </div>
            </div>
        `;
        grid.appendChild(col);
    });
}

// Afficher les d√©tails d'un dataset
function showDatasetDetails(datasetId) {
    selectedDataset = datasets.find(d => d.id === datasetId);
    if (!selectedDataset) return;
    
    // Fermer tous les modals ouverts d'abord
    document.querySelectorAll('.modal.show').forEach(modalEl => {
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) {
            modalInstance.hide();
        }
    });
    
    // Attendre un peu pour que Bootstrap nettoie
    setTimeout(() => {
        // Limpiar cualquier modal o backdrop previo
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('overflow');
        document.body.style.removeProperty('padding-right');
        
        // Asegurar que no haya loading activo
        hideLoading();
        
        const modalElement = document.getElementById('datasetDetailModal');
        // Verificar si ya existe una instancia
        let modal = bootstrap.Modal.getInstance(modalElement);
        if (!modal) {
            modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: true
            });
        }
        
        document.getElementById('datasetDetailTitle').innerHTML = `
            <i class="bi bi-database"></i> ${selectedDataset.name}
        `;
        
        // Mostrar loading en el contenido
        document.getElementById('datasetDetailContent').innerHTML = `
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Cargando an√°lisis del dataset...</p>
            </div>
        `;
        
        // Mostrar el modal
        modal.show();
        
        // Cargar los datos del dataset
        fetch(`/api/datasets/${datasetId}/columns/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                displayDatasetDetails(selectedDataset, data);
            })
            .catch(error => {
                console.error('Error completo:', error);
                document.getElementById('datasetDetailContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error al cargar los detalles del dataset
                        <br><small>${error.message}</small>
                    </div>
                `;
            });
    }, 100);
}

// Mostrar an√°lisis completo del dataset
function displayDatasetDetails(dataset, data) {
    const shape = data.shape || [0, 0];
    const rows = shape[0];
    const cols = shape[1];
    const stats = data.stats || {};
    const preview = data.preview || {};
    const columns = data.columns || [];
    const memoryUsage = data.memory_usage ? data.memory_usage.toFixed(2) : '0';
    const totalNulls = data.total_null_count || 0;
    
    // Guardar datos en variable global para uso posterior
    window.currentDatasetData = data;
    
    // Preview de datos PRIMERO
    let dataPreview = `
        <div class="row mb-4">
            <div class="col-md-12">
                <h5 class="text-primary mb-3"><i class="bi bi-eye"></i> Vista Previa de Datos (Primeras 10 filas)</h5>
                <div class="table-responsive" style="max-height: 300px; overflow: auto;">
                    <table class="table table-sm table-striped table-hover">
                        <thead class="table-dark sticky-top">
                            <tr>
                                ${columns.map(col => `<th class="text-nowrap">${col}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    // Generar filas del preview
    for (let i = 0; i < 10 && i < rows; i++) {
        dataPreview += '<tr>';
        columns.forEach(col => {
            const value = preview[col] && preview[col][i] !== undefined ? preview[col][i] : '';
            dataPreview += `<td class="text-nowrap">${value}</td>`;
        });
        dataPreview += '</tr>';
    }
    
    dataPreview += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Selector de variable y generador de histograma
    let variableSelector = `
        <div class="row mb-4">
            <div class="col-md-12">
                <h5 class="text-primary mb-3"><i class="bi bi-bar-chart-line"></i> An√°lisis de Distribuci√≥n</h5>
                <div class="card bg-dark border-primary">
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-8">
                                <label for="variableSelect" class="form-label text-info">Seleccionar Variable:</label>
                                <select class="form-select" id="variableSelect">
                                    <option value="">-- Seleccione una variable --</option>
                                    ${columns.map(col => {
                                        const colStats = stats[col] || {};
                                        const dtype = colStats.dtype || 'unknown';
                                        const isNumeric = colStats.mean !== undefined;
                                        
                                        let typeLabel = dtype;
                                        if (dtype.includes('int') || dtype.includes('float')) {
                                            typeLabel = 'üìä Num√©rico';
                                        } else if (dtype.includes('datetime')) {
                                            typeLabel = 'üìÖ Fecha/Hora';
                                        } else if (dtype.includes('numeric (stored as text)')) {
                                            typeLabel = 'üî¢ Num√©rico (texto)';
                                        } else if (dtype.includes('object')) {
                                            typeLabel = 'üìù Texto';
                                        }
                                        
                                        return `<option value="${col}" data-numeric="${isNumeric}" data-dtype="${dtype}">${col} - ${typeLabel}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" onclick="generateHistogram()">
                                    <i class="bi bi-graph-up"></i> Generar Histograma
                                </button>
                            </div>
                        </div>
                        <div class="mt-4" id="histogramContainer" style="display: none;">
                            <canvas id="variableHistogram" height="400"></canvas>
                        </div>
                        <div class="mt-3" id="variableStats" style="display: none;">
                            <!-- Las estad√≠sticas de la variable seleccionada aparecer√°n aqu√≠ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Info general compacta
    let generalInfo = `
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3">
                            <i class="bi bi-table text-primary" style="font-size: 1.5rem;"></i>
                            <h6 class="mt-2 mb-0">${rows.toLocaleString()} √ó ${cols}</h6>
                            <small class="text-muted">Dimensiones</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3">
                            <i class="bi bi-hdd text-success" style="font-size: 1.5rem;"></i>
                            <h6 class="mt-2 mb-0">${memoryUsage} MB</h6>
                            <small class="text-muted">Memoria</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3">
                            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 1.5rem;"></i>
                            <h6 class="mt-2 mb-0">${totalNulls.toLocaleString()}</h6>
                            <small class="text-muted">Valores Nulos</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card text-center p-3">
                            <i class="bi bi-percent text-info" style="font-size: 1.5rem;"></i>
                            <h6 class="mt-2 mb-0">${rows > 0 ? ((totalNulls / (rows * cols)) * 100).toFixed(2) : '0'}%</h6>
                            <small class="text-muted">Faltantes</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // An√°lisis detallado (simplificado)
    let detailedAnalysis = `
        <div class="row mb-4">
            <div class="col-md-12">
                <h5 class="text-primary mb-3"><i class="bi bi-list-columns-reverse"></i> Informaci√≥n de Variables</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Variable</th>
                                <th>Tipo</th>
                                <th>Valores √önicos</th>
                                <th>Nulos</th>
                                <th>% Nulos</th>
                                <th>Estad√≠sticas</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${columns.map(col => {
                                const colStats = stats[col] || {};
                                const dtype = colStats.dtype || 'unknown';
                                const isNumeric = colStats.mean !== undefined;
                                
                                // Determinar el color y el icono seg√∫n el tipo
                                let badgeClass = 'secondary';
                                let typeIcon = 'bi-question-circle';
                                let displayType = dtype;
                                
                                if (dtype.includes('int') || dtype.includes('float')) {
                                    badgeClass = 'success';
                                    typeIcon = 'bi-123';
                                    displayType = 'Num√©rico';
                                } else if (dtype.includes('datetime')) {
                                    badgeClass = 'warning';
                                    typeIcon = 'bi-calendar-date';
                                    displayType = 'Fecha/Hora';
                                } else if (dtype.includes('numeric (stored as text)')) {
                                    badgeClass = 'primary';
                                    typeIcon = 'bi-hash';
                                    displayType = 'Num√©rico (como texto)';
                                } else if (dtype.includes('object (URL)')) {
                                    badgeClass = 'info';
                                    typeIcon = 'bi-link-45deg';
                                    displayType = 'URL';
                                } else if (dtype.includes('object (Email)')) {
                                    badgeClass = 'info';
                                    typeIcon = 'bi-envelope';
                                    displayType = 'Email';
                                } else if (dtype.includes('object (ID/Code)')) {
                                    badgeClass = 'secondary';
                                    typeIcon = 'bi-upc';
                                    displayType = 'ID/C√≥digo';
                                } else if (dtype.includes('object (Boolean text)')) {
                                    badgeClass = 'danger';
                                    typeIcon = 'bi-toggle-on';
                                    displayType = 'Booleano (texto)';
                                } else if (dtype.includes('object (')) {
                                    // Extraer el tipo espec√≠fico del par√©ntesis
                                    const match = dtype.match(/object \(([^)]+)\)/);
                                    badgeClass = 'info';
                                    typeIcon = 'bi-box';
                                    displayType = match ? match[1] : 'Objeto';
                                } else if (dtype.includes('object')) {
                                    badgeClass = 'info';
                                    typeIcon = 'bi-fonts';
                                    displayType = 'Texto';
                                }
                                
                                return `
                                    <tr>
                                        <td><strong>${col}</strong></td>
                                        <td>
                                            <span class="badge bg-${badgeClass}">
                                                <i class="bi ${typeIcon}"></i> ${displayType}
                                            </span>
                                            <small class="text-muted d-block">${dtype}</small>
                                        </td>
                                        <td>${colStats.unique_count || 0}</td>
                                        <td>${colStats.null_count || 0}</td>
                                        <td>${colStats.null_percentage ? colStats.null_percentage.toFixed(1) : '0'}%</td>
                                        <td>
                                            ${isNumeric ? 
                                                `<small>
                                                    Œº=${colStats.mean?.toFixed(2) || 'N/A'}, œÉ=${colStats.std?.toFixed(2) || 'N/A'}
                                                    ${colStats.decimals_info ? `<br>Decimales: ${colStats.decimals_info.most_common_decimals || 0}` : ''}
                                                    ${colStats.magnitude_info ? `<br>Magnitud: 10<sup>${colStats.magnitude_info.avg_magnitude}</sup>` : ''}
                                                </small>` : 
                                                `<small>${colStats.unique_count} valores √∫nicos</small>`
                                            }
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Combinar todo
    document.getElementById('datasetDetailContent').innerHTML = 
        dataPreview + variableSelector + generalInfo + detailedAnalysis;
}

// Generar gr√°ficos del dataset
function generateDatasetCharts(columns, stats) {
    // Destruir gr√°ficos existentes
    Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
    });
    charts = {};
    
    // Gr√°fico de tipos de datos
    const dataTypes = {};
    columns.forEach(col => {
        const dtype = stats[col]?.dtype || 'unknown';
        const type = dtype.includes('float') || dtype.includes('int') ? 'Num√©rico' : 
                     dtype.includes('object') ? 'Texto' : 
                     dtype.includes('datetime') ? 'Fecha' : 'Otro';
        dataTypes[type] = (dataTypes[type] || 0) + 1;
    });
    
    const ctx1 = document.getElementById('dataTypesChart');
    if (ctx1) {
        charts.dataTypes = new Chart(ctx1, {
            type: 'pie',
            data: {
                labels: Object.keys(dataTypes),
                datasets: [{
                    data: Object.values(dataTypes),
                    backgroundColor: ['#10b981', '#3b82f6', '#a855f7', '#f59e0b']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#f0f9ff' }
                    }
                }
            }
        });
    }
    
    // Gr√°fico de datos faltantes
    const nullData = columns.map(col => stats[col]?.null_percentage || 0);
    const ctx2 = document.getElementById('missingDataChart');
    if (ctx2) {
        charts.missingData = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: columns,
                datasets: [{
                    label: 'Porcentaje de valores nulos',
                    data: nullData,
                    backgroundColor: 'rgba(239, 68, 68, 0.5)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { color: '#f0f9ff' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    x: {
                        ticks: { 
                            color: '#f0f9ff',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
    
    // Gr√°ficos individuales por columna
    columns.forEach((col, index) => {
        const colStats = stats[col];
        if (!colStats) return;
        
        const canvasId = `chart_${index}_${col.replace(/[^a-zA-Z0-9]/g, '_')}`;
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        
        if (colStats.histogram) {
            // Histograma para datos num√©ricos
            const bins = colStats.histogram.bins;
            const counts = colStats.histogram.counts;
            const labels = [];
            for (let i = 0; i < bins.length - 1; i++) {
                labels.push(`${bins[i].toFixed(1)}-${bins[i+1].toFixed(1)}`);
            }
            
            charts[canvasId] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frecuencia',
                        data: counts,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#f0f9ff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#f0f9ff',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        } else if (colStats.top_values) {
            // Gr√°fico de barras para datos categ√≥ricos
            charts[canvasId] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: colStats.top_values.values,
                    datasets: [{
                        label: 'Frecuencia',
                        data: colStats.top_values.counts,
                        backgroundColor: 'rgba(16, 185, 129, 0.5)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#f0f9ff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#f0f9ff',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    });
}

// Generar histograma para variable seleccionada
function generateHistogram() {
    const select = document.getElementById('variableSelect');
    const selectedVariable = select.value;
    
    if (!selectedVariable) {
        showNotification('Error', 'Por favor seleccione una variable', 'warning');
        return;
    }
    
    const data = window.currentDatasetData;
    if (!data || !data.stats) {
        showNotification('Error', 'No hay datos disponibles', 'error');
        return;
    }
    
    const colStats = data.stats[selectedVariable];
    const isNumeric = select.options[select.selectedIndex].getAttribute('data-numeric') === 'true';
    
    // Mostrar contenedor
    document.getElementById('histogramContainer').style.display = 'block';
    document.getElementById('variableStats').style.display = 'block';
    
    // Destruir gr√°fico anterior si existe
    if (window.variableChart) {
        window.variableChart.destroy();
    }
    
    const canvas = document.getElementById('variableHistogram');
    const ctx = canvas.getContext('2d');
    
    if (isNumeric && colStats.histogram) {
        // Histograma para variables num√©ricas
        const bins = colStats.histogram.bins;
        const counts = colStats.histogram.counts;
        const labels = [];
        
        for (let i = 0; i < bins.length - 1; i++) {
            labels.push(`${bins[i].toFixed(1)} - ${bins[i+1].toFixed(1)}`);
        }
        
        window.variableChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: `Distribuci√≥n de ${selectedVariable}`,
                    data: counts,
                    backgroundColor: 'rgba(0, 212, 255, 0.5)',
                    borderColor: 'rgba(0, 212, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Histograma de ${selectedVariable}`,
                        color: '#00d4ff',
                        font: { size: 16 }
                    },
                    legend: { display: false }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Intervalos',
                            color: '#00d4ff'
                        },
                        ticks: { 
                            color: '#f0f9ff',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Frecuencia',
                            color: '#00d4ff'
                        },
                        beginAtZero: true,
                        ticks: { color: '#f0f9ff' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });
        
        // Mostrar estad√≠sticas
        let decimalInfo = '';
        if (colStats.decimals_info) {
            decimalInfo = `
                <div class="col-md-4">
                    <small class="text-muted">Decimales:</small><br>
                    <strong>Com√∫n: ${colStats.decimals_info.most_common_decimals || 0}</strong><br>
                    <small>M√°x: ${colStats.decimals_info.max_decimals || 0}, Prom: ${colStats.decimals_info.avg_decimals?.toFixed(1) || 0}</small>
                </div>
            `;
        }
        
        let magnitudeInfo = '';
        if (colStats.magnitude_info) {
            magnitudeInfo = `
                <div class="col-md-4">
                    <small class="text-muted">Orden de Magnitud:</small><br>
                    <strong>10<sup>${colStats.magnitude_info.avg_magnitude}</sup></strong><br>
                    <small>Rango: 10<sup>${colStats.magnitude_info.min_magnitude}</sup> a 10<sup>${colStats.magnitude_info.max_magnitude}</sup></small>
                </div>
            `;
        }
        
        document.getElementById('variableStats').innerHTML = `
            <div class="card bg-dark border-info">
                <div class="card-body">
                    <h6 class="text-info mb-3">Estad√≠sticas de ${selectedVariable}</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted">Media:</small><br>
                            <strong>${colStats.mean?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Desviaci√≥n Est√°ndar:</small><br>
                            <strong>${colStats.std?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Mediana:</small><br>
                            <strong>${colStats.q50?.toFixed(2) || 'N/A'}</strong>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <small class="text-muted">M√≠nimo:</small><br>
                            <strong>${colStats.min?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Q1 (25%):</small><br>
                            <strong>${colStats.q25?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Q3 (75%):</small><br>
                            <strong>${colStats.q75?.toFixed(2) || 'N/A'}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">M√°ximo:</small><br>
                            <strong>${colStats.max?.toFixed(2) || 'N/A'}</strong>
                        </div>
                    </div>
                    ${decimalInfo || magnitudeInfo ? `
                        <div class="row mt-3">
                            ${decimalInfo}
                            ${magnitudeInfo}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    } else if (!isNumeric && colStats.top_values) {
        // Gr√°fico de barras para variables categ√≥ricas
        window.variableChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: colStats.top_values.values,
                datasets: [{
                    label: `Frecuencia de ${selectedVariable}`,
                    data: colStats.top_values.counts,
                    backgroundColor: 'rgba(16, 185, 129, 0.5)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Distribuci√≥n de ${selectedVariable} (Top 10 valores)`,
                        color: '#00d4ff',
                        font: { size: 16 }
                    },
                    legend: { display: false }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Categor√≠as',
                            color: '#00d4ff'
                        },
                        ticks: { 
                            color: '#f0f9ff',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Frecuencia',
                            color: '#00d4ff'
                        },
                        beginAtZero: true,
                        ticks: { color: '#f0f9ff' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });
        
        // Mostrar estad√≠sticas categ√≥ricas
        document.getElementById('variableStats').innerHTML = `
            <div class="card bg-dark border-info">
                <div class="card-body">
                    <h6 class="text-info mb-3">Informaci√≥n de ${selectedVariable}</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted">Valores √∫nicos:</small><br>
                            <strong>${colStats.unique_count || 0}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Valores nulos:</small><br>
                            <strong>${colStats.null_count || 0} (${colStats.null_percentage?.toFixed(1) || 0}%)</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Moda:</small><br>
                            <strong>${colStats.top_values?.values[0] || 'N/A'}</strong>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        document.getElementById('histogramContainer').innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> No hay datos de distribuci√≥n disponibles para esta variable
            </div>
        `;
        document.getElementById('variableStats').innerHTML = '';
    }
}

// Actualizar estad√≠sticas
function updateStats(datasetList) {
    const totalSize = datasetList.reduce((sum, d) => sum + (d.file_size || 0), 0);
    const totalRows = datasetList.reduce((sum, d) => sum + (d.row_count || 0), 0);
    const lastDate = datasetList.length > 0 ? 
        new Date(Math.max(...datasetList.map(d => new Date(d.created_at)))).toLocaleDateString('fr-FR') : '-';
    
    document.getElementById('totalDatasets').textContent = datasetList.length;
    document.getElementById('totalSize').textContent = (totalSize / 1024 / 1024).toFixed(2) + ' MB';
    document.getElementById('totalRows').textContent = totalRows.toLocaleString();
    document.getElementById('lastUpdate').textContent = lastDate;
}

// Inicializar drag & drop
function initDragDrop() {
    const uploadArea = document.querySelector('.upload-area');
    
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    uploadArea.addEventListener('drop', handleDrop);
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('active');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('active');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('active');
    
    const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.csv'));
    if (files.length > 0) {
        handleFiles(files);
    } else {
        showNotification('Erreur', 'Veuillez d√©poser uniquement des fichiers CSV', 'error');
    }
}

function handleFileSelect(input) {
    const files = Array.from(input.files);
    if (files.length > 0) {
        handleFiles(files);
    }
}

// Traiter les fichiers
function handleFiles(files) {
    files.forEach(file => uploadFile(file));
}

// Forcer la fermeture du modal d'upload
function forceCloseUploadModal() {
    const modalElement = document.getElementById('uploadProgressModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
        modal.hide();
    }
    // Nettoyer tous les backdrops et styles
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
}

// Upload d'un fichier
function uploadFile(file) {
    // Nettoyer les modals existants avant d'en cr√©er un nouveau
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
    
    const modalElement = document.getElementById('uploadProgressModal');
    // V√©rifier si une instance existe d√©j√†
    let modal = bootstrap.Modal.getInstance(modalElement);
    if (!modal) {
        modal = new bootstrap.Modal(modalElement, {
            backdrop: 'static',
            keyboard: false
        });
    }
    document.getElementById('uploadFileName').textContent = file.name;
    modal.show();
    
    const formData = new FormData();
    formData.append('name', file.name.replace('.csv', ''));
    formData.append('file', file);
    formData.append('description', `Dataset import√© depuis ${file.name}`);
    
    // Simuler la progression
    let progress = 0;
    const progressBar = document.getElementById('uploadProgressBar');
    const progressInterval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
        progressBar.textContent = Math.round(progress) + '%';
    }, 200);
    
    fetch('/api/datasets/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        document.getElementById('uploadStatus').textContent = 'Upload termin√© avec succ√®s!';
        
        setTimeout(() => {
            modal.hide();
            // Forcer la suppression du backdrop
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
            
            showNotification('Succ√®s!', `Dataset "${file.name}" charg√© avec succ√®s`, 'success');
            loadDatasets();
        }, 1000);
    })
    .catch(error => {
        clearInterval(progressInterval);
        modal.hide();
        // Forcer la suppression du backdrop en cas d'erreur
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('overflow');
        document.body.style.removeProperty('padding-right');
        
        showNotification('Erreur', 'Erreur lors du chargement: ' + error, 'error');
    });
}

// Analyser un dataset
function analyzeDataset() {
    if (!selectedDataset) return;
    
    showNotification('Analyse', 'Analyse approfondie du dataset en cours...', 'info');
    
    // Rediriger vers une page d'analyse ou ouvrir un modal d'analyse
    setTimeout(() => {
        showNotification('Succ√®s!', 'Analyse termin√©e', 'success');
    }, 2000);
}

// T√©l√©charger un dataset
function downloadDataset(datasetId) {
    const dataset = datasetId ? datasets.find(d => d.id === datasetId) : selectedDataset;
    if (!dataset) return;
    
    // Mostrar notificaci√≥n de inicio de descarga
    showNotification('T√©l√©chargement', `T√©l√©chargement de "${dataset.name}" en cours...`, 'info');
    
    // Descargar el archivo
    window.location.href = `/api/datasets/${dataset.id}/download/`;
}

// Supprimer un dataset
function deleteDataset(datasetId) {
    const dataset = datasetId ? datasets.find(d => d.id === datasetId) : selectedDataset;
    if (!dataset) return;
    
    Swal.fire({
        title: '√ätes-vous s√ªr?',
        text: `Voulez-vous vraiment supprimer le dataset "${dataset.name}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Oui, supprimer',
        cancelButtonText: 'Annuler'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading();
            
            fetch(`/api/datasets/${dataset.id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                hideLoading();
                if (response.ok) {
                    showNotification('Succ√®s!', 'Dataset supprim√© avec succ√®s', 'success');
                    if (!datasetId) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('datasetDetailModal'));
                        if (modal) modal.hide();
                    }
                    loadDatasets();
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Erreur de suppression:', error);
                showNotification('Erreur', 'Erreur lors de la suppression: ' + error.message, 'error');
            });
        }
    });
}

// Funci√≥n de limpieza de emergencia
function emergencyCleanup() {
    // Cerrar todos los modales abiertos
    document.querySelectorAll('.modal.show').forEach(modal => {
        const modalInstance = bootstrap.Modal.getInstance(modal);
        if (modalInstance) {
            modalInstance.hide();
        }
    });
    
    // Eliminar todos los backdrops
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    
    // Limpiar clases del body
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
    
    // Ocultar loading spinner
    hideLoading();
}

// Detectar tecla ESC para limpieza de emergencia
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        emergencyCleanup();
    }
});

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // Limpiar cualquier modal o backdrop residual al cargar la p√°gina
    emergencyCleanup();
    
    // Agregar listeners para limpiar cuando se ocultan los modals
    const uploadModal = document.getElementById('uploadProgressModal');
    uploadModal.addEventListener('hidden.bs.modal', function () {
        setTimeout(() => {
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        }, 100);
    });
    
    const detailModal = document.getElementById('datasetDetailModal');
    detailModal.addEventListener('hidden.bs.modal', function () {
        setTimeout(() => {
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        }, 100);
    });
    
    loadDatasets();
    initDragDrop();
    
    // Actualiser toutes les 30 secondes
    setInterval(loadDatasets, 30000);
});
</script>
{% endblock %}