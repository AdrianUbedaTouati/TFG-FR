{% extends 'base.html' %}
{% load static %}

{% block title %}Gestion des Modèles - MétéoIA{% endblock %}

{% block extra_css %}
<style>
    /* Styles similaires aux cartes de datasets */
    .model-card {
        background: rgba(10, 14, 39, 0.8);
        border: 2px solid rgba(0, 212, 255, 0.3);
        border-radius: 20px;
        padding: 20px;
        transition: all 0.4s ease;
        position: relative;
        overflow: visible;
        display: flex;
        flex-direction: column;
        min-height: 480px;
        height: auto;
        width: 100%;
        backdrop-filter: blur(10px);
    }
    
    @media (max-width: 576px) {
        .model-card {
            height: auto;
            min-height: 420px;
            padding: 15px;
        }
    }
    
    .model-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(138, 43, 226, 0.1) 0%, transparent 70%);
        transform: rotate(45deg);
        transition: all 0.5s ease;
        opacity: 0;
        pointer-events: none;
    }
    
    .model-card:hover {
        transform: translateY(-10px);
        border-color: rgba(138, 43, 226, 0.8);
        box-shadow: 0 15px 40px rgba(138, 43, 226, 0.3);
    }
    
    .model-card:hover::before {
        opacity: 1;
    }
    
    .model-icon {
        font-size: 3rem;
        background: linear-gradient(135deg, #8a2be2, #6366f1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
        text-align: center;
    }
    
    .model-card .card-title {
        color: white !important;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .model-card .card-body {
        display: flex;
        flex-direction: column;
        flex: 1;
        width: 100%;
        padding: 0;
    }
    
    .model-stats {
        display: flex;
        justify-content: space-around;
        margin-top: 15px;
        margin-bottom: 10px;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.3rem;
        font-weight: bold;
        color: #8a2be2;
    }
    
    .quick-actions {
        position: absolute;
        top: 10px;
        right: 15px;
        display: flex;
        gap: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 100;
    }
    
    .model-card:hover .quick-actions {
        opacity: 1;
    }
    
    .quick-actions button {
        background: rgba(138, 43, 226, 0.2);
        border: 2px solid rgba(138, 43, 226, 0.4);
        color: #8a2be2;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .quick-actions button:hover {
        transform: scale(1.1);
    }
    
    .quick-actions button[data-action="train"]:hover {
        background: rgba(138, 43, 226, 0.8);
        border-color: #8a2be2;
        color: white;
        box-shadow: 0 0 20px rgba(138, 43, 226, 0.8);
    }
    
    .quick-actions button[data-action="edit"]:hover {
        background: rgba(99, 102, 241, 0.8);
        border-color: #6366f1;
        color: white;
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.8);
    }
    
    .quick-actions button[data-action="clone"]:hover {
        background: rgba(16, 185, 129, 0.8);
        border-color: #10b981;
        color: white;
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);
    }
    
    .quick-actions button[data-action="delete"]:hover {
        background: rgba(239, 68, 68, 0.8);
        border-color: #ef4444;
        color: white;
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
    }
    
    .model-type-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        background: rgba(138, 43, 226, 0.2);
        color: #8a2be2;
        border: 1px solid rgba(138, 43, 226, 0.3);
    }
    
    .training-status {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.85rem;
    }
    
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }
    
    .status-success { background: #10b981; }
    .status-training { background: #f59e0b; animation: pulse 2s infinite; }
    .status-failed { background: #ef4444; }
    
    .models-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(min(100%, 320px), 1fr));
        gap: 20px;
        padding: 20px 0;
    }
    
    @media (max-width: 576px) {
        .models-container {
            grid-template-columns: 1fr;
            padding: 10px 0;
            gap: 15px;
        }
    }
    
    @media (min-width: 577px) and (max-width: 992px) {
        .models-container {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }
    }
    
    @media (min-width: 993px) {
        .models-container {
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        }
    }
    
    .models-container::-webkit-scrollbar {
        height: 10px;
    }
    
    .models-container::-webkit-scrollbar-track {
        background: rgba(138, 43, 226, 0.1);
        border-radius: 5px;
    }
    
    .models-container::-webkit-scrollbar-thumb {
        background: rgba(138, 43, 226, 0.5);
        border-radius: 5px;
    }
    
    .models-container::-webkit-scrollbar-thumb:hover {
        background: rgba(138, 43, 226, 0.7);
    }
    
    .create-model-card {
        background: rgba(138, 43, 226, 0.1);
        border: 2px dashed rgba(138, 43, 226, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        min-height: 280px;
    }
    
    .create-model-card:hover {
        background: rgba(138, 43, 226, 0.2);
        border-color: #8a2be2;
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(138, 43, 226, 0.3);
    }
    
    .create-model-card i {
        font-size: 3rem;
        color: #8a2be2;
        margin-bottom: 10px;
    }
    
    .create-model-card h5 {
        font-size: 1.1rem;
        margin-bottom: 5px;
    }
    
    .create-model-card p {
        font-size: 0.9rem;
        margin-bottom: 0;
    }
    
    @media (max-width: 576px) {
        .create-model-card {
            min-height: 200px;
        }
        
        .create-model-card i {
            font-size: 2.5rem;
        }
        
        .create-model-card h5 {
            font-size: 1rem;
        }
        
        .create-model-card p {
            font-size: 0.85rem;
        }
    }
    
    /* Empty state message */
    .empty-state-message {
        grid-column: 2 / -1;
        text-align: center;
        padding: 40px 20px;
    }
    
    .empty-state-icon {
        font-size: 4rem;
        color: rgba(138, 43, 226, 0.5);
    }
    
    .empty-state-title {
        color: rgba(255, 255, 255, 0.8);
        font-size: 1.3rem;
        font-weight: 500;
    }
    
    .empty-state-text {
        font-size: 0.95rem;
    }
    
    @media (max-width: 576px) {
        .empty-state-message {
            grid-column: 1 / -1;
            padding: 30px 15px;
        }
        
        .empty-state-icon {
            font-size: 3rem;
        }
        
        .empty-state-title {
            font-size: 1.1rem;
        }
        
        .empty-state-text {
            font-size: 0.9rem;
        }
    }
    
    /* Framework selection modal styles */
    .framework-btn {
        min-height: 150px;
        height: auto;
        padding: 20px;
        border-radius: 15px;
        transition: all 0.3s ease;
        position: relative;
        overflow: visible;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .framework-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }
    
    .framework-btn i {
        font-size: 2rem;
        margin-bottom: 10px;
    }
    
    .framework-btn.btn-outline-primary:hover {
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.9), rgba(13, 110, 253, 0.7));
        border-color: #0d6efd;
        color: white;
    }
    
    .framework-btn.btn-outline-warning:hover {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.9), rgba(255, 193, 7, 0.7));
        border-color: #ffc107;
        color: #000;
    }
    
    #frameworkSelectionModal .modal-content {
        background: rgba(10, 14, 39, 0.95);
        border: 1px solid rgba(138, 43, 226, 0.3);
        border-radius: 20px;
        backdrop-filter: blur(10px);
    }
    
    #frameworkSelectionModal .modal-header {
        border-bottom: 1px solid rgba(138, 43, 226, 0.2);
    }
    
    #frameworkSelectionModal .modal-footer {
        border-top: 1px solid rgba(138, 43, 226, 0.2);
    }
    
    /* Layer builder styles for expert mode */
    .layer-item {
        background: rgba(0, 212, 255, 0.1);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        position: relative;
        transition: all 0.3s ease;
    }
    
    .layer-item:hover {
        background: rgba(0, 212, 255, 0.15);
        transform: translateX(5px);
    }
    
    .layer-item .layer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .layer-item .layer-title {
        font-weight: bold;
        color: #00d4ff;
    }
    
    .layer-item .layer-controls {
        display: flex;
        gap: 10px;
    }
    
    .layer-item .btn-move {
        background: rgba(0, 212, 255, 0.2);
        border: 1px solid rgba(0, 212, 255, 0.4);
        color: #00d4ff;
        padding: 2px 8px;
        font-size: 0.8rem;
        transition: all 0.3s ease;
    }
    
    .layer-item .btn-move:hover:not(:disabled) {
        background: rgba(0, 212, 255, 0.4);
        border-color: #00d4ff;
        box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
    }
    
    .layer-item .btn-delete {
        background: rgba(255, 107, 107, 0.2);
        border: 1px solid rgba(255, 107, 107, 0.4);
        color: #ff6b6b;
        padding: 2px 8px;
        font-size: 0.8rem;
        transition: all 0.3s ease;
    }
    
    .layer-item .btn-delete:hover {
        background: rgba(255, 107, 107, 0.4);
        border-color: #ff6b6b;
        box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
    }
    
    .layer-params {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
    }
    
    /* Replace all gray buttons with vibrant colors */
    .btn-secondary {
        background: rgba(138, 43, 226, 0.2) !important;
        border: 1px solid rgba(138, 43, 226, 0.5) !important;
        color: #ffffff !important;
    }
    
    .btn-secondary:hover {
        background: rgba(138, 43, 226, 0.4) !important;
        border-color: #8a2be2 !important;
        box-shadow: 0 0 20px rgba(138, 43, 226, 0.5) !important;
    }
    
    /* Modal styles */
    .modal-backdrop.show {
        opacity: 0.5;
    }
    
    /* Modal d'historique des entraînements */
    .training-history-item {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(138, 43, 226, 0.3);
        border-radius: 15px;
        padding: 20px;
        padding-right: 15px; /* Reduced right padding */
        margin-bottom: 15px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    /* Ensure modal body has some padding to avoid cutting off content */
    #trainingHistoryModal .modal-body {
        padding-right: 25px;
        overflow-x: hidden;
    }
    
    .training-history-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(138, 43, 226, 0.1), transparent);
        transition: left 0.5s ease;
    }
    
    .training-history-item:hover::before {
        left: 100%;
    }
    
    .training-history-item:hover {
        background: rgba(138, 43, 226, 0.15);
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(138, 43, 226, 0.3);
    }
    
    .training-history-item.completed {
        border-color: rgba(0, 255, 0, 0.3);
    }
    
    .training-history-item.completed:hover {
        background: rgba(0, 255, 0, 0.1);
        box-shadow: 0 5px 20px rgba(0, 255, 0, 0.3);
    }
    
    .training-history-header {
        padding: 10px;
        border-bottom: 1px solid rgba(138, 43, 226, 0.2);
    }
    
    .metrics-summary {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .metric-item {
        display: flex;
        align-items: center;
        gap: 5px;
        background: rgba(138, 43, 226, 0.1);
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
    }
    
    .metric-item i {
        color: #8a2be2;
    }
    
    .metric-label {
        color: #94a3b8;
    }
    
    .metric-value {
        color: #00d4ff;
        font-weight: bold;
    }
    
    .primary-metric {
        background: rgba(16, 185, 129, 0.15) !important;
        border: 1px solid rgba(16, 185, 129, 0.3) !important;
        padding: 6px 12px !important;
        font-size: 0.9rem !important;
    }
    
    .secondary-metrics {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
    }
    
    .secondary-metrics .metric-item {
        flex: 1;
        min-width: 110px;
        font-size: 0.8rem !important;
        padding: 4px 8px !important;
    }
    
    .primary-metric i {
        color: #10b981 !important;
    }
    
    .primary-metric .metric-value {
        color: #10b981 !important;
        font-size: 1rem !important;
    }
    
    .metric-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        margin-right: 5px;
        background: rgba(99, 102, 241, 0.2);
        color: #a5b4fc;
    }
    
    /* Responsive button group in training history */
    .training-history-item .btn-group {
        display: flex;
        flex-wrap: nowrap;
        gap: 3px;
    }
    
    .training-history-item .btn-group .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        white-space: nowrap;
    }
    
    @media (max-width: 992px) {
        .training-history-item .row > div {
            margin-bottom: 10px;
        }
        
        .training-history-item .btn-group {
            justify-content: flex-start;
        }
    }
    
    @media (max-width: 768px) {
        .training-history-item .btn-group {
            flex-wrap: wrap;
        }
        
        .training-history-item .btn-group .btn {
            flex: 1;
            min-width: 80px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 text-white mb-4">
                <i class="bi bi-cpu"></i> Gestion des Modèles
            </h1>
        </div>
    </div>
    
    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-cpu text-primary" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="totalModels">0</h3>
                    <p class="text-muted mb-0">Modèles Définis</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-graph-up text-success" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="totalTrainings">0</h3>
                    <p class="text-muted mb-0">Entraînements Totaux</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-trophy text-warning" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="bestScore">-</h3>
                    <p class="text-muted mb-0">Meilleur Score</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-clock-history text-info" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="lastTraining">-</h3>
                    <p class="text-muted mb-0">Dernier Entraînement</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filtres -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-primary">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label for="searchFilter" class="form-label text-info">Rechercher par nom</label>
                            <input type="text" class="form-control" id="searchFilter" 
                                   placeholder="Nom du modèle..." onkeyup="filterModels()">
                        </div>
                        <div class="col-md-4">
                            <label for="typeFilter" class="form-label text-info">Type de modèle</label>
                            <select class="form-select" id="typeFilter" onchange="filterModels()">
                                <option value="">Tous les types</option>
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-info">Tri</label>
                            <select class="form-select" id="sortFilter" onchange="filterModels()">
                                <option value="modified" selected>Par date de modification</option>
                                <option value="name">Par nom</option>
                                <option value="date">Par date de création</option>
                                <option value="performance">Par performance</option>
                                <option value="trainings">Par nombre d'entraînements</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modèles -->
    <div class="row">
        <div class="col-12">
            <h3 class="text-white mb-3">Modèles Disponibles</h3>
            <div class="models-container" id="modelsContainer">
                <!-- Carte pour créer un nouveau modèle -->
                <div class="card model-card create-model-card" onclick="showCreateModelModal()">
                    <div class="text-center">
                        <i class="bi bi-plus-circle"></i>
                        <h5 class="text-white mt-2">Créer un Nouveau Modèle</h5>
                        <p class="text-muted">Définir et configurer</p>
                    </div>
                </div>
                
                <!-- Les modèles seront chargés ici -->
            </div>
        </div>
    </div>
</div>

<!-- Modal Historique des Entraînements -->
<div class="modal fade" id="trainingHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="trainingHistoryTitle">
                    <i class="bi bi-clock-history"></i> Historique des Entraînements
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="trainingHistoryContent">
                <!-- Le contenu sera chargé dynamiquement -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Édition du Modèle -->
<div class="modal fade" id="editModelModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="editModelTitle">
                    <i class="bi bi-pencil-square"></i> Éditer le Modèle
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="editModelContent">
                <!-- Le contenu sera chargé dynamiquement -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveModelChanges()">
                    <i class="bi bi-save"></i> Enregistrer les modifications
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Configuration d'Entraînement -->
<div class="modal fade" id="trainConfigModal" tabindex="-1">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="trainConfigTitle">
                    <i class="bi bi-gear"></i> Configuration d'Entraînement
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="trainModelInfo" class="text-info mb-3"></p>
                
                <div class="mb-4">
                    <label class="form-label">Division des Données</label>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label for="trainSizeConfig" class="form-label small">Entraînement (%)</label>
                            <input type="number" class="form-control" id="trainSizeConfig" min="40" max="80" value="70" required onchange="updateDataSplitsConfig()">
                        </div>
                        <div class="col-md-4">
                            <label for="valSizeConfig" class="form-label small">Validation (%)</label>
                            <input type="number" class="form-control" id="valSizeConfig" min="10" max="30" value="15" required onchange="updateDataSplitsConfig()">
                        </div>
                        <div class="col-md-4">
                            <label for="testSizeConfig" class="form-label small">Test (%)</label>
                            <input type="number" class="form-control" id="testSizeConfig" min="10" max="30" value="15" readonly style="background-color: rgba(255,255,255,0.1);">
                        </div>
                    </div>
                    <small class="text-muted">Les pourcentages doivent totaliser 100%</small>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Ces paramètres s'appliquent uniquement à cette session d'entraînement.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirmTrainBtn" onclick="confirmTraining()">
                    <i class="bi bi-play-fill"></i> Lancer l'Entraînement
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Créer un Modèle (identique à dashboard) -->
<div class="modal fade" id="createModelModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white">
                    <i class="bi bi-cpu"></i> Créer un Nouveau Modèle
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createModelForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modelName" class="form-label">Nom du Modèle</label>
                                <input type="text" class="form-control" id="modelName" placeholder="Ex: Modèle Météo LSTM v2" required>
                            </div>
                            <div class="mb-3">
                                <label for="modelType" class="form-label">Type de Modèle</label>
                                <select class="form-select" id="modelType" required onchange="updateFrameworkOptions()">
                                    <option value="">Sélectionner...</option>
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                            <div class="mb-3" id="frameworkSelection" style="display: none;">
                                <label for="framework" class="form-label">Framework</label>
                                <select class="form-select" id="framework">
                                    <option value="keras">TensorFlow/Keras</option>
                                    <option value="pytorch">PyTorch</option>
                                </select>
                                <small class="text-muted">Choisissez le framework pour votre modèle de deep learning</small>
                            </div>
                            <div class="mb-3">
                                <label for="dataset" class="form-label">Dataset</label>
                                <select class="form-select" id="dataset" required onchange="loadDatasetColumns()">
                                    <option value="">Sélectionner un dataset...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="modelRequirements" class="model-requirements" style="display: none;">
                                <h6 class="text-warning mb-2"><i class="bi bi-info-circle"></i> Exigences du Modèle</h6>
                                <p id="modelRequirementsText" class="mb-0 small"></p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Colonnes Cibles (à prédire)</label>
                                <div id="targetVariables" class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background: rgba(255, 107, 107, 0.05); border-color: rgba(255, 107, 107, 0.3) !important;">
                                    <p class="text-muted">Sélectionnez d'abord un dataset</p>
                                </div>
                                <small class="text-muted" id="targetHelp">Cliquez pour sélectionner les variables à prédire</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Variables Prédictives</label>
                                <div id="predictorVariables" class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background: rgba(0, 212, 255, 0.05); border-color: rgba(0, 212, 255, 0.3) !important;">
                                    <p class="text-muted">Sélectionnez d'abord un dataset</p>
                                </div>
                                <small class="text-muted" id="predictorHelp">Cliquez pour sélectionner les variables d'entrée</small>
                            </div>
                            <!-- MODULE 1: Division des Données -->
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">📊 Module 1: Division des Données</h6>
                                </div>
                                <div class="card-body">
                                    <!-- Méthode de division -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="splitMethod" class="form-label">
                                                Méthode de Division
                                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Choisissez comment diviser vos données"></i>
                                            </label>
                                            <select class="form-select" id="splitMethod" onchange="updateSplitMethodOptions()">
                                                <option value="random" selected>Aléatoire</option>
                                                <option value="stratified">Stratifiée</option>
                                                <option value="group">Par Groupes</option>
                                                <option value="temporal">Temporelle</option>
                                                <option value="sequential">Séquentielle</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="globalRandomState" class="form-label">
                                                Semence Globale
                                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Pour la reproductibilité de tous les modèles"></i>
                                            </label>
                                            <input type="number" class="form-control" id="globalRandomState" placeholder="Laisser vide pour aléatoire" min="0">
                                        </div>
                                    </div>
                                    
                                    <!-- Options spécifiques selon la méthode -->
                                    <div id="splitMethodOptions">
                                        <!-- Options Aléatoire (par défaut) -->
                                        <div id="randomOptions" class="split-options">
                                            <div class="alert alert-info">
                                                <i class="bi bi-shuffle"></i> Division aléatoire simple avec mélange des données
                                            </div>
                                        </div>
                                        
                                        <!-- Options Stratifiée -->
                                        <div id="stratifiedOptions" class="split-options" style="display: none;">
                                            <div class="alert alert-warning">
                                                <i class="bi bi-bar-chart"></i> Maintient les proportions de classes dans chaque ensemble (classification uniquement)
                                            </div>
                                        </div>
                                        
                                        <!-- Options Par Groupes -->
                                        <div id="groupOptions" class="split-options" style="display: none;">
                                            <div class="mb-3">
                                                <label for="groupColumn" class="form-label">Colonne de Groupes</label>
                                                <select class="form-select" id="groupColumn">
                                                    <option value="">Sélectionner une colonne...</option>
                                                </select>
                                                <small class="text-muted">Les groupes ne seront pas mélangés entre train/val/test</small>
                                            </div>
                                        </div>
                                        
                                        <!-- Options Temporelles -->
                                        <div id="temporalOptions" class="split-options" style="display: none;">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label for="temporalMethod" class="form-label">Méthode Temporelle</label>
                                                    <select class="form-select" id="temporalMethod">
                                                        <option value="holdout">Holdout (simple)</option>
                                                        <option value="blocked">Blocs temporels</option>
                                                        <option value="walk_forward">Walk-forward</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="temporalGap" class="form-label">Gap (périodes)</label>
                                                    <input type="number" class="form-control" id="temporalGap" min="0" value="0">
                                                    <small class="text-muted">Périodes de séparation entre ensembles</small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Options Séquentielles -->
                                        <div id="sequentialOptions" class="split-options" style="display: none;">
                                            <div class="alert alert-success">
                                                <i class="bi bi-list-ol"></i> <strong>Division séquentielle :</strong> Les données sont divisées selon leur ordre d'entrée original, sans mélange ni réorganisation. 
                                                Idéal pour les données ordonnées par importance ou temporellement.
                                            </div>
                                            <div class="alert alert-info">
                                                <i class="bi bi-info-circle"></i> <strong>Note :</strong> Cette méthode n'utilise pas de semence aléatoire car il n'y a pas de randomisation.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Proportions -->
                                    <div class="mt-3">
                                        <label class="form-label">Proportions des Ensembles</label>
                                        <div class="row g-2">
                                            <div class="col-md-4">
                                                <label for="trainSize" class="form-label small">Entraînement (%)</label>
                                                <input type="number" class="form-control" id="trainSize" min="40" max="80" value="70" required onchange="updateDataSplits()">
                                            </div>
                                            <div class="col-md-4">
                                                <label for="valSize" class="form-label small">Validation (%)</label>
                                                <input type="number" class="form-control" id="valSize" min="10" max="30" value="15" required onchange="updateDataSplits()">
                                            </div>
                                            <div class="col-md-4">
                                                <label for="testSize" class="form-label small">Test (%)</label>
                                                <input type="number" class="form-control" id="testSize" min="10" max="30" value="15" readonly style="background-color: rgba(255,255,255,0.1);">
                                            </div>
                                        </div>
                                        <small class="text-muted">Les pourcentages doivent totaliser 100%</small>
                                    </div>
                                    
                                    <!-- Visualisation de la Division des Données -->
                                    <div class="mt-4" id="dataSplitVisualization" style="display: none;">
                                        <h6 class="text-info mb-3"><i class="bi bi-pie-chart"></i> Répartition des Données</h6>
                                        <div class="row g-3">
                                            <!-- Zone Entraînement -->
                                            <div class="col-md-4">
                                                <div class="card border-primary">
                                                    <div class="card-header bg-primary text-white text-center">
                                                        <h6 class="mb-0"><i class="bi bi-play-fill"></i> Entraînement</h6>
                                                    </div>
                                                    <div class="card-body text-center">
                                                        <div class="display-6 text-primary" id="trainCount">--</div>
                                                        <small class="text-muted">échantillons</small>
                                                        <div class="mt-2">
                                                            <span class="badge bg-primary" id="trainPercentage">--%</span>
                                                        </div>
                                                        <div class="progress mt-2" style="height: 8px;">
                                                            <div class="progress-bar bg-primary" role="progressbar" id="trainProgressBar" style="width: 0%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Zone Validation -->
                                            <div class="col-md-4">
                                                <div class="card border-warning">
                                                    <div class="card-header bg-warning text-dark text-center">
                                                        <h6 class="mb-0"><i class="bi bi-check-circle"></i> Validation</h6>
                                                    </div>
                                                    <div class="card-body text-center">
                                                        <div class="display-6 text-warning" id="valCount">--</div>
                                                        <small class="text-muted">échantillons</small>
                                                        <div class="mt-2">
                                                            <span class="badge bg-warning text-dark" id="valPercentage">--%</span>
                                                        </div>
                                                        <div class="progress mt-2" style="height: 8px;">
                                                            <div class="progress-bar bg-warning" role="progressbar" id="valProgressBar" style="width: 0%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Zone Test -->
                                            <div class="col-md-4">
                                                <div class="card border-success">
                                                    <div class="card-header bg-success text-white text-center">
                                                        <h6 class="mb-0"><i class="bi bi-clipboard-check"></i> Test</h6>
                                                    </div>
                                                    <div class="card-body text-center">
                                                        <div class="display-6 text-success" id="testCount">--</div>
                                                        <small class="text-muted">échantillons</small>
                                                        <div class="mt-2">
                                                            <span class="badge bg-success" id="testPercentage">--%</span>
                                                        </div>
                                                        <div class="progress mt-2" style="height: 8px;">
                                                            <div class="progress-bar bg-success" role="progressbar" id="testProgressBar" style="width: 0%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Información adicional -->
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <div class="alert alert-info">
                                                    <div class="row text-center">
                                                        <div class="col-md-3">
                                                            <strong>Total Dataset:</strong> <span id="totalDatasetCount">--</span> échantillons
                                                        </div>
                                                        <div class="col-md-3">
                                                            <strong>Après Filtres:</strong> <span id="filteredDatasetCount">--</span> échantillons
                                                        </div>
                                                        <div class="col-md-3">
                                                            <strong>Variables Prédictives:</strong> <span id="predictorCount">--</span>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <strong>Variables Cibles:</strong> <span id="targetCount">--</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- MODULE 2: (À définir) -->
                            <div class="card mb-3">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">🔧 Module 2: Configuration Avancée (En développement)</h6>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">Ce module sera défini prochainement...</p>
                                </div>
                            </div>
                            <div class="mb-3" id="epochsContainer">
                                <label for="epochs" class="form-label">Époques (pour Deep Learning)</label>
                                <input type="number" class="form-control" id="epochs" min="1" max="1000" value="50">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mode Expert Toggle -->
                    <div class="row mt-4" id="expertModeContainer">
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="expertMode" onchange="toggleExpertMode()">
                                <label class="form-check-label" for="expertMode">
                                    <i class="bi bi-gear-fill"></i> Mode Expert - Configuration avancée du modèle
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuration du Modèle (Normal + Expert) -->
                    <div id="modelConfiguration" class="mt-4" style="display: none;">
                        <h5 class="text-info mb-3"><i class="bi bi-sliders"></i> Configuration du Modèle</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="lossFunction" class="form-label">Fonction de Perte</label>
                                    <select class="form-select" id="lossFunction">
                                        <option value="">Sélectionner...</option>
                                        <optgroup label="Régression">
                                            <option value="mse">MSE (Mean Squared Error)</option>
                                            <option value="mae">MAE (Mean Absolute Error)</option>
                                            <option value="huber">Huber Loss</option>
                                            <option value="log_cosh">Log-Cosh Loss</option>
                                        </optgroup>
                                        <optgroup label="Classification">
                                            <option value="binary_crossentropy">Binary Crossentropy</option>
                                            <option value="categorical_crossentropy">Categorical Crossentropy</option>
                                            <option value="sparse_categorical_crossentropy">Sparse Categorical Crossentropy</option>
                                        </optgroup>
                                        <optgroup label="Multi-tâches">
                                            <option value="custom">Personnalisée (définir dans le code)</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="optimizer" class="form-label">Optimiseur</label>
                                    <select class="form-select" id="optimizer">
                                        <option value="adam">Adam</option>
                                        <option value="sgd">SGD</option>
                                        <option value="rmsprop">RMSprop</option>
                                        <option value="adagrad">Adagrad</option>
                                        <option value="adamax">Adamax</option>
                                        <option value="nadam">Nadam</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="learningRate" class="form-label">Taux d'Apprentissage</label>
                                    <input type="number" class="form-control" id="learningRate" step="0.0001" value="0.001">
                                </div>
                                <div class="mb-3">
                                    <label for="batchSize" class="form-label">Taille du Batch</label>
                                    <input type="number" class="form-control" id="batchSize" min="1" value="32">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuration Random Forest -->
                    {% include 'partials/random_forest_config.html' %}

                    <!-- Configuration XGBoost -->
                    <div id="xgboostConfiguration" class="mt-4" style="display: none;">
                        <h5 class="text-info mb-3"><i class="bi bi-lightning"></i> Configuration XGBoost</h5>
                        
                        <!-- Preset Selector -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="xgbPreset" class="form-label">Configuration prédéfinie</label>
                                <select class="form-select" id="xgbPreset" onchange="applyXGBoostPreset()">
                                    <option value="rapido">Rapide</option>
                                    <option value="balanceado" selected>Balancé (recommandé)</option>
                                    <option value="preciso">Précis (lent)</option>
                                </select>
                                <small class="text-muted">Rapide: entraînement rapide. Balancé: bon compromis. Précis: meilleure qualité.</small>
                            </div>
                            <div class="col-md-6">
                                <label for="xgbProblemType" class="form-label">Type de problème</label>
                                <select class="form-select" id="xgbProblemType" onchange="updateXGBoostOptions()">
                                    <option value="regression">Régression</option>
                                    <option value="classification">Classification</option>
                                </select>
                                <small class="text-muted">Classification pour prédire des catégories, Régression pour des valeurs numériques</small>
                            </div>
                        </div>
                        
                        <!-- Options de base -->
                        <div class="card mb-3">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">🟢 Options sencillas</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="xgbNEstimators" class="form-label">
                                                Nombre d'arbres (n_estimators) 
                                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Plus d'arbres = meilleur modèle mais plus lent. Active early stopping pour optimiser."></i>
                                            </label>
                                            <input type="range" class="form-range mb-2" id="xgbNEstimators" min="100" max="3000" step="50" value="500" oninput="updateRangeValue('xgbNEstimators', 'xgbNEstimatorsValue')">
                                            <div class="d-flex justify-content-between">
                                                <small>100</small>
                                                <span id="xgbNEstimatorsValue" class="badge bg-primary">500</span>
                                                <small>3000</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="xgbLearningRate" class="form-label">
                                                Taux d'apprentissage (eta) 
                                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Contrôle la contribution de chaque arbre. Valeurs plus faibles = plus robuste mais nécessite plus d'arbres."></i>
                                            </label>
                                            <select class="form-select" id="xgbLearningRate">
                                                <option value="0.005">0.005 (très lent, très précis)</option>
                                                <option value="0.01">0.01</option>
                                                <option value="0.05" selected>0.05 (recommandé)</option>
                                                <option value="0.1">0.1</option>
                                                <option value="0.3">0.3 (rapide, moins stable)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="xgbMaxDepth" class="form-label">
                                                Profondeur maximale 
                                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Contrôle la complexité des arbres. 0 = pas de limite."></i>
                                            </label>
                                            <select class="form-select" id="xgbMaxDepth">
                                                <option value="0">Sans limite</option>
                                                <option value="3">3 (peu profond)</option>
                                                <option value="6" selected>6 (recommandé)</option>
                                                <option value="8">8</option>
                                                <option value="10">10</option>
                                                <option value="12">12</option>
                                                <option value="16">16 (très profond)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="xgbSubsample" class="form-label">
                                                Échantillonnage lignes (subsample) 
                                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Fraction des données utilisées pour chaque arbre. Réduit le surapprentissage."></i>
                                            </label>
                                            <input type="range" class="form-range mb-2" id="xgbSubsample" min="0.5" max="1.0" step="0.05" value="0.8" oninput="updateRangeValue('xgbSubsample', 'xgbSubsampleValue')">
                                            <div class="d-flex justify-content-between">
                                                <small>0.5</small>
                                                <span id="xgbSubsampleValue" class="badge bg-primary">0.8</span>
                                                <small>1.0</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="xgbColsampleBytree" class="form-label">
                                                Échantillonnage colonnes (colsample_bytree) 
                                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Fraction des features utilisées pour chaque arbre."></i>
                                            </label>
                                            <input type="range" class="form-range mb-2" id="xgbColsampleBytree" min="0.5" max="1.0" step="0.05" value="0.8" oninput="updateRangeValue('xgbColsampleBytree', 'xgbColsampleBytreeValue')">
                                            <div class="d-flex justify-content-between">
                                                <small>0.5</small>
                                                <span id="xgbColsampleBytreeValue" class="badge bg-primary">0.8</span>
                                                <small>1.0</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="xgbEvalMetric" class="form-label">
                                                Métrique d'évaluation 
                                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Métrique utilisée pour early stopping et évaluation."></i>
                                            </label>
                                            <select class="form-select" id="xgbEvalMetric">
                                                <option value="auto">Automatique (recommandé)</option>
                                                <option value="rmse">RMSE (régression)</option>
                                                <option value="mae">MAE (régression)</option>
                                                <option value="logloss">LogLoss (classification binaire)</option>
                                                <option value="auc">AUC (classification binaire)</option>
                                                <option value="mlogloss">MultiLogLoss (multiclasse)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Early Stopping -->
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="xgbEarlyStoppingEnabled" checked onchange="toggleXGBoostEarlyStopping()">
                                                <label class="form-check-label" for="xgbEarlyStoppingEnabled">
                                                    Activer Early Stopping 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Arrête l'entraînement quand le modèle n'améliore plus. Très recommandé!"></i>
                                                </label>
                                            </div>
                                            <div class="mt-2" id="xgbEarlyStoppingContainer">
                                                <label for="xgbEarlyStoppingRounds" class="form-label">Rounds de patience</label>
                                                <input type="number" class="form-control" id="xgbEarlyStoppingRounds" min="10" max="500" value="50">
                                                <small class="text-muted">Nombre d'itérations sans amélioration avant d'arrêter</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- GPU Acceleration -->
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="xgbUseGPU">
                                                <label class="form-check-label" for="xgbUseGPU">
                                                    Utiliser GPU (CUDA) 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Accélère significativement l'entraînement si GPU disponible."></i>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Options avancées -->
                        <div class="card">
                            <div class="card-header bg-warning text-white">
                                <h6 class="mb-0">
                                    <button class="btn btn-link text-white p-0" type="button" data-bs-toggle="collapse" data-bs-target="#xgbAdvancedOptions" aria-expanded="false">
                                        ⚙️ Options avancées <i class="bi bi-chevron-down"></i>
                                    </button>
                                </h6>
                            </div>
                            <div class="collapse" id="xgbAdvancedOptions">
                                <div class="card-body">
                                    <p class="text-muted mb-3">Configuration détaillée pour affiner les performances du modèle XGBoost.</p>
                                    
                                    <!-- Régularisation et complexité -->
                                    <h6 class="text-info">Régularisation et contrôle de complexité</h6>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="xgbMinChildWeight" class="form-label">
                                                    Min child weight 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Somme minimale de poids (hessian) nécessaire dans un enfant."></i>
                                                </label>
                                                <input type="number" class="form-control" id="xgbMinChildWeight" min="0" max="10" step="0.5" value="1">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="xgbGamma" class="form-label">
                                                    Gamma (min_split_loss) 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Réduction minimale de perte pour faire une partition."></i>
                                                </label>
                                                <input type="range" class="form-range mb-2" id="xgbGamma" min="0" max="1" step="0.01" value="0" oninput="updateRangeValue('xgbGamma', 'xgbGammaValue')">
                                                <div class="d-flex justify-content-between">
                                                    <small>0</small>
                                                    <span id="xgbGammaValue" class="badge bg-primary">0</span>
                                                    <small>1</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="xgbRegLambda" class="form-label">
                                                    Lambda (L2 régularisation) 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Terme de régularisation L2 sur les poids."></i>
                                                </label>
                                                <input type="range" class="form-range mb-2" id="xgbRegLambda" min="0" max="10" step="0.1" value="1" oninput="updateRangeValue('xgbRegLambda', 'xgbRegLambdaValue')">
                                                <div class="d-flex justify-content-between">
                                                    <small>0</small>
                                                    <span id="xgbRegLambdaValue" class="badge bg-primary">1</span>
                                                    <small>10</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="xgbRegAlpha" class="form-label">
                                                    Alpha (L1 régularisation) 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Terme de régularisation L1 sur les poids. Peut créer de la sparsité."></i>
                                                </label>
                                                <input type="range" class="form-range mb-2" id="xgbRegAlpha" min="0" max="10" step="0.1" value="0" oninput="updateRangeValue('xgbRegAlpha', 'xgbRegAlphaValue')">
                                                <div class="d-flex justify-content-between">
                                                    <small>0</small>
                                                    <span id="xgbRegAlphaValue" class="badge bg-primary">0</span>
                                                    <small>10</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="xgbMaxDeltaStep" class="form-label">
                                                    Max delta step 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Utile pour classes très déséquilibrées. 0 = pas de contrainte."></i>
                                                </label>
                                                <input type="number" class="form-control" id="xgbMaxDeltaStep" min="0" max="10" step="0.5" value="0">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Échantillonnage avancé -->
                                    <h6 class="text-info">Échantillonnage de colonnes et lignes</h6>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="xgbColsampleBylevel" class="form-label">
                                                    Colsample by level 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Échantillonnage des colonnes pour chaque niveau."></i>
                                                </label>
                                                <input type="range" class="form-range mb-2" id="xgbColsampleBylevel" min="0.3" max="1.0" step="0.05" value="1.0" oninput="updateRangeValue('xgbColsampleBylevel', 'xgbColsampleBylevelValue')">
                                                <div class="d-flex justify-content-between">
                                                    <small>0.3</small>
                                                    <span id="xgbColsampleBylevelValue" class="badge bg-primary">1.0</span>
                                                    <small>1.0</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="xgbColsampleBynode" class="form-label">
                                                    Colsample by node 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Échantillonnage des colonnes pour chaque split."></i>
                                                </label>
                                                <input type="range" class="form-range mb-2" id="xgbColsampleBynode" min="0.3" max="1.0" step="0.05" value="1.0" oninput="updateRangeValue('xgbColsampleBynode', 'xgbColsampleBynodeValue')">
                                                <div class="d-flex justify-content-between">
                                                    <small>0.3</small>
                                                    <span id="xgbColsampleBynodeValue" class="badge bg-primary">1.0</span>
                                                    <small>1.0</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Méthode de construction -->
                                    <h6 class="text-info">Méthode de construction et performance</h6>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="xgbTreeMethod" class="form-label">
                                                    Tree method 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Algorithme de construction des arbres."></i>
                                                </label>
                                                <select class="form-select" id="xgbTreeMethod">
                                                    <option value="auto">Auto (recommandé)</option>
                                                    <option value="hist">Hist (rapide)</option>
                                                    <option value="approx">Approx</option>
                                                    <option value="exact">Exact (petits datasets)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="xgbMaxBin" class="form-label">
                                                    Max bin 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Nombre max de bins pour hist/approx. Plus = précis mais lent."></i>
                                                </label>
                                                <input type="number" class="form-control" id="xgbMaxBin" min="16" max="512" value="256">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="xgbGrowPolicy" class="form-label">
                                                    Grow policy 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Politique de croissance des arbres."></i>
                                                </label>
                                                <select class="form-select" id="xgbGrowPolicy" onchange="toggleMaxLeaves()">
                                                    <option value="depthwise">Depthwise (par défaut)</option>
                                                    <option value="lossguide">Lossguide</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3" id="xgbMaxLeavesContainer" style="display: none;">
                                                <label for="xgbMaxLeaves" class="form-label">
                                                    Max leaves 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Nombre max de feuilles (lossguide uniquement)."></i>
                                                </label>
                                                <input type="number" class="form-control" id="xgbMaxLeaves" min="0" max="1024" value="0">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Classification déséquilibrée -->
                                    <div id="xgbClassificationSettings" style="display: none;">
                                        <h6 class="text-info">Classification déséquilibrée</h6>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="xgbScalePosWeight" class="form-label">
                                                        Scale pos weight 
                                                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Poids de la classe positive. Suggéré: #négatifs/#positifs"></i>
                                                    </label>
                                                    <input type="number" class="form-control" id="xgbScalePosWeight" min="0" max="100" step="0.1" value="1">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Booster et variantes -->
                                    <h6 class="text-info">Booster et variantes</h6>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="xgbBooster" class="form-label">
                                                    Booster 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Type de booster à utiliser."></i>
                                                </label>
                                                <select class="form-select" id="xgbBooster" onchange="toggleBoosterOptions()">
                                                    <option value="gbtree" selected>GBTree (par défaut)</option>
                                                    <option value="dart">DART (avec dropout)</option>
                                                    <option value="gblinear">GBLinear</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- DART parameters -->
                                    <div id="xgbDartParameters" style="display: none;">
                                        <h6 class="text-info">Paramètres DART</h6>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="xgbRateDrop" class="form-label">
                                                        Rate drop 
                                                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Fraction d'arbres à abandonner."></i>
                                                    </label>
                                                    <input type="range" class="form-range mb-2" id="xgbRateDrop" min="0" max="1" step="0.05" value="0.1" oninput="updateRangeValue('xgbRateDrop', 'xgbRateDropValue')">
                                                    <div class="d-flex justify-content-between">
                                                        <small>0</small>
                                                        <span id="xgbRateDropValue" class="badge bg-primary">0.1</span>
                                                        <small>1</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="xgbSkipDrop" class="form-label">
                                                        Skip drop 
                                                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Probabilité de ne pas faire de dropout."></i>
                                                    </label>
                                                    <input type="range" class="form-range mb-2" id="xgbSkipDrop" min="0" max="1" step="0.05" value="0.5" oninput="updateRangeValue('xgbSkipDrop', 'xgbSkipDropValue')">
                                                    <div class="d-flex justify-content-between">
                                                        <small>0</small>
                                                        <span id="xgbSkipDropValue" class="badge bg-primary">0.5</span>
                                                        <small>1</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Reproducibilité et exécution -->
                                    <h6 class="text-info">Exécution</h6>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="alert alert-info p-2">
                                                <small><i class="bi bi-info-circle"></i> La semilla aleatoria se configura globalmente en el <strong>Módulo 1: División de Datos</strong></small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="xgbNJobs" class="form-label">
                                                    Threads (n_jobs) 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="-1 utilise tous les cœurs disponibles."></i>
                                                </label>
                                                <select class="form-select" id="xgbNJobs">
                                                    <option value="-1">Utiliser tous les cœurs</option>
                                                    <option value="1">1 cœur</option>
                                                    <option value="2">2 cœurs</option>
                                                    <option value="4">4 cœurs</option>
                                                    <option value="8">8 cœurs</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="xgbVerbosity" class="form-label">
                                                    Verbosity 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Niveau de détail des messages."></i>
                                                </label>
                                                <select class="form-select" id="xgbVerbosity">
                                                    <option value="0">0 - Silencieux</option>
                                                    <option value="1" selected>1 - Avertissements</option>
                                                    <option value="2">2 - Info</option>
                                                    <option value="3">3 - Debug</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuration Decision Tree -->
                    <div id="decisionTreeConfiguration" class="mt-4" style="display: none;">
                        <h5 class="text-warning mb-3"><i class="bi bi-diagram-3"></i> Configuration Decision Tree</h5>
                        
                        <!-- Preset Selector -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="dtPreset" class="form-label">Configuration prédéfinie</label>
                                <select class="form-select" id="dtPreset" onchange="applyDecisionTreePreset()">
                                    <option value="rapido">Rapide</option>
                                    <option value="balanceado" selected>Balancé (recommandé)</option>
                                    <option value="preciso">Précis (contrôlé)</option>
                                </select>
                                <small class="text-muted">Rapide: arbre simple. Balancé: bon compromis. Précis: arbre complet avec validation.</small>
                            </div>
                            <div class="col-md-6">
                                <label for="dtProblemType" class="form-label">Type de problème</label>
                                <select class="form-select" id="dtProblemType" onchange="updateDecisionTreeOptions()">
                                    <option value="regression">Régression</option>
                                    <option value="classification">Classification</option>
                                </select>
                                <small class="text-muted">Classification pour prédire des catégories, Régression pour des valeurs numériques</small>
                            </div>
                        </div>
                        
                        <!-- Options de base -->
                        <div class="card mb-3">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">🟢 Options sencillas</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="dtCriterion" class="form-label">
                                                Critère de division 
                                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Mesure de qualité d'une division"></i>
                                            </label>
                                            <select class="form-select" id="dtCriterion">
                                                <option value="gini">Gini (classification)</option>
                                                <option value="entropy">Entropie (classification)</option>
                                                <option value="squared_error">Erreur quadratique (régression)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="dtMaxDepthEnabled" onchange="toggleDecisionTreeMaxDepth()">
                                                <label class="form-check-label" for="dtMaxDepthEnabled">
                                                    Limiter la profondeur 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Limiter la profondeur réduit le surapprentissage"></i>
                                                </label>
                                            </div>
                                            <input type="number" class="form-control mt-2" id="dtMaxDepth" min="2" max="50" value="12" disabled>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="dtMinSamplesLeaf" class="form-label">
                                                Min échantillons par feuille 
                                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Mínimo de muestras por hoja; subirlo suaviza el árbol"></i>
                                            </label>
                                            <div class="input-group">
                                                <input type="range" class="form-range" id="dtMinSamplesLeaf" min="1" max="50" value="1" oninput="updateDecisionTreeMinSamplesLeaf()">
                                                <span class="input-group-text" id="dtMinSamplesLeafValue" style="width: 60px;">1</span>
                                            </div>
                                            <div class="form-check mt-1">
                                                <input class="form-check-input" type="checkbox" id="dtMinSamplesLeafFraction" onchange="toggleMinSamplesLeafType()">
                                                <label class="form-check-label" for="dtMinSamplesLeafFraction">
                                                    Utiliser fraction (0-0.5) au lieu d'entier
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="dtMaxFeatures" class="form-label">
                                                Features par division 
                                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Límite de variables consideradas por división"></i>
                                            </label>
                                            <select class="form-select" id="dtMaxFeatures" onchange="toggleDecisionTreeMaxFeatures()">
                                                <option value="None" selected>Toutes</option>
                                                <option value="sqrt">sqrt</option>
                                                <option value="log2">log2</option>
                                                <option value="int">Nombre fixe</option>
                                                <option value="float">Fraction (0-1)</option>
                                            </select>
                                            <input type="number" class="form-control mt-2" id="dtMaxFeaturesValue" style="display: none;" min="1" value="5">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <label for="dtValidationMethod" class="form-label">
                                                Validation rapide 
                                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Pour évaluer; ne change pas l'arbre final sauf si vous l'appliquez"></i>
                                            </label>
                                            <select class="form-select" id="dtValidationMethod">
                                                <option value="holdout">Hold-out 80/20</option>
                                                <option value="cv">Validation croisée k-fold (k=5)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Options avancées -->
                        <div class="card">
                            <div class="card-header bg-warning text-white">
                                <h6 class="mb-0">
                                    <button class="btn btn-link text-white p-0" type="button" data-bs-toggle="collapse" data-bs-target="#dtAdvancedOptions" aria-expanded="false">
                                        ⚙️ Options avancées <i class="bi bi-chevron-down"></i>
                                    </button>
                                </h6>
                            </div>
                            <div class="collapse" id="dtAdvancedOptions">
                                <div class="card-body">
                                    <p class="text-muted mb-3">Afinado fino et casos especiales pour Decision Tree.</p>
                                    
                                    <!-- Structure et divisions -->
                                    <h6 class="text-info">Structure et divisions</h6>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="dtSplitter" class="form-label">
                                                    Splitter 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Best: meilleure division. Random: division aléatoire"></i>
                                                </label>
                                                <select class="form-select" id="dtSplitter">
                                                    <option value="best" selected>Best (recommandé)</option>
                                                    <option value="random">Random</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="dtMinSamplesSplit" class="form-label">
                                                    Min échantillons pour diviser 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Minimum pour diviser un nœud"></i>
                                                </label>
                                                <input type="number" class="form-control" id="dtMinSamplesSplit" min="2" max="100" value="2">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="dtMinWeightFractionLeaf" class="form-label">
                                                    Fraction min poids dans feuille 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Fraction minimale de poids dans une feuille"></i>
                                                </label>
                                                <input type="range" class="form-range mb-2" id="dtMinWeightFractionLeaf" min="0" max="0.5" step="0.01" value="0.0" oninput="updateRangeValue('dtMinWeightFractionLeaf', 'dtMinWeightFractionLeafValue')">
                                                <div class="d-flex justify-content-between">
                                                    <small>0.0</small>
                                                    <span id="dtMinWeightFractionLeafValue" class="badge bg-primary">0.0</span>
                                                    <small>0.5</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="dtMinImpurityDecrease" class="form-label">
                                                    Décrement min impureté 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Umbral de ganancia mínima para aceptar una división"></i>
                                                </label>
                                                <input type="range" class="form-range mb-2" id="dtMinImpurityDecrease" min="0" max="0.1" step="0.001" value="0.0" oninput="updateRangeValue('dtMinImpurityDecrease', 'dtMinImpurityDecreaseValue')">
                                                <div class="d-flex justify-content-between">
                                                    <small>0.0</small>
                                                    <span id="dtMinImpurityDecreaseValue" class="badge bg-primary">0.0</span>
                                                    <small>0.1</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="dtMaxLeafNodes" class="form-label">
                                                    Max nœuds feuilles 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Nombre maximum de feuilles. Laisser vide pour pas de limite"></i>
                                                </label>
                                                <input type="number" class="form-control" id="dtMaxLeafNodes" min="2" placeholder="Sans limite">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="dtCcpAlpha" class="form-label">
                                                    CCP Alpha 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Poda por coste-complejidad (post-pruning)"></i>
                                                </label>
                                                <input type="number" class="form-control" id="dtCcpAlpha" min="0" step="0.0001" value="0.0">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Critères complets -->
                                    <h6 class="text-info">Critères complets</h6>
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <label for="dtCriterionAdvanced" class="form-label">
                                                    Critère avancé 
                                                    <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Options avancées de critères"></i>
                                                </label>
                                                <select class="form-select" id="dtCriterionAdvanced">
                                                    <option value="default">Utiliser le critère basique</option>
                                                    <optgroup label="Classification">
                                                        <option value="gini">Gini</option>
                                                        <option value="entropy">Entropie</option>
                                                        <option value="log_loss">Log Loss</option>
                                                    </optgroup>
                                                    <optgroup label="Régression">
                                                        <option value="squared_error">Erreur quadratique</option>
                                                        <option value="absolute_error">Erreur absolue</option>
                                                        <option value="friedman_mse">Friedman MSE</option>
                                                        <option value="poisson">Poisson (y ≥ 0)</option>
                                                    </optgroup>
                                                </select>
                                                <small class="text-warning" id="dtPoissonWarning" style="display: none;">
                                                    <i class="bi bi-exclamation-triangle"></i> Poisson requiert des valeurs cibles ≥ 0
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Classification spécifique -->
                                    <div id="dtClassificationSettings" style="display: none;">
                                        <h6 class="text-info">Options de classification</h6>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="dtClassWeight" class="form-label">
                                                        Poids des classes 
                                                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Pour gérer les classes déséquilibrées"></i>
                                                    </label>
                                                    <select class="form-select" id="dtClassWeight">
                                                        <option value="None">Aucun</option>
                                                        <option value="balanced">Équilibré automatiquement</option>
                                                        <option value="custom">Personnalisé</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="dtDecisionThreshold" class="form-label">
                                                        Seuil de décision 
                                                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Pour convertir probabilités en classe"></i>
                                                    </label>
                                                    <input type="range" class="form-range mb-2" id="dtDecisionThreshold" min="0" max="1" step="0.05" value="0.5" oninput="updateRangeValue('dtDecisionThreshold', 'dtDecisionThresholdValue')">
                                                    <div class="d-flex justify-content-between">
                                                        <small>0.0</small>
                                                        <span id="dtDecisionThresholdValue" class="badge bg-primary">0.5</span>
                                                        <small>1.0</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="dtOutputType" class="form-label">
                                                        Type de sortie 
                                                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Classe pour décisions finales, Probabilités pour analyse"></i>
                                                    </label>
                                                    <select class="form-select" id="dtOutputType">
                                                        <option value="class">Classe prédite</option>
                                                        <option value="proba">Probabilités</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Reproductibilité -->
                                    <h6 class="text-info">Reproductibilité</h6>
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <div class="alert alert-info">
                                                <i class="bi bi-info-circle"></i> La semilla aleatoria se configura globalmente en el <strong>Módulo 1: División de Datos</strong>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Presets de complexité -->
                                    <h6 class="text-info">Presets de complexité</h6>
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-outline-secondary" onclick="applyDecisionTreeComplexityPreset('simple')">
                                                    <i class="bi bi-tree"></i> Plus simple
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" onclick="applyDecisionTreeComplexityPreset('flexible')">
                                                    <i class="bi bi-diagram-3-fill"></i> Plus flexible
                                                </button>
                                            </div>
                                            <small class="text-muted d-block mt-1">
                                                Simple: profondeur limitée, feuilles min 2. Flexible: sans limites.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Architecture du Réseau (Mode Expert) -->
                    <div id="networkArchitecture" class="mt-4" style="display: none;">
                        <h5 class="text-info mb-3"><i class="bi bi-diagram-3"></i> Architecture du Réseau</h5>
                        
                        <!-- Boutons pour ajouter des couches -->
                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="addLayer('dense')">
                                <i class="bi bi-plus-circle"></i> Dense
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="addLayer('lstm')">
                                <i class="bi bi-plus-circle"></i> LSTM
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="addLayer('gru')">
                                <i class="bi bi-plus-circle"></i> GRU
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="addLayer('conv1d')">
                                <i class="bi bi-plus-circle"></i> Conv1D
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="addLayer('dropout')">
                                <i class="bi bi-plus-circle"></i> Dropout
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="addLayer('batchnorm')">
                                <i class="bi bi-plus-circle"></i> BatchNorm
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="addLayer('flatten')">
                                <i class="bi bi-plus-circle"></i> Flatten
                            </button>
                        </div>
                        
                        <!-- Conteneur des couches -->
                        <div id="layersContainer" class="border rounded p-3" style="max-height: 400px; overflow-y: auto; background: rgba(0, 0, 0, 0.3);">
                            <p class="text-muted text-center">Aucune couche ajoutée. Cliquez sur les boutons ci-dessus pour ajouter des couches.</p>
                        </div>
                        
                        <!-- Configuration de la couche de sortie -->
                        <div class="mt-3">
                            <h6 class="text-warning">Couche de Sortie</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="outputActivation" class="form-label">Activation de Sortie</label>
                                        <select class="form-select" id="outputActivation">
                                            <option value="linear">Linear (Régression)</option>
                                            <option value="sigmoid">Sigmoid (Classification binaire)</option>
                                            <option value="softmax">Softmax (Classification multi-classe)</option>
                                            <option value="tanh">Tanh</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="outputUnits" class="form-label">Nombre d'Unités de Sortie</label>
                                        <input type="number" class="form-control" id="outputUnits" min="1" value="1">
                                        <small class="text-muted">Sera automatiquement ajusté selon les variables cibles</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Métriques et Callbacks -->
                    <div id="metricsCallbacks" class="mt-4" style="display: none;">
                        <h5 class="text-info mb-3"><i class="bi bi-graph-up"></i> Métriques et Callbacks</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Métriques à Suivre</label>
                                <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                                    <div class="form-check">
                                        <input class="form-check-input metric-checkbox" type="checkbox" value="accuracy" id="metric_accuracy">
                                        <label class="form-check-label" for="metric_accuracy">Accuracy</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input metric-checkbox" type="checkbox" value="mae" id="metric_mae" checked>
                                        <label class="form-check-label" for="metric_mae">MAE</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input metric-checkbox" type="checkbox" value="mse" id="metric_mse" checked>
                                        <label class="form-check-label" for="metric_mse">MSE</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input metric-checkbox" type="checkbox" value="rmse" id="metric_rmse">
                                        <label class="form-check-label" for="metric_rmse">RMSE</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input metric-checkbox" type="checkbox" value="r2" id="metric_r2">
                                        <label class="form-check-label" for="metric_r2">R²</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Callbacks</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="earlyStoppingCallback" checked>
                                    <label class="form-check-label" for="earlyStoppingCallback">
                                        Early Stopping
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="reduceLRCallback" checked>
                                    <label class="form-check-label" for="reduceLRCallback">
                                        Reduce LR on Plateau
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="modelCheckpointCallback" checked>
                                    <label class="form-check-label" for="modelCheckpointCallback">
                                        Model Checkpoint
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-4">
                        <i class="bi bi-info-circle"></i> Le modèle sera sauvegardé. Vous pourrez l'entraîner plus tard depuis cette page.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="createModelOnly()">
                    <i class="bi bi-save"></i> Créer le Modèle
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Framework Selection Modal -->
<div class="modal fade" id="frameworkSelectionModal" tabindex="-1" aria-labelledby="frameworkSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="frameworkSelectionModalLabel">
                    <i class="bi bi-code-square"></i> Choisir le Framework
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p class="mb-4">Sélectionnez le framework pour générer le code:</p>
                <div class="row g-3">
                    <div class="col-6">
                        <button type="button" class="btn btn-outline-primary w-100 framework-btn" data-framework="keras">
                            <i class="bi bi-layers"></i>
                            <div class="mt-2">
                                <strong>Keras</strong>
                                <br>
                                <small class="text-muted">TensorFlow/Keras</small>
                            </div>
                        </button>
                    </div>
                    <div class="col-6">
                        <button type="button" class="btn btn-outline-warning w-100 framework-btn" data-framework="pytorch">
                            <i class="bi bi-fire"></i>
                            <div class="mt-2">
                                <strong>PyTorch</strong>
                                <br>
                                <small class="text-muted">PyTorch</small>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
let modelsList = [];
let filteredModels = [];
let selectedModel = null;

// Charger les modèles
function loadModels() {
    showLoading('Chargement des modèles...', 'Récupération de vos modèles d\'IA');
    
    fetch('/api/models/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            modelsList = data;
            updateStatistics();
            filterModels();
            hideLoading();
        })
        .catch(error => {
            console.error('Erreur:', error);
            hideLoading();
            showNotification('Erreur', 'Impossible de charger les modèles', 'error');
        });
}

// Mettre à jour les statistiques
function updateStatistics() {
    document.getElementById('totalModels').textContent = modelsList.length;
    
    let totalTrainings = 0;
    let bestScore = 0;
    let lastTrainingDate = null;
    
    modelsList.forEach(model => {
        totalTrainings += model.actual_training_count || 0;
        if (model.best_score && model.best_score > bestScore) {
            bestScore = model.best_score;
        }
        if (model.last_trained) {
            const date = new Date(model.last_trained);
            if (!lastTrainingDate || date > lastTrainingDate) {
                lastTrainingDate = date;
            }
        }
    });
    
    document.getElementById('totalTrainings').textContent = totalTrainings;
    document.getElementById('bestScore').textContent = bestScore > 0 ? (bestScore * 100).toFixed(1) + '%' : '-';
    document.getElementById('lastTraining').textContent = lastTrainingDate ? 
        lastTrainingDate.toLocaleDateString('fr-FR') : '-';
}

// Filtrer les modèles
function filterModels() {
    const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value;
    const sortBy = document.getElementById('sortFilter').value;
    
    // Filtrer
    filteredModels = modelsList.filter(model => {
        const matchesSearch = model.name.toLowerCase().includes(searchTerm) || 
                            model.description.toLowerCase().includes(searchTerm);
        const matchesType = !typeFilter || model.model_type === typeFilter;
        return matchesSearch && matchesType;
    });
    
    // Trier
    filteredModels.sort((a, b) => {
        switch (sortBy) {
            case 'name':
                return a.name.localeCompare(b.name);
            case 'date':
                return new Date(b.created_at) - new Date(a.created_at);
            case 'modified':
                return new Date(b.updated_at) - new Date(a.updated_at);
            case 'performance':
                return (b.best_score || 0) - (a.best_score || 0);
            case 'trainings':
                return (b.actual_training_count || 0) - (a.actual_training_count || 0);
            default:
                return new Date(b.updated_at) - new Date(a.updated_at);
        }
    });
    
    displayModels();
}

// Afficher les modèles
function displayModels() {
    const container = document.getElementById('modelsContainer');
    
    // Garder la carte de création
    const createCard = container.querySelector('.create-model-card');
    container.innerHTML = '';
    container.appendChild(createCard);
    
    if (filteredModels.length === 0) {
        const emptyMessage = document.createElement('div');
        emptyMessage.className = 'empty-state-message';
        emptyMessage.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-cpu empty-state-icon"></i>
                <h5 class="empty-state-title mt-3">Aucun modèle trouvé</h5>
                <p class="empty-state-text text-muted">Créez votre premier modèle pour commencer</p>
            </div>
        `;
        container.appendChild(emptyMessage);
        return;
    }
    
    filteredModels.forEach(model => {
        const card = createModelCard(model);
        container.appendChild(card);
    });
}

// Créer une carte de modèle
function createModelCard(model) {
    const card = document.createElement('div');
    card.className = 'card model-card';
    card.style.cursor = 'pointer';
    card.onclick = () => editModel(model.id);
    
    const latestTraining = model.latest_training;
    const statusClass = latestTraining?.status === 'completed' ? 'success' : 
                       latestTraining?.status === 'training' ? 'training' : 'failed';
    
    card.innerHTML = `
        <div class="quick-actions">
            <button type="button" class="action-btn" data-action="train" 
                    onclick="event.stopPropagation(); trainModel(${model.id})" 
                    title="Entraîner">
                <i class="bi bi-play-fill"></i>
            </button>
            <button type="button" class="action-btn" data-action="export" 
                    onclick="event.stopPropagation(); exportModelCode(${model.id})" 
                    title="Exporter Code">
                <i class="bi bi-download"></i>
            </button>
            <button type="button" class="action-btn" data-action="import" 
                    onclick="event.stopPropagation(); importModelCode(${model.id})" 
                    title="Importer Code">
                <i class="bi bi-upload"></i>
            </button>
            <button type="button" class="action-btn" data-action="clone" 
                    onclick="event.stopPropagation(); cloneModel(${model.id})" 
                    title="Cloner">
                <i class="bi bi-files"></i>
            </button>
            <button type="button" class="action-btn" data-action="delete" 
                    onclick="event.stopPropagation(); deleteModel(${model.id})" 
                    title="Supprimer">
                <i class="bi bi-trash"></i>
            </button>
        </div>
        
        <div class="card-body">
            <div class="model-icon">
                <i class="bi bi-diagram-3"></i>
            </div>
            <h5 class="card-title text-center mb-2" style="font-weight: 600; font-size: 1.2rem;">
                ${model.name}
            </h5>
            <div class="text-center mb-3">
                <span class="model-type-badge">${model.model_type.toUpperCase()}</span>
            </div>
            <p class="text-muted small text-center mb-3" style="font-size: 0.85rem;">
                ${model.description || 'Modèle de prédiction météorologique'}
            </p>
            
            <div class="model-stats">
                <div class="stat-item">
                    <div class="stat-value">${model.actual_training_count || 0}</div>
                    <div class="text-muted small">Entraînements</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${model.best_score ? (model.best_score * 100).toFixed(1) : '-'}%</div>
                    <div class="text-muted small">Meilleur</div>
                </div>
            </div>
            
            <div class="mt-3 pt-3" style="border-top: 1px solid rgba(138, 43, 226, 0.2);">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted small">Dataset:</span>
                    <span class="text-info small">${model.dataset_name}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted small">Créé le:</span>
                    <span class="small">${new Date(model.created_at).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted small">Modifié le:</span>
                    <span class="small">${new Date(model.updated_at).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
                </div>
                ${latestTraining ? `
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted small">Dernier statut:</span>
                    <span class="training-status">
                        <span class="status-dot status-${statusClass}"></span>
                        <span class="small">${getStatusText(latestTraining.status)}</span>
                    </span>
                </div>
                ` : ''}
            </div>
            
            <div class="text-center mt-3 pt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="showTrainingHistory(${model.id}); return false;">
                    <i class="bi bi-clock-history"></i> Voir l'historique
                </button>
            </div>
        </div>
    `;
    
    return card;
}

// Obtenir le texte du statut
function getStatusText(status) {
    switch (status) {
        case 'completed': return 'Terminé';
        case 'training': return 'En cours';
        case 'failed': return 'Échoué';
        default: return 'En attente';
    }
}

// Afficher l'historique des entraînements
function showTrainingHistory(modelId) {
    // Prevent the event from propagating to parent elements
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    const model = modelsList.find(m => m.id === modelId);
    if (!model) return;
    
    selectedModel = model;
    
    // Close any other open modals first
    cleanupModals();
    
    // Extra cleanup with delay to ensure everything is closed
    setTimeout(() => {
        // Remove any remaining backdrops
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('overflow');
        document.body.style.removeProperty('padding-right');
    }, 100);
    
    document.getElementById('trainingHistoryTitle').innerHTML = `
        <i class="bi bi-clock-history"></i> Historique - ${model.name}
    `;
    
    showLoading('Chargement de l\'historique...', 'Récupération des sessions d\'entraînement');
    
    fetch(`/api/models/${modelId}/trainings/`)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            console.log('Training history API response:', data);
            // The API returns data wrapped in success response
            const trainings = data.trainings || data.data?.trainings || [];
            console.log('Extracted trainings:', trainings);
            console.log('Number of trainings:', trainings.length);
            displayTrainingHistory(trainings);
            
            // Ensure no other modal is interfering
            const modalElement = document.getElementById('trainingHistoryModal');
            
            // Dispose of any existing instance
            const existingInstance = bootstrap.Modal.getInstance(modalElement);
            if (existingInstance) {
                existingInstance.dispose();
            }
            
            // Create a new instance
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',  // Changed to static backdrop
                keyboard: true,
                focus: true
            });
            
            // Show the modal with a longer delay to ensure all cleanup is complete
            setTimeout(() => {
                modal.show();
            }, 300);
        })
        .catch(error => {
            hideLoading();
            console.error('Erreur:', error);
            showNotification('Erreur', 'Impossible de charger l\'historique', 'error');
        });
}

// Afficher l'historique
function displayTrainingHistory(trainings) {
    const content = document.getElementById('trainingHistoryContent');
    
    if (trainings.length === 0) {
        content.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-clock-history" style="font-size: 3rem;"></i>
                <p class="mt-3">Aucun entraînement pour ce modèle</p>
                <button class="btn btn-primary" onclick="trainModel(${selectedModel.id})">
                    <i class="bi bi-play-fill"></i> Lancer le premier entraînement
                </button>
            </div>
        `;
        return;
    }
    
    // Sort trainings by date (most recent first)
    const sortedTrainings = trainings.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    
    content.innerHTML = `
        <div class="training-history-header mb-3">
            <div class="row">
                <div class="col-6">
                    <small class="text-muted">Total: ${trainings.length} entraînement(s)</small>
                </div>
                <div class="col-6 text-end">
                    <button class="btn btn-sm btn-primary" onclick="trainModel(${selectedModel.id})">
                        <i class="bi bi-plus-circle"></i> Nouvel entraînement
                    </button>
                </div>
            </div>
        </div>
        ${sortedTrainings.map((training, index) => {
            const metrics = training.test_results || {};
            const statusClass = training.status === 'completed' ? 'success' : 
                               training.status === 'training' ? 'warning' : 'danger';
            const statusIcon = training.status === 'completed' ? 'check-circle-fill' : 
                              training.status === 'training' ? 'hourglass-split' : 'x-circle-fill';
            
            // Calculate how long ago the training was
            let timeAgo = '';
            if (training.created_at) {
                const now = new Date();
                const created = new Date(training.created_at);
                const diffMs = now - created;
                const diffSeconds = Math.floor(diffMs / 1000);
                const diffMinutes = Math.floor(diffSeconds / 60);
                const diffHours = Math.floor(diffMinutes / 60);
                const diffDays = Math.floor(diffHours / 24);
                const diffMonths = Math.floor(diffDays / 30);
                const diffYears = Math.floor(diffDays / 365);
                
                if (diffYears > 0) {
                    timeAgo = diffYears === 1 ? 'il y a 1 an' : `il y a ${diffYears} ans`;
                } else if (diffMonths > 0) {
                    timeAgo = diffMonths === 1 ? 'il y a 1 mois' : `il y a ${diffMonths} mois`;
                } else if (diffDays > 0) {
                    timeAgo = diffDays === 1 ? 'il y a 1 jour' : `il y a ${diffDays} jours`;
                } else if (diffHours > 0) {
                    timeAgo = diffHours === 1 ? 'il y a 1 heure' : `il y a ${diffHours} heures`;
                } else if (diffMinutes > 0) {
                    timeAgo = diffMinutes === 1 ? 'il y a 1 minute' : `il y a ${diffMinutes} minutes`;
                } else {
                    timeAgo = 'à l\'instant';
                }
            }
            
            return `
                <div class="training-history-item ${training.status === 'completed' ? 'completed' : ''}">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <h6 class="mb-1 text-white">
                                <i class="bi bi-${statusIcon} text-${statusClass}"></i> 
                                Session #${training.id}
                            </h6>
                            <small class="text-muted">
                                <i class="bi bi-calendar3"></i> ${new Date(training.created_at).toLocaleDateString('fr-FR')}
                                <br>
                                <i class="bi bi-clock"></i> ${new Date(training.created_at).toLocaleTimeString('fr-FR')}
                                ${timeAgo ? `<br><i class="bi bi-clock-history"></i> ${timeAgo}` : ''}
                            </small>
                        </div>
                        <div class="col-md-2">
                            <span class="badge bg-${statusClass} px-3 py-2">
                                <i class="bi bi-${statusIcon}"></i> ${getStatusText(training.status)}
                            </span>
                            ${training.status === 'completed' && Object.keys(metrics).length > 0 ? `
                                <div class="mt-2">
                                    ${(() => {
                                        // Get problem type from training hyperparameters
                                        let isClassification = false;
                                        if (training.hyperparameters && training.hyperparameters.problem_type) {
                                            isClassification = training.hyperparameters.problem_type === 'classification';
                                        } else {
                                            // Fallback: determine from available metrics
                                            isClassification = metrics.accuracy !== undefined || metrics.precision !== undefined || metrics.f1_score !== undefined;
                                        }
                                        
                                        if (isClassification) {
                                            if (metrics.accuracy !== undefined) {
                                                return `<div class="text-success small fw-bold"><i class="bi bi-bullseye"></i> ${(metrics.accuracy * 100).toFixed(1)}%</div>`;
                                            } else if (metrics.f1_score !== undefined) {
                                                return `<div class="text-success small fw-bold"><i class="bi bi-bullseye"></i> F1: ${(metrics.f1_score * 100).toFixed(1)}%</div>`;
                                            } else if (metrics.precision !== undefined) {
                                                return `<div class="text-success small fw-bold"><i class="bi bi-bullseye"></i> ${(metrics.precision * 100).toFixed(1)}%</div>`;
                                            }
                                        } else {
                                            if (metrics.r2 !== undefined) {
                                                return `<div class="text-info small fw-bold"><i class="bi bi-graph-up"></i> R²: ${metrics.r2.toFixed(3)}</div>`;
                                            } else if (metrics.mae !== undefined) {
                                                return `<div class="text-warning small fw-bold"><i class="bi bi-graph-down"></i> MAE: ${metrics.mae.toFixed(3)}</div>`;
                                            }
                                        }
                                        return '';
                                    })()}
                                </div>
                            ` : ''}
                        </div>
                        <div class="col-md-4">
                            ${training.status === 'completed' && Object.keys(metrics).length > 0 ? `
                                <div class="metrics-summary">
                                    ${(() => {
                                        // Determine problem type
                                        let isClassification = false;
                                        let problemType = 'Régression';
                                        if (training.hyperparameters && training.hyperparameters.problem_type) {
                                            isClassification = training.hyperparameters.problem_type === 'classification';
                                            problemType = isClassification ? 'Classification' : 'Régression';
                                        } else {
                                            // Fallback: determine from available metrics
                                            isClassification = metrics.accuracy !== undefined || metrics.precision !== undefined || metrics.f1_score !== undefined;
                                            problemType = isClassification ? 'Classification' : 'Régression';
                                        }
                                        
                                        return `
                                            <div class="metric-item">
                                                <i class="bi bi-diagram-3"></i>
                                                <span class="metric-label">Type:</span>
                                                <span class="metric-value">${problemType}</span>
                                            </div>
                                            ${training.model_type === 'random_forest' && training.hyperparameters && training.hyperparameters.n_estimators ? `
                                                <div class="metric-item">
                                                    <i class="bi bi-tree"></i>
                                                    <span class="metric-label">Arbres:</span>
                                                    <span class="metric-value">${training.hyperparameters.n_estimators}</span>
                                                </div>
                                            ` : ''}
                                            ${isClassification ? `
                                                ${metrics.accuracy !== undefined ? `
                                                    <div class="metric-item">
                                                        <i class="bi bi-bullseye"></i>
                                                        <span class="metric-label">Précision:</span>
                                                        <span class="metric-value">${(metrics.accuracy * 100).toFixed(2)}%</span>
                                                    </div>
                                                ` : ''}
                                                ${metrics.f1_score !== undefined ? `
                                                    <div class="metric-item">
                                                        <i class="bi bi-award"></i>
                                                        <span class="metric-label">Score F1:</span>
                                                        <span class="metric-value">${(metrics.f1_score * 100).toFixed(2)}%</span>
                                                    </div>
                                                ` : ''}
                                            ` : `
                                                ${metrics.r2 !== undefined ? `
                                                    <div class="metric-item">
                                                        <i class="bi bi-graph-up"></i>
                                                        <span class="metric-label">R²:</span>
                                                        <span class="metric-value">${metrics.r2.toFixed(4)}</span>
                                                    </div>
                                                ` : ''}
                                                ${metrics.mae !== undefined ? `
                                                    <div class="metric-item">
                                                        <i class="bi bi-graph-down"></i>
                                                        <span class="metric-label">MAE:</span>
                                                        <span class="metric-value">${metrics.mae.toFixed(4)}</span>
                                                    </div>
                                                ` : ''}
                                            `}
                                        `;
                                    })()}
                                </div>
                            ` : training.status === 'failed' ? `
                                <div class="text-danger">
                                    <i class="bi bi-exclamation-triangle"></i> 
                                    ${training.error_message || 'Échec de l\'entraînement'}
                                </div>
                            ` : training.status === 'training' ? `
                                <div class="text-info">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    Entraînement en cours...
                                    ${training.progress ? `(${Math.round(training.progress * 100)}%)` : ''}
                                </div>
                            ` : '<span class="text-muted">Aucune métrique disponible</span>'}
                        </div>
                        <div class="col-md-3 text-end pe-0">
                            <div class="btn-group btn-group-sm" role="group">
                                ${training.status === 'completed' ? `
                                    <button class="btn btn-sm btn-primary" 
                                            onclick="window.location.href='/training-sessions/${training.id}/results/'"
                                            title="Voir l'analyse complète">
                                        <i class="bi bi-bar-chart-line"></i> Analyse
                                    </button>
                                    <button class="btn btn-sm btn-success" 
                                            onclick="downloadModel(${training.id})"
                                            title="Télécharger le modèle">
                                        <i class="bi bi-download"></i>
                                    </button>
                                    <button class="btn btn-sm btn-info" 
                                            onclick="window.location.href='/predictions/?session=${training.id}'"
                                            title="Faire des prédictions">
                                        <i class="bi bi-cpu"></i> Prédire
                                    </button>
                                ` : training.status === 'training' ? `
                                    <button class="btn btn-sm btn-warning" 
                                            onclick="window.location.href='/training-progress/${training.id}/'"
                                            title="Voir la progression">
                                        <i class="bi bi-hourglass-split"></i> Progression
                                    </button>
                                ` : training.status === 'failed' ? `
                                    <button class="btn btn-sm btn-danger" 
                                            onclick="retryTraining(${training.id})"
                                            title="Réessayer l'entraînement">
                                        <i class="bi bi-arrow-clockwise"></i> Réessayer
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm btn-danger" 
                                        onclick="deleteTraining(${training.id})"
                                        title="Supprimer cet entraînement">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('')}
    `;
}

// Download model file
function downloadModel(sessionId) {
    // Use the new download endpoint
    window.location.href = `/api/training-sessions/${sessionId}/download-model/`;
}

// Retry training for a failed session
function retryTraining(sessionId) {
    if (confirm('Voulez-vous réessayer cet entraînement avec les mêmes paramètres ?')) {
        // Get the training session data
        fetch(`/api/training-sessions/${sessionId}/`)
            .then(response => response.json())
            .then(session => {
                // Create a new training session with the same parameters
                const trainingData = {
                    model_definition: session.model_definition,
                    name: `${session.name} - Retry ${new Date().toISOString()}`,
                    model_type: session.model_type,
                    dataset: session.dataset,
                    predictor_columns: session.predictor_columns,
                    target_columns: session.target_columns,
                    config: session.config,
                    hyperparameters: session.hyperparameters,
                    train_split: session.train_split,
                    val_split: session.val_split,
                    test_split: session.test_split,
                    normalization_method: session.normalization_method,
                    selected_metrics: session.selected_metrics
                };
                
                // Create and start the new training
                fetch('/api/training-sessions/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(trainingData)
                })
                .then(response => response.json())
                .then(newSession => {
                    // Start training
                    return fetch(`/api/training-sessions/${newSession.id}/train/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    });
                })
                .then(response => response.json())
                .then(result => {
                    showNotification('Succès', 'L\'entraînement a été relancé', 'success');
                    // Refresh the training history
                    if (session.model_definition) {
                        showTrainingHistory(session.model_definition);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Erreur', 'Impossible de relancer l\'entraînement', 'error');
                });
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Erreur', 'Impossible de récupérer les données de la session', 'error');
            });
    }
}

// Delete a training session
function deleteTraining(sessionId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cet entraînement ? Cette action est irréversible.')) {
        fetch(`/api/training-sessions/${sessionId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (response.ok) {
                showNotification('Succès', 'L\'entraînement a été supprimé', 'success');
                // Refresh the training history
                if (selectedModel && selectedModel.id) {
                    showTrainingHistory(selectedModel.id);
                }
            } else {
                throw new Error('Erreur lors de la suppression');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Erreur', 'Impossible de supprimer l\'entraînement', 'error');
        });
    }
}

// Entraîner le modèle
// Variable globale pour stocker le modèle en cours d'entraînement
let currentTrainingModel = null;

function trainModel(modelId) {
    const model = modelsList.find(m => m.id === modelId);
    if (!model) return;
    
    // Stocker le modèle pour l'utiliser dans confirmTraining
    currentTrainingModel = model;
    
    // Mettre à jour les informations du modal
    document.getElementById('trainModelInfo').innerHTML = `
        <strong>Modèle:</strong> ${model.name}<br>
        <strong>Type:</strong> ${model.model_type.toUpperCase()}<br>
        <strong>Dataset:</strong> ${model.dataset_name || 'Dataset #' + model.dataset}
    `;
    
    // Afficher le modal de configuration
    const modal = new bootstrap.Modal(document.getElementById('trainConfigModal'));
    modal.show();
}

function confirmTraining() {
    if (!currentTrainingModel) return;
    
    // Valider les pourcentages
    if (!updateDataSplitsConfig()) {
        showNotification('Erreur', 'Les pourcentages de division des données doivent totaliser 100%', 'error');
        return;
    }
    
    const trainSize = parseInt(document.getElementById('trainSizeConfig').value);
    const valSize = parseInt(document.getElementById('valSizeConfig').value);
    const testSize = parseInt(document.getElementById('testSizeConfig').value);
    
    // Créer une nouvelle session d'entraînement avec les paramètres de division
    const trainingData = {
        model_definition: currentTrainingModel.id,
        name: `${currentTrainingModel.name} - Training ${new Date().toISOString()}`,
        model_type: currentTrainingModel.model_type,
        dataset: currentTrainingModel.dataset,
        predictor_columns: currentTrainingModel.predictor_columns,
        target_columns: currentTrainingModel.target_columns,
        config: currentTrainingModel.default_config,
        hyperparameters: currentTrainingModel.hyperparameters,
        custom_architecture: currentTrainingModel.custom_architecture,
        use_custom_architecture: currentTrainingModel.use_custom_architecture,
        train_split: trainSize / 100,
        val_split: valSize / 100,
        test_split: testSize / 100,
        test_size: testSize / 100  // Pour compatibilité
    };
    
    // Fermer le modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('trainConfigModal'));
    modal.hide();
    
    showLoading('Initialisation de l\'entraînement...', 'Préparation de votre modèle d\'IA');
    
    fetch('/api/training-sessions/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(trainingData)
    })
    .then(response => response.json())
    .then(session => {
        hideLoading();
        currentTrainingModel = null;
        // Rediriger vers la page de progression
        window.location.href = `/training-progress/${session.id}/`;
    })
    .catch(error => {
        hideLoading();
        currentTrainingModel = null;
        console.error('Erreur:', error);
        showNotification('Erreur', 'Impossible de démarrer l\'entraînement', 'error');
    });
}

// Éditer le modèle
// Helper function to load model form data
function loadModelFormData(model) {
    console.log('Loading model form data:', model);
    console.log('Hyperparameters:', model.hyperparameters);
    
    document.getElementById('modelName').value = model.name;
    document.getElementById('modelType').value = model.model_type;
    document.getElementById('epochs').value = model.hyperparameters?.epochs || 50;
    
    const testSize = model.hyperparameters?.test_size || 0.2;
    console.log('Loading test_size:', testSize, '-> UI value:', testSize * 100);
    document.getElementById('testSize').value = testSize * 100;
}

// Helper function to load hyperparameters
function loadModelHyperparameters(hyperparams) {
    if (!hyperparams) return;
    
    const paramMapping = {
        'loss_function': 'lossFunction',
        'optimizer': 'optimizer',
        'learning_rate': 'learningRate',
        'batch_size': 'batchSize',
        'output_activation': 'outputActivation',
        'output_units': 'outputUnits'
    };
    
    Object.entries(paramMapping).forEach(([key, elementId]) => {
        if (hyperparams[key]) {
            const element = document.getElementById(elementId);
            if (element) element.value = hyperparams[key];
        }
    });
}

// Helper function to load custom architecture
function loadCustomArchitecture(model) {
    if (model.use_custom_architecture && model.custom_architecture?.length > 0) {
        document.getElementById('expertMode').checked = true;
        toggleExpertMode();
        renderLayers();
    }
}

// Helper function to select dataset columns
function selectDatasetColumns(model) {
    // Sélectionner les variables cibles
    model.target_columns.forEach(col => {
        if (!col) return;
        const safeId = col.replace(/[^a-zA-Z0-9]/g, '_');
        const checkbox = document.querySelector(`#target_${safeId}`);
        if (checkbox) checkbox.checked = true;
    });
    
    // Sélectionner les variables prédictives
    model.predictor_columns.forEach(col => {
        if (!col) return;
        const safeId = col.replace(/[^a-zA-Z0-9]/g, '_');
        const checkbox = document.querySelector(`#pred_${safeId}`);
        if (checkbox) checkbox.checked = true;
    });
    
    applyModelRules();
}

// Helper function to setup edit modal UI
function setupEditModalUI(model, modelId) {
    // Changer le titre du modal
    document.querySelector('#createModelModal .modal-title').innerHTML = `
        <i class="bi bi-pencil-square"></i> Éditer le Modèle - ${model.name}
    `;
    
    // Changer le bouton pour sauvegarder
    const footer = document.querySelector('#createModelModal .modal-footer');
    footer.innerHTML = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" onclick="updateModel(${modelId})">
            <i class="bi bi-save"></i> Sauvegarder les modifications
        </button>
    `;
}

// Refactored editModel function
function editModel(modelId) {
    console.log('Editing model:', modelId);
    const model = modelsList.find(m => m.id === modelId);
    if (!model) {
        console.error('Model not found:', modelId);
        return;
    }
    
    selectedModel = model;
    
    // Clean up and reset
    cleanupModals();
    document.getElementById('createModelForm').reset();
    networkLayers = model.custom_architecture || [];
    layerIdCounter = networkLayers.length;
    
    // Load model data
    loadModelFormData(model);
    loadModelHyperparameters(model.hyperparameters);
    loadCustomArchitecture(model);
    
    // Load datasets and select the right one
    fetch('/api/datasets/')
        .then(response => response.json())
        .then(datasets => {
            const select = document.getElementById('dataset');
            select.innerHTML = '<option value="">Sélectionner un dataset...</option>';
            
            datasets.forEach(dataset => {
                const option = document.createElement('option');
                option.value = dataset.id;
                option.textContent = dataset.name;
                if (dataset.id === model.dataset) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // Load dataset columns if dataset is selected
            if (model.dataset) {
                loadDatasetColumns();
                
                // Select appropriate columns after loading
                setTimeout(() => selectDatasetColumns(model), 1000);
            }
            
            // Setup modal UI for editing
            setupEditModalUI(model, modelId);
            
            // Load model-specific configurations with delay to ensure DOM is ready
            setTimeout(() => {
                if (model.model_type === 'random_forest' && model.hyperparameters) {
                    if (typeof loadRandomForestConfiguration === 'function') {
                        loadRandomForestConfiguration(model.hyperparameters);
                    }
                } else if (model.model_type === 'xgboost' && model.hyperparameters) {
                    if (typeof loadXGBoostConfiguration === 'function') {
                        loadXGBoostConfiguration(model.hyperparameters);
                    }
                } else if (model.model_type === 'decision_tree' && model.hyperparameters) {
                    if (typeof loadDecisionTreeConfiguration === 'function') {
                        loadDecisionTreeConfiguration(model.hyperparameters);
                    }
                }
            }, 500);
            
            // Update framework options and show modal
            updateFrameworkOptions();
            showModalSafely('createModelModal');
        })
        .catch(error => {
            console.error('Error loading datasets:', error);
            showNotification('Erreur', 'Impossible de charger les datasets', 'error');
        });
}

// Mettre à jour le modèle
function updateModel(modelId) {
    const modelType = document.getElementById('modelType').value;
    
    // Validation du type de modèle
    if (!modelType || !modelRules[modelType]) {
        showNotification('Erreur', 'Veuillez sélectionner un type de modèle', 'error');
        return;
    }
    
    const rules = modelRules[modelType];
    
    // Collecter les variables cibles sélectionnées
    const targetCheckboxes = document.querySelectorAll('.target-checkbox:checked');
    const targetColumns = Array.from(targetCheckboxes).map(cb => cb.value);
    
    // Collecter les variables prédictives sélectionnées
    const predictorCheckboxes = document.querySelectorAll('.predictor-checkbox:checked:not(:disabled)');
    const predictorColumns = Array.from(predictorCheckboxes).map(cb => cb.value);
    
    // Validation selon les règles du modèle
    if (targetColumns.length < rules.minTargets) {
        showNotification('Erreur', `${rules.name} nécessite au moins ${rules.minTargets} variable(s) cible(s)`, 'error');
        return;
    }
    
    if (predictorColumns.length < rules.minPredictors) {
        showNotification('Erreur', `${rules.name} nécessite au moins ${rules.minPredictors} variable(s) prédictive(s)`, 'error');
        return;
    }
    
    // Construire la configuration du modèle
    const expertModeElement = document.getElementById('expertMode');
    const expertMode = expertModeElement ? expertModeElement.checked : false;
    
    // Get test size with null check
    const testSizeElement = document.getElementById('testSize');
    const testSizeValue = testSizeElement ? parseInt(testSizeElement.value) / 100 : 0.2;
    
    // Get epochs with null check
    const epochsElement = document.getElementById('epochs');
    const epochsValue = epochsElement ? parseInt(epochsElement.value) : 50;
    
    let modelConfig = {
        epochs: epochsValue,
        test_size: testSizeValue
    };
    
    console.log('Saving model config:', modelConfig);
    console.log('Test size being saved:', testSizeValue);
    console.log('Model type:', modelType);
    
    // Configuration commune pour les modèles de deep learning
    if (isDeepLearningModel(modelType) || expertMode) {
        modelConfig.loss_function = document.getElementById('lossFunction').value;
        modelConfig.optimizer = document.getElementById('optimizer').value;
        modelConfig.learning_rate = parseFloat(document.getElementById('learningRate').value);
        modelConfig.batch_size = parseInt(document.getElementById('batchSize').value);
        
        // Métriques sélectionnées
        const selectedMetrics = Array.from(document.querySelectorAll('.metric-checkbox:checked')).map(cb => cb.value);
        modelConfig.metrics = selectedMetrics;
        
        // Callbacks
        modelConfig.callbacks = {
            early_stopping: document.getElementById('earlyStoppingCallback').checked,
            reduce_lr: document.getElementById('reduceLRCallback').checked,
            model_checkpoint: document.getElementById('modelCheckpointCallback').checked
        };
        
        // Configuration de sortie
        modelConfig.output_activation = document.getElementById('outputActivation').value;
        modelConfig.output_units = parseInt(document.getElementById('outputUnits').value);
    }
    
    // Configuration Random Forest
    if (modelType === 'random_forest') {
        const rfConfig = getRandomForestConfig();
        console.log('Random Forest config:', rfConfig);
        modelConfig = { ...modelConfig, ...rfConfig };
    }
    
    // Configuration XGBoost
    if (modelType === 'xgboost') {
        modelConfig = { ...modelConfig, ...getXGBoostConfig() };
    }
    
    // Configuration Decision Tree
    if (modelType === 'decision_tree') {
        modelConfig = { ...modelConfig, ...getDecisionTreeConfig() };
    }
    
    // Architecture personnalisée en mode expert
    if (expertMode && networkLayers.length > 0) {
        modelConfig.custom_architecture = networkLayers;
        modelConfig.use_custom_architecture = true;
    } else {
        modelConfig.use_custom_architecture = false;
    }
    
    const modelData = {
        name: document.getElementById('modelName').value,
        description: `Modèle ${modelType.toUpperCase()} pour prédire ${targetColumns.join(', ')}`,
        model_type: modelType,
        dataset: document.getElementById('dataset').value,
        target_columns: targetColumns,
        predictor_columns: predictorColumns,
        default_config: modelConfig,
        hyperparameters: modelConfig,
        custom_architecture: expertMode && networkLayers.length > 0 ? networkLayers : null,
        use_custom_architecture: expertMode && networkLayers.length > 0
    };
    
    showLoading();
    
    const csrfToken = getCookie('csrftoken');
    
    // Mettre à jour le modèle
    fetch(`/api/models/${modelId}/`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(modelData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(modelDef => {
        // Fermer le modal et recharger la liste
        hideLoading();
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('createModelModal'));
        if (modalInstance) {
            modalInstance.hide();
            modalInstance.dispose();
        }
        cleanupModals();
        
        // Reset form and state
        document.getElementById('createModelForm').reset();
        networkLayers = [];
        layerIdCounter = 0;
        document.getElementById('expertMode').checked = false;
        toggleExpertMode();
        
        // Reset modal title and footer for next use
        document.querySelector('#createModelModal .modal-title').innerHTML = `
            <i class="bi bi-cpu"></i> Créer un Nouveau Modèle
        `;
        
        const footer = document.querySelector('#createModelModal .modal-footer');
        footer.innerHTML = `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-primary" onclick="createModelOnly()">
                <i class="bi bi-save"></i> Créer le Modèle
            </button>
        `;
        
        showNotification('Succès', 'Modèle mis à jour avec succès!', 'success');
        
        // Recharger la page après un court délai pour éviter les problèmes
        setTimeout(() => {
            window.location.reload();
        }, 1500);
    })
    .catch(error => {
        hideLoading();
        showNotification('Erreur', 'Erreur lors de la mise à jour du modèle: ' + error, 'error');
    });
}

// Cloner le modèle
function cloneModel(modelId) {
    const model = modelsList.find(m => m.id === modelId);
    if (!model) return;
    
    Swal.fire({
        title: 'Cloner le modèle',
        text: `Voulez-vous créer une copie de "${model.name}"?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#8a2be2',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Oui, cloner',
        cancelButtonText: 'Annuler',
        background: '#1a1f3a',
        color: '#ffffff',
        customClass: {
            popup: 'swal-custom-popup',
            title: 'swal-custom-title',
            htmlContainer: 'swal-custom-text',
            confirmButton: 'swal-custom-button'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading();
            
            fetch(`/api/models/${modelId}/clone/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(newModel => {
                hideLoading();
                showNotification('Succès', 'Modèle cloné avec succès', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                hideLoading();
                console.error('Erreur:', error);
                showNotification('Erreur', 'Impossible de cloner le modèle', 'error');
            });
        }
    });
}

// Supprimer le modèle
function deleteModel(modelId) {
    const model = modelsList.find(m => m.id === modelId);
    if (!model) return;
    
    Swal.fire({
        title: 'Êtes-vous sûr?',
        html: `
            <p>Voulez-vous vraiment supprimer le modèle "<strong>${model.name}</strong>"?</p>
            <p class="text-warning"><i class="bi bi-exclamation-triangle"></i> Cette action supprimera également tous les entraînements associés.</p>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Oui, supprimer',
        cancelButtonText: 'Annuler',
        background: '#1a1f3a',
        color: '#ffffff',
        customClass: {
            popup: 'swal-custom-popup',
            title: 'swal-custom-title',
            htmlContainer: 'swal-custom-text',
            confirmButton: 'swal-custom-button'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading();
            
            fetch(`/api/models/${modelId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(() => {
                hideLoading();
                showNotification('Succès', 'Modèle supprimé avec succès', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                hideLoading();
                console.error('Erreur:', error);
                showNotification('Erreur', 'Impossible de supprimer le modèle', 'error');
            });
        }
    });
}

// Fonction utilitaire pour obtenir le cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Ensure cleanupModals is available if not defined in base.html
if (typeof cleanupModals === 'undefined') {
    function cleanupModals() {
        // Hide and dispose all visible modals
        document.querySelectorAll('.modal.show').forEach(modalEl => {
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) {
                modalInstance.hide();
                // Dispose after hiding to ensure clean transition
                setTimeout(() => {
                    modalInstance.dispose();
                }, 300);
            }
        });
        
        // Remove all backdrops with a slight delay
        setTimeout(() => {
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        }, 100);
    }
}

// Afficher le chargement
function showLoading() {
    const loader = document.createElement('div');
    loader.id = 'globalLoader';
    loader.className = 'text-center p-5';
    loader.innerHTML = `
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Chargement...</span>
        </div>
    `;
    document.body.appendChild(loader);
}

// Masquer le chargement
function hideLoading() {
    const loader = document.getElementById('globalLoader');
    if (loader) {
        loader.remove();
    }
}

// Afficher une notification
function showNotification(title, message, type = 'info') {
    const icon = type === 'success' ? 'check-circle' : 
                 type === 'error' ? 'x-circle' : 
                 type === 'warning' ? 'exclamation-triangle' : 'info-circle';
                 
    const bgColor = type === 'success' ? 'success' : 
                    type === 'error' ? 'danger' : 
                    type === 'warning' ? 'warning' : 'info';
    
    const notification = document.createElement('div');
    notification.className = `alert alert-${bgColor} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-${icon} fs-4 me-2"></i>
            <div>
                <strong>${title}</strong>
                <p class="mb-0 small">${message}</p>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Définir les règles spécifiques pour chaque type de modèle
const modelRules = {
    'random_forest': {
        name: 'Random Forest',
        minTargets: 1,
        maxTargets: null, // Pas de limite, permet multi-output
        minPredictors: 1,
        allowSameVarAsBoth: false,
        description: 'Modèle de classification/régression multi-sortie. Peut prédire une ou plusieurs variables cibles simultanément. Nécessite au moins 1 variable prédictive. Les variables ne peuvent pas être à la fois cible et prédictive.'
    },
    'lstm': {
        name: 'LSTM',
        minTargets: 1,
        maxTargets: null, // Pas de limite
        minPredictors: 1,
        allowSameVarAsBoth: true,
        description: 'Réseau de neurones récurrent pour séries temporelles. Peut prédire plusieurs variables simultanément. Les variables peuvent être à la fois cible et prédictive (prédiction auto-régressive).'
    },
    'gru': {
        name: 'GRU',
        minTargets: 1,
        maxTargets: null,
        minPredictors: 1,
        allowSameVarAsBoth: true,
        description: 'Réseau de neurones récurrent optimisé. Similaire à LSTM mais plus rapide. Peut gérer des prédictions multivariées et auto-régressives.'
    },
    'xgboost': {
        name: 'XGBoost',
        minTargets: 1,
        maxTargets: 1,
        minPredictors: 1,
        allowSameVarAsBoth: false,
        description: 'Boosting de gradient optimisé. Excellent pour la classification/régression. Nécessite exactement 1 variable cible.'
    },
    'gradient_boosting': {
        name: 'Gradient Boosting',
        minTargets: 1,
        maxTargets: 1,
        minPredictors: 1,
        allowSameVarAsBoth: false,
        description: 'Méthode d\'ensemble par boosting. Nécessite exactement 1 variable cible et au moins 1 variable prédictive distincte.'
    },
    'decision_tree': {
        name: 'Decision Tree',
        minTargets: 1,
        maxTargets: 1,
        minPredictors: 1,
        allowSameVarAsBoth: false,
        description: 'Arbre de décision pour classification/régression. Modèle interprétable nécessitant exactement 1 variable cible.'
    }
};

// Variables globales pour l'architecture du réseau
let networkLayers = [];
let layerIdCounter = 0;

// Configuration des paramètres par défaut pour chaque type de couche
const layerDefaults = {
    dense: {
        name: 'Dense',
        params: {
            units: { type: 'number', default: 128, min: 1, label: 'Unités' },
            activation: { 
                type: 'select', 
                default: 'relu', 
                options: ['relu', 'tanh', 'sigmoid', 'linear', 'elu', 'selu', 'swish'],
                label: 'Activation'
            },
            use_bias: { type: 'checkbox', default: true, label: 'Utiliser Bias' },
            kernel_initializer: {
                type: 'select',
                default: 'glorot_uniform',
                options: ['glorot_uniform', 'glorot_normal', 'he_uniform', 'he_normal', 'random_normal', 'random_uniform'],
                label: 'Initialisation'
            }
        }
    },
    lstm: {
        name: 'LSTM',
        params: {
            units: { type: 'number', default: 128, min: 1, label: 'Unités' },
            activation: { type: 'select', default: 'tanh', options: ['tanh', 'sigmoid', 'relu'], label: 'Activation' },
            recurrent_activation: { type: 'select', default: 'sigmoid', options: ['sigmoid', 'tanh', 'relu'], label: 'Activation Récurrente' },
            return_sequences: { type: 'checkbox', default: false, label: 'Return Sequences' },
            dropout: { type: 'number', default: 0, min: 0, max: 1, step: 0.1, label: 'Dropout' },
            recurrent_dropout: { type: 'number', default: 0, min: 0, max: 1, step: 0.1, label: 'Dropout Récurrent' }
        }
    },
    gru: {
        name: 'GRU',
        params: {
            units: { type: 'number', default: 128, min: 1, label: 'Unités' },
            activation: { type: 'select', default: 'tanh', options: ['tanh', 'sigmoid', 'relu'], label: 'Activation' },
            recurrent_activation: { type: 'select', default: 'sigmoid', options: ['sigmoid', 'tanh', 'relu'], label: 'Activation Récurrente' },
            return_sequences: { type: 'checkbox', default: false, label: 'Return Sequences' },
            dropout: { type: 'number', default: 0, min: 0, max: 1, step: 0.1, label: 'Dropout' },
            recurrent_dropout: { type: 'number', default: 0, min: 0, max: 1, step: 0.1, label: 'Dropout Récurrent' }
        }
    },
    conv1d: {
        name: 'Conv1D',
        params: {
            filters: { type: 'number', default: 64, min: 1, label: 'Filtres' },
            kernel_size: { type: 'number', default: 3, min: 1, label: 'Taille du Noyau' },
            strides: { type: 'number', default: 1, min: 1, label: 'Strides' },
            padding: { type: 'select', default: 'same', options: ['valid', 'same', 'causal'], label: 'Padding' },
            activation: { type: 'select', default: 'relu', options: ['relu', 'tanh', 'sigmoid', 'linear'], label: 'Activation' }
        }
    },
    dropout: {
        name: 'Dropout',
        params: {
            rate: { type: 'number', default: 0.2, min: 0, max: 1, step: 0.05, label: 'Taux de Dropout' }
        }
    },
    batchnorm: {
        name: 'BatchNormalization',
        params: {
            momentum: { type: 'number', default: 0.99, min: 0, max: 1, step: 0.01, label: 'Momentum' },
            epsilon: { type: 'number', default: 0.001, min: 0, step: 0.0001, label: 'Epsilon' }
        }
    },
    flatten: {
        name: 'Flatten',
        params: {}
    }
};

// Charger les colonnes du dataset sélectionné
function loadDatasetColumns() {
    const datasetId = document.getElementById('dataset').value;
    const targetDiv = document.getElementById('targetVariables');
    const predictorDiv = document.getElementById('predictorVariables');
    
    if (!datasetId) {
        targetDiv.innerHTML = '<p class="text-muted">Sélectionnez d\'abord un dataset</p>';
        predictorDiv.innerHTML = '<p class="text-muted">Sélectionnez d\'abord un dataset</p>';
        return;
    }
    
    // Afficher un message de chargement
    targetDiv.innerHTML = '<p class="text-muted"><i class="bi bi-hourglass-split"></i> Chargement des colonnes...</p>';
    predictorDiv.innerHTML = '<p class="text-muted"><i class="bi bi-hourglass-split"></i> Chargement des colonnes...</p>';
    
    fetch(`/api/datasets/${datasetId}/columns/`)
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Données reçues:', data); // Debug
            
            // Vérifier la structure de la réponse
            if (!data || typeof data !== 'object') {
                throw new Error('Réponse invalide du serveur');
            }
            
            // La réponse contient un objet avec 'columns' et 'dtypes'
            // Filtrer les colonnes pour s'assurer qu'elles sont valides
            const rawColumns = data.columns || [];
            console.log('Colonnes brutes:', rawColumns);
            
            const columns = rawColumns.filter(col => col && typeof col === 'string');
            console.log('Colonnes filtrées:', columns);
            
            if (rawColumns.length !== columns.length) {
                console.warn(`${rawColumns.length - columns.length} colonnes invalides ont été filtrées`);
            }
            
            const dtypes = data.dtypes || {};
            
            // Créer les checkboxes pour les variables cibles et prédictives
            targetDiv.innerHTML = '';
            predictorDiv.innerHTML = '';
            
            if (columns.length === 0) {
                targetDiv.innerHTML = '<p class="text-warning">Aucune colonne trouvée dans ce dataset</p>';
                predictorDiv.innerHTML = '<p class="text-warning">Aucune colonne trouvée dans ce dataset</p>';
                return;
            }
            
            columns.forEach(columnName => {
                // Skip if columnName is undefined or null
                if (!columnName) {
                    console.warn('Colonne vide ou non définie trouvée, ignorée');
                    return;
                }
                
                // Ensure columnName is a string
                const colName = String(columnName);
                const dtype = dtypes[colName] || 'unknown';
                const safeId = colName.replace(/[^a-zA-Z0-9]/g, '_');
                
                // Créer une checkbox pour les variables cibles
                const targetCheckboxDiv = document.createElement('div');
                targetCheckboxDiv.className = 'form-check mb-2';
                targetCheckboxDiv.innerHTML = `
                    <input class="form-check-input target-checkbox" type="checkbox" 
                           value="${colName}" id="target_${safeId}">
                    <label class="form-check-label" for="target_${safeId}" style="cursor: pointer;">
                        ${colName} <span class="text-muted small">(${dtype})</span>
                    </label>
                `;
                targetDiv.appendChild(targetCheckboxDiv);
                
                // Créer une checkbox pour les variables prédictives
                const predCheckboxDiv = document.createElement('div');
                predCheckboxDiv.className = 'form-check mb-2';
                predCheckboxDiv.innerHTML = `
                    <input class="form-check-input predictor-checkbox" type="checkbox" 
                           value="${colName}" id="pred_${safeId}" checked>
                    <label class="form-check-label" for="pred_${safeId}" style="cursor: pointer;">
                        ${colName} <span class="text-muted small">(${dtype})</span>
                    </label>
                `;
                predictorDiv.appendChild(predCheckboxDiv);
            });
            
            // Appliquer les règles du modèle sélectionné
            applyModelRules();
            
            // Commented out to avoid interfering with modal display
            // showNotification('Succès', `${columns.length} colonnes chargées`, 'success');
        })
        .catch(error => {
            console.error('Erreur lors du chargement des colonnes:', error);
            console.error('Stack trace:', error.stack);
            
            // Message d'erreur plus détaillé
            let errorMessage = 'Impossible de charger les colonnes du dataset';
            if (error.message) {
                errorMessage += ': ' + error.message;
            }
            
            targetDiv.innerHTML = `<p class="text-danger">Erreur lors du chargement des colonnes: ${error.message || 'Erreur inconnue'}</p>`;
            predictorDiv.innerHTML = `<p class="text-danger">Erreur lors du chargement des colonnes: ${error.message || 'Erreur inconnue'}</p>`;
            
            showNotification('Erreur', errorMessage, 'error');
        });
    
    // Actualizar visualización cuando se carguen las columnas del dataset
    setTimeout(() => {
        updateDataSplitVisualization();
    }, 100);
}

// Appliquer les règles du modèle sélectionné
function applyModelRules() {
    const modelType = document.getElementById('modelType').value;
    const modelReqDiv = document.getElementById('modelRequirements');
    const modelReqText = document.getElementById('modelRequirementsText');
    
    if (!modelType || !modelRules[modelType]) {
        if (modelReqDiv) modelReqDiv.style.display = 'none';
        return;
    }
    
    const rules = modelRules[modelType];
    if (modelReqDiv) modelReqDiv.style.display = 'block';
    if (modelReqText) modelReqText.innerHTML = rules.description;
    
    // Mettre à jour les textes d'aide
    const targetHelp = document.getElementById('targetHelp');
    const predictorHelp = document.getElementById('predictorHelp');
    
    if (rules.maxTargets === 1) {
        targetHelp.textContent = 'Sélectionnez exactement 1 variable à prédire';
    } else {
        targetHelp.textContent = 'Sélectionnez une ou plusieurs variables à prédire';
    }
    
    if (!rules.allowSameVarAsBoth) {
        predictorHelp.textContent = 'Les variables cibles ne peuvent pas être sélectionnées comme prédictives';
    } else {
        predictorHelp.textContent = 'Les variables peuvent être à la fois cibles et prédictives';
    }
    
    // Appliquer les restrictions si nécessaire
    updateVariableRestrictions();
}

// Mettre à jour les restrictions sur les variables
function updateVariableRestrictions() {
    const modelType = document.getElementById('modelType').value;
    if (!modelType || !modelRules[modelType]) return;
    
    const rules = modelRules[modelType];
    const targetCheckboxes = document.querySelectorAll('.target-checkbox:checked');
    const predictorCheckboxes = document.querySelectorAll('.predictor-checkbox');
    
    if (!rules.allowSameVarAsBoth) {
        // Désactiver dans les prédicteurs les variables sélectionnées comme cibles
        const targetValues = Array.from(targetCheckboxes).map(cb => cb.value);
        
        predictorCheckboxes.forEach(checkbox => {
            if (targetValues.includes(checkbox.value)) {
                checkbox.checked = false;
                checkbox.disabled = true;
                checkbox.parentElement.classList.add('text-muted');
            } else {
                checkbox.disabled = false;
                checkbox.parentElement.classList.remove('text-muted');
            }
        });
    } else {
        // Réactiver toutes les checkboxes si le modèle le permet
        predictorCheckboxes.forEach(checkbox => {
            checkbox.disabled = false;
            checkbox.parentElement.classList.remove('text-muted');
        });
    }
    
    // Si maxTargets = 1, désactiver les autres checkboxes cibles
    if (rules.maxTargets === 1 && targetCheckboxes.length >= 1) {
        document.querySelectorAll('.target-checkbox:not(:checked)').forEach(checkbox => {
            checkbox.disabled = true;
        });
    } else {
        document.querySelectorAll('.target-checkbox:not(:checked)').forEach(checkbox => {
            checkbox.disabled = false;
        });
    }
}

// Toggle du mode expert
function toggleExpertMode() {
    const expertModeElement = document.getElementById('expertMode');
    const modelTypeElement = document.getElementById('modelType');
    
    if (!expertModeElement || !modelTypeElement) {
        console.error('Expert mode or model type element not found');
        return;
    }
    
    const expertMode = expertModeElement.checked;
    const modelType = modelTypeElement.value;
    
    // Get all elements with null checks
    const modelConfigElement = document.getElementById('modelConfiguration');
    const networkArchElement = document.getElementById('networkArchitecture');
    const metricsCallbacksElement = document.getElementById('metricsCallbacks');
    const randomForestConfigElement = document.getElementById('randomForestConfiguration');
    const layersContainerElement = document.getElementById('layersContainer');
    
    // Afficher/masquer les sections selon le mode et le type de modèle
    if (modelType === 'random_forest') {
        // Pour Random Forest, ne montrer que sa configuration spécifique
        if (modelConfigElement && modelConfigElement.style) modelConfigElement.style.display = 'none';
        if (networkArchElement && networkArchElement.style) networkArchElement.style.display = 'none';
        if (metricsCallbacksElement && metricsCallbacksElement.style) metricsCallbacksElement.style.display = 'none';
        if (randomForestConfigElement && randomForestConfigElement.style) randomForestConfigElement.style.display = 'block';
        if (typeof updateRandomForestOptions === 'function') {
            updateRandomForestOptions();
        }
    } else {
        // Pour les autres modèles, logique normale
        if (modelConfigElement && modelConfigElement.style) modelConfigElement.style.display = expertMode || isDeepLearningModel(modelType) ? 'block' : 'none';
        if (networkArchElement && networkArchElement.style) networkArchElement.style.display = expertMode ? 'block' : 'none';
        if (metricsCallbacksElement && metricsCallbacksElement.style) metricsCallbacksElement.style.display = expertMode || isDeepLearningModel(modelType) ? 'block' : 'none';
        if (randomForestConfigElement && randomForestConfigElement.style) randomForestConfigElement.style.display = 'none';
    }
    
    // Si on désactive le mode expert, réinitialiser l'architecture personnalisée
    if (!expertMode) {
        networkLayers = [];
        if (layersContainerElement) {
            layersContainerElement.innerHTML = '<p class="text-muted text-center">Aucune couche ajoutée. Cliquez sur les boutons ci-dessus pour ajouter des couches.</p>';
        }
    }
}

// Vérifier si c'est un modèle de deep learning
function isDeepLearningModel(modelType) {
    return ['lstm', 'gru'].includes(modelType);
}

// Ajouter une couche
function addLayer(layerType) {
    const layerConfig = layerDefaults[layerType];
    if (!layerConfig) return;
    
    const layerId = layerIdCounter++;
    const layer = {
        id: layerId,
        type: layerType,
        name: layerConfig.name,
        params: {}
    };
    
    // Initialiser avec les valeurs par défaut
    Object.keys(layerConfig.params).forEach(param => {
        layer.params[param] = layerConfig.params[param].default;
    });
    
    networkLayers.push(layer);
    renderLayers();
}

// Rendre l'affichage des couches
function renderLayers() {
    const container = document.getElementById('layersContainer');
    
    if (networkLayers.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Aucune couche ajoutée. Cliquez sur les boutons ci-dessus pour ajouter des couches.</p>';
        return;
    }
    
    container.innerHTML = networkLayers.map((layer, index) => {
        const layerConfig = layerDefaults[layer.type];
        let paramsHtml = '';
        
        Object.keys(layerConfig.params).forEach(paramName => {
            const paramConfig = layerConfig.params[paramName];
            const value = layer.params[paramName];
            
            switch (paramConfig.type) {
                case 'number':
                    paramsHtml += `
                        <div class="mb-2">
                            <label class="form-label small">${paramConfig.label}</label>
                            <input type="number" class="form-control form-control-sm" 
                                   value="${value}" 
                                   min="${paramConfig.min || ''}" 
                                   max="${paramConfig.max || ''}" 
                                   step="${paramConfig.step || ''}"
                                   onchange="updateLayerParam(${layer.id}, '${paramName}', this.value)">
                        </div>
                    `;
                    break;
                case 'select':
                    paramsHtml += `
                        <div class="mb-2">
                            <label class="form-label small">${paramConfig.label}</label>
                            <select class="form-select form-select-sm" 
                                    onchange="updateLayerParam(${layer.id}, '${paramName}', this.value)">
                                ${paramConfig.options.map(opt => 
                                    `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`
                                ).join('')}
                            </select>
                        </div>
                    `;
                    break;
                case 'checkbox':
                    paramsHtml += `
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" 
                                   ${value ? 'checked' : ''}
                                   onchange="updateLayerParam(${layer.id}, '${paramName}', this.checked)">
                            <label class="form-check-label small">${paramConfig.label}</label>
                        </div>
                    `;
                    break;
            }
        });
        
        return `
            <div class="layer-item">
                <div class="layer-header">
                    <span class="layer-title">
                        <i class="bi bi-layers"></i> ${index + 1}. ${layer.name}
                    </span>
                    <div class="layer-controls">
                        <button class="btn btn-move btn-sm" onclick="moveLayer(${index}, -1)" 
                                ${index === 0 ? 'disabled' : ''}>
                            <i class="bi bi-arrow-up"></i>
                        </button>
                        <button class="btn btn-move btn-sm" onclick="moveLayer(${index}, 1)" 
                                ${index === networkLayers.length - 1 ? 'disabled' : ''}>
                            <i class="bi bi-arrow-down"></i>
                        </button>
                        <button class="btn btn-delete btn-sm" onclick="removeLayer(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="layer-params">
                    ${paramsHtml}
                </div>
            </div>
        `;
    }).join('');
}

// Mettre à jour un paramètre de couche
function updateLayerParam(layerId, paramName, value) {
    const layer = networkLayers.find(l => l.id === layerId);
    if (layer) {
        // Convertir les valeurs string en nombres si nécessaire
        if (typeof value === 'string' && !isNaN(value) && value !== '') {
            value = parseFloat(value);
        }
        layer.params[paramName] = value;
    }
}

// Déplacer une couche
function moveLayer(index, direction) {
    if (index + direction < 0 || index + direction >= networkLayers.length) return;
    
    const temp = networkLayers[index];
    networkLayers[index] = networkLayers[index + direction];
    networkLayers[index + direction] = temp;
    renderLayers();
}

// Supprimer une couche
function removeLayer(index) {
    networkLayers.splice(index, 1);
    renderLayers();
}

// Créer uniquement la définition du modèle (sans entraînement)
function createModelOnly() {
    const modelType = document.getElementById('modelType').value;
    
    // Validation du type de modèle
    if (!modelType || !modelRules[modelType]) {
        showNotification('Erreur', 'Veuillez sélectionner un type de modèle', 'error');
        return;
    }
    
    const rules = modelRules[modelType];
    
    // Collecter les variables cibles sélectionnées
    const targetCheckboxes = document.querySelectorAll('.target-checkbox:checked');
    const targetColumns = Array.from(targetCheckboxes).map(cb => cb.value);
    
    // Collecter les variables prédictives sélectionnées
    const predictorCheckboxes = document.querySelectorAll('.predictor-checkbox:checked:not(:disabled)');
    const predictorColumns = Array.from(predictorCheckboxes).map(cb => cb.value);
    
    // Validation selon les règles du modèle
    if (targetColumns.length < rules.minTargets) {
        showNotification('Erreur', `${rules.name} nécessite au moins ${rules.minTargets} variable(s) cible(s)`, 'error');
        return;
    }
    
    if (predictorColumns.length < rules.minPredictors) {
        showNotification('Erreur', `${rules.name} nécessite au moins ${rules.minPredictors} variable(s) prédictive(s)`, 'error');
        return;
    }
    
    // Construire la configuration du modèle
    const expertMode = document.getElementById('expertMode').checked;
    let modelConfig = {
        epochs: parseInt(document.getElementById('epochs').value)
    };
    
    // Configuration commune pour les modèles de deep learning
    if (isDeepLearningModel(modelType) || expertMode) {
        modelConfig.loss_function = document.getElementById('lossFunction').value;
        modelConfig.optimizer = document.getElementById('optimizer').value;
        modelConfig.learning_rate = parseFloat(document.getElementById('learningRate').value);
        modelConfig.batch_size = parseInt(document.getElementById('batchSize').value);
        
        // Métriques sélectionnées
        const selectedMetrics = Array.from(document.querySelectorAll('.metric-checkbox:checked')).map(cb => cb.value);
        modelConfig.metrics = selectedMetrics;
        
        // Callbacks
        modelConfig.callbacks = {
            early_stopping: document.getElementById('earlyStoppingCallback').checked,
            reduce_lr: document.getElementById('reduceLRCallback').checked,
            model_checkpoint: document.getElementById('modelCheckpointCallback').checked
        };
        
        // Configuration de sortie
        modelConfig.output_activation = document.getElementById('outputActivation').value;
        modelConfig.output_units = parseInt(document.getElementById('outputUnits').value);
    }
    
    // Configuration Random Forest
    if (modelType === 'random_forest') {
        const rfConfig = getRandomForestConfig();
        console.log('Random Forest config:', rfConfig);
        modelConfig = { ...modelConfig, ...rfConfig };
    }
    
    // Configuration XGBoost
    if (modelType === 'xgboost') {
        modelConfig = { ...modelConfig, ...getXGBoostConfig() };
    }
    
    // Configuration Decision Tree
    if (modelType === 'decision_tree') {
        modelConfig = { ...modelConfig, ...getDecisionTreeConfig() };
    }
    
    // Architecture personnalisée en mode expert
    if (expertMode && networkLayers.length > 0) {
        modelConfig.custom_architecture = networkLayers;
        modelConfig.use_custom_architecture = true;
    } else {
        modelConfig.use_custom_architecture = false;
    }
    
    // Obtener la configuración de división de datos
    const dataSplitConfig = getDataSplitConfig();
    
    // Integrar la configuración de división en los hiperparámetros
    modelConfig = {
        ...modelConfig,
        ...dataSplitConfig
    };
    
    const modelDefinitionData = {
        name: document.getElementById('modelName').value,
        description: `Modèle ${modelType.toUpperCase()} pour prédire ${targetColumns.join(', ')}`,
        model_type: modelType,
        dataset: document.getElementById('dataset').value,
        target_columns: targetColumns,
        predictor_columns: predictorColumns,
        default_config: modelConfig,
        hyperparameters: modelConfig,
        custom_architecture: expertMode && networkLayers.length > 0 ? networkLayers : null,
        use_custom_architecture: expertMode && networkLayers.length > 0,
        // Agregar configuración de división de datos
        default_split_method: dataSplitConfig.split_method,
        default_split_config: dataSplitConfig.split_config
    };
    
    showLoading();
    
    const csrfToken = getCookie('csrftoken');
    
    // Créer la définition du modèle
    fetch('/api/models/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(modelDefinitionData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(modelDef => {
        // Fermer le modal et recharger la liste
        hideLoading();
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('createModelModal'));
        if (modalInstance) {
            modalInstance.hide();
            modalInstance.dispose();
        }
        cleanupModals();
        
        // Reset form and state
        document.getElementById('createModelForm').reset();
        networkLayers = [];
        layerIdCounter = 0;
        document.getElementById('expertMode').checked = false;
        toggleExpertMode();
        
        // Reset modal title and footer for next use
        document.querySelector('#createModelModal .modal-title').innerHTML = `
            <i class="bi bi-cpu"></i> Créer un Nouveau Modèle
        `;
        
        const footer = document.querySelector('#createModelModal .modal-footer');
        footer.innerHTML = `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-primary" onclick="createModelOnly()">
                <i class="bi bi-save"></i> Créer le Modèle
            </button>
        `;
        
        showNotification('Succès', 'Modèle créé avec succès!', 'success');
        
        // Recharger la page après un court délai pour éviter les problèmes
        setTimeout(() => {
            window.location.reload();
        }, 1500);
    })
    .catch(error => {
        hideLoading();
        showNotification('Erreur', 'Erreur lors de la création du modèle: ' + error, 'error');
    });
}

// Utility function to safely show modals
function showModalSafely(modalId, options = {}) {
    // Default options
    const defaultOptions = {
        backdrop: true,
        keyboard: true,
        focus: true
    };
    
    // Clean up first
    cleanupModals();
    
    // Small delay to ensure cleanup is complete
    setTimeout(() => {
        console.log('Trying to show modal:', modalId);
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
            console.log('Modal element found, creating Bootstrap modal...');
            const modal = new bootstrap.Modal(modalElement, {...defaultOptions, ...options});
            modal.show();
            console.log('Modal shown');
        } else {
            console.error('Modal element not found:', modalId);
        }
    }, 100);
}

// Fonction pour afficher le modal de création
function showCreateModelModal() {
    // Reset form and state
    resetCreateModelForm();
    
    // Load datasets
    loadDatasetsForModal()
        .then(() => {
            // Show modal after datasets are loaded
            showModalSafely('createModelModal');
        })
        .catch(error => {
            console.error('Erreur lors du chargement des datasets:', error);
            showNotification('Erreur', 'Impossible de charger les datasets', 'error');
        });
}

// Helper function to reset create model form
function resetCreateModelForm() {
    hideLoading();
    document.getElementById('createModelForm').reset();
    document.getElementById('targetVariables').innerHTML = '<p class="text-muted">Sélectionnez d\'abord un dataset</p>';
    document.getElementById('predictorVariables').innerHTML = '<p class="text-muted">Sélectionnez d\'abord un dataset</p>';
    document.getElementById('modelRequirements').style.display = 'none';
    networkLayers = [];
    layerIdCounter = 0;
}

// Helper function to load datasets for modal
function loadDatasetsForModal() {
    return fetch('/api/datasets/')
        .then(response => response.json())
        .then(datasets => {
            const select = document.getElementById('dataset');
            select.innerHTML = '<option value="">Sélectionner un dataset...</option>';
            datasets.forEach(dataset => {
                const option = document.createElement('option');
                option.value = dataset.id;
                option.textContent = dataset.name;
                select.appendChild(option);
            });
        });
}

// Ajouter des listeners pour les changements
document.addEventListener('DOMContentLoaded', function() {
    // Listener pour le changement de type de modèle
    const modelTypeSelect = document.getElementById('modelType');
    if (modelTypeSelect) {
        modelTypeSelect.addEventListener('change', function() {
            applyModelRules();
            toggleExpertMode(); // Mettre à jour l'affichage selon le type de modèle
        });
    }
    
    // Listener pour les changements de variables cibles
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('target-checkbox') || e.target.classList.contains('predictor-checkbox')) {
            updateVariableRestrictions();
            
            // Actualizar visualización cuando cambian las variables
            updateDataSplitVisualization();
            
            // Mettre à jour automatiquement le nombre d'unités de sortie
            const targetCount = document.querySelectorAll('.target-checkbox:checked').length;
            const outputUnitsInput = document.getElementById('outputUnits');
            if (outputUnitsInput) {
                outputUnitsInput.value = targetCount || 1;
            }
            
            // Si estamos en Random Forest, manejar cambios específicos
            const modelType = document.getElementById('modelType').value;
            if (modelType === 'random_forest' && typeof handleTargetColumnChange === 'function') {
                handleTargetColumnChange();
            }
        }
    });
});

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    loadImplementedModels(); // Load model types first
    loadModels();
    loadDatasets();
    
    // Actualiser toutes les 30 secondes
    setInterval(loadModels, 30000);
});

// Load implemented model types from backend
function loadImplementedModels() {
    fetch('/api/implemented-models/')
        .then(response => response.json())
        .then(data => {
            const modelTypeSelect = document.getElementById('modelType');
            const typeFilter = document.getElementById('typeFilter');
            
            // Clear existing options (keep first "Select..." option)
            while (modelTypeSelect.options.length > 1) {
                modelTypeSelect.remove(1);
            }
            
            // Clear filter options (keep first "All types" option)
            while (typeFilter.options.length > 1) {
                typeFilter.remove(1);
            }
            
            // Group models by category
            const neuralModels = data.models.filter(m => m.category === 'neural');
            const mlModels = data.models.filter(m => m.category === 'ml');
            
            // Add neural network models
            if (neuralModels.length > 0) {
                const neuralGroup = document.createElement('optgroup');
                neuralGroup.label = 'Deep Learning';
                neuralModels.forEach(model => {
                    const option = new Option(model.label, model.value);
                    neuralGroup.appendChild(option);
                    
                    // Also add to filter
                    const filterOption = new Option(model.label, model.value);
                    typeFilter.appendChild(filterOption);
                });
                modelTypeSelect.appendChild(neuralGroup);
            }
            
            // Add ML models
            if (mlModels.length > 0) {
                const mlGroup = document.createElement('optgroup');
                mlGroup.label = 'Machine Learning Classique';
                mlModels.forEach(model => {
                    const option = new Option(model.label, model.value);
                    mlGroup.appendChild(option);
                    
                    // Also add to filter
                    const filterOption = new Option(model.label, model.value);
                    typeFilter.appendChild(filterOption);
                });
                modelTypeSelect.appendChild(mlGroup);
            }
            
            console.log(`Loaded ${data.total} implemented model types`);
        })
        .catch(error => {
            console.error('Error loading model types:', error);
            // Fallback to basic models if API fails
            const fallbackModels = [
                {value: 'lstm', label: 'LSTM'},
                {value: 'gru', label: 'GRU'},
                {value: 'random_forest', label: 'Random Forest'},
                {value: 'xgboost', label: 'XGBoost'}
            ];
            
            const modelTypeSelect = document.getElementById('modelType');
            fallbackModels.forEach(model => {
                const option = new Option(model.label, model.value);
                modelTypeSelect.appendChild(option);
            });
        });
}

// Load available datasets
function loadDatasets() {
    fetch('/api/datasets/')
        .then(response => response.json())
        .then(datasets => {
            const datasetSelect = document.getElementById('dataset');
            
            // Clear existing options (keep first)
            while (datasetSelect.options.length > 1) {
                datasetSelect.remove(1);
            }
            
            // Add datasets
            datasets.forEach(dataset => {
                const option = new Option(
                    `${dataset.name} (${dataset.uploaded_at ? new Date(dataset.uploaded_at).toLocaleDateString() : 'N/A'})`,
                    dataset.id
                );
                datasetSelect.appendChild(option);
            });
            
            console.log(`Loaded ${datasets.length} datasets`);
        })
        .catch(error => {
            console.error('Error loading datasets:', error);
            showNotification('Erreur', 'Impossible de charger les datasets', 'error');
        });
}

// Framework selection
function updateFrameworkOptions() {
    const modelType = document.getElementById('modelType').value;
    const frameworkDiv = document.getElementById('frameworkSelection');
    const epochsContainer = document.getElementById('epochsContainer');
    const expertModeContainer = document.getElementById('expertModeContainer');
    
    // Show framework selection only for neural networks
    if (['lstm', 'gru', 'cnn', 'transformer'].includes(modelType)) {
        if (frameworkDiv) frameworkDiv.style.display = 'block';
    } else {
        if (frameworkDiv) frameworkDiv.style.display = 'none';
    }
    
    // Configurar las secciones según el tipo de modelo
    if (modelType === 'random_forest') {
        // Para Random Forest, ocultar secciones de redes neuronales
        const modelConfig = document.getElementById('modelConfiguration');
        const networkArch = document.getElementById('networkArchitecture');
        const metricsCallbacks = document.getElementById('metricsCallbacks');
        const randomForestConfig = document.getElementById('randomForestConfiguration');
        const xgboostConfig = document.getElementById('xgboostConfiguration');
        const decisionTreeConfig = document.getElementById('decisionTreeConfiguration');
        
        if (modelConfig) modelConfig.style.display = 'none';
        if (networkArch) networkArch.style.display = 'none';
        if (metricsCallbacks) metricsCallbacks.style.display = 'none';
        if (randomForestConfig) randomForestConfig.style.display = 'block';
        if (xgboostConfig) xgboostConfig.style.display = 'none';
        if (decisionTreeConfig) decisionTreeConfig.style.display = 'none';
        if (epochsContainer) epochsContainer.style.display = 'none';
        if (expertModeContainer) expertModeContainer.style.display = 'none';
        // Inicializar configuración de Random Forest
        if (typeof initializeRandomForestConfig === 'function') {
            initializeRandomForestConfig();
        }
        if (typeof updateRandomForestOptions === 'function') {
            updateRandomForestOptions();
        }
    } else if (modelType === 'xgboost') {
        // Para XGBoost, ocultar secciones de redes neuronales y opciones no relevantes
        const modelConfig = document.getElementById('modelConfiguration');
        const networkArch = document.getElementById('networkArchitecture');
        const metricsCallbacks = document.getElementById('metricsCallbacks');
        const randomForestConfig = document.getElementById('randomForestConfiguration');
        const xgboostConfig = document.getElementById('xgboostConfiguration');
        const decisionTreeConfig = document.getElementById('decisionTreeConfiguration');
        
        if (modelConfig) modelConfig.style.display = 'none';
        if (networkArch) networkArch.style.display = 'none';
        if (metricsCallbacks) metricsCallbacks.style.display = 'none';
        if (randomForestConfig) randomForestConfig.style.display = 'none';
        if (xgboostConfig) xgboostConfig.style.display = 'block';
        if (decisionTreeConfig) decisionTreeConfig.style.display = 'none';
        if (epochsContainer) epochsContainer.style.display = 'none';
        if (expertModeContainer) expertModeContainer.style.display = 'none';
        
        // Asegurar que el modo experto esté desactivado
        const expertModeElement = document.getElementById('expertMode');
        if (expertModeElement) expertModeElement.checked = false;
        if (typeof updateXGBoostOptions === 'function') {
            updateXGBoostOptions();
        }
    } else if (modelType === 'decision_tree') {
        // Para Decision Tree, ocultar secciones de redes neuronales y opciones no relevantes
        const modelConfig = document.getElementById('modelConfiguration');
        const networkArch = document.getElementById('networkArchitecture');
        const metricsCallbacks = document.getElementById('metricsCallbacks');
        const randomForestConfig = document.getElementById('randomForestConfiguration');
        const xgboostConfig = document.getElementById('xgboostConfiguration');
        const decisionTreeConfig = document.getElementById('decisionTreeConfiguration');
        
        if (modelConfig) modelConfig.style.display = 'none';
        if (networkArch) networkArch.style.display = 'none';
        if (metricsCallbacks) metricsCallbacks.style.display = 'none';
        if (randomForestConfig) randomForestConfig.style.display = 'none';
        if (xgboostConfig) xgboostConfig.style.display = 'none';
        if (decisionTreeConfig) decisionTreeConfig.style.display = 'block';
        if (epochsContainer) epochsContainer.style.display = 'none';
        if (expertModeContainer) expertModeContainer.style.display = 'none';
        
        // Asegurar que el modo experto esté desactivado
        const expertModeElement = document.getElementById('expertMode');
        if (expertModeElement) expertModeElement.checked = false;
        if (typeof updateDecisionTreeOptions === 'function') {
            updateDecisionTreeOptions();
        }
    } else {
        // Para otros modelos (redes neuronales)
        const randomForestConfig = document.getElementById('randomForestConfiguration');
        const xgboostConfig = document.getElementById('xgboostConfiguration');
        const decisionTreeConfig = document.getElementById('decisionTreeConfiguration');
        const modelConfig = document.getElementById('modelConfiguration');
        const metricsCallbacks = document.getElementById('metricsCallbacks');
        const networkArch = document.getElementById('networkArchitecture');
        
        if (randomForestConfig) randomForestConfig.style.display = 'none';
        if (xgboostConfig) xgboostConfig.style.display = 'none';
        if (decisionTreeConfig) decisionTreeConfig.style.display = 'none';
        
        if (epochsContainer) epochsContainer.style.display = isDeepLearningModel(modelType) ? 'block' : 'none';
        if (expertModeContainer) expertModeContainer.style.display = isDeepLearningModel(modelType) ? 'block' : 'none';
        
        // Aplicar lógica normal para modelos de deep learning
        const expertModeElement = document.getElementById('expertMode');
        const expertMode = expertModeElement ? expertModeElement.checked : false;
        
        if (modelConfig) modelConfig.style.display = expertMode || isDeepLearningModel(modelType) ? 'block' : 'none';
        if (metricsCallbacks) metricsCallbacks.style.display = expertMode || isDeepLearningModel(modelType) ? 'block' : 'none';
        if (networkArch) networkArch.style.display = expertMode ? 'block' : 'none';
    }
}

// Export model code
function exportModelCode(modelId) {
    // Show framework selection modal
    showFrameworkSelectionModal(modelId, 'export');
}

// Import model code
function importModelCode(modelId) {
    // Show framework selection modal
    showFrameworkSelectionModal(modelId, 'import');
}

// Show framework selection modal
function showFrameworkSelectionModal(modelId, action) {
    // Clean up any existing modals first
    cleanupModals();
    
    // Get the model to check its type
    const model = modelsList.find(m => m.id === modelId);
    
    // For models that only support sklearn, show sklearn-only modal
    if (model && ['random_forest', 'decision_tree', 'xgboost'].includes(model.model_type)) {
        showSklearnOnlyModal(modelId, action, model);
        return;
    }
    
    const modalElement = document.getElementById('frameworkSelectionModal');
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: true,
        keyboard: true,
        focus: true
    });
    
    // Update modal title based on action
    const title = document.getElementById('frameworkSelectionModalLabel');
    if (action === 'export') {
        title.innerHTML = '<i class="bi bi-download"></i> Exporter le Code du Modèle';
    } else if (action === 'import') {
        title.innerHTML = '<i class="bi bi-upload"></i> Importer le Code du Modèle';
    }
    
    // Restore modal for neural networks
    const kerasCol = modalElement.querySelector('[data-framework="keras"]')?.closest('.col-6');
    const pytorchCol = modalElement.querySelector('[data-framework="pytorch"]')?.closest('.col-6');
    const sklearnCol = modalElement.querySelector('[data-framework="sklearn"]')?.closest('.col-12');
    
    // Show Keras and PyTorch buttons, hide sklearn
    if (kerasCol) {
        kerasCol.style.display = 'block';
        kerasCol.className = 'col-6';
    }
    if (pytorchCol) {
        pytorchCol.style.display = 'block';
        pytorchCol.className = 'col-6';
    }
    if (sklearnCol) {
        sklearnCol.style.display = 'none';
    }
    
    // Restore modal text
    const modalText = modalElement.querySelector('.modal-body p');
    if (modalText) {
        modalText.textContent = 'Sélectionnez le framework pour générer le code:';
    }
    
    // Add click handlers to framework buttons
    const frameworkButtons = modalElement.querySelectorAll('.framework-btn');
    frameworkButtons.forEach(btn => {
        // Remove existing listeners
        btn.replaceWith(btn.cloneNode(true));
    });
    
    // Add new listeners
    modalElement.querySelectorAll('.framework-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const framework = this.dataset.framework;
            modal.hide();
            
            if (action === 'export') {
                performExportModelCode(modelId, framework);
            } else if (action === 'import') {
                performImportModelCode(modelId, framework);
            }
        });
    });
    
    modal.show();
}

// Show modal with only sklearn option
function showSklearnOnlyModal(modelId, action, model) {
    cleanupModals();
    
    // Clone the framework selection modal but modify it for sklearn only
    const modalElement = document.getElementById('frameworkSelectionModal');
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: true,
        keyboard: true,
        focus: true
    });
    
    // Update modal title based on action
    const title = document.getElementById('frameworkSelectionModalLabel');
    if (action === 'export') {
        title.innerHTML = '<i class="bi bi-download"></i> Exporter le Code du Modèle';
    } else if (action === 'import') {
        title.innerHTML = '<i class="bi bi-upload"></i> Importer le Code du Modèle';
    }
    
    // Hide Keras and PyTorch buttons
    const kerasCol = modalElement.querySelector('[data-framework="keras"]')?.closest('.col-6');
    const pytorchCol = modalElement.querySelector('[data-framework="pytorch"]')?.closest('.col-6');
    if (kerasCol) kerasCol.style.display = 'none';
    if (pytorchCol) pytorchCol.style.display = 'none';
    
    // Check if sklearn button exists, if not create it
    let sklearnBtn = modalElement.querySelector('[data-framework="sklearn"]');
    let sklearnCol;
    
    if (!sklearnBtn) {
        // Create sklearn button container
        const buttonsContainer = modalElement.querySelector('.modal-body .row');
        sklearnCol = document.createElement('div');
        sklearnCol.className = 'col-12';
        sklearnCol.innerHTML = `
            <button type="button" class="btn btn-outline-warning w-100 framework-btn" data-framework="sklearn">
                <i class="bi bi-graph-up" style="font-size: 2rem;"></i>
                <div class="mt-2">
                    <strong>Scikit-learn</strong>
                    <br>
                    <small class="text-muted">Machine Learning en Python</small>
                    <br>
                    <small class="text-muted">${model ? model.model_type.toUpperCase() : 'Random Forest'}</small>
                </div>
            </button>
        `;
        buttonsContainer.appendChild(sklearnCol);
        sklearnBtn = sklearnCol.querySelector('.framework-btn');
    } else {
        // Make sure sklearn button is visible and full width
        sklearnCol = sklearnBtn.closest('.col-6') || sklearnBtn.closest('.col-12');
        if (sklearnCol) {
            sklearnCol.style.display = 'block';
            sklearnCol.className = 'col-12';
        }
    }
    
    // Update modal text for ML models
    const modalText = modalElement.querySelector('.modal-body p');
    if (modalText) {
        modalText.textContent = 'Ce modèle utilise scikit-learn pour le Machine Learning:';
    }
    
    // Remove any existing click handlers
    const newSklearnBtn = sklearnBtn.cloneNode(true);
    sklearnBtn.parentNode.replaceChild(newSklearnBtn, sklearnBtn);
    
    // Add click handler
    newSklearnBtn.addEventListener('click', function() {
        modal.hide();
        
        if (action === 'export') {
            performExportModelCode(modelId, 'sklearn');
        } else if (action === 'import') {
            // Show info message for import (not fully implemented yet)
            showNotification('Information', 'Import de code scikit-learn en cours de développement.', 'info');
            // performImportModelCode(modelId, 'sklearn');
        }
    });
    
    modal.show();
}

// Perform the actual model code export
function performExportModelCode(modelId, framework) {
    showLoading();
    
    fetch(`/api/models/${modelId}/export-code/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ framework: framework })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        hideLoading();
        
        if (data.success === false) {
            throw new Error(data.error || 'Error exporting code');
        }
        
        // Create a blob from the code string
        const codeBlob = new Blob([data.code], { type: 'text/plain' });
        
        // Create download link
        const url = window.URL.createObjectURL(codeBlob);
        const a = document.createElement('a');
        const model = modelsList.find(m => m.id === modelId);
        const filename = `${model ? model.name : 'model'}_${framework}.py`;
        
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showNotification('Succès', `Code ${framework} exporté avec succès!`, 'success');
    })
    .catch(error => {
        hideLoading();
        console.error('Erreur:', error);
        showNotification('Erreur', `Impossible d'exporter le code: ${error.message}`, 'error');
    });
}

// Perform the actual model code import
function performImportModelCode(modelId, framework) {
    // Create file input
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.py';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('code_file', file);
        formData.append('framework', framework);
        
        showLoading();
        
        fetch(`/api/models/${modelId}/import-code/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showNotification('Succès', 'Code importé et modèle mis à jour avec succès!', 'success');
                loadModels(); // Refresh the models list
            } else {
                showNotification('Erreur', data.error || 'Erreur lors de l\'import', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Erreur:', error);
            showNotification('Erreur', 'Impossible d\'importer le code', 'error');
        });
    };
    
    input.click();
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ===== XGBoost Configuration Functions =====

// Update XGBoost options based on problem type
function updateXGBoostOptions() {
    const problemType = document.getElementById('xgbProblemType').value;
    const classificationSettings = document.getElementById('xgbClassificationSettings');
    
    if (problemType === 'classification') {
        classificationSettings.style.display = 'block';
        
        // Update eval metric options
        const evalMetric = document.getElementById('xgbEvalMetric');
        if (evalMetric.value === 'rmse' || evalMetric.value === 'mae') {
            evalMetric.value = 'auto';
        }
    } else {
        classificationSettings.style.display = 'none';
        
        // Update eval metric options
        const evalMetric = document.getElementById('xgbEvalMetric');
        if (evalMetric.value === 'logloss' || evalMetric.value === 'auc' || evalMetric.value === 'mlogloss') {
            evalMetric.value = 'auto';
        }
    }
}

// Apply XGBoost preset configuration
function applyXGBoostPreset() {
    const preset = document.getElementById('xgbPreset').value;
    
    const presets = {
        'rapido': {
            n_estimators: 100,
            learning_rate: 0.1,
            max_depth: 3,
            subsample: 0.8,
            colsample_bytree: 0.8,
            early_stopping_rounds: 30
        },
        'balanceado': {
            n_estimators: 500,
            learning_rate: 0.05,
            max_depth: 6,
            subsample: 0.8,
            colsample_bytree: 0.8,
            early_stopping_rounds: 50
        },
        'preciso': {
            n_estimators: 1000,
            learning_rate: 0.01,
            max_depth: 8,
            subsample: 0.9,
            colsample_bytree: 0.9,
            early_stopping_rounds: 100
        }
    };
    
    const config = presets[preset];
    if (config) {
        document.getElementById('xgbNEstimators').value = config.n_estimators;
        updateRangeValue('xgbNEstimators', 'xgbNEstimatorsValue');
        
        document.getElementById('xgbLearningRate').value = config.learning_rate;
        document.getElementById('xgbMaxDepth').value = config.max_depth;
        
        document.getElementById('xgbSubsample').value = config.subsample;
        updateRangeValue('xgbSubsample', 'xgbSubsampleValue');
        
        document.getElementById('xgbColsampleBytree').value = config.colsample_bytree;
        updateRangeValue('xgbColsampleBytree', 'xgbColsampleBytreeValue');
        
        document.getElementById('xgbEarlyStoppingRounds').value = config.early_stopping_rounds;
    }
}

// Toggle early stopping options
function toggleXGBoostEarlyStopping() {
    const enabled = document.getElementById('xgbEarlyStoppingEnabled').checked;
    const container = document.getElementById('xgbEarlyStoppingContainer');
    container.style.display = enabled ? 'block' : 'none';
}

// Toggle max leaves option based on grow policy
function toggleMaxLeaves() {
    const growPolicy = document.getElementById('xgbGrowPolicy').value;
    const maxLeavesContainer = document.getElementById('xgbMaxLeavesContainer');
    maxLeavesContainer.style.display = growPolicy === 'lossguide' ? 'block' : 'none';
}

// Toggle booster-specific options
function toggleBoosterOptions() {
    const booster = document.getElementById('xgbBooster').value;
    const dartParams = document.getElementById('xgbDartParameters');
    dartParams.style.display = booster === 'dart' ? 'block' : 'none';
}

// Get XGBoost configuration
function getXGBoostConfig() {
    const config = {
        preset: document.getElementById('xgbPreset').value,
        problem_type: document.getElementById('xgbProblemType').value,
        n_estimators: parseInt(document.getElementById('xgbNEstimators').value),
        learning_rate: parseFloat(document.getElementById('xgbLearningRate').value),
        max_depth: parseInt(document.getElementById('xgbMaxDepth').value),
        subsample: parseFloat(document.getElementById('xgbSubsample').value),
        colsample_bytree: parseFloat(document.getElementById('xgbColsampleBytree').value),
        eval_metric: document.getElementById('xgbEvalMetric').value,
        
        // Early stopping
        early_stopping_enabled: document.getElementById('xgbEarlyStoppingEnabled').checked,
        early_stopping_rounds: document.getElementById('xgbEarlyStoppingEnabled').checked ? 
            parseInt(document.getElementById('xgbEarlyStoppingRounds').value) : null,
        
        // GPU
        use_gpu: document.getElementById('xgbUseGPU').checked,
        
        // Advanced options
        min_child_weight: parseFloat(document.getElementById('xgbMinChildWeight').value),
        gamma: parseFloat(document.getElementById('xgbGamma').value),
        reg_lambda: parseFloat(document.getElementById('xgbRegLambda').value),
        reg_alpha: parseFloat(document.getElementById('xgbRegAlpha').value),
        max_delta_step: parseFloat(document.getElementById('xgbMaxDeltaStep').value),
        
        // Column sampling
        colsample_bylevel: parseFloat(document.getElementById('xgbColsampleBylevel').value),
        colsample_bynode: parseFloat(document.getElementById('xgbColsampleBynode').value),
        
        // Tree method
        tree_method: document.getElementById('xgbTreeMethod').value,
        max_bin: parseInt(document.getElementById('xgbMaxBin').value),
        grow_policy: document.getElementById('xgbGrowPolicy').value,
        max_leaves: document.getElementById('xgbGrowPolicy').value === 'lossguide' ? 
            parseInt(document.getElementById('xgbMaxLeaves').value) : null,
        
        // Classification settings
        scale_pos_weight: document.getElementById('xgbProblemType').value === 'classification' ? 
            parseFloat(document.getElementById('xgbScalePosWeight').value) : null,
        
        // Booster
        booster: document.getElementById('xgbBooster').value,
        
        // DART parameters
        rate_drop: document.getElementById('xgbBooster').value === 'dart' ? 
            parseFloat(document.getElementById('xgbRateDrop').value) : null,
        skip_drop: document.getElementById('xgbBooster').value === 'dart' ? 
            parseFloat(document.getElementById('xgbSkipDrop').value) : null,
        
        // Execution
        // random_state ahora se maneja globalmente en el Módulo 1
        n_jobs: parseInt(document.getElementById('xgbNJobs').value),
        verbosity: parseInt(document.getElementById('xgbVerbosity').value)
    };
    
    // Set device based on GPU usage
    if (config.use_gpu) {
        config.device = 'cuda';
        if (config.tree_method === 'auto') {
            config.tree_method = 'hist';
        }
    }
    
    // Set objective based on problem type
    if (config.problem_type === 'classification') {
        config.objective = 'binary:logistic';  // Will be adjusted for multiclass in backend
    } else {
        config.objective = 'reg:squarederror';
    }
    
    // Auto-select eval metric if needed
    if (config.eval_metric === 'auto') {
        if (config.problem_type === 'classification') {
            config.eval_metric = 'logloss';
        } else {
            config.eval_metric = 'rmse';
        }
    }
    
    return config;
}

// Update range value display
function updateRangeValue(rangeId, displayId) {
    const range = document.getElementById(rangeId);
    const display = document.getElementById(displayId);
    if (range && display) {
        display.textContent = range.value;
    }
}

// Helper function to set value and update range display
function setValueWithRangeUpdate(elementId, value, rangeDisplayId) {
    const element = document.getElementById(elementId);
    if (element && value !== undefined && value !== null) {
        element.value = value;
        if (rangeDisplayId) {
            updateRangeValue(elementId, rangeDisplayId);
        }
    }
}

// Helper function to set checkbox value
function setCheckboxValue(elementId, value, callback) {
    const element = document.getElementById(elementId);
    if (element && value !== undefined) {
        element.checked = value;
        if (callback && typeof callback === 'function') {
            callback();
        }
    }
}

// loadRandomForestConfiguration is now defined in random-forest-config-v2.js

// Load XGBoost configuration for editing
function loadXGBoostConfiguration(hyperparams) {
    if (!hyperparams) return;
    
    // Basic parameters
    setValueWithRangeUpdate('xgbPreset', hyperparams.preset || 'balanceado');
    setValueWithRangeUpdate('xgbProblemType', hyperparams.problem_type || 'regression');
    setValueWithRangeUpdate('xgbNEstimators', hyperparams.n_estimators, 'xgbNEstimatorsValue');
    setValueWithRangeUpdate('xgbLearningRate', hyperparams.learning_rate);
    setValueWithRangeUpdate('xgbMaxDepth', hyperparams.max_depth);
    setValueWithRangeUpdate('xgbSubsample', hyperparams.subsample, 'xgbSubsampleValue');
    setValueWithRangeUpdate('xgbColsampleBytree', hyperparams.colsample_bytree, 'xgbColsampleBytreeValue');
    setValueWithRangeUpdate('xgbEvalMetric', hyperparams.eval_metric || 'auto');
    
    // Early stopping
    setCheckboxValue('xgbEarlyStoppingEnabled', hyperparams.early_stopping_enabled !== false, toggleXGBoostEarlyStopping);
    if (hyperparams.early_stopping_rounds) {
        setValueWithRangeUpdate('xgbEarlyStoppingRounds', hyperparams.early_stopping_rounds);
    }
    
    // GPU
    setCheckboxValue('xgbUseGPU', hyperparams.use_gpu || hyperparams.device === 'cuda');
    
    // Advanced parameters
    setValueWithRangeUpdate('xgbMinChildWeight', hyperparams.min_child_weight || 1);
    setValueWithRangeUpdate('xgbGamma', hyperparams.gamma || 0, 'xgbGammaValue');
    setValueWithRangeUpdate('xgbRegLambda', hyperparams.reg_lambda || 1, 'xgbRegLambdaValue');
    setValueWithRangeUpdate('xgbRegAlpha', hyperparams.reg_alpha || 0, 'xgbRegAlphaValue');
    setValueWithRangeUpdate('xgbMaxDeltaStep', hyperparams.max_delta_step || 0);
    
    // Column sampling
    setValueWithRangeUpdate('xgbColsampleBylevel', hyperparams.colsample_bylevel || 1, 'xgbColsampleBylevelValue');
    setValueWithRangeUpdate('xgbColsampleBynode', hyperparams.colsample_bynode || 1, 'xgbColsampleBynodeValue');
    
    // Tree method
    setValueWithRangeUpdate('xgbTreeMethod', hyperparams.tree_method || 'auto');
    setValueWithRangeUpdate('xgbMaxBin', hyperparams.max_bin || 256);
    setValueWithRangeUpdate('xgbGrowPolicy', hyperparams.grow_policy || 'depthwise');
    if (hyperparams.max_leaves) {
        setValueWithRangeUpdate('xgbMaxLeaves', hyperparams.max_leaves);
    }
    toggleMaxLeaves();
    
    // Classification settings
    if (hyperparams.scale_pos_weight) {
        setValueWithRangeUpdate('xgbScalePosWeight', hyperparams.scale_pos_weight);
    }
    
    // Booster
    setValueWithRangeUpdate('xgbBooster', hyperparams.booster || 'gbtree');
    toggleBoosterOptions();
    
    // DART parameters
    if (hyperparams.rate_drop !== undefined) {
        setValueWithRangeUpdate('xgbRateDrop', hyperparams.rate_drop, 'xgbRateDropValue');
    }
    if (hyperparams.skip_drop !== undefined) {
        setValueWithRangeUpdate('xgbSkipDrop', hyperparams.skip_drop, 'xgbSkipDropValue');
    }
    
    // Execution
    if (hyperparams.random_state) {
        setValueWithRangeUpdate('xgbRandomState', hyperparams.random_state);
    }
    setValueWithRangeUpdate('xgbNJobs', hyperparams.n_jobs || -1);
    setValueWithRangeUpdate('xgbVerbosity', hyperparams.verbosity || 1);
    
    // Update UI based on problem type
    updateXGBoostOptions();
}

// ===== Decision Tree Configuration Functions =====

// Update Decision Tree options based on problem type
function updateDecisionTreeOptions() {
    const problemType = document.getElementById('dtProblemType').value;
    const classificationSettings = document.getElementById('dtClassificationSettings');
    const criterion = document.getElementById('dtCriterion');
    
    if (problemType === 'classification') {
        classificationSettings.style.display = 'block';
        
        // Update criterion options for classification
        criterion.innerHTML = `
            <option value="gini">Gini (recommandé)</option>
            <option value="entropy">Entropie</option>
        `;
    } else {
        classificationSettings.style.display = 'none';
        
        // Update criterion options for regression
        criterion.innerHTML = `
            <option value="squared_error">Erreur quadratique (recommandé)</option>
        `;
    }
    
    // Update advanced criterion if needed
    updateDecisionTreeCriterionAdvanced();
}

// Update advanced criterion based on problem type
function updateDecisionTreeCriterionAdvanced() {
    const criterionAdvanced = document.getElementById('dtCriterionAdvanced');
    const currentValue = criterionAdvanced.value;
    
    if (currentValue === 'poisson') {
        document.getElementById('dtPoissonWarning').style.display = 'block';
    } else {
        document.getElementById('dtPoissonWarning').style.display = 'none';
    }
}

// Apply Decision Tree preset configuration
function applyDecisionTreePreset() {
    const preset = document.getElementById('dtPreset').value;
    
    const presets = {
        'rapido': {
            max_depth_enabled: true,
            max_depth: 8,
            min_samples_leaf: 2,
            ccp_alpha: 0
        },
        'balanceado': {
            max_depth_enabled: true,
            max_depth: 12,
            min_samples_leaf: 2,
            max_features: 'sqrt',
            ccp_alpha: 0
        },
        'preciso': {
            max_depth_enabled: false,
            max_depth: null,
            min_samples_leaf: 1,
            ccp_alpha: 0.0001
        }
    };
    
    const config = presets[preset];
    if (config) {
        // Max depth
        document.getElementById('dtMaxDepthEnabled').checked = config.max_depth_enabled;
        toggleDecisionTreeMaxDepth();
        if (config.max_depth_enabled && config.max_depth) {
            document.getElementById('dtMaxDepth').value = config.max_depth;
        }
        
        // Min samples leaf
        document.getElementById('dtMinSamplesLeaf').value = config.min_samples_leaf;
        updateDecisionTreeMinSamplesLeaf();
        
        // Max features
        if (config.max_features) {
            document.getElementById('dtMaxFeatures').value = config.max_features;
            toggleDecisionTreeMaxFeatures();
        }
        
        // CCP alpha
        document.getElementById('dtCcpAlpha').value = config.ccp_alpha;
    }
}

// Toggle max depth
function toggleDecisionTreeMaxDepth() {
    const enabled = document.getElementById('dtMaxDepthEnabled').checked;
    document.getElementById('dtMaxDepth').disabled = !enabled;
}

// Update min samples leaf display
function updateDecisionTreeMinSamplesLeaf() {
    const value = document.getElementById('dtMinSamplesLeaf').value;
    const isFraction = document.getElementById('dtMinSamplesLeafFraction').checked;
    
    if (isFraction) {
        const fractionValue = value / 100; // Convert to 0-0.5 range
        document.getElementById('dtMinSamplesLeafValue').textContent = fractionValue.toFixed(2);
    } else {
        document.getElementById('dtMinSamplesLeafValue').textContent = value;
    }
}

// Toggle min samples leaf type (int vs fraction)
function toggleMinSamplesLeafType() {
    const isFraction = document.getElementById('dtMinSamplesLeafFraction').checked;
    const slider = document.getElementById('dtMinSamplesLeaf');
    
    if (isFraction) {
        slider.min = 0;
        slider.max = 50; // Represents 0-0.5
        slider.value = Math.min(slider.value, 50);
    } else {
        slider.min = 1;
        slider.max = 50;
        slider.value = Math.max(1, slider.value);
    }
    
    updateDecisionTreeMinSamplesLeaf();
}

// Toggle max features input
function toggleDecisionTreeMaxFeatures() {
    const maxFeatures = document.getElementById('dtMaxFeatures').value;
    const valueInput = document.getElementById('dtMaxFeaturesValue');
    
    if (maxFeatures === 'int' || maxFeatures === 'float') {
        valueInput.style.display = 'block';
        if (maxFeatures === 'float') {
            valueInput.type = 'number';
            valueInput.min = '0';
            valueInput.max = '1';
            valueInput.step = '0.1';
            valueInput.value = '0.5';
        } else {
            valueInput.type = 'number';
            valueInput.min = '1';
            valueInput.max = '';
            valueInput.step = '1';
            valueInput.value = '5';
        }
    } else {
        valueInput.style.display = 'none';
    }
}

// Apply complexity preset
function applyDecisionTreeComplexityPreset(type) {
    if (type === 'simple') {
        document.getElementById('dtMaxDepthEnabled').checked = true;
        toggleDecisionTreeMaxDepth();
        document.getElementById('dtMaxDepth').value = 10;
        document.getElementById('dtMinSamplesLeaf').value = 2;
        updateDecisionTreeMinSamplesLeaf();
    } else if (type === 'flexible') {
        document.getElementById('dtMaxDepthEnabled').checked = false;
        toggleDecisionTreeMaxDepth();
        document.getElementById('dtMinSamplesLeaf').value = 1;
        updateDecisionTreeMinSamplesLeaf();
    }
}

// Get Decision Tree configuration
function getDecisionTreeConfig() {
    const config = {
        preset: document.getElementById('dtPreset').value,
        problem_type: document.getElementById('dtProblemType').value,
        criterion: document.getElementById('dtCriterion').value,
        splitter: document.getElementById('dtSplitter').value,
        max_depth_enabled: document.getElementById('dtMaxDepthEnabled').checked,
        max_depth: document.getElementById('dtMaxDepthEnabled').checked ? 
            parseInt(document.getElementById('dtMaxDepth').value) : null,
        
        // Handle min_samples_leaf (int or fraction)
        min_samples_leaf_fraction: document.getElementById('dtMinSamplesLeafFraction').checked,
        min_samples_leaf: document.getElementById('dtMinSamplesLeafFraction').checked ?
            parseFloat(document.getElementById('dtMinSamplesLeaf').value) / 100 :
            parseInt(document.getElementById('dtMinSamplesLeaf').value),
        
        // Handle max_features
        max_features: getDecisionTreeMaxFeatures(),
        
        min_samples_split: parseInt(document.getElementById('dtMinSamplesSplit').value),
        min_weight_fraction_leaf: parseFloat(document.getElementById('dtMinWeightFractionLeaf').value),
        min_impurity_decrease: parseFloat(document.getElementById('dtMinImpurityDecrease').value),
        max_leaf_nodes: document.getElementById('dtMaxLeafNodes').value ? 
            parseInt(document.getElementById('dtMaxLeafNodes').value) : null,
        ccp_alpha: parseFloat(document.getElementById('dtCcpAlpha').value),
        
        // Advanced criterion
        criterion_advanced: document.getElementById('dtCriterionAdvanced').value,
        
        // Classification specific
        class_weight: document.getElementById('dtProblemType').value === 'classification' ?
            document.getElementById('dtClassWeight').value : null,
        decision_threshold: document.getElementById('dtProblemType').value === 'classification' ?
            parseFloat(document.getElementById('dtDecisionThreshold').value) : null,
        output_type: document.getElementById('dtProblemType').value === 'classification' ?
            document.getElementById('dtOutputType').value : null,
        
        // Other
        // random_state ahora se maneja globalmente en el Módulo 1
        validation_method: document.getElementById('dtValidationMethod').value
    };
    
    // Override criterion if advanced is selected
    if (config.criterion_advanced !== 'default') {
        config.criterion = config.criterion_advanced;
    }
    
    return config;
}

// Get max features value based on selection
function getDecisionTreeMaxFeatures() {
    const maxFeatures = document.getElementById('dtMaxFeatures').value;
    
    if (maxFeatures === 'None') {
        return null;
    } else if (maxFeatures === 'int') {
        return parseInt(document.getElementById('dtMaxFeaturesValue').value);
    } else if (maxFeatures === 'float') {
        return parseFloat(document.getElementById('dtMaxFeaturesValue').value);
    } else {
        return maxFeatures; // 'sqrt' or 'log2'
    }
}

// Load Decision Tree configuration for editing
function loadDecisionTreeConfiguration(hyperparams) {
    if (!hyperparams) return;
    
    // Basic parameters
    setValueWithRangeUpdate('dtPreset', hyperparams.preset || 'balanceado');
    setValueWithRangeUpdate('dtProblemType', hyperparams.problem_type || 'regression');
    setValueWithRangeUpdate('dtSplitter', hyperparams.splitter || 'best');
    
    // Criterion
    if (hyperparams.criterion) {
        // Check if it's an advanced criterion
        const basicCriteria = ['gini', 'entropy', 'squared_error'];
        if (!basicCriteria.includes(hyperparams.criterion)) {
            setValueWithRangeUpdate('dtCriterionAdvanced', hyperparams.criterion);
        } else {
            setValueWithRangeUpdate('dtCriterion', hyperparams.criterion);
        }
    }
    
    // Max depth
    setCheckboxValue('dtMaxDepthEnabled', hyperparams.max_depth_enabled !== false, toggleDecisionTreeMaxDepth);
    if (hyperparams.max_depth) {
        setValueWithRangeUpdate('dtMaxDepth', hyperparams.max_depth);
    }
    
    // Min samples leaf
    if (hyperparams.min_samples_leaf_fraction) {
        setCheckboxValue('dtMinSamplesLeafFraction', true, toggleMinSamplesLeafType);
        setValueWithRangeUpdate('dtMinSamplesLeaf', hyperparams.min_samples_leaf * 100);
    } else {
        setCheckboxValue('dtMinSamplesLeafFraction', false, toggleMinSamplesLeafType);
        setValueWithRangeUpdate('dtMinSamplesLeaf', hyperparams.min_samples_leaf || 1);
    }
    updateDecisionTreeMinSamplesLeaf();
    
    // Max features
    if (hyperparams.max_features !== null && hyperparams.max_features !== undefined) {
        if (typeof hyperparams.max_features === 'number') {
            if (hyperparams.max_features <= 1) {
                setValueWithRangeUpdate('dtMaxFeatures', 'float');
                setValueWithRangeUpdate('dtMaxFeaturesValue', hyperparams.max_features);
            } else {
                setValueWithRangeUpdate('dtMaxFeatures', 'int');
                setValueWithRangeUpdate('dtMaxFeaturesValue', hyperparams.max_features);
            }
        } else {
            setValueWithRangeUpdate('dtMaxFeatures', hyperparams.max_features);
        }
        toggleDecisionTreeMaxFeatures();
    }
    
    // Other parameters
    setValueWithRangeUpdate('dtMinSamplesSplit', hyperparams.min_samples_split || 2);
    setValueWithRangeUpdate('dtMinWeightFractionLeaf', hyperparams.min_weight_fraction_leaf || 0, 'dtMinWeightFractionLeafValue');
    setValueWithRangeUpdate('dtMinImpurityDecrease', hyperparams.min_impurity_decrease || 0, 'dtMinImpurityDecreaseValue');
    
    if (hyperparams.max_leaf_nodes) {
        setValueWithRangeUpdate('dtMaxLeafNodes', hyperparams.max_leaf_nodes);
    }
    
    setValueWithRangeUpdate('dtCcpAlpha', hyperparams.ccp_alpha || 0);
    
    // Classification specific
    if (hyperparams.class_weight) {
        setValueWithRangeUpdate('dtClassWeight', hyperparams.class_weight);
    }
    if (hyperparams.decision_threshold !== undefined) {
        setValueWithRangeUpdate('dtDecisionThreshold', hyperparams.decision_threshold, 'dtDecisionThresholdValue');
    }
    if (hyperparams.output_type) {
        setValueWithRangeUpdate('dtOutputType', hyperparams.output_type);
    }
    
    // Random state - ahora se maneja globalmente en el Módulo 1
    // No necesitamos configurar random_state individual
    
    setValueWithRangeUpdate('dtValidationMethod', hyperparams.validation_method || 'holdout');
    
    // Update UI based on problem type
    updateDecisionTreeOptions();
}

// Función para actualizar los porcentajes de división de datos
function updateDataSplits() {
    const trainSize = parseInt(document.getElementById('trainSize').value) || 0;
    const valSize = parseInt(document.getElementById('valSize').value) || 0;
    const testSizeInput = document.getElementById('testSize');
    
    // Calcular el porcentaje de test restante
    const testSize = 100 - trainSize - valSize;
    
    // Validar que los porcentajes sean válidos
    if (testSize < 0 || testSize > 100) {
        testSizeInput.value = 'Error';
        testSizeInput.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';
        return false;
    }
    
    testSizeInput.value = testSize;
    testSizeInput.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
    
    // Validar que la suma sea 100
    if (trainSize + valSize + testSize !== 100) {
        testSizeInput.style.backgroundColor = 'rgba(255, 193, 7, 0.2)';
        return false;
    }
    
    // Actualizar la visualización si hay un dataset seleccionado
    updateDataSplitVisualization();
    
    return true;
}

// Función para actualizar los porcentajes de división de datos en el modal de configuración
function updateDataSplitsConfig() {
    const trainSize = parseInt(document.getElementById('trainSizeConfig').value) || 0;
    const valSize = parseInt(document.getElementById('valSizeConfig').value) || 0;
    const testSizeInput = document.getElementById('testSizeConfig');
    
    // Calcular el porcentaje de test restante
    const testSize = 100 - trainSize - valSize;
    
    // Validar que los porcentajes sean válidos
    if (testSize < 0 || testSize > 100) {
        testSizeInput.value = 'Error';
        testSizeInput.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';
        return false;
    }
    
    testSizeInput.value = testSize;
    testSizeInput.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
    
    // Validar que la suma sea 100
    if (trainSize + valSize + testSize !== 100) {
        testSizeInput.style.backgroundColor = 'rgba(255, 193, 7, 0.2)';
        return false;
    }
    
    return true;
}

// Función para actualizar las opciones según el método de división seleccionado
function updateSplitMethodOptions() {
    const splitMethod = document.getElementById('splitMethod').value;
    
    // Ocultar todas las opciones
    document.querySelectorAll('.split-options').forEach(el => {
        el.style.display = 'none';
    });
    
    // Mostrar las opciones correspondientes
    const optionsId = splitMethod + 'Options';
    const optionsElement = document.getElementById(optionsId);
    if (optionsElement) {
        optionsElement.style.display = 'block';
    }
    
    // Si es por grupos, cargar las columnas disponibles
    if (splitMethod === 'group') {
        loadGroupColumns();
    }
    
    // Si es estratificada, verificar si es un problema de clasificación
    if (splitMethod === 'stratified') {
        checkStratifiedCompatibility();
    }
    
    // Actualizar la visualización cuando cambie el método de división
    updateDataSplitVisualization();
}

// Cargar columnas para división por grupos
function loadGroupColumns() {
    const dataset = document.getElementById('dataset').value;
    const groupColumnSelect = document.getElementById('groupColumn');
    
    if (!dataset) {
        groupColumnSelect.innerHTML = '<option value="">Seleccione primero un dataset</option>';
        return;
    }
    
    // Obtener las columnas del dataset
    fetch(`/api/datasets/${dataset}/columns/`)
        .then(response => response.json())
        .then(columns => {
            groupColumnSelect.innerHTML = '<option value="">Sélectionner une colonne...</option>';
            columns.forEach(col => {
                if (col.dtype === 'object' || col.dtype === 'int64') {
                    const option = document.createElement('option');
                    option.value = col.name;
                    option.textContent = `${col.name} (${col.dtype})`;
                    groupColumnSelect.appendChild(option);
                }
            });
        })
        .catch(error => {
            console.error('Error al cargar columnas:', error);
            showNotification('Error', 'No se pudieron cargar las columnas', 'error');
        });
}

// Verificar compatibilidad con división estratificada
function checkStratifiedCompatibility() {
    const targetVariables = document.querySelectorAll('.target-checkbox:checked');
    
    if (targetVariables.length === 0) {
        showNotification('Avertissement', 
            'La división estratificada requiere al menos una variable objetivo de clasificación', 
            'warning');
        return;
    }
    
    // Aquí podrías agregar más validaciones según el tipo de problema
}

// Obtener la configuración de división de datos
function getDataSplitConfig() {
    const config = {
        split_method: document.getElementById('splitMethod').value,
        train_split: parseFloat(document.getElementById('trainSize').value) / 100,
        val_split: parseFloat(document.getElementById('valSize').value) / 100,
        test_split: parseFloat(document.getElementById('testSize').value) / 100,
        random_state: document.getElementById('globalRandomState').value || null,
        split_config: {}
    };
    
    // Configuración específica según el método
    switch (config.split_method) {
        case 'group':
            config.split_config.group_column = document.getElementById('groupColumn').value;
            break;
        case 'temporal':
            config.split_config.method = document.getElementById('temporalMethod').value;
            config.split_config.gap = parseInt(document.getElementById('temporalGap').value) || 0;
            break;
    }
    
    return config;
}

// Función para actualizar la visualización de división de datos
function updateDataSplitVisualization() {
    const datasetId = document.getElementById('dataset').value;
    
    if (!datasetId) {
        // Ocultar visualización si no hay dataset
        document.getElementById('dataSplitVisualization').style.display = 'none';
        return;
    }
    
    // Obtener información del dataset
    fetch(`/api/datasets/${datasetId}/`)
        .then(response => response.json())
        .then(dataset => {
            // Contar variables seleccionadas
            const targetCheckboxes = document.querySelectorAll('.target-checkbox:checked');
            const predictorCheckboxes = document.querySelectorAll('.predictor-checkbox:checked');
            
            const targetCount = targetCheckboxes.length;
            const predictorCount = predictorCheckboxes.length;
            
            // Obtener porcentajes actuales
            const trainPct = parseInt(document.getElementById('trainSize').value) || 70;
            const valPct = parseInt(document.getElementById('valSize').value) || 15;
            const testPct = parseInt(document.getElementById('testSize').value) || 15;
            
            // Calcular número de muestras (asumiendo que no hay filtros por ahora)
            const totalSamples = dataset.row_count || 0;
            const filteredSamples = totalSamples; // TODO: aplicar filtros reales
            
            const trainSamples = Math.floor(filteredSamples * trainPct / 100);
            const valSamples = Math.floor(filteredSamples * valPct / 100);
            const testSamples = filteredSamples - trainSamples - valSamples;
            
            // Actualizar elementos de la visualización
            updateSplitVisualizationElements(trainSamples, valSamples, testSamples, trainPct, valPct, testPct);
            updateDatasetInfoElements(totalSamples, filteredSamples, predictorCount, targetCount);
            
            // Mostrar la visualización
            document.getElementById('dataSplitVisualization').style.display = 'block';
        })
        .catch(error => {
            console.error('Error obteniendo información del dataset:', error);
            document.getElementById('dataSplitVisualization').style.display = 'none';
        });
}

// Función para actualizar los elementos de visualización de splits
function updateSplitVisualizationElements(trainSamples, valSamples, testSamples, trainPct, valPct, testPct) {
    // Actualizar contadores
    document.getElementById('trainCount').textContent = trainSamples.toLocaleString();
    document.getElementById('valCount').textContent = valSamples.toLocaleString();
    document.getElementById('testCount').textContent = testSamples.toLocaleString();
    
    // Actualizar porcentajes
    document.getElementById('trainPercentage').textContent = `${trainPct}%`;
    document.getElementById('valPercentage').textContent = `${valPct}%`;
    document.getElementById('testPercentage').textContent = `${testPct}%`;
    
    // Actualizar barras de progreso
    document.getElementById('trainProgressBar').style.width = `${trainPct}%`;
    document.getElementById('valProgressBar').style.width = `${valPct}%`;
    document.getElementById('testProgressBar').style.width = `${testPct}%`;
}

// Función para actualizar información del dataset
function updateDatasetInfoElements(totalSamples, filteredSamples, predictorCount, targetCount) {
    document.getElementById('totalDatasetCount').textContent = totalSamples.toLocaleString();
    document.getElementById('filteredDatasetCount').textContent = filteredSamples.toLocaleString();
    document.getElementById('predictorCount').textContent = predictorCount;
    document.getElementById('targetCount').textContent = targetCount;
}

// Función para actualizar la visualización cuando cambian las variables
function updateVariableVisualization() {
    // Esta función se puede llamar cuando se seleccionan/deseleccionan variables
    updateDataSplitVisualization();
}

// Actualizar la función createModelOnly para incluir la nueva configuración
const originalCreateModelOnly = window.createModelOnly || function() {};
window.createModelOnly = function() {
    // Obtener la configuración de división de datos
    const dataSplitConfig = getDataSplitConfig();
    
    // Aquí deberías integrar dataSplitConfig con el resto de la configuración del modelo
    // Por ahora, lo guardamos en una variable global para uso posterior
    window.currentDataSplitConfig = dataSplitConfig;
    
    // Llamar a la función original si existe
    if (typeof originalCreateModelOnly === 'function') {
        originalCreateModelOnly();
    }
};
</script>

<!-- Include Random Forest configuration script -->
<script src="{% static 'js/random-forest-config-v2.js' %}"></script>

{% endblock %}