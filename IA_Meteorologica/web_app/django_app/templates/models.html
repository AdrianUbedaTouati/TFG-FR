{% extends 'base.html' %}
{% load static %}

{% block title %}Gestion des Modèles - MétéoIA{% endblock %}

{% block extra_css %}
<style>
    /* Styles similaires aux cartes de datasets */
    .model-card {
        background: rgba(10, 14, 39, 0.8);
        border: 2px solid rgba(0, 212, 255, 0.3);
        border-radius: 20px;
        padding: 25px;
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 420px;
        width: 350px;
        min-width: 350px;
        max-width: 350px;
        backdrop-filter: blur(10px);
    }
    
    .model-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(138, 43, 226, 0.1) 0%, transparent 70%);
        transform: rotate(45deg);
        transition: all 0.5s ease;
        opacity: 0;
        pointer-events: none;
    }
    
    .model-card:hover {
        transform: translateY(-10px);
        border-color: rgba(138, 43, 226, 0.8);
        box-shadow: 0 15px 40px rgba(138, 43, 226, 0.3);
    }
    
    .model-card:hover::before {
        opacity: 1;
    }
    
    .model-icon {
        font-size: 3rem;
        background: linear-gradient(135deg, #8a2be2, #6366f1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
        text-align: center;
    }
    
    .model-card .card-title {
        color: white !important;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .model-card .card-body {
        display: flex;
        flex-direction: column;
        flex: 1;
        width: 100%;
        padding: 0;
    }
    
    .model-stats {
        display: flex;
        justify-content: space-around;
        margin-top: auto;
        margin-bottom: 10px;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.3rem;
        font-weight: bold;
        color: #8a2be2;
    }
    
    .quick-actions {
        position: absolute;
        top: 10px;
        right: 15px;
        display: flex;
        gap: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 100;
    }
    
    .model-card:hover .quick-actions {
        opacity: 1;
    }
    
    .quick-actions button {
        background: rgba(138, 43, 226, 0.2);
        border: 2px solid rgba(138, 43, 226, 0.4);
        color: #8a2be2;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .quick-actions button:hover {
        transform: scale(1.1);
    }
    
    .quick-actions button[data-action="train"]:hover {
        background: rgba(138, 43, 226, 0.8);
        border-color: #8a2be2;
        color: white;
        box-shadow: 0 0 20px rgba(138, 43, 226, 0.8);
    }
    
    .quick-actions button[data-action="edit"]:hover {
        background: rgba(99, 102, 241, 0.8);
        border-color: #6366f1;
        color: white;
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.8);
    }
    
    .quick-actions button[data-action="clone"]:hover {
        background: rgba(16, 185, 129, 0.8);
        border-color: #10b981;
        color: white;
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);
    }
    
    .quick-actions button[data-action="delete"]:hover {
        background: rgba(239, 68, 68, 0.8);
        border-color: #ef4444;
        color: white;
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
    }
    
    .model-type-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        background: rgba(138, 43, 226, 0.2);
        color: #8a2be2;
        border: 1px solid rgba(138, 43, 226, 0.3);
    }
    
    .training-status {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.85rem;
    }
    
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }
    
    .status-success { background: #10b981; }
    .status-training { background: #f59e0b; animation: pulse 2s infinite; }
    .status-failed { background: #ef4444; }
    
    .models-container {
        display: flex;
        gap: 30px;
        overflow-x: auto;
        padding: 20px 0;
        scroll-behavior: smooth;
    }
    
    .models-container::-webkit-scrollbar {
        height: 10px;
    }
    
    .models-container::-webkit-scrollbar-track {
        background: rgba(138, 43, 226, 0.1);
        border-radius: 5px;
    }
    
    .models-container::-webkit-scrollbar-thumb {
        background: rgba(138, 43, 226, 0.5);
        border-radius: 5px;
    }
    
    .models-container::-webkit-scrollbar-thumb:hover {
        background: rgba(138, 43, 226, 0.7);
    }
    
    .create-model-card {
        background: rgba(138, 43, 226, 0.1);
        border: 3px dashed rgba(138, 43, 226, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .create-model-card:hover {
        background: rgba(138, 43, 226, 0.2);
        border-color: #8a2be2;
        transform: scale(1.02);
    }
    
    /* Modal styles */
    .modal-backdrop.show {
        opacity: 0.5;
    }
    
    /* Modal d'historique des entraînements */
    .training-history-item {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(138, 43, 226, 0.3);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }
    
    .training-history-item:hover {
        background: rgba(138, 43, 226, 0.1);
        transform: translateX(5px);
    }
    
    .metric-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        margin-right: 5px;
        background: rgba(99, 102, 241, 0.2);
        color: #a5b4fc;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 text-white mb-4">
                <i class="bi bi-cpu"></i> Gestion des Modèles
            </h1>
        </div>
    </div>
    
    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-cpu text-primary" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="totalModels">0</h3>
                    <p class="text-muted mb-0">Modèles Définis</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-graph-up text-success" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="totalTrainings">0</h3>
                    <p class="text-muted mb-0">Entraînements Totaux</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-trophy text-warning" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="bestScore">-</h3>
                    <p class="text-muted mb-0">Meilleur Score</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-clock-history text-info" style="font-size: 2rem;"></i>
                    <h3 class="mt-3" id="lastTraining">-</h3>
                    <p class="text-muted mb-0">Dernier Entraînement</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filtres -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-primary">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label for="searchFilter" class="form-label text-info">Rechercher par nom</label>
                            <input type="text" class="form-control" id="searchFilter" 
                                   placeholder="Nom du modèle..." onkeyup="filterModels()">
                        </div>
                        <div class="col-md-4">
                            <label for="typeFilter" class="form-label text-info">Type de modèle</label>
                            <select class="form-select" id="typeFilter" onchange="filterModels()">
                                <option value="">Tous les types</option>
                                <option value="random_forest">Random Forest</option>
                                <option value="lstm">LSTM</option>
                                <option value="gru">GRU</option>
                                <option value="xgboost">XGBoost</option>
                                <option value="gradient_boosting">Gradient Boosting</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-info">Tri</label>
                            <select class="form-select" id="sortFilter" onchange="filterModels()">
                                <option value="name">Par nom</option>
                                <option value="date">Par date de création</option>
                                <option value="performance">Par performance</option>
                                <option value="trainings">Par nombre d'entraînements</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modèles -->
    <div class="row">
        <div class="col-12">
            <h3 class="text-white mb-3">Modèles Disponibles</h3>
            <div class="models-container" id="modelsContainer">
                <!-- Carte pour créer un nouveau modèle -->
                <div class="card model-card create-model-card" onclick="showCreateModelModal()">
                    <div class="text-center">
                        <i class="bi bi-plus-circle" style="font-size: 4rem; color: #8a2be2;"></i>
                        <h5 class="text-white mt-3">Créer un Nouveau Modèle</h5>
                        <p class="text-muted">Définir et configurer un nouveau modèle</p>
                    </div>
                </div>
                
                <!-- Les modèles seront chargés ici -->
            </div>
        </div>
    </div>
</div>

<!-- Modal Historique des Entraînements -->
<div class="modal fade" id="trainingHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="trainingHistoryTitle">
                    <i class="bi bi-clock-history"></i> Historique des Entraînements
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="trainingHistoryContent">
                <!-- Le contenu sera chargé dynamiquement -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Édition du Modèle -->
<div class="modal fade" id="editModelModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="editModelTitle">
                    <i class="bi bi-pencil-square"></i> Éditer le Modèle
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="editModelContent">
                <!-- Le contenu sera chargé dynamiquement -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveModelChanges()">
                    <i class="bi bi-save"></i> Enregistrer les modifications
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Créer un Modèle -->
<div class="modal fade" id="createModelModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white">
                    <i class="bi bi-cpu"></i> Créer un Nouveau Modèle
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createModelForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modelName" class="form-label">Nom du Modèle</label>
                                <input type="text" class="form-control" id="modelName" placeholder="Ex: Modèle Météo LSTM v2" required>
                            </div>
                            <div class="mb-3">
                                <label for="modelDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="modelDescription" rows="2" placeholder="Description du modèle..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="modelType" class="form-label">Type de Modèle</label>
                                <select class="form-select" id="modelType" required>
                                    <option value="">Sélectionner...</option>
                                    <option value="random_forest">Random Forest</option>
                                    <option value="lstm">LSTM (Deep Learning)</option>
                                    <option value="gru">GRU (Deep Learning)</option>
                                    <option value="xgboost">XGBoost</option>
                                    <option value="gradient_boosting">Gradient Boosting</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="dataset" class="form-label">Dataset</label>
                                <select class="form-select" id="dataset" required onchange="loadDatasetColumns()">
                                    <option value="">Sélectionner un dataset...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Colonnes Cibles (à prédire)</label>
                                <div id="targetVariables" class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background: rgba(255, 107, 107, 0.05); border-color: rgba(255, 107, 107, 0.3) !important;">
                                    <p class="text-muted">Sélectionnez d'abord un dataset</p>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Variables Prédictives</label>
                                <div id="predictorVariables" class="border rounded p-3" style="max-height: 200px; overflow-y: auto; background: rgba(0, 212, 255, 0.05); border-color: rgba(0, 212, 255, 0.3) !important;">
                                    <p class="text-muted">Sélectionnez d'abord un dataset</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i> Le modèle sera sauvegardé sans entraînement. Vous pourrez l'entraîner plus tard depuis cette page.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveNewModel()">
                    <i class="bi bi-save"></i> Créer le Modèle
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
let modelsList = [];
let filteredModels = [];
let selectedModel = null;

// Charger les modèles
function loadModels() {
    showLoading();
    
    fetch('/api/models/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            modelsList = data;
            updateStatistics();
            filterModels();
            hideLoading();
        })
        .catch(error => {
            console.error('Erreur:', error);
            hideLoading();
            showNotification('Erreur', 'Impossible de charger les modèles', 'error');
        });
}

// Mettre à jour les statistiques
function updateStatistics() {
    document.getElementById('totalModels').textContent = modelsList.length;
    
    let totalTrainings = 0;
    let bestScore = 0;
    let lastTrainingDate = null;
    
    modelsList.forEach(model => {
        totalTrainings += model.training_count || 0;
        if (model.best_score && model.best_score > bestScore) {
            bestScore = model.best_score;
        }
        if (model.last_trained) {
            const date = new Date(model.last_trained);
            if (!lastTrainingDate || date > lastTrainingDate) {
                lastTrainingDate = date;
            }
        }
    });
    
    document.getElementById('totalTrainings').textContent = totalTrainings;
    document.getElementById('bestScore').textContent = bestScore > 0 ? (bestScore * 100).toFixed(1) + '%' : '-';
    document.getElementById('lastTraining').textContent = lastTrainingDate ? 
        lastTrainingDate.toLocaleDateString('fr-FR') : '-';
}

// Filtrer les modèles
function filterModels() {
    const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value;
    const sortBy = document.getElementById('sortFilter').value;
    
    // Filtrer
    filteredModels = modelsList.filter(model => {
        const matchesSearch = model.name.toLowerCase().includes(searchTerm) || 
                            model.description.toLowerCase().includes(searchTerm);
        const matchesType = !typeFilter || model.model_type === typeFilter;
        return matchesSearch && matchesType;
    });
    
    // Trier
    filteredModels.sort((a, b) => {
        switch (sortBy) {
            case 'name':
                return a.name.localeCompare(b.name);
            case 'date':
                return new Date(b.created_at) - new Date(a.created_at);
            case 'performance':
                return (b.best_score || 0) - (a.best_score || 0);
            case 'trainings':
                return (b.training_count || 0) - (a.training_count || 0);
            default:
                return 0;
        }
    });
    
    displayModels();
}

// Afficher les modèles
function displayModels() {
    const container = document.getElementById('modelsContainer');
    
    // Garder la carte de création
    const createCard = container.querySelector('.create-model-card');
    container.innerHTML = '';
    container.appendChild(createCard);
    
    if (filteredModels.length === 0) {
        const emptyMessage = document.createElement('div');
        emptyMessage.className = 'col-12 text-center text-muted py-5';
        emptyMessage.innerHTML = '<i class="bi bi-cpu" style="font-size: 3rem;"></i><br>Aucun modèle trouvé';
        container.appendChild(emptyMessage);
        return;
    }
    
    filteredModels.forEach(model => {
        const card = createModelCard(model);
        container.appendChild(card);
    });
}

// Créer une carte de modèle
function createModelCard(model) {
    const card = document.createElement('div');
    card.className = 'card model-card';
    
    const latestTraining = model.latest_training;
    const statusClass = latestTraining?.status === 'completed' ? 'success' : 
                       latestTraining?.status === 'training' ? 'training' : 'failed';
    
    card.innerHTML = `
        <div class="quick-actions">
            <button type="button" class="action-btn" data-action="train" 
                    onclick="event.stopPropagation(); trainModel(${model.id})" 
                    title="Entraîner">
                <i class="bi bi-play-fill"></i>
            </button>
            <button type="button" class="action-btn" data-action="edit" 
                    onclick="event.stopPropagation(); editModel(${model.id})" 
                    title="Éditer">
                <i class="bi bi-pencil"></i>
            </button>
            <button type="button" class="action-btn" data-action="clone" 
                    onclick="event.stopPropagation(); cloneModel(${model.id})" 
                    title="Cloner">
                <i class="bi bi-files"></i>
            </button>
            <button type="button" class="action-btn" data-action="delete" 
                    onclick="event.stopPropagation(); deleteModel(${model.id})" 
                    title="Supprimer">
                <i class="bi bi-trash"></i>
            </button>
        </div>
        
        <div class="card-body">
            <div class="model-icon">
                <i class="bi bi-diagram-3"></i>
            </div>
            <h5 class="card-title text-center mb-2" style="font-weight: 600; font-size: 1.2rem;">
                ${model.name}
            </h5>
            <div class="text-center mb-3">
                <span class="model-type-badge">${model.model_type.toUpperCase()}</span>
            </div>
            <p class="text-muted small text-center mb-3" style="font-size: 0.85rem;">
                ${model.description || 'Modèle de prédiction météorologique'}
            </p>
            
            <div class="model-stats">
                <div class="stat-item">
                    <div class="stat-value">${model.training_count || 0}</div>
                    <div class="text-muted small">Entraînements</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${model.success_rate || 0}%</div>
                    <div class="text-muted small">Succès</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${model.best_score ? (model.best_score * 100).toFixed(1) : '-'}%</div>
                    <div class="text-muted small">Meilleur</div>
                </div>
            </div>
            
            <div class="mt-3 pt-3" style="border-top: 1px solid rgba(138, 43, 226, 0.2);">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted small">Dataset:</span>
                    <span class="text-info small">${model.dataset_name}</span>
                </div>
                ${latestTraining ? `
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted small">Dernier statut:</span>
                    <span class="training-status">
                        <span class="status-dot status-${statusClass}"></span>
                        <span class="small">${getStatusText(latestTraining.status)}</span>
                    </span>
                </div>
                ` : ''}
            </div>
            
            <div class="text-center mt-auto pt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="showTrainingHistory(${model.id})">
                    <i class="bi bi-clock-history"></i> Voir l'historique
                </button>
            </div>
        </div>
    `;
    
    return card;
}

// Obtenir le texte du statut
function getStatusText(status) {
    switch (status) {
        case 'completed': return 'Terminé';
        case 'training': return 'En cours';
        case 'failed': return 'Échoué';
        default: return 'En attente';
    }
}

// Afficher l'historique des entraînements
function showTrainingHistory(modelId) {
    const model = modelsList.find(m => m.id === modelId);
    if (!model) return;
    
    selectedModel = model;
    
    // Clean up any existing modals first
    cleanupModals();
    
    document.getElementById('trainingHistoryTitle').innerHTML = `
        <i class="bi bi-clock-history"></i> Historique - ${model.name}
    `;
    
    showLoading();
    
    fetch(`/api/models/${modelId}/trainings/`)
        .then(response => response.json())
        .then(trainings => {
            hideLoading();
            displayTrainingHistory(trainings);
            
            const modalElement = document.getElementById('trainingHistoryModal');
            // Always create a fresh instance
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: false,  // Pas de backdrop
                keyboard: true,
                focus: true
            });
            modal.show();
        })
        .catch(error => {
            hideLoading();
            console.error('Erreur:', error);
            showNotification('Erreur', 'Impossible de charger l\'historique', 'error');
        });
}

// Afficher l'historique
function displayTrainingHistory(trainings) {
    const content = document.getElementById('trainingHistoryContent');
    
    if (trainings.length === 0) {
        content.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-clock-history" style="font-size: 3rem;"></i>
                <p class="mt-3">Aucun entraînement pour ce modèle</p>
                <button class="btn btn-primary" onclick="trainModel(${selectedModel.id})">
                    <i class="bi bi-play-fill"></i> Lancer le premier entraînement
                </button>
            </div>
        `;
        return;
    }
    
    content.innerHTML = trainings.map(training => {
        const metrics = training.test_results || {};
        const statusClass = training.status === 'completed' ? 'success' : 
                           training.status === 'training' ? 'warning' : 'danger';
        
        return `
            <div class="training-history-item">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <h6 class="mb-1">Session #${training.id}</h6>
                        <small class="text-muted">
                            ${new Date(training.created_at).toLocaleString('fr-FR')}
                        </small>
                    </div>
                    <div class="col-md-2">
                        <span class="badge bg-${statusClass}">
                            ${getStatusText(training.status)}
                        </span>
                    </div>
                    <div class="col-md-5">
                        ${metrics.accuracy ? `
                            <span class="metric-badge">Accuracy: ${(metrics.accuracy * 100).toFixed(2)}%</span>
                        ` : ''}
                        ${metrics.mae ? `
                            <span class="metric-badge">MAE: ${metrics.mae.toFixed(4)}</span>
                        ` : ''}
                        ${metrics.rmse ? `
                            <span class="metric-badge">RMSE: ${metrics.rmse.toFixed(4)}</span>
                        ` : ''}
                    </div>
                    <div class="col-md-2 text-end">
                        ${training.status === 'completed' ? `
                            <button class="btn btn-sm btn-outline-info" 
                                    onclick="window.location.href='/training-progress/${training.id}/'">
                                <i class="bi bi-eye"></i> Détails
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Entraîner le modèle
function trainModel(modelId) {
    const model = modelsList.find(m => m.id === modelId);
    if (!model) return;
    
    // Créer une nouvelle session d'entraînement basée sur la définition du modèle
    const trainingData = {
        model_definition: modelId,
        name: `${model.name} - Training ${new Date().toISOString()}`,
        model_type: model.model_type,
        dataset: model.dataset,
        predictor_columns: model.predictor_columns,
        target_columns: model.target_columns,
        config: model.default_config,
        hyperparameters: model.hyperparameters,
        custom_architecture: model.custom_architecture,
        use_custom_architecture: model.use_custom_architecture
    };
    
    showLoading();
    
    fetch('/api/training-sessions/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(trainingData)
    })
    .then(response => response.json())
    .then(session => {
        hideLoading();
        // Rediriger vers la page de progression
        window.location.href = `/training-progress/${session.id}/`;
    })
    .catch(error => {
        hideLoading();
        console.error('Erreur:', error);
        showNotification('Erreur', 'Impossible de démarrer l\'entraînement', 'error');
    });
}

// Éditer le modèle
function editModel(modelId) {
    const model = modelsList.find(m => m.id === modelId);
    if (!model) return;
    
    selectedModel = model;
    
    // Clean up any existing modals first
    cleanupModals();
    
    document.getElementById('editModelTitle').innerHTML = `
        <i class="bi bi-pencil-square"></i> Éditer - ${model.name}
    `;
    
    // Créer le formulaire d'édition
    document.getElementById('editModelContent').innerHTML = `
        <form id="editModelForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="editModelName" class="form-label">Nom du modèle</label>
                        <input type="text" class="form-control" id="editModelName" 
                               value="${model.name}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editModelDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editModelDescription" rows="3">${model.description || ''}</textarea>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Type de modèle</label>
                        <input type="text" class="form-control" value="${model.model_type.toUpperCase()}" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dataset</label>
                        <input type="text" class="form-control" value="${model.dataset_name}" disabled>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Pour modifier la configuration technique du modèle (architecture, variables, etc.), 
                créez une nouvelle version en clonant ce modèle.
            </div>
        </form>
    `;
    
    const modalElement = document.getElementById('editModelModal');
    // Always create a fresh instance
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: false,  // Pas de backdrop
        keyboard: true,
        focus: true
    });
    modal.show();
}

// Sauvegarder les modifications
function saveModelChanges() {
    if (!selectedModel) return;
    
    const data = {
        name: document.getElementById('editModelName').value,
        description: document.getElementById('editModelDescription').value
    };
    
    showLoading();
    
    fetch(`/api/models/${selectedModel.id}/`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(updated => {
        hideLoading();
        showNotification('Succès', 'Modèle mis à jour avec succès', 'success');
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('editModelModal'));
        if (modalInstance) {
            modalInstance.hide();
            modalInstance.dispose();
        }
        cleanupModals();
        loadModels();
    })
    .catch(error => {
        hideLoading();
        console.error('Erreur:', error);
        showNotification('Erreur', 'Impossible de sauvegarder les modifications', 'error');
    });
}

// Cloner le modèle
function cloneModel(modelId) {
    const model = modelsList.find(m => m.id === modelId);
    if (!model) return;
    
    Swal.fire({
        title: 'Cloner le modèle',
        text: `Voulez-vous créer une copie de "${model.name}"?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#8a2be2',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Oui, cloner',
        cancelButtonText: 'Annuler'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading();
            
            fetch(`/api/models/${modelId}/clone/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(newModel => {
                hideLoading();
                showNotification('Succès', 'Modèle cloné avec succès', 'success');
                loadModels();
            })
            .catch(error => {
                hideLoading();
                console.error('Erreur:', error);
                showNotification('Erreur', 'Impossible de cloner le modèle', 'error');
            });
        }
    });
}

// Supprimer le modèle
function deleteModel(modelId) {
    const model = modelsList.find(m => m.id === modelId);
    if (!model) return;
    
    Swal.fire({
        title: 'Êtes-vous sûr?',
        html: `
            <p>Voulez-vous vraiment supprimer le modèle "<strong>${model.name}</strong>"?</p>
            <p class="text-warning"><i class="bi bi-exclamation-triangle"></i> Cette action supprimera également tous les entraînements associés.</p>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Oui, supprimer',
        cancelButtonText: 'Annuler'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading();
            
            fetch(`/api/models/${modelId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(() => {
                hideLoading();
                showNotification('Succès', 'Modèle supprimé avec succès', 'success');
                loadModels();
            })
            .catch(error => {
                hideLoading();
                console.error('Erreur:', error);
                showNotification('Erreur', 'Impossible de supprimer le modèle', 'error');
            });
        }
    });
}

// Fonction utilitaire pour obtenir le cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Ensure cleanupModals is available if not defined in base.html
if (typeof cleanupModals === 'undefined') {
    function cleanupModals() {
        // Remove all backdrops
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('overflow');
        document.body.style.removeProperty('padding-right');
        
        // Dispose of all modal instances
        document.querySelectorAll('.modal').forEach(modalEl => {
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) {
                modalInstance.dispose();
            }
        });
    }
}

// Afficher le chargement
function showLoading() {
    const loader = document.createElement('div');
    loader.id = 'globalLoader';
    loader.className = 'text-center p-5';
    loader.innerHTML = `
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Chargement...</span>
        </div>
    `;
    document.body.appendChild(loader);
}

// Masquer le chargement
function hideLoading() {
    const loader = document.getElementById('globalLoader');
    if (loader) {
        loader.remove();
    }
}

// Afficher une notification
function showNotification(title, message, type = 'info') {
    const icon = type === 'success' ? 'check-circle' : 
                 type === 'error' ? 'x-circle' : 
                 type === 'warning' ? 'exclamation-triangle' : 'info-circle';
                 
    const bgColor = type === 'success' ? 'success' : 
                    type === 'error' ? 'danger' : 
                    type === 'warning' ? 'warning' : 'info';
    
    const notification = document.createElement('div');
    notification.className = `alert alert-${bgColor} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-${icon} fs-4 me-2"></i>
            <div>
                <strong>${title}</strong>
                <p class="mb-0 small">${message}</p>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Fonction pour afficher le modal de création
function showCreateModelModal() {
    // Ensure page is clean
    setTimeout(() => {
        // Clean up any existing modals first
        cleanupModals();
        hideLoading();
        
        // Charger les datasets disponibles
        fetch('/api/datasets/')
            .then(response => response.json())
            .then(datasets => {
                const select = document.getElementById('dataset');
                select.innerHTML = '<option value="">Sélectionner un dataset...</option>';
                datasets.forEach(dataset => {
                    const option = document.createElement('option');
                    option.value = dataset.id;
                    option.textContent = dataset.name;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Erreur lors du chargement des datasets:', error);
            });
        
        // Réinitialiser le formulaire
        document.getElementById('createModelForm').reset();
        document.getElementById('targetVariables').innerHTML = '<p class="text-muted">Sélectionnez d\'abord un dataset</p>';
        document.getElementById('predictorVariables').innerHTML = '<p class="text-muted">Sélectionnez d\'abord un dataset</p>';
        
        // Afficher le modal
        const modalElement = document.getElementById('createModelModal');
        
        // Always create a fresh instance
        const modal = new bootstrap.Modal(modalElement, {
            backdrop: false,  // Pas de backdrop pour éviter le filtre gris
            keyboard: true,
            focus: true
        });
        
        modal.show();
    }, 50);
}

// Charger les colonnes du dataset
function loadDatasetColumns() {
    const datasetId = document.getElementById('dataset').value;
    const targetDiv = document.getElementById('targetVariables');
    const predictorDiv = document.getElementById('predictorVariables');
    
    if (!datasetId) {
        targetDiv.innerHTML = '<p class="text-muted">Sélectionnez d\'abord un dataset</p>';
        predictorDiv.innerHTML = '<p class="text-muted">Sélectionnez d\'abord un dataset</p>';
        return;
    }
    
    // Charger les colonnes
    fetch(`/api/datasets/${datasetId}/columns/`)
        .then(response => response.json())
        .then(data => {
            const columns = data.columns || [];
            
            // Variables cibles
            targetDiv.innerHTML = '';
            columns.forEach(columnName => {
                const div = document.createElement('div');
                div.className = 'form-check';
                div.innerHTML = `
                    <input class="form-check-input target-checkbox" type="checkbox" 
                           value="${columnName}" id="target_${columnName}">
                    <label class="form-check-label" for="target_${columnName}">
                        ${columnName}
                    </label>
                `;
                targetDiv.appendChild(div);
            });
            
            // Variables prédictives
            predictorDiv.innerHTML = '';
            columns.forEach(columnName => {
                const div = document.createElement('div');
                div.className = 'form-check';
                div.innerHTML = `
                    <input class="form-check-input predictor-checkbox" type="checkbox" 
                           value="${columnName}" id="predictor_${columnName}">
                    <label class="form-check-label" for="predictor_${columnName}">
                        ${columnName}
                    </label>
                `;
                predictorDiv.appendChild(div);
            });
        })
        .catch(error => {
            console.error('Erreur:', error);
            targetDiv.innerHTML = '<p class="text-danger">Erreur lors du chargement des colonnes</p>';
            predictorDiv.innerHTML = '<p class="text-danger">Erreur lors du chargement des colonnes</p>';
        });
}

// Sauvegarder le nouveau modèle
function saveNewModel() {
    // Collecter les données du formulaire
    const modelName = document.getElementById('modelName').value;
    const modelDescription = document.getElementById('modelDescription').value;
    const modelType = document.getElementById('modelType').value;
    const datasetId = document.getElementById('dataset').value;
    
    // Validation basique
    if (!modelName || !modelType || !datasetId) {
        showNotification('Erreur', 'Veuillez remplir tous les champs obligatoires', 'error');
        return;
    }
    
    // Collecter les variables sélectionnées
    const targetColumns = Array.from(document.querySelectorAll('.target-checkbox:checked'))
        .map(cb => cb.value);
    const predictorColumns = Array.from(document.querySelectorAll('.predictor-checkbox:checked'))
        .map(cb => cb.value);
    
    if (targetColumns.length === 0) {
        showNotification('Erreur', 'Veuillez sélectionner au moins une variable cible', 'error');
        return;
    }
    
    if (predictorColumns.length === 0) {
        showNotification('Erreur', 'Veuillez sélectionner au moins une variable prédictive', 'error');
        return;
    }
    
    // Configuration par défaut selon le type de modèle
    let defaultConfig = {};
    if (modelType === 'lstm' || modelType === 'gru') {
        defaultConfig = {
            epochs: 50,
            batch_size: 32,
            optimizer: 'adam',
            learning_rate: 0.001,
            loss_function: 'mse',
            metrics: ['mae', 'mse']
        };
    } else if (modelType === 'random_forest') {
        defaultConfig = {
            n_estimators: 100,
            max_depth: null,
            min_samples_split: 2,
            min_samples_leaf: 1
        };
    } else if (modelType === 'xgboost') {
        defaultConfig = {
            n_estimators: 100,
            max_depth: 3,
            learning_rate: 0.1,
            objective: 'reg:squarederror'
        };
    }
    
    const modelData = {
        name: modelName,
        description: modelDescription || `Modèle ${modelType.toUpperCase()} pour prédire ${targetColumns.join(', ')}`,
        model_type: modelType,
        dataset: datasetId,
        target_columns: targetColumns,
        predictor_columns: predictorColumns,
        default_config: defaultConfig,
        hyperparameters: defaultConfig
    };
    
    showLoading();
    
    fetch('/api/models/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(modelData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(model => {
        hideLoading();
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('createModelModal'));
        if (modalInstance) {
            modalInstance.hide();
            modalInstance.dispose();
        }
        cleanupModals();
        showNotification('Succès', 'Modèle créé avec succès!', 'success');
        loadModels(); // Recharger la liste des modèles
    })
    .catch(error => {
        hideLoading();
        console.error('Erreur:', error);
        showNotification('Erreur', 'Impossible de créer le modèle', 'error');
    });
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    loadModels();
    
    // Actualiser toutes les 30 secondes
    setInterval(loadModels, 30000);
});
</script>
{% endblock %}